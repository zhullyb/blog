<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>systemd (正體中文) - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.35.0">
<meta name="robots" content="noindex,follow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="http://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Systemd_正體中文 rootpage-Systemd_正體中文 skin-vector action-view skin-vector-legacy">
<div id="content" class="mw-body" role="main" style="margin: 0">
	<a id="top"></a>
	<div id="siteNotice" class="mw-body-content"></div>
	<div class="mw-indicators mw-body-content">
	</div>
	<h1 id="firstHeading" class="firstHeading" lang="en">systemd (正體中文)</h1>
	<div id="bodyContent" class="mw-body-content">
		<div id="siteSub" class="noprint">From ArchWiki</div>
		<div id="contentSub"></div>
		<div id="contentSub2"></div>
		
		<div id="jump-to-nav"></div>
		<a class="mw-jump-link" href="#mw-head">Jump to navigation</a>
		<a class="mw-jump-link" href="#searchInput">Jump to search</a>
		<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr">
<div class="warningbox">The printable version is no longer supported and may have rendering errors. Please update your browser bookmarks and please use the default browser print function instead.</div>
<div class="mw-parser-output">
<p><span></span>
</p>
<div class="noprint archwiki-template-message">
<p><a href="../File:Tango-preferences-desktop-locale.png" class="image"><img alt="Tango-preferences-desktop-locale.png" src="../File:Tango-preferences-desktop-locale.png" decoding="async" width="48" height="48"></a><b>本條目或段落需要進行<a href="../en/ArchWiki:Contributing.html#Translating" title="ArchWiki:Contributing">翻譯</a>。</b><a href="../File:Tango-preferences-desktop-locale.png" class="image"><img alt="Tango-preferences-desktop-locale.png" src="../File:Tango-preferences-desktop-locale.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>註記: </b> 仍有部分章節尚未翻譯 (<a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php/Talk:Systemd_(%E6%AD%A3%E9%AB%94%E4%B8%AD%E6%96%87)">討論</a>)</div>
</div>
<div class="archwiki-template-meta-related-articles-start">
<p>Related articles</p>
<ul>
<li><a href="../en/Systemd/FAQ.html" class="mw-redirect" title="Systemd FAQ">Systemd FAQ</a></li>
<li><a href="../en/Init.html" class="mw-redirect" title="Init to systemd cheatsheet">Init to systemd cheatsheet</a></li>
<li><a href="../en/Udev.html" title="Udev">udev</a></li>
</ul>
</div>
<p>節錄自 <a rel="nofollow" class="external text" href="https://freedesktop.org/wiki/Software/systemd">systemd 專案網頁</a>:
</p>
<p><b>systemd</b> 是一個Linux的系統與服務管理器, 並且相容於 SysV 與 LSB init scripts.
systemd 提供並行化任務的能力, 使用 socket 與 <a href="../en/D-Bus.html" title="D-Bus">D-Bus</a> 來啟動服務, 按照需要啟動服務(daemons),
使用 Linux <a href="../en/Cgroups.html" title="Cgroups">control groups</a> 來追蹤程序, 支援系統快照與回復系統狀態, 維護掛載與自動掛載點.
並由精密的控制來管理各個服務. 它亦可以完美的取代 sysvinit。目前Arch已經採用<a href="../en/Systemd.html" title="Systemd">Systemd</a>取代sysvinit。
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 若希望了解 Arch 為何轉變到 systemd, 請參照 <a rel="nofollow" class="external text" href="https://bbs.archlinux.org/viewtopic.php?pid=1149530#p1149530">這篇文章</a>.</div>
<div id="toc" class="toc" role="navigation" aria-labelledby="mw-toc-heading">
<input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none"><div class="toctitle" lang="en" dir="ltr">
<h2 id="mw-toc-heading">Contents</h2>
<span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span>
</div>
<ul>
<li class="toclevel-1 tocsection-1">
<a href="#systemd_%E5%9F%BA%E6%9C%AC%E5%B7%A5%E5%85%B7"><span class="tocnumber">1</span> <span class="toctext">systemd 基本工具</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="#%E5%88%86%E6%9E%90%E7%B3%BB%E7%B5%B1%E7%8B%80%E6%85%8B"><span class="tocnumber">1.1</span> <span class="toctext">分析系統狀態</span></a></li>
<li class="toclevel-2 tocsection-3"><a href="#%E4%BD%BF%E7%94%A8%E5%96%AE%E5%85%83"><span class="tocnumber">1.2</span> <span class="toctext">使用單元</span></a></li>
<li class="toclevel-2 tocsection-4"><a href="#%E9%9B%BB%E6%BA%90%E7%AE%A1%E7%90%86"><span class="tocnumber">1.3</span> <span class="toctext">電源管理</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-5">
<a href="#%E7%B7%A8%E5%AF%AB%E5%96%AE%E5%85%83%E6%AA%94%E6%A1%88"><span class="tocnumber">2</span> <span class="toctext">編寫單元檔案</span></a>
<ul>
<li class="toclevel-2 tocsection-6"><a href="#%E8%99%95%E7%90%86%E4%BE%9D%E8%B3%B4%E9%97%9C%E4%BF%82"><span class="tocnumber">2.1</span> <span class="toctext">處理依賴關係</span></a></li>
<li class="toclevel-2 tocsection-7"><a href="#%E6%9C%8D%E5%8B%99%E9%A1%9E%E5%9E%8B"><span class="tocnumber">2.2</span> <span class="toctext">服務類型</span></a></li>
<li class="toclevel-2 tocsection-8"><a href="#%E4%BF%AE%E6%94%B9%E7%8F%BE%E6%9C%89%E5%96%AE%E5%85%83%E6%AA%94"><span class="tocnumber">2.3</span> <span class="toctext">修改現有單元檔</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-9">
<a href="#%E7%9B%AE%E6%A8%99%EF%BC%88target%EF%BC%89"><span class="tocnumber">3</span> <span class="toctext">目標（target）</span></a>
<ul>
<li class="toclevel-2 tocsection-10"><a href="#%E8%8E%B7%E5%8F%96%E7%95%B6%E5%89%8D%E7%9B%AE%E6%A8%99"><span class="tocnumber">3.1</span> <span class="toctext">获取當前目標</span></a></li>
<li class="toclevel-2 tocsection-11"><a href="#%E5%89%B5%E5%BB%BA%E6%96%B0%E7%9B%AE%E6%A8%99"><span class="tocnumber">3.2</span> <span class="toctext">創建新目標</span></a></li>
<li class="toclevel-2 tocsection-12"><a href="#%E7%9B%AE%E6%A8%99%E8%A1%A8"><span class="tocnumber">3.3</span> <span class="toctext">目標表</span></a></li>
<li class="toclevel-2 tocsection-13"><a href="#%E5%88%87%E6%8D%A2%E5%9F%B7%E8%A1%8C%E7%B4%9A%E5%88%A5/%E7%9B%AE%E6%A8%99"><span class="tocnumber">3.4</span> <span class="toctext">切换執行級別/目標</span></a></li>
<li class="toclevel-2 tocsection-14"><a href="#%E4%BF%AE%E6%94%B9%E9%A0%90%E8%A8%AD%E5%9F%B7%E8%A1%8C%E7%B4%9A%E5%88%A5/%E7%9B%AE%E6%A8%99"><span class="tocnumber">3.5</span> <span class="toctext">修改預設執行級別/目標</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-15"><a href="#%E8%87%A8%E6%99%82%E6%AA%94%E6%A1%88"><span class="tocnumber">4</span> <span class="toctext">臨時檔案</span></a></li>
<li class="toclevel-1 tocsection-16"><a href="#%E5%AE%9A%E6%99%82%E5%99%A8"><span class="tocnumber">5</span> <span class="toctext">定時器</span></a></li>
<li class="toclevel-1 tocsection-17">
<a href="#%E6%97%A5%E8%AA%8C"><span class="tocnumber">6</span> <span class="toctext">日誌</span></a>
<ul>
<li class="toclevel-2 tocsection-18"><a href="#%E9%81%8E%E6%BF%BE%E8%BC%B8%E5%87%BA"><span class="tocnumber">6.1</span> <span class="toctext">過濾輸出</span></a></li>
<li class="toclevel-2 tocsection-19"><a href="#%E6%97%A5%E8%AA%8C%E5%A4%A7%E5%B0%8F%E7%9A%84%E9%99%90%E5%88%B6"><span class="tocnumber">6.2</span> <span class="toctext">日誌大小的限制</span></a></li>
<li class="toclevel-2 tocsection-20"><a href="#%E9%85%8D%E5%90%88_syslog_%E4%BD%BF%E7%94%A8"><span class="tocnumber">6.3</span> <span class="toctext">配合 syslog 使用</span></a></li>
<li class="toclevel-2 tocsection-21"><a href="#%E6%89%8B%E5%8B%95%E6%B8%85%E7%90%86%E6%97%A5%E8%AA%8C"><span class="tocnumber">6.4</span> <span class="toctext">手動清理日誌</span></a></li>
<li class="toclevel-2 tocsection-22"><a href="#Journald_in_conjunction_with_syslog"><span class="tocnumber">6.5</span> <span class="toctext">Journald in conjunction with syslog</span></a></li>
<li class="toclevel-2 tocsection-23"><a href="#%E8%BD%89%E9%80%81_journald_%E5%88%B0_/dev/tty12"><span class="tocnumber">6.6</span> <span class="toctext">轉送 journald 到 /dev/tty12</span></a></li>
<li class="toclevel-2 tocsection-24"><a href="#%E6%9F%A5%E7%9C%8B%E7%89%B9%E5%AE%9A%E4%BD%8D%E7%BD%AE%E7%9A%84%E6%97%A5%E8%AA%8C"><span class="tocnumber">6.7</span> <span class="toctext">查看特定位置的日誌</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-25">
<a href="#%E7%96%91%E9%9B%A3%E8%A7%A3%E7%AD%94"><span class="tocnumber">7</span> <span class="toctext">疑難解答</span></a>
<ul>
<li class="toclevel-2 tocsection-26"><a href="#%E5%B0%8B%E6%89%BE%E9%8C%AF%E8%AA%A4"><span class="tocnumber">7.1</span> <span class="toctext">尋找錯誤</span></a></li>
<li class="toclevel-2 tocsection-27"><a href="#%E8%A8%BA%E6%96%B7%E9%96%8B%E6%A9%9F%E5%95%8F%E9%A1%8C"><span class="tocnumber">7.2</span> <span class="toctext">診斷開機問題</span></a></li>
<li class="toclevel-2 tocsection-28"><a href="#%E8%A8%BA%E6%96%B7%E4%B8%80%E4%B8%AA%E7%89%B9%E5%AE%9A%E6%9C%8D%E5%8B%99"><span class="tocnumber">7.3</span> <span class="toctext">診斷一个特定服務</span></a></li>
<li class="toclevel-2 tocsection-29"><a href="#%E9%97%9C%E6%A9%9F/%E9%87%8D%E5%95%9F%E5%8D%81%E5%88%86%E7%B7%A9%E6%85%A2"><span class="tocnumber">7.4</span> <span class="toctext">關機/重啟十分緩慢</span></a></li>
<li class="toclevel-2 tocsection-30"><a href="#%E7%9F%AD%E6%99%82%E8%99%95%E7%90%86%E7%A8%8B%E5%BA%8F%E7%84%A1%E6%97%A5%E8%AA%8C%E8%A8%98%E9%8C%84"><span class="tocnumber">7.5</span> <span class="toctext">短時處理程序無日誌記錄</span></a></li>
<li class="toclevel-2 tocsection-31"><a href="#%E7%A6%81%E6%AD%A2%E5%9C%A8%E7%A8%8B%E5%BA%8F%E5%B4%A9%E6%BA%83%E6%97%B6%E8%BD%AC%E5%82%A8%E5%86%85%E5%AD%98"><span class="tocnumber">7.6</span> <span class="toctext">禁止在程序崩溃时转储内存</span></a></li>
<li class="toclevel-2 tocsection-32"><a href="#%E5%95%9F%E5%8B%95%E6%99%82%E9%96%93%E5%A4%AA%E9%95%B7"><span class="tocnumber">7.7</span> <span class="toctext">啟動時間太長</span></a></li>
<li class="toclevel-2 tocsection-33"><a href="#systemd-tmpfiles-setup.service_%E5%9C%A8%E5%95%9F%E5%8B%95%E6%99%82%E5%95%9F%E5%8B%95%E5%A4%B1%E6%95%97"><span class="tocnumber">7.8</span> <span class="toctext">systemd-tmpfiles-setup.service 在啟動時啟動失敗</span></a></li>
<li class="toclevel-2 tocsection-34"><a href="#%E4%B8%8D%E8%83%BD%E8%A8%AD%E5%AE%9A%E5%9C%A8%E9%96%8B%E6%A9%9F%E6%99%82%E5%90%AF%E5%8A%A8%E8%BB%9F%E9%80%A3%E7%B5%90%E5%88%B0_/etc/systemd/system_%E7%9A%84%E6%9C%8D%E5%8B%99"><span class="tocnumber">7.9</span> <span class="toctext">不能設定在開機時启动軟連結到 /etc/systemd/system 的服務</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-35"><a href="#%E7%9B%B8%E9%97%9C%E8%B3%87%E6%BA%90"><span class="tocnumber">8</span> <span class="toctext">相關資源</span></a></li>
</ul>
</div>

<h2>
<span id="systemd_.E5.9F.BA.E6.9C.AC.E5.B7.A5.E5.85.B7"></span><span class="mw-headline" id="systemd_基本工具">systemd 基本工具</span>
</h2>
<p>查看和控制systemd的主要命令是<code>systemctl</code>。該命令可用查看系統狀態和管理系統及服務。詳見<span class="plainlinks archwiki-template-man" title="$ man 1 systemctl"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemctl.1">systemctl(1)</a></span>。
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>提示:</strong> * 在 <code>systemctl</code> 參數中添加 <code>-H &lt;使用者名稱&gt;@&lt;主機名&gt;</code> 可以實現對其他機器的遠端控制。該過程使用 <a href="../en/Secure_Shell.html" class="mw-redirect" title="SSH">SSH</a>連線。
<ul>
<li>
<code>systemadm</code> 是 systemd 的官方圖形前端。<a href="../en/Official_repositories.html" title="Official repositories">官方軟體倉庫</a> 提供了稳定版本 <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=systemd-ui">systemd-ui</a></span>。</li>
<li>
<a href="../en/KDE.html#Plasma" class="mw-redirect" title="Plasma">Plasma</a> 用戶可以安裝 <i>systemctl</i> 圖像前端 <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/systemd-kcm/">systemd-kcm</a></span><sup><small>AUR</small></sup>。安裝後可以在 <i>System administration</i> 下找到</li>
</ul>
</div>
<h3>
<span id=".E5.88.86.E6.9E.90.E7.B3.BB.E7.B5.B1.E7.8B.80.E6.85.8B"></span><span class="mw-headline" id="分析系統狀態">分析系統狀態</span>
</h3>
<p>顯示 <b>系統狀態</b>:
</p>
<pre>$ systemctl status
</pre>
<p>顯示激活的單元（Unit）：
</p>
<pre>$ systemctl
</pre>
<p>以下命令等效：
</p>
<pre>$ systemctl list-units
</pre>
<p>顯示執行失敗的單元：
</p>
<pre>$ systemctl --failed
</pre>
<p>所有可用的單元檔案存放在 <code>/usr/lib/systemd/system/</code> 和 <code>/etc/systemd/system/</code> 目錄（後者優先級更高）。查看所有已安裝服務：
</p>
<pre>$ systemctl list-unit-files
</pre>
<h3>
<span id=".E4.BD.BF.E7.94.A8.E5.96.AE.E5.85.83"></span><span class="mw-headline" id="使用單元">使用單元</span>
</h3>
<p>一个單元（Unit）的設定檔可以描述如下內容之一：系統服務（<code>.service</code>）、掛載點（<code>.mount</code>）、sockets（<code>.sockets</code>） 、系統設備（<code>.device</code>）、交換分割區（<code>.swap</code>）、檔案路徑（<code>.path</code>）、啟動目標（<code>.target</code>）、由 systemd 管理的計時器（<code>.timer</code>）。請參考 <span class="plainlinks archwiki-template-man" title="$ man 5 systemd.unit"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd.unit.5">systemd.unit(5)</a></span>。
</p>
<p>使用 <code>systemctl</code> 控制單元時，通常需要使用單元檔案的全名，包括附檔名（例如 <code>sshd.service</code>）。但是有些單元可以在<code>systemctl</code>中使用簡寫方式。
</p>
<ul>
<li>如果無附檔名，systemctl 預設把附檔名當作 <code>.service</code>。例如 <code>netcfg</code> 和 <code>netcfg.service</code> 是等價的。</li>
<li>掛載點會自動轉化為相應的 <code>.mount</code> 單元。例如 <code>/home</code> 等價于 <code>home.mount</code>。</li>
<li>設備會自動轉化為为相應的 <code>.device</code> 單元，所以 <code>/dev/sda2</code> 等價於 <code>dev-sda2.device</code>。</li>
</ul>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 有一些單元的名稱包含一个 <code>@</code> 标记， (e.g. <code>name@<i>string</i>.service</code>): 這意味着它是範本单元 <code>name@.service</code> 的一个 實例。 <code><i>string</i></code> 被稱作實例標識符, 在 <i>systemctl</i> 調用範本單元時，會將其當作一个參數傳給範本單元，範本單元會使用這個傳入的參數代替範本中的 <code>%I</code> 指示符。 
<p>在實例化之前，<i>systemd</i> 會先檢查 <code>name@string.suffix</code> 檔案是否存在（如果存在，應該就是直接使用這個檔案，而不是將範本實例化了）。大多數情況下，包换 <code>@</code> 標記都意味着這個檔案是範本。如果一個範本單元沒有實例化就調用，該調用會返回失敗，因為範本單元中的 <code>%I</code> 指示符沒有被替換。
</p>
</div>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> 
<ul>
<li>下面的大部分命令都可以跟多个單元名, 詳細資訊常見 <span class="plainlinks archwiki-template-man" title="$ man 1 systemctl"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemctl.1">systemctl(1)</a></span>。</li>
<li>從<a rel="nofollow" class="external text" href="https://github.com/systemd/systemd/blob/master/NEWS#L323-L326">systemd 220版本</a>開始, <code>systemctl</code>命令在<code>enable</code>、<code>disable</code>和<code>mask</code>子命令中增加了<code>--now</code>選項，可以實現激活的同時啟動服務，取消激活的同时停止服務。</li>
<li>一个軟體包可能會提供多个不同的單元。如果你已经安裝了軟體包，可以通过<code>pacman -Qql <i>package</i> | grep systemd</code>命令檢查這個軟體包提供了哪些單元。</li>
</ul>
</div>
<p>立即激活單元：
</p>
<pre># systemctl start &lt;單元&gt;
</pre>
<p>立即停止單元：
</p>
<pre># systemctl stop &lt;單元&gt;
</pre>
<p>重启單元：
</p>
<pre># systemctl restart &lt;單元&gt;
</pre>
<p>重新載入配置：
</p>
<pre># systemctl reload &lt;單元&gt;
</pre>
<p>顯示單元的運行狀態：
</p>
<pre>$ systemctl status &lt;單元&gt;
</pre>
<p>檢查單元是否配置為自動啟動：
</p>
<pre>$ systemctl is-enabled &lt;單元&gt;
</pre>
<p>開機時自动激活單元：
</p>
<pre># systemctl enable &lt;單元&gt;
</pre>
<p>取消開機自動激活單元：
</p>
<pre># systemctl disable &lt;單元&gt;
</pre>
<p>禁用一个單元(禁用后，間接啟動也是不可能的)：
</p>
<pre># systemctl mask &lt;單元&gt;
</pre>
<p>取消禁用一个單元：
</p>
<pre># systemctl unmask &lt;單元&gt;
</pre>
<p>顯示單元的手冊頁（必须須由單元檔案提供）：
</p>
<pre># systemctl help &lt;單元&gt;
</pre>
<p>重新載入 systemd，掃描新的或有變動的單元：
</p>
<pre># systemctl daemon-reload
</pre>
<h3>
<span id=".E9.9B.BB.E6.BA.90.E7.AE.A1.E7.90.86"></span><span class="mw-headline" id="電源管理">電源管理</span>
</h3>
<p>安裝 <a href="../en/Polkit.html" title="Polkit">polkit</a> 後才可以一般使用者身分使用電源管理。
</p>
<p>如果你正登入在一个本機的<code>systemd-logind</code>工作階段，且當前沒有其它活動的工作階段，那麼以下命令無需root權限即可執行。否則（例如，當前有另一个使用者登入在某个tty），systemd 將會自動請求輸入root密碼。
</p>
<p>重新啟動：
</p>
<pre>$ systemctl reboot
</pre>
<p>關機：
</p>
<pre>$ systemctl poweroff
</pre>
<p>待機：
</p>
<pre>$ systemctl suspend
</pre>
<p>休眠：
</p>
<pre>$ systemctl hibernate
</pre>
<p>混合休眠模式（同时休眠到硬碟並待機）：
</p>
<pre>$ systemctl hybrid-sleep
</pre>
<h2>
<span id=".E7.B7.A8.E5.AF.AB.E5.96.AE.E5.85.83.E6.AA.94.E6.A1.88"></span><span class="mw-headline" id="編寫單元檔案">編寫單元檔案</span>
</h2>
<p><code>systemd</code> <a rel="nofollow" class="external text" href="https://www.freedesktop.org/software/systemd/man/systemd.unit.html">單元檔案</a>的語法來源於XDG桌面入口設定檔<code>.desktop</code>檔案，最初的源头則是Microsoft Windows的<code>.ini</code>檔案。單元檔案可以從2個地方載入，優先級從低到高分別是：
</p>
<ul>
<li>
<code>/usr/lib/systemd/system/</code>: 軟體包安裝的單元</li>
<li>
<code>/etc/systemd/system/</code>: 系統管理員安裝的單元</li>
</ul>
<ul>
<li>當<code>systemd</code>執行在<a href="../en/Systemd/User.html#How_it_works" title="Systemd/User">使用者模式</a>下时，使用的載入路徑是完全不同的。</li>
<li>systemd 單元名稱仅能包含 ASCII 字符, 下劃線和點號. 其它字符需要用 C-style "\x2d" 替換. 參閱 <span class="plainlinks archwiki-template-man" title="$ man 5 systemd.unit"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd.unit.5">systemd.unit(5)</a></span> 和 <span class="plainlinks archwiki-template-man" title="$ man 1 systemd-escape"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd-escape.1">systemd-escape(1)</a></span>.}}</li>
</ul>
<p>單元檔的語法，可以參考系統中已經安裝的單元，也可以參考<span class="plainlinks archwiki-template-man" title="$ man 5 systemd.service"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd.service.5">systemd.service(5)</a></span>中的<a rel="nofollow" class="external text" href="https://www.freedesktop.org/software/systemd/man/systemd.service.html#Examples">EXAMPLES章節</a>。
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>提示:</strong>  以 <code>#</code> 開頭的注释可能也能用在 unit-files 中, 但是只能在新行中使用。 不要在 <i>systemd</i> 的參數後面使用行末註釋， 否則 unit 將會啟動失敗。</div>
<h3>
<span id=".E8.99.95.E7.90.86.E4.BE.9D.E8.B3.B4.E9.97.9C.E4.BF.82"></span><span class="mw-headline" id="處理依賴關係">處理依賴關係</span>
</h3>
<p>使用systemd时，可通過正確編寫單元檔來解決其依賴關係。典型的情況是，單元<code>A</code>要求單元<code>B</code>在<code>A</code>啟動之前執行。在此情況下，向單元<code>A</code>設定檔中的 <code>[Unit]</code> 段添加 <code>Requires=B</code> 和 <code>After=B</code> 即可。若此依賴關係是可选的，可添加 <code>Wants=B</code> 和 <code>After=B</code>。請注意 <code>Wants=</code> 和 <code>Requires=</code> 並不意味着 <code>After=</code>，即如果 <code>After=</code> 選項沒有制定，這兩個單元將被並行啟動。
</p>
<p>依賴關係通常被用在服務（service）而不是<a href="#%E7%9B%AE%E6%A8%99%EF%BC%88target%EF%BC%89">目標（target）</a>上。例如， <code>network.target</code> 一般會被某个配置網路介面的服務引入，所以，將自訂的單元排在該服務之後即可，因為 <code>network.target</code> 已經啟動。
</p>
<h3>
<span id=".E6.9C.8D.E5.8B.99.E9.A1.9E.E5.9E.8B"></span><span class="mw-headline" id="服務類型">服務類型</span>
</h3>
<p>編寫自訂的 service 檔案时，可以選擇幾種不同的服務啟動方式。啟動方式可通过設定檔 <code>[Service]</code> 段中的 <code>Type=</code> 參數進行設定。
</p>
<ul>
<li>
<code>Type=simple</code>（預設值）：systemd認為該服務將立即啟動。服務程序不會fork。如果該服務要啟動其他服務，不要使用此類型啟動，除非該服務是socket激活型。</li>
<li>
<code>Type=forking</code>：systemd認為當該服務程序fork，且父程序退出後服務啟動成功。對於常規的守护程序（daemon），除非你確定此啟動方式無法滿足需求，使用此類型啟動即可。使用此啟動類型應該同時指定 <code>PIDFile=</code>，以便systemd能夠跟踪服務的主程序。</li>
<li>
<code>Type=oneshot</code>：這一選項適用於只执行一項任務、随後立即退出的服務。可能需要同時設定 <code>RemainAfterExit=yes</code> 使得 systemd 在服務程序退出之後仍然認為服務處於激活狀態。</li>
<li>
<code>Type=notify</code>：與 <code>Type=simple</code> 相同，但約定服務會在就緒後向 systemd 發送一個信號。這一通知的實現由 <code>libsystemd-daemon.so</code> 提供。</li>
<li>
<code>Type=dbus</code>：若以此方式啟動，當指定的 <code>BusName</code> 出現在D-Bus系統總線上时，systemd認為服務就緒。</li>
<li>
<code>Type=idle</code>: <code>systemd</code>會等待所有工作處理完成後，才開始執行<code>idle</code>類型的單元。其他行為和<code>Type=simple</code> 類似。</li>
</ul>
<p><code>type</code>的更多解釋可以參考 <a rel="nofollow" class="external text" href="https://www.freedesktop.org/software/systemd/man/systemd.service.html#Type=">systemd.service(5)</a>。
</p>
<h3>
<span id=".E4.BF.AE.E6.94.B9.E7.8F.BE.E6.9C.89.E5.96.AE.E5.85.83.E6.AA.94"></span><span class="mw-headline" id="修改現有單元檔">修改現有單元檔</span>
</h3>
<p>為了避免和 pacman 衝突，不應該直接編輯軟體包提供的檔案. 要更改由軟體包提供的單元檔，先創建名為 <code>/etc/systemd/system/&lt;單元名&gt;.d/</code> 的目錄（如 <code>/etc/systemd/system/httpd.service.d/</code>），然後放入 <code>*.conf</code> 檔案，其中可以添加或重設參數。這裡設定的參數優先級高於原來的單元檔案。例如，如果想添加一个額外的依賴，創建這麼一個檔案即可：
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/&lt;unit&gt;.d/customdependency.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Requires=&lt;新依賴&gt;
After=&lt;新依賴&gt;</pre>
<p>As another example, in order to replace the <code>ExecStart</code> directive for a unit that is not of type <code>oneshot</code>, create the following file:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/<i>unit</i>.d/customexec.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Service]
ExecStart=
ExecStart=<i>new command</i></pre>
<p>想知道為什麼修改 <code>ExecStart</code> 前必須將其置空，參見 (<a rel="nofollow" class="external autonumber" href="https://bugzilla.redhat.com/show_bug.cgi?id=756787#c9">[1]</a>).
</p>
<p>下面是自動重啟服務的一个例子:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/<i>unit</i>.d/restart.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Service]
Restart=always
RestartSec=30</pre>
<p>然後執行以下命令使更改生效：
</p>
<pre># systemctl daemon-reload
# systemctl restart &lt;單元&gt;
</pre>
<p>此外，把舊的單元檔案從 <code>/usr/lib/systemd/system/</code> 複製到 <code>/etc/systemd/system/</code>，然後進行修改，也可以達到同樣的效果。在 <code>/etc/systemd/system/</code> 目錄中的單元檔的優先級總是高於 <code>/usr/lib/systemd/system/</code> 目錄中的同名單元檔案。注意，當 <code>/usr/lib/</code> 中的單元檔因軟體包升級而變更时，<code>/etc/</code> 中自訂的單元檔案不會同步更新。此外，你還得執行行 <code>systemctl reenable &lt;unit&gt;</code>，手動重新啟用該單元。因此，建議使用前面一種利用 <code>*.conf</code> 的方法。
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>提示:</strong> 用 <code>systemd-delta</code> 命令來查看哪些單元檔案被覆蓋、哪些被修改。系統維護的時候需要即時了解哪些單元已經有了更新。</div>
<p>安裝 <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/vim-systemd/">vim-systemd</a></span><sup><small>AUR</small></sup> 軟體包，可以使 unit 設定檔在 <a href="../en/Vim.html" title="Vim">Vim</a> 下支持語法高亮。
</p>
<h2>
<span id=".E7.9B.AE.E6.A8.99.EF.BC.88target.EF.BC.89"></span><span class="mw-headline" id="目標（target）">目標（target）</span>
</h2>
<p>執行級別（runlevel）是一个舊的概念。現在，systemd 引入了一個和執行級別功能相似又不同的概念——目標（target）。不像數字表示的執行級別，每個<i>目標</i>都有名字和獨特的功能，並且能同時啟用多個。一些<i>目標</i>繼承其他<i>目標</i>的服務，並啟動新服務。systemd 提供了一些模仿 sysvinit 執行級別的<i>目標</i>，仍可以使用舊的 <code>telinit 執行級別</code> 命令切換。
</p>
<h3>
<span id=".E8.8E.B7.E5.8F.96.E7.95.B6.E5.89.8D.E7.9B.AE.E6.A8.99"></span><span class="mw-headline" id="获取當前目標">获取當前目標</span>
</h3>
<p>不要使用 <code>runlevel</code> 命令了：
</p>
<pre>$ systemctl list-units --type=target
</pre>
<h3>
<span id=".E5.89.B5.E5.BB.BA.E6.96.B0.E7.9B.AE.E6.A8.99"></span><span class="mw-headline" id="創建新目標">創建新目標</span>
</h3>
<p>在 Fedora 中，啟動級別 0、1、3、5、6 都被赋予特定用途，並且都對應一個 systemd 的<i>目標</i>。然而，沒有什麼很好的移植用戶定義的執行級別（2、4）的方法。要實現類似功能，可以以原有的執行級別為基礎，創建一个新的<i>目標</i> <code>/etc/systemd/system/&lt;新目標&gt;</code>（可以參考 <code>/usr/lib/systemd/system/graphical.target</code>），創建 <code>/etc/systemd/system/&lt;新目標&gt;.wants</code> 目錄，向其中加入額外服務的連結（指向 <code>/usr/lib/systemd/system/</code> 中的單元檔案）。
</p>
<h3>
<span id=".E7.9B.AE.E6.A8.99.E8.A1.A8"></span><span class="mw-headline" id="目標表">目標表</span>
</h3>
<table class="wikitable">
<tbody>
<tr>
<th>SysV 執行級別</th>
<th>Systemd 目標</th>
<th>註釋
</th>
</tr>
<tr>
<td>0</td>
<td>runlevel0.target, poweroff.target</td>
<td>停機，關閉系統（halt）
</td>
</tr>
<tr>
<td>1, s, single</td>
<td>runlevel1.target, rescue.target</td>
<td>單使用者模式
</td>
</tr>
<tr>
<td>2, 4</td>
<td>runlevel2.target, runlevel4.target, multi-user.target</td>
<td>用戶自訂启动級別，通常識別為級別3。
</td>
</tr>
<tr>
<td>3</td>
<td>runlevel3.target, multi-user.target</td>
<td>多使用者，無圖形界面。使用者可以通過終端或網路登入。
</td>
</tr>
<tr>
<td>5</td>
<td>runlevel5.target, graphical.target</td>
<td>多用戶，圖形界面。繼承級別3的服務，並啟動圖形界面服務。
</td>
</tr>
<tr>
<td>6</td>
<td>runlevel6.target, reboot.target</td>
<td>重新開機
</td>
</tr>
<tr>
<td>emergency</td>
<td>emergency.target</td>
<td>急救模式（Emergency shell）
</td>
</tr>
</tbody>
</table>
<h3>
<span id=".E5.88.87.E6.8D.A2.E5.9F.B7.E8.A1.8C.E7.B4.9A.E5.88.A5.2F.E7.9B.AE.E6.A8.99"></span><span class="mw-headline" id="切换執行級別/目標">切换執行級別/目標</span>
</h3>
<p>systemd 中，執行級別通過“目標單元”設定。通过如下命令切換：
</p>
<pre># systemctl isolate graphical.target
</pre>
<p>該命令對下次啟動無影响。等價於<code>telinit 3</code> 或 <code>telinit 5</code>。
</p>
<h3>
<span id=".E4.BF.AE.E6.94.B9.E9.A0.90.E8.A8.AD.E5.9F.B7.E8.A1.8C.E7.B4.9A.E5.88.A5.2F.E7.9B.AE.E6.A8.99"></span><span class="mw-headline" id="修改預設執行級別/目標">修改預設執行級別/目標</span>
</h3>
<p>開機啟動進入的目標是 <code>default.target</code>，預設連結到 <code>graphical.target</code> （大致相當於原來的啟動級別5）。可以通過<a href="../en/Kernel_parameters.html" title="Kernel parameters">內核參數</a>更改預設啟動級別：
</p>
<ul>
<li>
<code>systemd.unit=multi-user.target</code> （大致相當於級別3）</li>
<li>
<code>systemd.unit=rescue.target</code> （大致相當於級別1）</li>
</ul>
<p>另一個方法是修改 <code>default.target</code>。可以通過 <code>systemctl</code> 修改它：
</p>
<pre># systemctl set-default multi-user.target
</pre>
<p>要覆蓋已經設置的<i>default.target</i>，請使用 force:
</p>
<pre># systemctl set-default -f multi-user.target
</pre>
<p>可以在 <code>systemctl</code> 的輸出中看到命令执行的效果：連結 <code>/etc/systemd/system/default.target</code> 被創建，指向新的預設啟動級別。
</p>
<h2>
<span id=".E8.87.A8.E6.99.82.E6.AA.94.E6.A1.88"></span><span class="mw-headline" id="臨時檔案">臨時檔案</span>
</h2>
<p><code>/usr/lib/tmpfiles.d/</code> 和 <code>/etc/tmpfiles.d/</code> 中的檔案描述了 systemd-tmpfiles 如何創建、清理、删除臨時檔案和目錄，這些檔案和目錄通常存放在 <code>/run</code> 和 <code>/tmp</code> 中。設定檔名稱為 <code>/etc/tmpfiles.d/&lt;program&gt;.conf</code>。此處的配置能覆蓋 <code>/usr/lib/tmpfiles.d/</code>目錄中的同名配置。
</p>
<p>臨時檔案通常和服務檔案同时提供，以生成守護程序需要的檔案和目錄。例如 <a href="../zh-CN/Samba.html" title="Samba (简体中文)">Samba</a> 服務需要目錄 <code>/run/samba</code> 存在並設置正確的權限位，就象這樣：
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/usr/lib/tmpfiles.d/samba.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">D /run/samba 0755 root root
</pre>
<p>此外，臨時檔案還可以用來在開機時向特定檔案寫入某些內容。比如，要禁止系統從USB裝置唤醒，利用舊的 <code>/etc/rc.local</code> 可以用 <code>echo USBE &gt; /proc/acpi/wakeup</code>，而現在可以這麼做：
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/tmpfiles.d/disable-usb-wake.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">w /proc/acpi/wakeup - - - - USBE
</pre>
<p>詳情參見<code>systemd-tmpfiles(8)</code> 和 <span class="plainlinks archwiki-template-man" title="$ man 5 tmpfiles.d"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/tmpfiles.d.5">tmpfiles.d(5)</a></span>。
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>注意：</strong> 該方法不能向 <code>/sys</code> 中的設定檔加入參數，因為 <code>systemd-tmpfiles-setup</code> 有可能在相關模組載入前運行。這種情況下，需要首先通過 <code>modinfo &lt;模組名&gt;</code> 確認需要的參數，並在 <a href="../en/Kernel_module.html#Options" class="mw-redirect" title="Kernel modules"><code>/etc/modprobe.d</code> 下的一个檔案</a><sup>[<a href="../en/Help:Procedures.html#Fix_broken_section_links" title="Help:Procedures">broken link</a>: invalid section]</sup>中設置改參數。另外，還可以使用 <a href="../zh-CN/Udev.html#udev%E8%A6%8F%E5%89%87" title="Udev (简体中文)">udev 規則</a><sup>[<a href="../en/Help:Procedures.html#Fix_broken_section_links" title="Help:Procedures">broken link</a>: invalid section]</sup>，在設備就緒時設定相應屬性。</div>
<h2>
<span id=".E5.AE.9A.E6.99.82.E5.99.A8"></span><span class="mw-headline" id="定時器">定時器</span>
</h2>
<p>Systemd Timer是以 <i>.timer</i> 为附檔名的設定檔，記錄由system裡面由時間觸發的動作, Timer可以替代 <i>cron</i> 的大部分功能。請參閱 <a href="../en/Systemd/Timers.html" title="Systemd/Timers">systemd/Timers</a>和<a href="../en/Cron.html" title="Cron">cron</a>.
</p>
<h2>
<span id=".E6.97.A5.E8.AA.8C"></span><span class="mw-headline" id="日誌">日誌</span>
</h2>
<p>systemd 提供了自己的日誌系統（logging system），稱為 <a href="../en/Systemd/Journal.html" class="mw-redirect" title="Journald">journald</a>. 使用 systemd 日誌，無需額外安裝日誌服務（syslog）。讀取日誌的命令：
</p>
<pre># journalctl
</pre>
<p>預設情況下（當 <code>Storage=</code> 在檔案 <code>/etc/systemd/journald.conf</code> 中被設定為 <code>auto</code>），日誌記錄将被寫入 <code>/var/log/journal/</code>。該目錄是 <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=systemd">systemd</a></span> 軟體包的一部分。若被删除，systemd <b>不會</b>自動創建它，直到下次升級軟體包时重建該目錄。如果該目錄缺失，systemd 會將日誌記錄寫入 <code>/run/systemd/journal</code>。這意味著，系統重啟後日誌將丟失。
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> 如果 <code>/var/log/journal/</code> 位于 <a href="../en/Btrfs.html" title="Btrfs">btrfs</a> 檔案系統，應該考慮對這個目錄禁用寫入時複製（COW，Copy On Write），參閱<a href="../en/Btrfs.html#Copy-on-Write_(CoW)" title="Btrfs">Btrfs#Copy-on-Write (CoW)</a>.</div>
<h3>
<span id=".E9.81.8E.E6.BF.BE.E8.BC.B8.E5.87.BA"></span><span class="mw-headline" id="過濾輸出">過濾輸出</span>
</h3>
<p><code>journalctl</code>可以根據特定字段過濾输出。如果過濾的字段比較多，需要較長時間才能顯示出來。
</p>
<p>示例：
</p>
<p>顯示本次啟動後的所有日誌：
</p>
<pre># journalctl -b
</pre>
<p>不過，一般大家更關心的不是本次啟動後的日誌，而是上次啟動時的（例如，剛剛系統崩溃了）。可以使用 <code>-b</code> 參數: 
</p>
<ul>
<li>
<code>journalctl -b -0</code> 顯示本次啟動的訊息</li>
<li>
<code>journalctl -b -1</code> 顯示上次啟動的訊息</li>
<li>
<code>journalctl -b -2</code> 顯示上上次啟動的訊息 <code>journalctl -b -2</code>
</li>
</ul>
<ul>
<li>現實從某个日期 ( 或時間 ) 開始的訊息: <pre># journalctl --since="2012-10-30 18:17:16"</pre>
</li>
<li>顯示從某個時間 ( 例如 20分鐘前 ) 的訊息: <pre># journalctl --since "20 min ago"</pre>
</li>
<li>顯示最新訊息<pre># journalctl -f</pre>
</li>
<li>顯示特定程式的所有訊息: <pre># journalctl /usr/lib/systemd/systemd</pre>
</li>
<li>顯示特定處理程序的所有訊息: <pre># journalctl _PID=1</pre>
</li>
<li>顯示指定單元的所有訊息：<pre># journalctl -u netcfg</pre>
</li>
<li>顯示內核環快取訊息r: <pre># journalctl -k</pre>
</li>
<li>Show auth.log equivalent by filtering on syslog facility: <pre># journalctl -f -l SYSLOG_FACILITY=10</pre>
</li>
</ul>
<p>詳情請參閱<span class="plainlinks archwiki-template-man" title="$ man 1 journalctl"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/journalctl.1">journalctl(1)</a></span>、<span class="plainlinks archwiki-template-man" title="$ man 7 systemd.journal-fields"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd.journal-fields.7">systemd.journal-fields(7)</a></span>。
</p>
<h3>
<span id=".E6.97.A5.E8.AA.8C.E5.A4.A7.E5.B0.8F.E7.9A.84.E9.99.90.E5.88.B6"></span><span class="mw-headline" id="日誌大小的限制">日誌大小的限制</span>
</h3>
<p>如果按上面的操作保留日誌的話，預設的日誌最大限制为所在檔案系統容量的 10%，即：如果 <code>/var/log/journal</code> 儲存在 50GiB 的根分割區中，那麼日誌最多存储 5GiB 的資料。可以修改設定檔指定最大限制。如限制日誌最大 50MiB：
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/journald.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">SystemMaxUse=50M</pre>
<p>詳情請參考 <span class="plainlinks archwiki-template-man" title="$ man 5 journald.conf"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/journald.conf.5">journald.conf(5)</a></span>.
</p>
<h3>
<span id=".E9.85.8D.E5.90.88_syslog_.E4.BD.BF.E7.94.A8"></span><span class="mw-headline" id="配合_syslog_使用">配合 syslog 使用</span>
</h3>
<p>systemd 提供了 socket <code>/run/systemd/journal/syslog</code>，以相容傳統日誌服務。所有系统資訊都會被傳入。要使傳統日誌服務工作，需要讓服務連結該 socket，而非 <code>/dev/log</code>（<a rel="nofollow" class="external text" href="http://lwn.net/Articles/474968/">官方說明</a>）。Arch 軟體仓庫中的 <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=syslog-ng">syslog-ng</a></span> 已經包含了需要的配置。
</p>
<p><i>systemd</i> 216 開始,<code>journald.conf</code> 使用 <code>no</code> 轉送socket . 为了使 <i>syslog-ng</i> 配合 <i>journald</i> , 你需要在 <code>/etc/systemd/journald.conf</code>  中設置  <code>ForwardToSyslog=yes</code> . 參閱 <a href="../en/Syslog-ng.html#Overview" title="Syslog-ng">Syslog-ng#Overview</a> 了解更多細節.
</p>
<p>如果你選擇使用 <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/rsyslog/">rsyslog</a></span><sup><small>AUR</small></sup> , 因為 <a href="../en/Rsyslog.html" title="Rsyslog">rsyslog</a> 從日誌中 <a rel="nofollow" class="external text" href="https://lists.freedesktop.org/archives/systemd-devel/2014-August/022295.html#journald">直接</a> 傳出消息,所以不再必要改變那個選項..
</p>
<p>設定開機啟動 syslog-ng：
</p>
<pre> # systemctl enable syslog-ng
</pre>
<h3>
<span id=".E6.89.8B.E5.8B.95.E6.B8.85.E7.90.86.E6.97.A5.E8.AA.8C"></span><span class="mw-headline" id="手動清理日誌">手動清理日誌</span>
</h3>
<p><code>/var/log/journal</code> 存放着日誌, <code>rm</code> 應該能工作. 或者使用<code>journalctl</code>,
</p>
<p>例如:
</p>
<ul>
<li>清理日誌使總大小小於 100M: <pre># journalctl --vacuum-size=100M</pre>
</li>
<li>清理最早兩週前的日誌. <pre># journalctl --vacuum-time=2weeks</pre>
</li>
</ul>
<p>參閱  {ic|man journalctl}} 获得更多資訊.
</p>
<h3><span class="mw-headline" id="Journald_in_conjunction_with_syslog">Journald in conjunction with syslog</span></h3>
<p>Compatibility with a classic, non-journald aware <a href="../en/Syslog-ng.html" title="Syslog-ng">syslog</a> implementation can be provided by letting <i>systemd</i> forward all messages via the socket <code>/run/systemd/journal/syslog</code>. To make the syslog daemon work with the journal, it has to bind to this socket instead of <code>/dev/log</code> (<a rel="nofollow" class="external text" href="http://lwn.net/Articles/474968/">official announcement</a>). 
</p>
<p>As of <i>systemd</i> 216 the default <code>journald.conf</code> for forwarding to the socket was changed to <code>ForwardToSyslog=no</code> to avoid system overhead, because <a href="../en/Rsyslog.html" title="Rsyslog">rsyslog</a> or <a href="../en/Syslog-ng.html" title="Syslog-ng">syslog-ng</a> (since 3.6) pull the messages from the journal by <a rel="nofollow" class="external text" href="https://lists.freedesktop.org/archives/systemd-devel/2014-August/022295.html#journald">itself</a>. 
</p>
<p>See <a href="../en/Syslog-ng.html#Overview" title="Syslog-ng">Syslog-ng#Overview</a> and <a href="../en/Syslog-ng.html#syslog-ng_and_systemd_journal" title="Syslog-ng">Syslog-ng#syslog-ng and systemd journal</a>, or <a href="../en/Rsyslog.html" title="Rsyslog">rsyslog</a> respectively, for details on configuration.
</p>
<h3>
<span id=".E8.BD.89.E9.80.81_journald_.E5.88.B0_.2Fdev.2Ftty12"></span><span class="mw-headline" id="轉送_journald_到_/dev/tty12">轉送 journald 到 /dev/tty12</span>
</h3>
<p>建立一個 <a href="#Editing_provided_units">drop-in directory</a><sup>[<a href="../en/Help:Procedures.html#Fix_broken_section_links" title="Help:Procedures">broken link</a>: invalid section]</sup> <code>/etc/systemd/journald.conf.d</code> 然後在其中建立 <code>fw-tty12.conf</code> :
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/journald.conf.d/fw-tty12.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Journal]
ForwardToConsole=yes
TTYPath=/dev/tty12
MaxLevelConsole=info</pre>
<p>然後重新啟動  systemd-journald.
</p>
<h3>
<span id=".E6.9F.A5.E7.9C.8B.E7.89.B9.E5.AE.9A.E4.BD.8D.E7.BD.AE.E7.9A.84.E6.97.A5.E8.AA.8C"></span><span class="mw-headline" id="查看特定位置的日誌">查看特定位置的日誌</span>
</h3>
<p>有时你希望查看另一個系統上的日誌.例如从 Live 環境修复現有的系統.
</p>
<p>這種情況下你可以掛載目標系統 ( 例如掛載到 <code>/mnt</code> ),然後用 <code>-D</code>/<code>--directory</code> 參數指定目錄,像這樣:
</p>
<pre>$ journalctl -D <i>/mnt</i>/var/log/journal -xe
</pre>
<h2>
<span id=".E7.96.91.E9.9B.A3.E8.A7.A3.E7.AD.94"></span><span class="mw-headline" id="疑難解答">疑難解答</span>
</h2>
<h3>
<span id=".E5.B0.8B.E6.89.BE.E9.8C.AF.E8.AA.A4"></span><span class="mw-headline" id="尋找錯誤">尋找錯誤</span>
</h3>
<p>這個例子中的失敗的服務是 <code>systemd-modules-load</code> :
</p>
<p><b>1.</b> 通過 <i>systemd</i> 尋找啟動失敗的服務:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$ systemctl --state=failed</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">systemd-modules-load.service   loaded <b>failed failed</b>  Load Kernel Modules</pre>
<p><b>2.</b> 我們發現了啟動失敗的 <code>systemd-modules-load</code> 服務. 我們想知道更多諮詢:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$ systemctl status systemd-modules-load</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">systemd-modules-load.service - Load Kernel Modules
   Loaded: loaded (/usr/lib/systemd/system/systemd-modules-load.service; static)
   Active: <b>failed</b> (Result: exit-code) since So 2013-08-25 11:48:13 CEST; 32s ago
     Docs: man:systemd-modules-load.service(8).
           man:modules-load.d(5)
  Process: <b>15630</b> ExecStart=/usr/lib/systemd/systemd-modules-load (<b>code=exited, status=1/FAILURE</b>)</pre>
<p>如果沒有列出 <code>Process ID</code>, 通過 <code>systemctl</code> 重新啟動失敗的服務 ( 例如 <code>systemctl restart systemd-modules-load</code> )
</p>
<p><b>3.</b> 現在得到了 PID ,你就可以進一步探查錯誤的詳細資訊了.通過下列的命令收集日誌,PID 參數是你剛剛得到的 <code>Process ID</code> (例如 15630):
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$ journalctl -b _PID=15630</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">-- Logs begin at Sa 2013-05-25 10:31:12 CEST, end at So 2013-08-25 11:51:17 CEST. --
Aug 25 11:48:13 mypc systemd-modules-load[15630]: <b>Failed to find module 'blacklist usblp'</b>
Aug 25 11:48:13 mypc systemd-modules-load[15630]: <b>Failed to find module 'install usblp /bin/false'</b></pre>
<p><b>4.</b> 我們發現有些內核模組的設定檔不正確,因此在  <code>/etc/modules-load.d/</code> 中檢查一下:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$ ls -Al /etc/modules-load.d/</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">...
-rw-r--r--   1 root root    79  1. Dez 2012  blacklist.conf
-rw-r--r--   1 root root     1  2. Mär 14:30 encrypt.conf
-rw-r--r--   1 root root     3  5. Dez 2012  printing.conf
-rw-r--r--   1 root root     6 14. Jul 11:01 realtek.conf
-rw-r--r--   1 root root    65  2. Jun 23:01 virtualbox.conf
...
</pre>
<p><b>5.</b> 錯誤訊息 <code>Failed to find module 'blacklist usblp'</code> 也許和  <code>blacklist.conf</code> 相關. 讓我們註釋掉第三步發現的錯誤的選項:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/modules-load.d/blacklist.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"><b>#</b> blacklist usblp
<b>#</b> install usblp /bin/false
</pre>
<p><b>6.</b> 最後重新啟動 <code>systemd-modules-load</code> 服務:
</p>
<pre>$ systemctl start systemd-modules-load
</pre>
<p>如果服務成功啟動，不會有任何輸出.如果你还是遇到了錯誤,回到步驟三,获得新的 PID 来跟踪日誌並解決錯誤.
</p>
<p>可以像這樣確認服務成功啟動:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$ systemctl status systemd-modules-load</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">systemd-modules-load.service - Load Kernel Modules
   Loaded: <b>loaded</b> (/usr/lib/systemd/system/systemd-modules-load.service; static)
   Active: <b>active (exited)</b> since So 2013-08-25 12:22:31 CEST; 34s ago
     Docs: man:systemd-modules-load.service(8)
           man:modules-load.d(5)
 Process: 19005 ExecStart=/usr/lib/systemd/systemd-modules-load (code=exited, status=0/SUCCESS)
Aug 25 12:22:31 mypc systemd[1]: <b>Started Load Kernel Modules</b>.</pre>
<p>參閱 <a href="#%E8%A8%BA%E6%96%B7%E9%96%8B%E6%A9%9F%E5%95%8F%E9%A1%8C">#診斷開機問題</a> 一節获得更多探查錯誤的方法.  
</p>
<h3>
<span id=".E8.A8.BA.E6.96.B7.E9.96.8B.E6.A9.9F.E5.95.8F.E9.A1.8C"></span><span class="mw-headline" id="診斷開機問題">診斷開機問題</span>
</h3>
<p>使用如下內核參數開機：
<code>systemd.log_level=debug systemd.log_target=kmsg log_buf_len=1M</code>
</p>
<p>更多有關偵錯的資訊，參見<a rel="nofollow" class="external autonumber" href="https://freedesktop.org/wiki/Software/systemd/Debugging">[2]</a>。
</p>
<h3>
<span id=".E8.A8.BA.E6.96.B7.E4.B8.80.E4.B8.AA.E7.89.B9.E5.AE.9A.E6.9C.8D.E5.8B.99"></span><span class="mw-headline" id="診斷一个特定服務">診斷一个特定服務</span>
</h3>
<p>如果某个 <i>systemd</i> 服務的工作狀況不合你的預期，因此你希望偵錯的话,設定 <code>SYSTEMD_LOG_LEVEL</code> <a href="../en/Environment_variables.html" class="mw-redirect" title="Environment variable">環境變數</a> 为 <code>debug</code> . 例如以偵錯模式執行 <i>systemd-networkd</i> 服務:
</p>
<pre># systemctl stop systemd-networkd
# SYSTEMD_LOG_LEVEL=debug /lib/systemd/systemd-networkd
</pre>
<p>或者等價的,臨時編輯系統單元檔,例如:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/lib/systemd/system/systemd-networkd.service</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Service]
...
Environment=SYSTEMD_LOG_LEVEL=debug
....</pre>
<p>如果經常需要偵錯資訊,以<a href="#%E4%BF%AE%E6%94%B9%E7%8F%BE%E6%9C%89%E5%96%AE%E5%85%83%E6%AA%94">一般方法</a>增加環境變數.
</p>
<h3>
<span id=".E9.97.9C.E6.A9.9F.2F.E9.87.8D.E5.95.9F.E5.8D.81.E5.88.86.E7.B7.A9.E6.85.A2"></span><span class="mw-headline" id="關機/重啟十分緩慢">關機/重啟十分緩慢</span>
</h3>
<p>如果關機特别慢（甚至跟當機了一样），很可能是某个拒不退出的服務在作怪。systemd 會等待一段時間，然後再嘗試殺死它。請閱讀<a rel="nofollow" class="external text" href="https://freedesktop.org/wiki/Software/systemd/Debugging#Shutdown_Completes_Eventually">這篇文章</a>，確認你是否是該問題的受害者。
</p>
<h3>
<span id=".E7.9F.AD.E6.99.82.E8.99.95.E7.90.86.E7.A8.8B.E5.BA.8F.E7.84.A1.E6.97.A5.E8.AA.8C.E8.A8.98.E9.8C.84"></span><span class="mw-headline" id="短時處理程序無日誌記錄">短時處理程序無日誌記錄</span>
</h3>
<p>若 <code>journalctl -u foounit.service</code> 沒有顯示某个短時處理程序的任何輸出，那麼改用 PID 試試。例如，若 <code>systemd-modules-load.service</code> 执行失敗，那麼先用 <code>systemctl status systemd-modules-load</code> 查詢其 PID（比如是123），然後檢索該 PID 相關的日誌 <code>journalctl -b _PID=123</code>。執行時處理程序的日誌元資料（諸如 _SYSTEMD_UNIT 和 _COMM）被亂序收集在 <code>/proc</code> 目錄。要修复該問題，必須修改內核，使其通過Socket連線來提供上述資料，該過程類似於 SCM_CREDENTIALS。
</p>
<h3>
<span id=".E7.A6.81.E6.AD.A2.E5.9C.A8.E7.A8.8B.E5.BA.8F.E5.B4.A9.E6.BA.83.E6.97.B6.E8.BD.AC.E5.82.A8.E5.86.85.E5.AD.98"></span><span class="mw-headline" id="禁止在程序崩溃时转储内存">禁止在程序崩溃时转储内存</span>
</h3>
<p>要使用老的內核轉儲，創建下面檔案:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/sysctl.d/49-coredump.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">kernel.core_pattern = core
kernel.core_uses_pid = 0</pre>
<p>然後執行：
</p>
<pre># /usr/lib/systemd/systemd-sysctl
</pre>
<p>同樣可能需要執行“unlimit”設定檔案大小：
</p>
<pre>$ ulimit -c unlimited
</pre>
<p>更多資訊請參閱 <a rel="nofollow" class="external text" href="https://www.freedesktop.org/software/systemd/man/sysctl.d.html">sysctl.d</a> 和 <a rel="nofollow" class="external text" href="https://www.kernel.org/doc/Documentation/sysctl/kernel.txt">/proc/sys/kernel </a>。
</p>
<h3>
<span id=".E5.95.9F.E5.8B.95.E6.99.82.E9.96.93.E5.A4.AA.E9.95.B7"></span><span class="mw-headline" id="啟動時間太長">啟動時間太長</span>
</h3>
<p>不少用戶使用 <code>systemd-analyze</code> 命令以後報告啟動的時間比預計的要長,通常會說 <code>systemd-analyze</code> 分析結果表示 <a href="../en/NetworkManager.html" title="NetworkManager">NetworkManager</a> 佔用了太多的啟動時間.
</p>
<p>有些用戶的問題是 <code>/var/log/journal</code> 資料夾似乎過大.這也許也會對像<code>systemctl status</code> 或 <code>journalctl</code> 的命令有影响.一种解決方案是删除其中的檔案 (但最好將他們備份到某处) 然後限制日誌檔案的大小.請參考<a href="../en/Systemd/Journal.html" class="mw-redirect" title="Journald">journald</a>.
</p>
<h3>
<span id="systemd-tmpfiles-setup.service_.E5.9C.A8.E5.95.9F.E5.8B.95.E6.99.82.E5.95.9F.E5.8B.95.E5.A4.B1.E6.95.97"></span><span class="mw-headline" id="systemd-tmpfiles-setup.service_在啟動時啟動失敗">systemd-tmpfiles-setup.service 在啟動時啟動失敗</span>
</h3>
<p>從 systemd 219 開始, <code>/usr/lib/tmpfiles.d/systemd.conf</code> 指定 <code>/var/log/journal</code> 的 ACL 屬性和目錄, 因此日誌所在的檔案系統上要啟用ACL.
</p>
<p>參考 <a href="../en/Access_Control_Lists.html#Enable_ACL" title="Access Control Lists">Access Control Lists#Enable ACL</a> 获得如何包含 <code>/var/log/journal</code> 啟動 ACL 的詳細資訊.
</p>
<h3>
<span id=".E4.B8.8D.E8.83.BD.E8.A8.AD.E5.AE.9A.E5.9C.A8.E9.96.8B.E6.A9.9F.E6.99.82.E5.90.AF.E5.8A.A8.E8.BB.9F.E9.80.A3.E7.B5.90.E5.88.B0_.2Fetc.2Fsystemd.2Fsystem_.E7.9A.84.E6.9C.8D.E5.8B.99"></span><span class="mw-headline" id="不能設定在開機時启动軟連結到_/etc/systemd/system_的服務">不能設定在開機時启动軟連結到 /etc/systemd/system 的服務</span>
</h3>
<p>如果 <code>/etc/systemd/system/<i>foo</i>.service</code> 是个符號連結， 執行 <code>systemctl enable <i>foo</i>.service</code> 時可能遇到這樣的錯誤:
</p>
<pre>Failed to issue method call: No such file or directory
</pre>
<p>這是 systemd 的 <a rel="nofollow" class="external text" href="https://bugzilla.redhat.com/show_bug.cgi?id=955379#c14">設計選擇</a> ,可以通過輸入絕對路徑來規避這個錯誤:
</p>
<pre># systemctl enable <i>/absolute/path/foo</i>.service
</pre>
<h2>
<span id=".E7.9B.B8.E9.97.9C.E8.B3.87.E6.BA.90"></span><span class="mw-headline" id="相關資源">相關資源</span>
</h2>
<ul>
<li>
<a rel="nofollow" class="external autonumber" href="http://www.freedesktop.org/wiki/Software/systemd%E5%AE%98%E6%96%B9%E7%B6%B2%E7%AB%99">[3]</a><sup title="Last check status: 404">[<a href="https://en.wikipedia.org/wiki/Wikipedia:Link_rot" class="extiw" title="wikipedia:Wikipedia:Link rot">dead link</a> 2020-08-06 ⓘ]</sup>
</li>
<li><a href="https://en.wikipedia.org/wiki/zh:systemd" class="extiw" title="wikipedia:zh:systemd">維基百科對systemd的介紹</a></li>
<li><a rel="nofollow" class="external text" href="https://freedesktop.org/wiki/Software/systemd/Optimizations">systemd優化</a></li>
<li><a rel="nofollow" class="external text" href="https://www.freedesktop.org/wiki/Software/systemd/FrequentlyAskedQuestions">常見問題FAQ</a></li>
<li><a rel="nofollow" class="external autonumber" href="http://www.freedesktop.org/wiki/Software/systemd/TipsAndTricks%E5%B0%8F%E6%8A%80%E5%B7%A7">[4]</a></li>
<li><a rel="nofollow" class="external text" href="http://0pointer.de/public/systemd-ebook-psankar.pdf">systemd for Administrators (PDF)</a></li>
<li><a rel="nofollow" class="external text" href="http://fedoraproject.org/wiki/Systemd">Fedora對systemd的介紹</a></li>
</ul>
</div>
</div>
<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../zh-TW/Category:Init.html" title="Category:Init (正體中文)">Init (正體中文)</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden categories: <ul>
<li><a href="../zh-TW/Category:Pages_or_sections_flagged_with_Template:Translateme.html" title="Category:Pages or sections flagged with Template:Translateme (正體中文)">Pages or sections flagged with Template:Translateme (正體中文)</a></li>
<li><a href="../en/Category:Pages_with_broken_section_links.html" title="Category:Pages with broken section links">Pages with broken section links</a></li>
<li><a href="../en/Category:Pages_with_dead_links.html" title="Category:Pages with dead links">Pages with dead links</a></li>
</ul>
</div>
</div>
	</div>
</div>

<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
		<li>Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Systemd_(%E6%AD%A3%E9%AB%94%E4%B8%AD%E6%96%87)&amp;oldid=637001">https://wiki.archlinux.org/index.php?title=Systemd_(正體中文)&amp;oldid=637001</a>"</li>
		<li id="footer-info-lastmod"> This page was last edited on 2 October 2020, at 12:36.</li>
		<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="http://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
	<br>
</ul>
	<ul id="footer-places">
		<li id="footer-places-privacy"><a href="../en/ArchWiki:Privacy_policy.html" title="ArchWiki:Privacy policy">Privacy policy</a></li>
		<li id="footer-places-about"><a href="../en/ArchWiki:About.html" title="ArchWiki:About">About ArchWiki</a></li>
		<li id="footer-places-disclaimer"><a href="../en/ArchWiki:General_disclaimer.html" title="ArchWiki:General disclaimer">Disclaimers</a></li>
	</ul>
	<ul id="footer-icons" class="noprint">
		<li id="footer-copyrightico">
	</ul>
	<div style="clear: both;"></div>
</footer>



</body>
</html>
