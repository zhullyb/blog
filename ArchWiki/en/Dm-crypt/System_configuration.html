<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>dm-crypt/System configuration - ArchWiki</title>
<link rel="stylesheet" href="../../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.35.0">
<meta name="robots" content="noindex,follow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="http://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Dm-crypt_System_configuration rootpage-Dm-crypt skin-vector action-view skin-vector-legacy">
<div id="content" class="mw-body" role="main" style="margin: 0">
	<a id="top"></a>
	<div id="siteNotice" class="mw-body-content"></div>
	<div class="mw-indicators mw-body-content">
	</div>
	<h1 id="firstHeading" class="firstHeading" lang="en">dm-crypt/System configuration</h1>
	<div id="bodyContent" class="mw-body-content">
		<div id="siteSub" class="noprint">From ArchWiki</div>
		<div id="contentSub"><span class="subpages">&lt; <a href="../../en/Dm-crypt.html" title="Dm-crypt">Dm-crypt</a></span></div>
		<div id="contentSub2"></div>
		
		<div id="jump-to-nav"></div>
		<a class="mw-jump-link" href="#mw-head">Jump to navigation</a>
		<a class="mw-jump-link" href="#searchInput">Jump to search</a>
		<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr">
<div class="warningbox">The printable version is no longer supported and may have rendering errors. Please update your browser bookmarks and please use the default browser print function instead.</div>
<div class="mw-parser-output">
<p><span></span>
</p>
<div class="noprint archwiki-template-message">
<p><a href="../../File:Tango-view-fullscreen.png" class="image"><img alt="Tango-view-fullscreen.png" src="../../File:Tango-view-fullscreen.png" decoding="async" width="48" height="48"></a><b>This article or section needs expansion.</b><a href="../../File:Tango-view-fullscreen.png" class="image"><img alt="Tango-view-fullscreen.png" src="../../File:Tango-view-fullscreen.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>Reason:</b> Aggregate here all the generic information on system configuration from the other sub-articles of <a href="../../en/Dm-crypt.html" title="Dm-crypt">dm-crypt</a>. (Discuss in <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php/Talk:Dm-crypt/System_configuration">Talk:Dm-crypt/System configuration#</a>)</div>
</div>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> 
<ul>
<li>If in need to remotely unlock root or other early-boot filesystems (headless machine, distant servers...), follow  the specific instructions from <a href="../../en/Dm-crypt/Specialties.html#Remote_unlocking_of_the_root_(or_other)_partition" title="Dm-crypt/Specialties">dm-crypt/Specialties#Remote unlocking of the root (or other) partition</a>.</li>
<li>To ease inputting UUIDs, PARTUUIDs, etc. in configuration files, you can install and use a <a href="../../en/List_of_applications.html#Text_editors" class="mw-redirect" title="Text editor">text editor</a> that supports inserting command output (e.g. <a href="../../en/Nano.html" title="Nano">nano</a> with <code>Ctrl+t</code>, <a href="../../en/Vim.html" title="Vim">Vim</a> or <a href="../../en/Neovim.html" title="Neovim">Neovim</a> with <code>:read</code> or <a href="../../en/Midnight_Commander.html#Modules" class="mw-redirect" title="Mcedit">mcedit</a> with <code>Alt+u</code>) and pass it <a href="../../en/Persistent_block_device_naming.html#Persistent_naming_methods" title="Persistent block device naming">the apropriate lsblk or blkid command</a>. Alternatively, you can install a <a href="../../en/List_of_applications/Utilities.html#Terminal_multiplexers" title="List of applications/Utilities">terminal multiplexer</a> and use its copy and paste functionality.</li>
</ul>
</div>
<div id="toc" class="toc" role="navigation" aria-labelledby="mw-toc-heading">
<input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none"><div class="toctitle" lang="en" dir="ltr">
<h2 id="mw-toc-heading">Contents</h2>
<span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span>
</div>
<ul>
<li class="toclevel-1 tocsection-1">
<a href="#mkinitcpio"><span class="tocnumber">1</span> <span class="toctext">mkinitcpio</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="#Examples"><span class="tocnumber">1.1</span> <span class="toctext">Examples</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-3">
<a href="#Boot_loader"><span class="tocnumber">2</span> <span class="toctext">Boot loader</span></a>
<ul>
<li class="toclevel-2 tocsection-4">
<a href="#Kernel_parameters"><span class="tocnumber">2.1</span> <span class="toctext">Kernel parameters</span></a>
<ul>
<li class="toclevel-3 tocsection-5"><a href="#root"><span class="tocnumber">2.1.1</span> <span class="toctext">root</span></a></li>
<li class="toclevel-3 tocsection-6"><a href="#resume"><span class="tocnumber">2.1.2</span> <span class="toctext">resume</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-7">
<a href="#Using_encrypt_hook"><span class="tocnumber">2.2</span> <span class="toctext">Using encrypt hook</span></a>
<ul>
<li class="toclevel-3 tocsection-8"><a href="#cryptdevice"><span class="tocnumber">2.2.1</span> <span class="toctext">cryptdevice</span></a></li>
<li class="toclevel-3 tocsection-9"><a href="#cryptkey"><span class="tocnumber">2.2.2</span> <span class="toctext">cryptkey</span></a></li>
<li class="toclevel-3 tocsection-10"><a href="#crypto"><span class="tocnumber">2.2.3</span> <span class="toctext">crypto</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-11">
<a href="#Using_sd-encrypt_hook"><span class="tocnumber">2.3</span> <span class="toctext">Using sd-encrypt hook</span></a>
<ul>
<li class="toclevel-3 tocsection-12"><a href="#rd.luks.uuid"><span class="tocnumber">2.3.1</span> <span class="toctext">rd.luks.uuid</span></a></li>
<li class="toclevel-3 tocsection-13"><a href="#rd.luks.name"><span class="tocnumber">2.3.2</span> <span class="toctext">rd.luks.name</span></a></li>
<li class="toclevel-3 tocsection-14"><a href="#rd.luks.options"><span class="tocnumber">2.3.3</span> <span class="toctext">rd.luks.options</span></a></li>
<li class="toclevel-3 tocsection-15"><a href="#rd.luks.key"><span class="tocnumber">2.3.4</span> <span class="toctext">rd.luks.key</span></a></li>
<li class="toclevel-3 tocsection-16"><a href="#Timeout"><span class="tocnumber">2.3.5</span> <span class="toctext">Timeout</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-17">
<a href="#crypttab"><span class="tocnumber">3</span> <span class="toctext">crypttab</span></a>
<ul>
<li class="toclevel-2 tocsection-18">
<a href="#Mounting_at_boot_time"><span class="tocnumber">3.1</span> <span class="toctext">Mounting at boot time</span></a>
<ul>
<li class="toclevel-3 tocsection-19"><a href="#Unlocking_with_a_keyfile"><span class="tocnumber">3.1.1</span> <span class="toctext">Unlocking with a keyfile</span></a></li>
<li class="toclevel-3 tocsection-20"><a href="#Mounting_a_stacked_blockdevice"><span class="tocnumber">3.1.2</span> <span class="toctext">Mounting a stacked blockdevice</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-21"><a href="#Mounting_on_demand"><span class="tocnumber">3.2</span> <span class="toctext">Mounting on demand</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-22">
<a href="#Troubleshooting"><span class="tocnumber">4</span> <span class="toctext">Troubleshooting</span></a>
<ul>
<li class="toclevel-2 tocsection-23"><a href="#System_stuck_on_boot/password_prompt_does_not_show"><span class="tocnumber">4.1</span> <span class="toctext">System stuck on boot/password prompt does not show</span></a></li>
</ul>
</li>
</ul>
</div>

<h2><span class="mw-headline" id="mkinitcpio">mkinitcpio</span></h2>
<p>Depending on the particular scenarios, a subset of the following <a href="../../en/Mkinitcpio.html" title="Mkinitcpio">mkinitcpio</a> hooks will have to be enabled:
</p>
<table class="wikitable">
<tbody>
<tr>
<th>busybox</th>
<th>systemd</th>
<th>Use case
</th>
</tr>
<tr>
<td style="text-align: center;white-space:nowrap;">
<code>encrypt</code>
</td>
<td style="text-align: center;white-space:nowrap;">
<code>sd-encrypt</code>
</td>
<td>Always needed when encrypting the root partition, or a partition that needs to be mounted <i>before</i> root. It is not needed in all the other cases, as system initialization scripts like <code>/etc/crypttab</code> take care of unlocking other encrypted partitions. This hook must be placed <i>after</i> the <code>udev</code> or <code>systemd</code> hook.
</td>
</tr>
<tr>
<td colspan="2" style="text-align: center;white-space:nowrap;">
<code>keyboard</code>
</td>
<td>Needed to make keyboards work in early userspace.
</td>
</tr>
<tr>
<td style="text-align: center;white-space:nowrap;">
<code>keymap</code>
</td>
<td rowspan="2" style="text-align: center;white-space:nowrap;">
<code>sd-vconsole</code>
</td>
<td>Provides support for non-US keymaps for typing encryption passwords; it must come <i>before</i> the <code>encrypt</code> hook. Set your keymap in <code>/etc/vconsole.conf</code>, see <a href="../../en/Linux_console/Keyboard_configuration.html#Persistent_configuration" class="mw-redirect" title="Keyboard configuration in console">Keyboard configuration in console#Persistent configuration</a>.
</td>
</tr>
<tr>
<td style="text-align: center;white-space:nowrap;">
<code>consolefont</code>
</td>
<td>Loads an alternative console font in early userspace. Set your font in <code>/etc/vconsole.conf</code>, see <a href="../../en/Linux_console.html#Persistent_configuration" title="Linux console">Linux console#Persistent configuration</a>.
</td>
</tr>
</tbody>
</table>
<p><a href="../../en/Mkinitcpio.html#Common_hooks" title="Mkinitcpio">Other hooks</a> needed should be clear from other manual steps followed during the installation of the system.
</p>
<p>Remember to <a href="../../en/Mkinitcpio.html#Image_creation_and_activation" class="mw-redirect" title="Regenerate the initramfs">regenerate the initramfs</a> after saving the changes.
</p>
<h3><span class="mw-headline" id="Examples">Examples</span></h3>
<p>A typical <code>/etc/mkinitcpio.conf</code> configuration using <code>encrypt</code> hook:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/mkinitcpio.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">...
HOOKS=(base udev autodetect keyboard keymap consolefont modconf block encrypt lvm2 filesystems fsck)
...</pre>
<p>A configuration with systemd-based initramfs using <code>sd-encrypt</code> hook:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/mkinitcpio.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">...
HOOKS=(base systemd autodetect keyboard sd-vconsole modconf block sd-encrypt sd-lvm2 filesystems fsck)
...</pre>
<h2><span class="mw-headline" id="Boot_loader">Boot loader</span></h2>
<p>In order to enable booting an encrypted root partition, a subset of the following kernel parameters need to be set. See <a href="../../en/Kernel_parameters.html" title="Kernel parameters">kernel parameters</a> for instructions specific to your <a href="../../en/Arch_boot_process.html#Boot_loader" class="mw-redirect" title="Boot loader">boot loader</a>. 
</p>
<p>For example, if using <a href="../../en/GRUB.html" title="GRUB">GRUB</a>, the relevant parameters are added to <code>/etc/default/grub</code> before <a href="../../en/GRUB.html#Generate_the_main_configuration_file" title="GRUB">generating the main configuration file</a>. See also <a href="../../en/GRUB.html#Warning_when_installing_in_chroot" title="GRUB">GRUB#Warning when installing in chroot</a> as another point to be aware of when installing the GRUB loader.
</p>
<p>The kernel parameters you need to specify depend on whether or not you are using the <code>encrypt</code> hook or the <code>sd-encrypt</code> hook.
</p>
<h3><span class="mw-headline" id="Kernel_parameters">Kernel parameters</span></h3>
<p><a href="../../en/Kernel_parameters.html" title="Kernel parameters">Kernel parameters</a> like <code>root</code> and <code>resume</code> are specified the same way for both <code>encrypt</code> and <code>sd-encrypt</code> hooks.
</p>
<h4><span class="mw-headline" id="root">root</span></h4>
<p>The <code>root=</code> parameter specifies the <code><i>device</i></code> of the actual (decrypted) root file system:
</p>
<pre>root=<i>device</i>
</pre>
<ul>
<li>If the file system is formatted directly on the decrypted device file this will be <code>/dev/mapper/<i>dmname</i></code>.</li>
<li>If a LVM gets activated first and contains an <a href="../../en/Dm-crypt/Encrypting_an_entire_system.html#LUKS_on_LVM" title="Dm-crypt/Encrypting an entire system">encrypted logical rootvolume</a>, the above form applies as well.</li>
<li>If the root file system is contained in a logical volume of a fully <a href="../../en/Dm-crypt/Encrypting_an_entire_system.html#LVM_on_LUKS" class="mw-redirect" title="Encrypted LVM">encrypted LVM</a>, the device mapper for it will be in the general form of <code>root=/dev/<i>volumegroup</i>/<i>logicalvolume</i></code>.</li>
</ul>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> When using <a href="../../en/GRUB.html" title="GRUB">GRUB</a> and generating <code>grub.cfg</code> with <i>grub-mkconfig</i>, this parameter does not need to be specified manually. <i>grub-mkconfig</i> will determine the correct UUID of the decrypted root filesystem and add it to <code>grub.cfg</code> automatically.</div>
<h4><span class="mw-headline" id="resume">resume</span></h4>
<pre>resume=<i>device</i>
</pre>
<ul><li>
<code><i>device</i></code> is the device file of the decrypted (swap) filesystem used for <a href="../../en/Power_management/Suspend_and_hibernate.html#Hibernation" title="Power management/Suspend and hibernate">suspend to disk</a>. If swap is on a separate partition, it will be in the form of <code>/dev/mapper/swap</code>. See also <a href="../../en/Dm-crypt/Swap_encryption.html" title="Dm-crypt/Swap encryption">dm-crypt/Swap encryption</a>.</li></ul>
<h3><span class="mw-headline" id="Using_encrypt_hook">Using encrypt hook</span></h3>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Compared to the <a href="../../en/Dm-crypt/System_configuration.html#Using_sd-encrypt_hook" class="mw-redirect" title="Sd-encrypt">sd-encrypt</a> hook, the <code>encrypt</code> hook does not support:
<ul>
<li>Unlocking <a href="../../en/Dm-crypt/Specialties.html#The_encrypt_hook_and_multiple_disks" title="Dm-crypt/Specialties">multiple encrypted disks</a> (<a rel="nofollow" class="external text" href="https://bugs.archlinux.org/task/23182">FS#23182</a>). Only <b>one</b> device can be unlocked in the initramfs.</li>
<li>Using a <a href="../../en/Dm-crypt/Specialties.html#Encrypted_system_using_a_detached_LUKS_header" title="Dm-crypt/Specialties">detached LUKS header</a> (<a rel="nofollow" class="external text" href="https://bugs.archlinux.org/task/42851">FS#42851</a>).</li>
</ul>
</div>
<h4><span class="mw-headline" id="cryptdevice">cryptdevice</span></h4>
<p>This parameter will make the system prompt for the passphrase to unlock the device containing the encrypted root on a cold boot. It is parsed by the <code>encrypt</code> hook to identify which device contains the encrypted system:
</p>
<pre>cryptdevice=<i>device</i>:<i>dmname</i>
</pre>
<ul>
<li>
<code><i>device</i></code> is the path to the device backing the encrypted device. Usage of <a href="../../en/Persistent_block_device_naming.html" title="Persistent block device naming">persistent block device naming</a> is strongly recommended.</li>
<li>
<code><i>dmname</i></code> is the <b>d</b>evice-<b>m</b>apper name given to the device after decryption, which will be available as <code>/dev/mapper/<i>dmname</i></code>.</li>
<li>If a LVM contains the <a href="../../en/Dm-crypt/Encrypting_an_entire_system.html#LUKS_on_LVM" title="Dm-crypt/Encrypting an entire system">encrypted root</a>, the LVM gets activated first and the volume group containing the logical volume of the encrypted root serves as <i>device</i>. It is then followed by the respective volume group to be mapped to root. The parameter follows the form of <code>cryptdevice=<i>/dev/vgname/lvname</i>:<i>dmname</i></code>.</li>
</ul>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> One may want to <a href="../../en/Dm-crypt/Specialties.html#Discard/TRIM_support_for_solid_state_drives_(SSD)" title="Dm-crypt/Specialties">enable Discard/TRIM support</a> for solid state drives (SSD).</div>
<h4><span class="mw-headline" id="cryptkey">cryptkey</span></h4>
<p>This parameter specifies the location of a keyfile and is required by the <code><i>encrypt</i></code> hook for reading such a keyfile to unlock the <code><i>cryptdevice</i></code> (unless a key is in the default location, see below). It can have three parameter sets, depending on whether the keyfile exists as a file in a particular device, a bitstream starting on a specific location, or a file in the initramfs. 
</p>
<p>For a file in a device the format is:
</p>
<pre>cryptkey=<i>device</i>:<i>fstype</i>:<i>path</i>
</pre>
<ul>
<li>
<code><i>device</i></code> is the raw block device where the key exists. Usage of <a href="../../en/Persistent_block_device_naming.html" title="Persistent block device naming">persistent block device naming</a> is strongly recommended.</li>
<li>
<code><i>fstype</i></code> is the filesystem type of <code><i>device</i></code> (or auto).</li>
<li>
<code><i>path</i></code> is the absolute path of the keyfile within the device.</li>
</ul>
<p>Example: <code>cryptkey=LABEL=usbstick:vfat:/secretkey</code>
</p>
<p>For a bitstream on a device the key's location is specified with the following: 
</p>
<pre>cryptkey=<i>device</i>:<i>offset</i>:<i>size</i> 
</pre>
<p>where the offset and size are in bytes. For example, <code>cryptkey=UUID=<i>ZZZZZZZZ-ZZZZ-ZZZZ-ZZZZ-ZZZZZZZZZZZZ</i>:0:512</code> reads a 512 byte keyfile starting at the beginning of the device. 
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> If the device path you want to access contains the character <code>:</code>, you have to escape it with a backslash <code>\</code>. In that case the cryptkey parameter would be as follow: <code>cryptkey=/dev/disk/by-id/usb-123456-0\:0:0:512</code> for a usb key with the id <code>usb-123456-0:0</code>.</div>
<p>For a file <a href="../../en/Mkinitcpio.html#BINARIES_and_FILES" title="Mkinitcpio">included</a> in the initramfs the format is<a rel="nofollow" class="external autonumber" href="https://github.com/archlinux/svntogit-packages/blob/packages/cryptsetup/trunk/hooks-encrypt#L14">[1]</a>:
</p>
<pre>cryptkey=rootfs:<i>path</i>
</pre>
<p>Example: <code>cryptkey=rootfs:/secretkey</code>
</p>
<p>Also note that if <code>cryptkey</code> is not specified, it defaults to <code>/crypto_keyfile.bin</code> (in the initramfs).<a rel="nofollow" class="external autonumber" href="https://github.com/archlinux/svntogit-packages/blob/packages/cryptsetup/trunk/hooks-encrypt#L8">[2]</a>
</p>
<p>See also <a href="../../en/Dm-crypt/Device_encryption.html#Keyfiles" title="Dm-crypt/Device encryption">dm-crypt/Device encryption#Keyfiles</a>.
</p>
<h4><span class="mw-headline" id="crypto">crypto</span></h4>
<p>This parameter is specific to pass <i>dm-crypt</i> plain mode options to the <i>encrypt</i> hook. 
</p>
<p>It takes the form
</p>
<pre>crypto=&lt;hash&gt;:&lt;cipher&gt;:&lt;keysize&gt;:&lt;offset&gt;:&lt;skip&gt;
</pre>
<p>The arguments relate directly to the <i>cryptsetup</i> options. See <a href="../../en/Dm-crypt/Device_encryption.html#Encryption_options_for_plain_mode" title="Dm-crypt/Device encryption">dm-crypt/Device encryption#Encryption options for plain mode</a>.
</p>
<p>For a disk encrypted with just <i>plain</i> default options, the <code>crypto</code> arguments must be specified, but each entry can be left blank: 
</p>
<pre>crypto=::::
</pre>
<p>A specific example of arguments is  
</p>
<pre>crypto=sha512:twofish-xts-plain64:512:0:
</pre>
<h3><span class="mw-headline" id="Using_sd-encrypt_hook">Using sd-encrypt hook</span></h3>
<p>In all of the following a <code>rd.luks</code> can be replaced with a <code>luks</code>. The <code>rd.luks</code> parameters are only honored by the initrd, while the <code>luks</code> parameters are honored by both the main system and initrd. Unless you want to control devices which get unlocked after boot from kernel command line, use <code>rd.luks</code>. See <span class="plainlinks archwiki-template-man" title="$ man 8 systemd-cryptsetup-generator"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd-cryptsetup-generator.8">systemd-cryptsetup-generator(8)</a></span> for more options and more details.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> 
<ul>
<li>If the file <code>/etc/crypttab.initramfs</code> exists, <a href="../../en/Mkinitcpio.html" title="Mkinitcpio">mkinitcpio</a> will add it to the initramfs as <code>/etc/crypttab</code>, you can specify devices that need to be unlocked at boot there. Syntax is documented in <a href="#crypttab">#crypttab</a> and <span class="plainlinks archwiki-template-man" title="$ man 5 crypttab"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/crypttab.5">crypttab(5)</a></span>.</li>
<li>
<code>/etc/crypttab.initramfs</code> is not limited to using only UUID like <code>rd.luks</code>. You can use any of the <a href="../../en/Persistent_block_device_naming.html#Persistent_naming_methods" title="Persistent block device naming">persistent block device naming methods</a>.</li>
<li>Passwords entered during boot are cached in the kernel keyring by <span class="plainlinks archwiki-template-man" title="$ man 8 systemd-cryptsetup"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd-cryptsetup.8">systemd-cryptsetup(8)</a></span>, so if multiple devices can be unlocked with the same password (this includes devices in <a href="#crypttab">crypttab</a> that are unlocked after boot), then you will only need to input each password once.</li>
</ul>
</div>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 
<ul>
<li>All of the <code>rd.luks</code> parameters can be specified multiple times to unlock multiple LUKS encrypted volumes.</li>
<li>The <code>rd.luks</code> parameters only support unlocking detectable LUKS devices. To unlock a plain dm-crypt device or a LUKS device with a detached header, you must specify it in <code>/etc/crypttab.initramfs</code>. See <a href="#crypttab">#crypttab</a> for the syntax.</li>
</ul>
</div>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> If you are using <code>/etc/crypttab</code> or <code>/etc/crypttab.initramfs</code> together with <code>luks.*</code> or <code>rd.luks.*</code> parameters, only those devices specified on the kernel command line will be activated and you will see <code>Not creating device 'devicename' because it was not specified on the kernel command line.</code>. To activate all devices in <code>/etc/crypttab</code> do not specify any <code>luks.*</code> parameters and use <code>rd.luks.*</code>. To activate all devices in <code>/etc/crypttab.initramfs</code> do not specify any <code>luks.*</code> or <code>rd.luks.*</code> parameters.</div>
<h4><span class="mw-headline" id="rd.luks.uuid">rd.luks.uuid</span></h4>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> <code>rd.luks.uuid</code> can be omitted when using <code>rd.luks.name</code>.</div>
<pre>rd.luks.uuid=<i>XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX</i>
</pre>
<p>Specify the <a href="../../en/Persistent_block_device_naming.html#by-uuid" class="mw-redirect" title="UUID">UUID</a> of the device to be decrypted on boot with this flag. If the UUID is in <code>/etc/crypttab.initramfs</code>, the options listed there will be used. For <code>luks.uuid</code> options from <code>/etc/crypttab.initramfs</code> or <code>/etc/crypttab</code> will be used.
</p>
<p>By default the mapped device will be located at <code>/dev/mapper/luks-<i>XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX</i></code> where <i>XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX</i> is the UUID of the LUKS partition.
</p>
<h4><span class="mw-headline" id="rd.luks.name">rd.luks.name</span></h4>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> When using this parameter you can omit <code>rd.luks.uuid</code>.</div>
<pre>rd.luks.name=<i>XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX</i>=<i>name</i>
</pre>
<p>Specify the name of the mapped device after the LUKS partition is open, where <i>XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX</i> is the UUID of the LUKS partition. This is equivalent to the second parameter of <code>encrypt</code>'s <code>cryptdevice</code>.
</p>
<p>For example, specifying <code>rd.luks.name=12345678-9ABC-DEF0-1234-56789ABCDEF0=cryptroot</code> causes the unlocked LUKS device with UUID <code>12345678-9ABC-DEF0-1234-56789ABCDEF0</code> to be located at <code>/dev/mapper/cryptroot</code>.
</p>
<h4><span class="mw-headline" id="rd.luks.options">rd.luks.options</span></h4>
<pre>rd.luks.options=<i>XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX</i>=<i>options</i>
</pre>
<p>or
</p>
<pre>rd.luks.options=<i>options</i>
</pre>
<p>Set options for the device specified by it UUID or, if not specified, for all UUIDs not specified elsewhere (e.g., crypttab).
</p>
<p>This is roughly equivalent to the third parameter of <code>encrypt</code>'s <code>cryptdevice</code>.
</p>
<p>Follows a similar format to options in crypttab - options are separated by commas, options with values are specified using <code><i>option</i>=<i>value</i></code>.
</p>
<p>For example:
</p>
<pre>rd.luks.options=timeout=10s,swap,cipher=aes-cbc-essiv:sha256,size=256
</pre>
<h4><span class="mw-headline" id="rd.luks.key">rd.luks.key</span></h4>
<p>Specify the location of a password file used to decrypt the device specified by its UUID. There is no default location like there is with the <code>encrypt</code> hook parameter <code>cryptkey</code>.
</p>
<p>If the keyfile is <a href="../../en/Mkinitcpio.html#BINARIES_and_FILES" title="Mkinitcpio">included in the initramfs</a>:
</p>
<pre>rd.luks.key=<i>XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX</i>=<i>/path/to/keyfile</i>
</pre>
<p>or
</p>
<pre>rd.luks.key=<i>/path/to/keyfile</i>
</pre>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> The whole <code>rd.luks.key</code> parameter can be omitted if the keyfile is included as <code>/etc/cryptsetup-keys.d/<i>name</i>.key</code>.</div>
<p>If the keyfile is on another device:
</p>
<pre>rd.luks.key=<i>XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX</i>=<i>/path/to/keyfile</i>:UUID=<i>ZZZZZZZZ-ZZZZ-ZZZZ-ZZZZ-ZZZZZZZZZZZZ</i>
</pre>
<p>Replace <code>UUID=<i>ZZZZZZZZ-ZZZZ-ZZZZ-ZZZZ-ZZZZZZZZZZZZ</i></code> with the identifier of the device on which the keyfile is located. If the type of file system is different than your root file system, you must <a href="../../en/Mkinitcpio.html#MODULES" title="Mkinitcpio">include the kernel module for it in the initramfs</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> <code>rd.luks.key</code> with a keyfile on another device by default does not fallback to asking for a password if the device is not available. To fallback to a password prompt, specify the <code>keyfile-timeout=</code> option in <code>rd.luks.options</code>. E.g. for a 10 second timeout:
<pre>rd.luks.options=<i>XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX</i>=keyfile-timeout=10s</pre>
</div>
<h4><span class="mw-headline" id="Timeout">Timeout</span></h4>
<p>There are two options that affect the timeout for entering the password during boot:
</p>
<ul>
<li>
<code>rd.luks.options=timeout=<i>mytimeout</i></code> specifies the timeout for querying for a password</li>
<li>
<code>rootflags=x-systemd.device-timeout=<i>mytimeout</i></code> specifies how long systemd should wait for the rootfs device to show up before giving up (defaults to 90 seconds)</li>
</ul>
<p>If you want to disable the timeout altogether, then set both timeouts to zero:
</p>
<pre>rd.luks.options=timeout=0 rootflags=x-systemd.device-timeout=0
</pre>
<h2><span class="mw-headline" id="crypttab">crypttab</span></h2>
<p>The <code>/etc/crypttab</code> (encrypted device table) file is similar to the <a href="../../en/Fstab.html" title="Fstab">fstab</a> file and contains a list of encrypted devices to be unlocked during system boot up. This file can be used for automatically mounting encrypted swap devices or secondary file systems.
</p>
<p><code>crypttab</code> is read <i>before</i> <code>fstab</code>, so that dm-crypt containers can be unlocked before the file system inside is mounted. Note that <code>crypttab</code> is read <i>after</i> the system has booted up, therefore it is not a replacement for unlocking encrypted partitions by using <a href="#mkinitcpio">mkinitcpio</a> hooks and <a href="#Boot_loader">boot loader options</a> as in the case of <a href="../../en/Dm-crypt/Encrypting_an_entire_system.html" title="Dm-crypt/Encrypting an entire system">encrypting the root partition</a>. <code>crypttab</code> processing at boot time is made by the <code>systemd-cryptsetup-generator</code> automatically.
</p>
<p>See <span class="plainlinks archwiki-template-man" title="$ man 5 crypttab"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/crypttab.5">crypttab(5)</a></span> for details, read below for some examples, and the <a href="#Mounting_at_boot_time">#Mounting at boot time</a> section for instructions on how to use UUIDs to mount an encrypted device.
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> 
<ul>
<li>If the <i>nofail</i> option is specified, the password entry screen may disappear while typing the password. <i>nofail</i> should therefore only be used together with keyfiles.</li>
<li>There are issues with <a href="../../en/Systemd.html" title="Systemd">systemd</a> when processing <code>crypttab</code> entries for <i>dm-crypt</i> <a href="../../en/Dm-crypt/Device_encryption.html#Encryption_options_for_plain_mode" title="Dm-crypt/Device encryption">plain mode</a> (<code>--type plain</code>) devices:
<ul>
<li>For <code>--type plain</code> devices with a keyfile, it is necessary to add the <code>hash=plain</code> option to crypttab due to a <a rel="nofollow" class="external text" href="https://bugs.freedesktop.org/show_bug.cgi?id=52630">systemd incompatibility</a>. <b>Do not</b> use <code>systemd-cryptsetup</code> manually for device creation to work around it.</li>
<li>It may be further required to add the <code>plain</code> option explicitly to force <code>systemd-cryptsetup</code> to recognize a <code>--type plain</code>) device at boot. See <a rel="nofollow" class="external text" href="https://github.com/systemd/systemd/issues/442">systemd issue 442</a>.</li>
</ul>
</li>
</ul>
</div>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/crypttab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"># Example crypttab file. Fields are: name, underlying device, passphrase, cryptsetup options.

# Mount /dev/lvm/swap re-encrypting it with a fresh key each reboot
 swap	/dev/lvm/swap	/dev/urandom	swap,cipher=aes-xts-plain64,size=256

# Mount /dev/lvm/tmp as /dev/mapper/tmp using plain dm-crypt with a random passphrase, making its contents unrecoverable after it is dismounted.
tmp	/dev/lvm/tmp	/dev/urandom	tmp,cipher=aes-xts-plain64,size=256 

# Mount /dev/lvm/home as /dev/mapper/home using LUKS, and prompt for the passphrase at boot time.
home   /dev/lvm/home

# Mount /dev/sdb1 as /dev/mapper/backup using LUKS, with a passphrase stored in a file.
backup /dev/sdb1       /home/alice/backup.key</pre>
<p>To test your crypttab immediately after editing it, reload the systemd manager configuration with:
</p>
<pre># systemctl daemon-reload
</pre>
<p>and <a href="../../en/Systemd.html#Using_units" class="mw-redirect" title="Start">start</a> the newly generated <code>systemd-cryptsetup@<i>name</i>.service</code>.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># cryptsetup status <i>name</i></pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">/dev/mapper/<i>name</i> is active.
  type:    ...
  cipher:  ...
  keysize: ... bits
  key location: ...
  device:  /dev/sdxN
  sector size:  ...
  offset:  ... sectors
  size:    ... sectors
  mode:    ...
  flags:   ...</pre>
<p>For more on <code>systemd-cryptsetup@<i>name</i>.service</code>, see <a href="#Mounting_on_demand">#Mounting on demand</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> If you use GPT and specific partition type UUIDs, you can avoid using crypttab and fstab for some mount points with systemd. For more information, see <a href="../../en/Systemd.html#GPT_partition_automounting" title="Systemd">systemd#GPT partition automounting</a>.</div>
<h3><span class="mw-headline" id="Mounting_at_boot_time">Mounting at boot time</span></h3>
<p>If you want to mount an encrypted drive at boot time, enter the device's UUID in <code>/etc/crypttab</code>. You get the UUID (partition) by using the command <code>lsblk -f</code> and adding it to <code>crypttab</code> in the form:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/crypttab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">externaldrive         UUID=2f9a8428-ac69-478a-88a2-4aa458565431        none    luks,timeout=180</pre>
<p>The first parameter is your preferred device mapper's name for the encrypted drive. The option <code>none</code> will trigger a prompt during boot to type the passphrase for unlocking the partition. The <code>timeout</code> option defines a timeout in seconds for entering the decryption password during boot.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> Passwords entered in the password prompt are cached in the kernel keyring by <span class="plainlinks archwiki-template-man" title="$ man 8 systemd-cryptsetup"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd-cryptsetup.8">systemd-cryptsetup(8)</a></span> (when <a href="#Using_sd-encrypt_hook">using the sd-encrypt hook</a>, this also includes passwords entered in the initramfs stage). If a device in <code>crypttab</code> uses a previously entered password, the third parameter can be set to <code>none</code> and the cached password will be automatically used.</div>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Keep in mind that the <code>timeout</code> option in <code>crypttab</code> only determines the amount of time allowed for <i>entering the password</i> of the encrypted device. In addition, <a href="../../en/Systemd.html" title="Systemd">systemd</a> also has a default timeout which determines the amount of time allowed for <i>the device to be available</i> (defaulting to 90 seconds), which is independent of the password timer. In consequence, even when the <code>timeout</code> option in <code>crypttab</code> is set to a value larger than 90 seconds (or it is at its default value of 0, meaning unlimited time), <i>systemd</i> will still only wait a maximum of 90 seconds for the device to be unlocked. In order to change the time <i>systemd</i> will wait for a device to be available, the option <code>x-systemd.device-timeout</code> (see <span class="plainlinks archwiki-template-man" title="$ man 5 systemd.mount"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd.mount.5">systemd.mount(5)</a></span>) can be set in <a href="../../en/Fstab.html" title="Fstab">fstab</a> for said device. It is probably desired, then, that the amount of time of the <code>timeout</code> option in <code>crypttab</code> is equal to the amount of time of the <code>x-systemd.device-timeout</code> option in <code>fstab</code> for each device mounted at boot time.</div>
<h4><span class="mw-headline" id="Unlocking_with_a_keyfile">Unlocking with a keyfile</span></h4>
<p>If the <a href="../../en/Dm-crypt/Device_encryption.html#Keyfiles" title="Dm-crypt/Device encryption">keyfile</a> for a secondary file system is itself stored inside an encrypted root, it is safe while the system is powered off and can be sourced to automatically unlock the mount during with boot via <a href="../../en/Dm-crypt/System_configuration.html#crypttab" class="mw-redirect" title="Crypttab">crypttab</a>. For example, unlock a crypt specified by <a href="../../en/Persistent_block_device_naming.html#by-uuid" class="mw-redirect" title="UUID">UUID</a>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/crypttab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">home-crypt    UUID=<i>UUID-identifier</i>    /etc/cryptsetup-keys.d/home-crypt.key</pre>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> 
<ul>
<li>If a keyfile is not specified, <span class="plainlinks archwiki-template-man" title="$ man 8 systemd-cryptsetup"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd-cryptsetup.8">systemd-cryptsetup(8)</a></span> will automatically try to load it from <code>/etc/cryptsetup-keys.d/<i>name</i>.key</code> and <code>/run/cryptsetup-keys.d/<i>name</i>.key</code>.<a rel="nofollow" class="external autonumber" href="https://github.com/systemd/systemd/pull/15637">[3]</a>
</li>
<li>If you prefer to use a <code>--plain</code> mode blockdevice, the encryption options necessary to unlock it are specified in <code>/etc/crypttab</code>. Take care to apply the systemd workaround mentioned in <a href="../../en/Dm-crypt/System_configuration.html#crypttab" class="mw-redirect" title="Crypttab">crypttab</a> in this case.</li>
</ul>
</div>
<p>Then use the device mapper's name (defined in <code>/etc/crypttab</code>) to make an entry in <code>/etc/fstab</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/fstab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">/dev/mapper/home-crypt        /home   ext4        defaults        0       2
</pre>
<p>Since <code>/dev/mapper/externaldrive</code> already is the result of a unique partition mapping, there is no need to specify an UUID for it. In any case, the mapper with the filesystem will have a different UUID than the partition it is encrypted in.
</p>
<h4><span class="mw-headline" id="Mounting_a_stacked_blockdevice">Mounting a stacked blockdevice</span></h4>
<p>The systemd generators also automatically process stacked block devices at boot. 
</p>
<p>For example, you can create a <a href="../../en/RAID.html" title="RAID">RAID</a> setup, use cryptsetup on it and create an <a href="../../en/LVM.html" title="LVM">LVM</a> logical volume with respective filesystem inside the encrypted block device. A resulting: 
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$ lsblk -f</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">─sdXX                  linux_raid_member    
│ └─md0                 crypto_LUKS   
│   └─cryptedbackup     LVM2_member 
│     └─vgraid-lvraid   ext4              /mnt/backup
└─sdYY                  linux_raid_member    
  └─md0                 crypto_LUKS       
    └─cryptedbackup     LVM2_member 
      └─vgraid-lvraid   ext4              /mnt/backup
</pre>
<p>will ask for the passphrase and mount automatically at boot. 
</p>
<p>Given you specify the correct corresponding crypttab (e.g. UUID for the <code>crypto_LUKS</code> device) and fstab (<code>/dev/vgraid/lvraid</code>) entries, there is no need to add additional mkinitcpio hooks/configuration, because <code>/etc/crypttab</code> processing applies to non-root mounts only. One exception is when the <code>mdadm_udev</code> hook is used <i>already</i> (e.g. for the root device). In this case <code>/etc/madadm.conf</code> and the initramfs need updating to achieve the correct root raid is picked first.
</p>
<h3><span class="mw-headline" id="Mounting_on_demand">Mounting on demand</span></h3>
<p>Instead of using
</p>
<pre># cryptsetup luksOpen UUID=... externaldrive
</pre>
<p>you can <a href="../../en/Systemd.html#Using_units" class="mw-redirect" title="Start">start</a> <code>systemd-cryptsetup@externaldrive.service</code> when you have an entry as follows in your <code>/etc/crypttab</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/crypttab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">externaldrive UUID=... none noauto</pre>
<p>That way you do not need to remember the exact crypttab options. It will prompt you for the passphrase if needed.
</p>
<p>The corresponding unit file is generated automatically by <span class="plainlinks archwiki-template-man" title="$ man 8 systemd-cryptsetup-generator"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd-cryptsetup-generator.8">systemd-cryptsetup-generator(8)</a></span>. You can list all generated unit files using:
</p>
<pre>$ systemctl list-unit-files | grep systemd-cryptsetup
</pre>
<h2><span class="mw-headline" id="Troubleshooting">Troubleshooting</span></h2>
<h3>
<span id="System_stuck_on_boot.2Fpassword_prompt_does_not_show"></span><span class="mw-headline" id="System_stuck_on_boot/password_prompt_does_not_show">System stuck on boot/password prompt does not show</span>
</h3>
<p>If you are using <a href="../../en/Plymouth.html" title="Plymouth">Plymouth</a>, make sure to use the correct modules (see: <a href="../../en/Plymouth.html#The_plymouth_hook" title="Plymouth">Plymouth#The plymouth hook</a>) or disable it. Otherwise Plymouth will swallow the password prompt, making a system boot impossible.
</p>
</div>
</div>
<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../../en/Category:Data-at-rest_encryption.html" title="Category:Data-at-rest encryption">Data-at-rest encryption</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden category: <ul><li><a href="../../en/Category:Pages_or_sections_flagged_with_Template:Expansion.html" title="Category:Pages or sections flagged with Template:Expansion">Pages or sections flagged with Template:Expansion</a></li></ul>
</div>
</div>
	</div>
</div>

<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
		<li>Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Dm-crypt/System_configuration&amp;oldid=645016">https://wiki.archlinux.org/index.php?title=Dm-crypt/System_configuration&amp;oldid=645016</a>"</li>
		<li id="footer-info-lastmod"> This page was last edited on 13 December 2020, at 10:43.</li>
		<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="http://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
	<br>
</ul>
	<ul id="footer-places">
		<li id="footer-places-privacy"><a href="../../en/ArchWiki:Privacy_policy.html" title="ArchWiki:Privacy policy">Privacy policy</a></li>
		<li id="footer-places-about"><a href="../../en/ArchWiki:About.html" title="ArchWiki:About">About ArchWiki</a></li>
		<li id="footer-places-disclaimer"><a href="../../en/ArchWiki:General_disclaimer.html" title="ArchWiki:General disclaimer">Disclaimers</a></li>
	</ul>
	<ul id="footer-icons" class="noprint">
		<li id="footer-copyrightico">
	</ul>
	<div style="clear: both;"></div>
</footer>



</body>
</html>
