<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>Snapper - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.35.0">
<meta name="robots" content="noindex,follow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="http://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Snapper rootpage-Snapper skin-vector action-view skin-vector-legacy">
<div id="content" class="mw-body" role="main" style="margin: 0">
	<a id="top"></a>
	<div id="siteNotice" class="mw-body-content"></div>
	<div class="mw-indicators mw-body-content">
	</div>
	<h1 id="firstHeading" class="firstHeading" lang="en">Snapper</h1>
	<div id="bodyContent" class="mw-body-content">
		<div id="siteSub" class="noprint">From ArchWiki</div>
		<div id="contentSub"></div>
		<div id="contentSub2"></div>
		
		<div id="jump-to-nav"></div>
		<a class="mw-jump-link" href="#mw-head">Jump to navigation</a>
		<a class="mw-jump-link" href="#searchInput">Jump to search</a>
		<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr">
<div class="warningbox">The printable version is no longer supported and may have rendering errors. Please update your browser bookmarks and please use the default browser print function instead.</div>
<div class="mw-parser-output">
<div class="archwiki-template-meta-related-articles-start">
<p>Related articles</p>
<ul>
<li><a href="../en/Btrfs.html" title="Btrfs">Btrfs</a></li>
<li><a href="../en/Mkinitcpio.html" title="Mkinitcpio">mkinitcpio</a></li>
</ul>
</div>
<p><a rel="nofollow" class="external text" href="http://snapper.io">Snapper</a> is a tool created by openSUSE's Arvin Schnell that helps with managing snapshots of <a href="../en/Btrfs.html" title="Btrfs">Btrfs</a> subvolumes and thin-provisioned <a href="../en/LVM.html" title="LVM">LVM</a> volumes. It can create and compare snapshots, revert between snapshots, and supports automatic snapshots timelines.
</p>
<div id="toc" class="toc" role="navigation" aria-labelledby="mw-toc-heading">
<input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none"><div class="toctitle" lang="en" dir="ltr">
<h2 id="mw-toc-heading">Contents</h2>
<span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span>
</div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Installation"><span class="tocnumber">1</span> <span class="toctext">Installation</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#Creating_a_new_configuration"><span class="tocnumber">2</span> <span class="toctext">Creating a new configuration</span></a></li>
<li class="toclevel-1 tocsection-3">
<a href="#Taking_snapshots"><span class="tocnumber">3</span> <span class="toctext">Taking snapshots</span></a>
<ul>
<li class="toclevel-2 tocsection-4">
<a href="#Automatic_timeline_snapshots"><span class="tocnumber">3.1</span> <span class="toctext">Automatic timeline snapshots</span></a>
<ul>
<li class="toclevel-3 tocsection-5"><a href="#Enable/disable"><span class="tocnumber">3.1.1</span> <span class="toctext">Enable/disable</span></a></li>
<li class="toclevel-3 tocsection-6"><a href="#Set_snapshot_limits"><span class="tocnumber">3.1.2</span> <span class="toctext">Set snapshot limits</span></a></li>
<li class="toclevel-3 tocsection-7"><a href="#Change_snapshot_and_cleanup_frequencies"><span class="tocnumber">3.1.3</span> <span class="toctext">Change snapshot and cleanup frequencies</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-8">
<a href="#Manual_snapshots"><span class="tocnumber">3.2</span> <span class="toctext">Manual snapshots</span></a>
<ul>
<li class="toclevel-3 tocsection-9"><a href="#Simple_snapshots"><span class="tocnumber">3.2.1</span> <span class="toctext">Simple snapshots</span></a></li>
<li class="toclevel-3 tocsection-10"><a href="#Pre/post_snapshots"><span class="tocnumber">3.2.2</span> <span class="toctext">Pre/post snapshots</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-11"><a href="#Snapshots_on_boot"><span class="tocnumber">3.3</span> <span class="toctext">Snapshots on boot</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-12">
<a href="#Managing_snapshots"><span class="tocnumber">4</span> <span class="toctext">Managing snapshots</span></a>
<ul>
<li class="toclevel-2 tocsection-13"><a href="#List_snapshots"><span class="tocnumber">4.1</span> <span class="toctext">List snapshots</span></a></li>
<li class="toclevel-2 tocsection-14"><a href="#List_configurations"><span class="tocnumber">4.2</span> <span class="toctext">List configurations</span></a></li>
<li class="toclevel-2 tocsection-15"><a href="#Delete_a_snapshot"><span class="tocnumber">4.3</span> <span class="toctext">Delete a snapshot</span></a></li>
<li class="toclevel-2 tocsection-16"><a href="#Access_for_non-root_users"><span class="tocnumber">4.4</span> <span class="toctext">Access for non-root users</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-17">
<a href="#Tips_and_tricks"><span class="tocnumber">5</span> <span class="toctext">Tips and tricks</span></a>
<ul>
<li class="toclevel-2 tocsection-18">
<a href="#Wrapping_pacman_transactions_in_snapshots"><span class="tocnumber">5.1</span> <span class="toctext">Wrapping pacman transactions in snapshots</span></a>
<ul>
<li class="toclevel-3 tocsection-19"><a href="#Backup_non-Btrfs_boot_partition_on_pacman_transactions"><span class="tocnumber">5.1.1</span> <span class="toctext">Backup non-Btrfs boot partition on pacman transactions</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-20"><a href="#Incremental_backup_to_external_drive"><span class="tocnumber">5.2</span> <span class="toctext">Incremental backup to external drive</span></a></li>
<li class="toclevel-2 tocsection-21">
<a href="#Suggested_filesystem_layout"><span class="tocnumber">5.3</span> <span class="toctext">Suggested filesystem layout</span></a>
<ul>
<li class="toclevel-3 tocsection-22"><a href="#Configuration_of_snapper_and_mount_point"><span class="tocnumber">5.3.1</span> <span class="toctext">Configuration of snapper and mount point</span></a></li>
<li class="toclevel-3 tocsection-23"><a href="#Restoring_/_to_a_previous_snapshot_of_@"><span class="tocnumber">5.3.2</span> <span class="toctext">Restoring / to a previous snapshot of @</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-24"><a href="#Deleting_files_from_snapshots"><span class="tocnumber">5.4</span> <span class="toctext">Deleting files from snapshots</span></a></li>
<li class="toclevel-2 tocsection-25">
<a href="#Preventing_slowdowns"><span class="tocnumber">5.5</span> <span class="toctext">Preventing slowdowns</span></a>
<ul>
<li class="toclevel-3 tocsection-26"><a href="#updatedb"><span class="tocnumber">5.5.1</span> <span class="toctext">updatedb</span></a></li>
<li class="toclevel-3 tocsection-27"><a href="#Disable_quota_groups"><span class="tocnumber">5.5.2</span> <span class="toctext">Disable quota groups</span></a></li>
<li class="toclevel-3 tocsection-28"><a href="#Count_the_number_of_snapshots"><span class="tocnumber">5.5.3</span> <span class="toctext">Count the number of snapshots</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-29"><a href="#Preserving_log_files"><span class="tocnumber">5.6</span> <span class="toctext">Preserving log files</span></a></li>
<li class="toclevel-2 tocsection-30"><a href="#Cleanup_based_on_disk_usage"><span class="tocnumber">5.7</span> <span class="toctext">Cleanup based on disk usage</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-31">
<a href="#Troubleshooting"><span class="tocnumber">6</span> <span class="toctext">Troubleshooting</span></a>
<ul>
<li class="toclevel-2 tocsection-32"><a href="#Snapper_logs"><span class="tocnumber">6.1</span> <span class="toctext">Snapper logs</span></a></li>
<li class="toclevel-2 tocsection-33"><a href="#IO_error"><span class="tocnumber">6.2</span> <span class="toctext">IO error</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-34"><a href="#See_also"><span class="tocnumber">7</span> <span class="toctext">See also</span></a></li>
</ul>
</div>

<h2><span class="mw-headline" id="Installation">Installation</span></h2>
<p><a href="../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">Install</a> the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=snapper">snapper</a></span> package. The development version <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/snapper-git/">snapper-git</a></span><sup><small>AUR</small></sup> is also available.
</p>
<p>Additionally, a GUI is available with <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/snapper-gui-git/">snapper-gui-git</a></span><sup><small>AUR</small></sup>.
</p>
<h2><span class="mw-headline" id="Creating_a_new_configuration">Creating a new configuration</span></h2>
<p>Before creating a snapper configuration for a Btrfs subvolume, the subvolume must already exist. If it does not, you should <a href="../en/Btrfs.html#Creating_a_subvolume" title="Btrfs">create</a> it before generating a snapper configuration.
</p>
<p>To create a new snapper configuration named <code><i>config</i></code> for the Btrfs subvolume at <code><i>/path/to/subvolume</i></code>, run:
</p>
<pre># snapper -c <i>config</i> create-config <i>/path/to/subvolume</i>
</pre>
<p>This will:
</p>
<ul>
<li>Create a configuration file at <code>/etc/snapper/configs/<i>config</i></code> based on the default template from <code>/etc/snapper/config-templates</code>.</li>
<li>Create a subvolume at <code><i>/path/to/subvolume</i>/.snapshots</code> where future snapshots for this configuration will be stored. A snapshot's path is <code><i>/path/to/subvolume</i>/.snapshots/<i>#</i>/snapshot</code>, where <code><i>#</i></code> is the snapshot number.</li>
<li>Add <code><i>config</i></code> to <code>SNAPPER_CONFIGS</code> in <code>/etc/conf.d/snapper</code>.</li>
</ul>
<p>For example, to create a configuration file for the subvolume mounted at <code>/</code>, run:
</p>
<pre># snapper -c root create-config /
</pre>
<p>At this point, the configuration is active. If your <a href="../en/Cron.html" title="Cron">cron</a> daemon is running, snapper will take <a href="#Automatic_timeline_snapshots">#Automatic timeline snapshots</a>. If you do not use a <a href="../en/Cron.html" title="Cron">cron</a> daemon, you will need to use the systemd service and timer. See <a href="#Enable/disable">#Enable/disable</a>.
</p>
<p>See also <span class="plainlinks archwiki-template-man" title="$ man 5 snapper-configs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/snapper-configs.5">snapper-configs(5)</a></span>.
</p>
<h2><span class="mw-headline" id="Taking_snapshots">Taking snapshots</span></h2>
<h3><span class="mw-headline" id="Automatic_timeline_snapshots">Automatic timeline snapshots</span></h3>
<p>A snapshot timeline can be created with a configurable number of hourly, daily, weekly, monthly, and yearly snapshots kept. When the timeline is enabled, by default a snapshot gets created once an hour. Once a day the snapshots get cleaned up by the timeline cleanup algorithm. Refer to the <code>TIMELINE_*</code> variables in <span class="plainlinks archwiki-template-man" title="$ man 5 snapper-configs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/snapper-configs.5">snapper-configs(5)</a></span> for details.
</p>
<h4>
<span id="Enable.2Fdisable"></span><span class="mw-headline" id="Enable/disable">Enable/disable</span>
</h4>
<p>If you have a <a href="../en/Cron.html" title="Cron">cron</a> daemon, this feature should start automatically. To disable it, edit the configuration file corresponding with the subvolume you do not want to have this feature and set:
</p>
<pre>TIMELINE_CREATE="no"
</pre>
<p>If you do not have a <a href="../en/Cron.html" title="Cron">cron</a> daemon, you can use the provided systemd units. <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Start">Start</a> and <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Enable">enable</a> <code>snapper-timeline.timer</code> to start the automatic snapshot timeline. Additionally, <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Start">start</a> and <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Enable">enable</a> <code>snapper-cleanup.timer</code> to periodically clean up older snapshots.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> If you have a cron daemon and also enable the systemd units, this may result in duplicate snapshots being created. If you wish to disable cron integration while using the systemd units, one possible solution is not to install the snapper package's cron files via <a href="../en/Pacman.html" title="Pacman">pacman</a>'s <a href="../en/Pacman.html#Skip_files_from_being_installed_to_system" title="Pacman">NoExtract</a> and <a href="../en/Pacman.html#Skip_file_from_being_upgraded" title="Pacman">NoUpgrade</a> configuration options. See <a rel="nofollow" class="external autonumber" href="https://unix.stackexchange.com/questions/425570/snapper-has-recently-started-performing-duplicate-snapshots-each-hour">[1]</a>.</div>
<h4><span class="mw-headline" id="Set_snapshot_limits">Set snapshot limits</span></h4>
<p>The default settings will keep 10 hourly, 10 daily, 10 monthly and 10 yearly snapshots. You may want to change this in the configuration, especially on busy subvolumes like <code>/</code>. See <a href="#Preventing_slowdowns">#Preventing slowdowns</a>.
</p>
<p>Here is an example section of a configuration named <code><i>config</i></code> with only 5 hourly snapshots, 7 daily ones, no monthly and no yearly ones:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/snapper/configs/<i>config</i></pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">TIMELINE_MIN_AGE="1800"
TIMELINE_LIMIT_HOURLY="5"
TIMELINE_LIMIT_DAILY="7"
TIMELINE_LIMIT_WEEKLY="0"
TIMELINE_LIMIT_MONTHLY="0"
TIMELINE_LIMIT_YEARLY="0"</pre>
<h4><span class="mw-headline" id="Change_snapshot_and_cleanup_frequencies">Change snapshot and cleanup frequencies</span></h4>
<p>If you are using the provided systemd timers, you can <a href="../en/Systemd.html#Editing_provided_units" class="mw-redirect" title="Edit">edit</a> them to change the snapshot and cleanup frequency.
</p>
<p>For example, when editing the <code>snapper-timeline.timer</code>, add the following to make the frequency every five minutes, instead of hourly:
</p>
<pre>[Timer]
OnCalendar=
OnCalendar=*:0/5
</pre>
<p>When editing <code>snapper-cleanup.timer</code>, you need to change <code>OnUnitActiveSec</code>. To make cleanups occur every hour instead of every day, add:
</p>
<pre>[Timer]
OnUnitActiveSec=1h
</pre>
<p>See <a href="../en/Systemd/Timers.html" title="Systemd/Timers">systemd/Timers</a> and <a href="../en/Systemd.html#Drop-in_files" title="Systemd">systemd#Drop-in files</a>.
</p>
<h3><span class="mw-headline" id="Manual_snapshots">Manual snapshots</span></h3>
<h4><span class="mw-headline" id="Simple_snapshots">Simple snapshots</span></h4>
<p>By default snapper takes snapshots that are of the <i>simple</i> type, having no special relationship to other snapshots.
</p>
<p>To take a snapshot of a subvolume manually, do:
</p>
<pre># snapper -c <i>config</i> create --description <i>desc</i>
</pre>
<p>The above command does not use any cleanup algorithm, so the snapshot is stored permanently or until <a href="#Delete_a_snapshot">deleted</a>.
</p>
<p>To set a cleanup algorithm, use the <code>-c</code> flag after <code>create</code> and choose either <code>number</code>, <code>timeline</code>, <code>pre</code>, or <code>post</code>. <code>number</code> sets snapper to periodically remove snapshots that have exceeded a set number in the configuration file. For example, to create a snaphot that uses the <code>number</code> algorithm for cleanup do:
</p>
<pre># snapper -c <i>config</i> create -c number
</pre>
<p>See <a href="#Automatic_timeline_snapshots">#Automatic timeline snapshots</a> for how <code>timeline</code> snapshots work and see <a href="#Pre/post_snapshots">#Pre/post snapshots</a> on how <code>pre</code> and <code>post</code> work.
</p>
<h4>
<span id="Pre.2Fpost_snapshots"></span><span class="mw-headline" id="Pre/post_snapshots">Pre/post snapshots</span>
</h4>
<p>In addition to <i>simple</i> snapshots, you can also create <i>pre/post</i> snapshots where <i>pre</i> snapshots always have a corresponding <i>post</i> snapshot. The purpose of these pairs is to create a snapshot before and after a system modification.
</p>
<p>To create a pre/post snapshot pair, first create a <i>pre</i> snapshot:
</p>
<pre># snapper -c <i>config</i> create -t pre -p
</pre>
<p>Note the number of the snapshot printed, as it is required for the post snapshot.
</p>
<p>Then perform a system modification (*e.g.*, install a new program, upgrade, etc.).
</p>
<p>Now create the <i>post</i> snapshot:
</p>
<pre># snapper -c <i>config</i> create -t post --pre-number <i>N</i>
</pre>
<p>where <code><i>N</i></code> is the corresponding <i>pre</i> snapshot number.
</p>
<p>An alternative method is to use the <code>--command</code> flag for <code>create</code>, which wraps a command with pre/post snapshots:
</p>
<pre># snapper -c <i>config</i> create --command <i>cmd</i>
</pre>
<p>where <code><i>cmd</i></code> is the command you wish to wrap with pre/post snapshots.
</p>
<p>See <a href="#Wrapping_pacman_transactions_in_snapshots">#Wrapping pacman transactions in snapshots</a>.
</p>
<h3><span class="mw-headline" id="Snapshots_on_boot">Snapshots on boot</span></h3>
<p>To have snapper take a snapshot of the <code>root</code> configuration, <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Enable">enable</a> <code>snapper-boot.timer</code>.
</p>
<h2><span class="mw-headline" id="Managing_snapshots">Managing snapshots</span></h2>
<h3><span class="mw-headline" id="List_snapshots">List snapshots</span></h3>
<p>To list snapshots taken for a given configuration <i>config</i> do:
</p>
<pre># snapper -c <i>config</i> list
</pre>
<h3><span class="mw-headline" id="List_configurations">List configurations</span></h3>
<p>To list all <a href="#Creating_a_new_configuration">configurations</a> you have created do:
</p>
<pre># snapper list-configs
</pre>
<h3><span class="mw-headline" id="Delete_a_snapshot">Delete a snapshot</span></h3>
<p>To delete a snapshot number <code><i>N</i></code> do:
</p>
<pre># snapper -c <i>config</i> delete <i>N</i>
</pre>
<p>Multiple snapshots can be deleted at one time. For example, to delete snapshots 65 and 70 of the root configuration do:
</p>
<pre># snapper -c root delete 65 70
</pre>
<p>To delete a range of snapshots, in this example between snapshots 65 and 70 of the root configuration do:
</p>
<pre># snapper -c root delete 65-70
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> When deleting a pre snapshot, you should always delete its corresponding post snapshot and vice versa.</div>
<h3><span class="mw-headline" id="Access_for_non-root_users">Access for non-root users</span></h3>
<p>Each config is created with the root user, and by default, only root can see and access it.
</p>
<p>To be able to list the snapshots for a given config for a specific user, simply change the value of <code>ALLOW_USERS</code> in your <code>/etc/snapper/configs/<i>config</i></code> file. You should now be able to run <code>snapper -c <i>config</i> list</code> as a normal user.
</p>
<p>Eventually, you want to be able to browse the <code>.snapshots</code> directory with a user, but the owner of this directory must stay root. Therefore, you should change the group owner by a group containing the user you are interested in, such as <code>users</code> for example:
</p>
<pre># chmod a+rx .snapshots
# chown :users .snapshots
</pre>
<h2><span class="mw-headline" id="Tips_and_tricks">Tips and tricks</span></h2>
<h3><span class="mw-headline" id="Wrapping_pacman_transactions_in_snapshots">Wrapping pacman transactions in snapshots</span></h3>
<p>There are a couple of packages used for automatically creating snapshots upon a pacman transaction:
</p>
<ul><li>
<b>pacupg</b> — Script that wraps package and AUR upgrades in Btrfs snapshots and provides an easy way to roll them back.</li></ul>
<dl><dd>
<a rel="nofollow" class="external free" href="https://github.com/crossroads1112/bin/tree/master/pacupg">https://github.com/crossroads1112/bin/tree/master/pacupg</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/pacupg/">pacupg</a></span><sup><small>AUR</small></sup>
</dd></dl>
<ul><li>
<b>snap-pac</b> — Makes pacman automatically use snapper to create <a href="#Pre/post_snapshots">#Pre/post snapshots</a> like openSUSE's YaST. Uses <a href="../en/Pacman.html#Hooks" title="Pacman">Pacman#Hooks</a>.</li></ul>
<dl><dd>
<a rel="nofollow" class="external free" href="https://github.com/wesbarnett/snap-pac">https://github.com/wesbarnett/snap-pac</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=snap-pac">snap-pac</a></span>
</dd></dl>
<ul><li>
<b>snap-pac-grub</b> — Additionally updates GRUB entries for <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=grub-btrfs">grub-btrfs</a></span> after <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=snap-pac">snap-pac</a></span> made the snapshots. Also uses <a href="../en/Pacman.html#Hooks" title="Pacman">Pacman#Hooks</a>.</li></ul>
<dl><dd>
<a rel="nofollow" class="external free" href="https://github.com/maximbaz/snap-pac-grub">https://github.com/maximbaz/snap-pac-grub</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/snap-pac-grub/">snap-pac-grub</a></span><sup><small>AUR</small></sup>
</dd></dl>
<ul><li>
<b>snp</b> — Wrap any shell command in a snapper pre-post snapshot, e.g. <code>snp pacman -Syu</code>.</li></ul>
<dl><dd>
<a rel="nofollow" class="external free" href="https://gist.github.com/erikw/5229436">https://gist.github.com/erikw/5229436</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/snp/">snp</a></span><sup><small>AUR</small></sup>
</dd></dl>
<h4><span class="mw-headline" id="Backup_non-Btrfs_boot_partition_on_pacman_transactions">Backup non-Btrfs boot partition on pacman transactions</span></h4>
<p>If your <code>/boot</code> partition is on a non Btrfs filesystem (e.g. an <a href="../en/EFI_system_partition.html" class="mw-redirect" title="ESP">ESP</a>) you are not able to do snapper backups with it. You can copy the boot partition automatically on a kernel update to your Btrfs root with a hook. This also plays nice together with <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=snap-pac">snap-pac</a></span>.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/pacman.d/hooks/50-bootbackup.hook</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Trigger]
Operation = Upgrade
Operation = Install
Operation = Remove
Type = Path
Target = boot/*

[Action]
Depends = rsync
Description = Backing up /boot...
When = PreTransaction
Exec = /usr/bin/rsync -a --delete /boot /.bootbackup</pre>
<h3><span class="mw-headline" id="Incremental_backup_to_external_drive">Incremental backup to external drive</span></h3>
<p>The following packages use <code>btrfs send</code> and <code>btrfs receive</code> to send backups incrementally to an external drive. Refer to their documenation to see differences in implementation, features, and requirements.
</p>
<ul><li>
<b>btrbk</b> — Tool for creating snapshots and remote backups of Btrfs subvolumes.</li></ul>
<dl><dd>
<a rel="nofollow" class="external free" href="https://github.com/digint/btrbk">https://github.com/digint/btrbk</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/btrbk/">btrbk</a></span><sup><small>AUR</small></sup>
</dd></dl>
<ul><li>
<b>buttersink</b> — Buttersink is like rsync for Btrfs snapshots.</li></ul>
<dl><dd>
<a rel="nofollow" class="external free" href="https://github.com/AmesCornish/buttersink.git">https://github.com/AmesCornish/buttersink.git</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/buttersink-git/">buttersink-git</a></span><sup><small>AUR</small></sup>
</dd></dl>
<ul><li>
<b>snap-sync</b> — Use snapper snapshots to backup to external drive.</li></ul>
<dl><dd>
<a rel="nofollow" class="external free" href="https://github.com/wesbarnett/snap-sync.git">https://github.com/wesbarnett/snap-sync.git</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=snap-sync">snap-sync</a></span>
</dd></dl>
<ul><li>
<b>snapsync</b> — A synchronization tool for snapper.</li></ul>
<dl><dd>
<a rel="nofollow" class="external free" href="https://github.com/doudou/snapsync">https://github.com/doudou/snapsync</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/ruby-snapsync/">ruby-snapsync</a></span><sup><small>AUR</small></sup>
</dd></dl>
<h3><span class="mw-headline" id="Suggested_filesystem_layout">Suggested filesystem layout</span></h3>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> The following layout is intended <i>not</i> to be used with <code>snapper rollback</code>, but is intended to mitigate inherent problems with restoring <code>/</code> with that command. See <a rel="nofollow" class="external text" href="https://bbs.archlinux.org/viewtopic.php?id=194491">this forum thread</a>.</div>
<p>Here is a suggested file system layout for easily restoring the subvolume <code>@</code> that is mounted at root to a previous snapshot:
</p>
<table class="wikitable">
<caption>Filesystem layout
</caption>
<tbody>
<tr>
<th>Subvolume</th>
<th>Mountpoint
</th>
</tr>
<tr>
<td>@</td>
<td>/
</td>
</tr>
<tr>
<td>@home</td>
<td>/home
</td>
</tr>
<tr>
<td>@snapshots</td>
<td>/.snapshots
</td>
</tr>
<tr>
<td>@var_log</td>
<td>/var/log
</td>
</tr>
</tbody>
</table>
<pre>subvolid=5
  |
  ├── @ -|
  |     contained directories:
  |       ├── /usr
  |       ├── /bin
  |       ├── /.snapshots
  |       ├── ...
  |
  ├── @home
  ├── @snapshots
  ├── @var_log
  └── @...
</pre>
<p>The subvolumes <code>@...</code> are mounted to any other directory that should have its own subvolume. 
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 
<ul>
<li>When taking a snapshot of <code>@</code> (mounted at the root <code>/</code>), other subvolumes are not included in the snapshot. Even if a subvolume is nested below <code>@</code>, a snapshot of <code>@</code> will <i>not</i> include it. Create snapper configurations for additional subvolumes besides <code>@</code> of which you want to keep snapshots.</li>
<li>Due to a <a href="../en/Btrfs.html#Swap_file" title="Btrfs">Btrfs limitation</a>, snapshotted volumes cannot contain <a href="../en/Swap.html#Swap_file" title="Swap">swap files</a>. Either put the swap file on another subvolume or create a <a href="../en/Swap.html#Swap_partition" title="Swap">swap partition</a>.</li>
</ul>
</div>
<p>If you were to restore your system to a previous snapshots of <code>@</code>, these other subvolumes will remain unaffected. For example, this allows you to restore <code>@</code> to a previous snapshot while keeping your <code>/home</code> unchanged, because of the subvolume that is mounted at <code>/home</code>.
</p>
<p>This layout allows the snapper utility to take regular snapshots of <code>/</code>, while at the same time making it easy to restore <code>/</code> from an Arch Live CD if it becomes unbootable.
</p>
<p>In this scenario, after the initial setup, snapper needs no changes, and will work as expected.
</p>
<h4><span class="mw-headline" id="Configuration_of_snapper_and_mount_point">Configuration of snapper and mount point</span></h4>
<p>It is assumed that the subvolume <code>@</code> is mounted at root <code>/</code>. It is also assumed that <code>/.snapshots</code> is <i>not</i> mounted and does <i>not</i> exist as folder, this can be ensured by the commands:
</p>
<pre># umount /.snapshots
# rm -r /.snapshots
</pre>
<p>Then <a href="#Creating_a_new_configuration">create a new configuration</a> for <code>/</code>. Snapper create-config automatically creates a subvolume <code>.snapshots</code> with the root subvolume <code>@</code> as its parent, that is not needed for the suggested filesystem layout, and can be deleted.
</p>
<pre># btrfs subvolume delete /.snapshots
</pre>
<p>After deleting the subvolume, recreate the directory /.snapshots.
</p>
<pre># mkdir /.snapshots
</pre>
<p>Now <a href="../en/File_systems.html#Mount_a_file_system" class="mw-redirect" title="Mount">mount</a> <code>@snapshots</code> to <code>/.snapshots</code>. For example, for a file system located on <code>/dev/sda1</code>:
</p>
<pre># mount -o subvol=@snapshots /dev/sda1 /.snapshots
</pre>
<p>To make this mount permanent, add an entry to your <a href="../en/Fstab.html" title="Fstab">fstab</a>.
</p>
<p>Or if you have an existing fstab entry remount the snapshot subvolume:
</p>
<pre># mount -a
</pre>
<p>Give the folder <code>750</code> <a href="../en/File_permissions_and_attributes.html#Numeric_method" class="mw-redirect" title="Permissions">permissions</a>.
</p>
<p>This will make all snapshots that snapper creates be stored outside of the <code>@</code> subvolume, so that <code>@</code> can easily be replaced anytime without losing the snapper snapshots.
</p>
<h4>
<span id="Restoring_.2F_to_a_previous_snapshot_of_.40"></span><span class="mw-headline" id="Restoring_/_to_a_previous_snapshot_of_@">Restoring <code>/</code> to a previous snapshot of <code>@</code></span>
</h4>
<p>If you ever want to restore <code>/</code> using one of snapper's snapshots, first boot into a live Arch Linux USB/CD.
</p>
<p><a href="../en/File_systems.html#Mount_a_file_system" class="mw-redirect" title="Mount">Mount</a> the toplevel subvolume (subvolid=5). That is, omit any <code>subvolid</code> mount flags.
</p>
<p>Find the snapshot you want to recover in <code>/mnt/@snapshots/*/info.xml</code>.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong>  You can use <code>vi</code> to easily browse through each file:
<pre># vi /mnt/@snapshots/*/info.xml
</pre>
Use <code>:n</code> to see the next file and <code>:rew</code> to go back to the first file.</div>
<p>Browse through the <code>&lt;description&gt;</code> tags and the <code>&lt;date&gt;</code> tags, and when you find the snapshot you wish to restore, remember the <code>&lt;num&gt;</code> number.
</p>
<p>Now, move <code>@</code> to another location (<i>e.g.</i> <code>/@.broken</code>) to save a copy of the current system. Alternatively, simply delete <code>@</code> using <code>btrfs subvolume delete</code>.
</p>
<p>Create a read-write snapshot of the read-only snapshot snapper took:
</p>
<pre># btrfs subvolume snapshot /mnt/@snapshots/<i>#</i>/snapshot /mnt/@
</pre>
<p>Where <code><i>#</i></code> is the number of the snapper snapshot you wish to restore. Your <code>/</code> has now been restored to the previous snapshot. Now just simply reboot.
</p>
<h3><span class="mw-headline" id="Deleting_files_from_snapshots">Deleting files from snapshots</span></h3>
<p>If you want to delete a specific file or folder from past snapshots without deleting the snapshots themselves, <a rel="nofollow" class="external text" href="https://pypi.python.org/pypi/snapperS">snapperS</a> is a script that adds this functionality to Snapper. This script can also be used to manipulate past snapshots in a number of other ways that Snapper does not currently support.
</p>
<p>If you want to remove a file without using an extra script, you just need to <a rel="nofollow" class="external text" href="https://unix.stackexchange.com/a/149933">make your snapshot subvolume read-write</a>, which you can do with:
</p>
<pre># btrfs property set /path/to/.snapshots/&lt;snapshot_num&gt;/snapshot ro false
</pre>
<p>Verify that <code>ro=false</code>:
</p>
<pre># btrfs property get /path/to/.snapshots/&lt;snapshot_num&gt;/snapshot
ro=false
</pre>
<p>You can now modify files in <code>/path/to/.snapshots/&lt;snapshot_num&gt;/snapshot</code> like normal.  You can use a shell loop to work on your snapshots in bulk.
</p>
<h3><span class="mw-headline" id="Preventing_slowdowns">Preventing slowdowns</span></h3>
<p>Keeping many snapshots for a large timeframe on a busy filesystem like <code>/</code>, where many system updates happen over time, can cause serious slowdowns. You can prevent it by:
</p>
<ul>
<li>
<a href="../en/Btrfs.html#Creating_a_subvolume" title="Btrfs">Creating</a> subvolumes for things that are not worth being snapshotted, like <code>/var/cache/pacman/pkg</code>, <code>/var/abs</code>, <code>/var/tmp</code>, and <code>/srv</code>.</li>
<li>Editing the default settings for hourly/daily/monthly/yearly snapshots when using <a href="#Automatic_timeline_snapshots">#Automatic timeline snapshots</a>.</li>
</ul>
<h4><span class="mw-headline" id="updatedb">updatedb</span></h4>
<p>By default, <code>updatedb</code> (see <a href="../en/Locate.html" class="mw-redirect" title="Mlocate">mlocate</a>) will also index the <code>.snapshots</code> directory created by snapper, which can cause serious slowdown and excessive memory usage if you have many snapshots. You can prevent <code>updatedb</code> from indexing over it by editing:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/updatedb.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">PRUNENAMES = ".snapshots"</pre>
<h4><span class="mw-headline" id="Disable_quota_groups">Disable quota groups</span></h4>
<p>There are reports of significant slow downs being caused by quota groups, if for instance <code>snapper ls</code> takes many minutes to return a result this could be the cause. See <a rel="nofollow" class="external autonumber" href="https://www.reddit.com/r/btrfs/comments/fmucrq/btrfs_snapshots_make_entire_system_lag_cpu_usage/">[2]</a>.
</p>
<p>To determine whether or not quota groups are enabled use the following command:
</p>
<pre># btrfs qgroup show /
</pre>
<p>Quota groups can then be disabled with:
</p>
<pre># btrfs quota disable /
</pre>
<h4><span class="mw-headline" id="Count_the_number_of_snapshots">Count the number of snapshots</span></h4>
<p>If disabling quota groups did not help with slow down, it may be helpful to count the number of snapshots, this can be done with:
</p>
<pre># btrfs subvolume list -ts / | wc -l
</pre>
<h3><span class="mw-headline" id="Preserving_log_files">Preserving log files</span></h3>
<p>It is recommended to create a subvolume for <code>/var/log</code> so that snapshots of <code>/</code> exclude it. That way if a snapshot of <code>/</code> is restored your log files will not also be reverted to the previous state. This makes it easier to troubleshoot.
</p>
<h3><span class="mw-headline" id="Cleanup_based_on_disk_usage">Cleanup based on disk usage</span></h3>
<div class="noprint archwiki-template-message">
<p><a href="../File:Tango-view-fullscreen.png" class="image"><img alt="Tango-view-fullscreen.png" src="../File:Tango-view-fullscreen.png" decoding="async" width="48" height="48"></a><b>This article or section needs expansion.</b><a href="../File:Tango-view-fullscreen.png" class="image"><img alt="Tango-view-fullscreen.png" src="../File:Tango-view-fullscreen.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>Reason:</b> See <a rel="nofollow" class="external autonumber" href="http://snapper.io/2016/05/18/space-aware-cleanup.html">[3]</a> for ideas. (Discuss in <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php/Talk:Snapper">Talk:Snapper#</a>)</div>
</div>
<h2><span class="mw-headline" id="Troubleshooting">Troubleshooting</span></h2>
<h3><span class="mw-headline" id="Snapper_logs">Snapper logs</span></h3>
<p>Snapper writes all activity to <code>/var/log/snapper.log</code> - check this file first if you think something goes wrong.
</p>
<p>If you have issues with hourly/daily/weekly snapshots, the most common cause for this so far has been that the cronie service (or whatever cron daemon you are using) was not running.
</p>
<h3><span class="mw-headline" id="IO_error">IO error</span></h3>
<p>If you get an 'IO Error' when trying to create a snapshot please make sure that the <a rel="nofollow" class="external text" href="https://bbs.archlinux.org/viewtopic.php?id=164404">.snapshots</a> directory associated to the subvolume you are trying to snapshot is a subvolume by itself.
</p>
<p>Another possible cause is that .snapshots directory does not have root as an owner (You will find <code>Btrfs.cc(openInfosDir):219 - .snapshots must have owner root</code> in the <code>/var/log/snapper.log</code>).
</p>
<h2><span class="mw-headline" id="See_also">See also</span></h2>
<ul>
<li><a rel="nofollow" class="external text" href="http://snapper.io/">Snapper homepage</a></li>
<li><a rel="nofollow" class="external text" href="https://en.opensuse.org/Portal:Snapper">openSUSE Snapper portal</a></li>
<li><a rel="nofollow" class="external text" href="https://btrfs.wiki.kernel.org/index.php/Main_Page">Btrfs homepage</a></li>
<li>
<a rel="nofollow" class="external text" href="https://www.linux.com/news/enterprise/systems-management/878490-snapper-suses-ultimate-btrfs-snapshot-manager/">Linux.com: Snapper: SUSE's Ultimate Btrfs Snapshot Manager</a><sup title="Last check status: 404">[<a href="https://en.wikipedia.org/wiki/Wikipedia:Link_rot" class="extiw" title="wikipedia:Wikipedia:Link rot">dead link</a> 2020-04-03 ⓘ]</sup>
</li>
</ul>
</div>
</div>
<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../en/Category:File_systems.html" title="Category:File systems">File systems</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden categories: <ul>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Expansion.html" title="Category:Pages or sections flagged with Template:Expansion">Pages or sections flagged with Template:Expansion</a></li>
<li><a href="../en/Category:Pages_with_dead_links.html" title="Category:Pages with dead links">Pages with dead links</a></li>
</ul>
</div>
</div>
	</div>
</div>

<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
		<li>Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Snapper&amp;oldid=647054">https://wiki.archlinux.org/index.php?title=Snapper&amp;oldid=647054</a>"</li>
		<li id="footer-info-lastmod"> This page was last edited on 26 December 2020, at 12:25.</li>
		<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="http://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
	<br>
</ul>
	<ul id="footer-places">
		<li id="footer-places-privacy"><a href="../en/ArchWiki:Privacy_policy.html" title="ArchWiki:Privacy policy">Privacy policy</a></li>
		<li id="footer-places-about"><a href="../en/ArchWiki:About.html" title="ArchWiki:About">About ArchWiki</a></li>
		<li id="footer-places-disclaimer"><a href="../en/ArchWiki:General_disclaimer.html" title="ArchWiki:General disclaimer">Disclaimers</a></li>
	</ul>
	<ul id="footer-icons" class="noprint">
		<li id="footer-copyrightico">
	</ul>
	<div style="clear: both;"></div>
</footer>



</body>
</html>
