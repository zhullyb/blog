<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>WireGuard - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.35.0">
<meta name="robots" content="noindex,follow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="http://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-WireGuard rootpage-WireGuard skin-vector action-view skin-vector-legacy">
<div id="content" class="mw-body" role="main" style="margin: 0">
	<a id="top"></a>
	<div id="siteNotice" class="mw-body-content"></div>
	<div class="mw-indicators mw-body-content">
	</div>
	<h1 id="firstHeading" class="firstHeading" lang="en">WireGuard</h1>
	<div id="bodyContent" class="mw-body-content">
		<div id="siteSub" class="noprint">From ArchWiki</div>
		<div id="contentSub"></div>
		<div id="contentSub2"></div>
		
		<div id="jump-to-nav"></div>
		<a class="mw-jump-link" href="#mw-head">Jump to navigation</a>
		<a class="mw-jump-link" href="#searchInput">Jump to search</a>
		<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr">
<div class="warningbox">The printable version is no longer supported and may have rendering errors. Please update your browser bookmarks and please use the default browser print function instead.</div>
<div class="mw-parser-output">
<p>From the <a rel="nofollow" class="external text" href="https://www.wireguard.com/">WireGuard</a> project homepage: 
</p>
<dl><dd>WireGuard is an extremely simple yet fast and modern VPN that utilizes state-of-the-art cryptography. It aims to be faster, simpler, leaner, and more useful than IPsec, while avoiding the massive headache. It intends to be considerably more performant than OpenVPN. WireGuard is designed as a general purpose VPN for running on embedded interfaces and super computers alike, fit for many different circumstances. Initially released for the Linux kernel, it is now cross-platform (Windows, macOS, BSD, iOS, Android) and widely deployable.</dd></dl>
<div id="toc" class="toc" role="navigation" aria-labelledby="mw-toc-heading">
<input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none"><div class="toctitle" lang="en" dir="ltr">
<h2 id="mw-toc-heading">Contents</h2>
<span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span>
</div>
<ul>
<li class="toclevel-1 tocsection-1">
<a href="#Installation"><span class="tocnumber">1</span> <span class="toctext">Installation</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="#Graphical_clients"><span class="tocnumber">1.1</span> <span class="toctext">Graphical clients</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-3">
<a href="#Usage"><span class="tocnumber">2</span> <span class="toctext">Usage</span></a>
<ul>
<li class="toclevel-2 tocsection-4"><a href="#Key_generation"><span class="tocnumber">2.1</span> <span class="toctext">Key generation</span></a></li>
<li class="toclevel-2 tocsection-5">
<a href="#Manual_WireGuard_setup"><span class="tocnumber">2.2</span> <span class="toctext">Manual WireGuard setup</span></a>
<ul>
<li class="toclevel-3 tocsection-6"><a href="#Peer_setup"><span class="tocnumber">2.2.1</span> <span class="toctext">Peer setup</span></a></li>
<li class="toclevel-3 tocsection-7">
<a href="#Additional_routes"><span class="tocnumber">2.2.2</span> <span class="toctext">Additional routes</span></a>
<ul>
<li class="toclevel-4 tocsection-8"><a href="#Point-to-site"><span class="tocnumber">2.2.2.1</span> <span class="toctext">Point-to-site</span></a></li>
<li class="toclevel-4 tocsection-9"><a href="#Site-to-point"><span class="tocnumber">2.2.2.2</span> <span class="toctext">Site-to-point</span></a></li>
<li class="toclevel-4 tocsection-10"><a href="#Site-to-site"><span class="tocnumber">2.2.2.3</span> <span class="toctext">Site-to-site</span></a></li>
<li class="toclevel-4 tocsection-11"><a href="#Routing_all_traffic_over_WireGuard"><span class="tocnumber">2.2.2.4</span> <span class="toctext">Routing all traffic over WireGuard</span></a></li>
</ul>
</li>
<li class="toclevel-3 tocsection-12"><a href="#DNS"><span class="tocnumber">2.2.3</span> <span class="toctext">DNS</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-13"><a href="#Basic_checkups"><span class="tocnumber">2.3</span> <span class="toctext">Basic checkups</span></a></li>
<li class="toclevel-2 tocsection-14">
<a href="#Persistent_configuration"><span class="tocnumber">2.4</span> <span class="toctext">Persistent configuration</span></a>
<ul>
<li class="toclevel-3 tocsection-15"><a href="#wg-quick"><span class="tocnumber">2.4.1</span> <span class="toctext">wg-quick</span></a></li>
<li class="toclevel-3 tocsection-16"><a href="#systemd-networkd"><span class="tocnumber">2.4.2</span> <span class="toctext">systemd-networkd</span></a></li>
<li class="toclevel-3 tocsection-17"><a href="#Netctl"><span class="tocnumber">2.4.3</span> <span class="toctext">Netctl</span></a></li>
<li class="toclevel-3 tocsection-18"><a href="#NetworkManager"><span class="tocnumber">2.4.4</span> <span class="toctext">NetworkManager</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-19">
<a href="#Specific_use-case:_VPN_server"><span class="tocnumber">3</span> <span class="toctext">Specific use-case: VPN server</span></a>
<ul>
<li class="toclevel-2 tocsection-20"><a href="#Server"><span class="tocnumber">3.1</span> <span class="toctext">Server</span></a></li>
<li class="toclevel-2 tocsection-21"><a href="#Key_generation_2"><span class="tocnumber">3.2</span> <span class="toctext">Key generation</span></a></li>
<li class="toclevel-2 tocsection-22"><a href="#Server_config"><span class="tocnumber">3.3</span> <span class="toctext">Server config</span></a></li>
<li class="toclevel-2 tocsection-23"><a href="#Client_config"><span class="tocnumber">3.4</span> <span class="toctext">Client config</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-24"><a href="#Testing_the_tunnel"><span class="tocnumber">4</span> <span class="toctext">Testing the tunnel</span></a></li>
<li class="toclevel-1 tocsection-25">
<a href="#Troubleshooting"><span class="tocnumber">5</span> <span class="toctext">Troubleshooting</span></a>
<ul>
<li class="toclevel-2 tocsection-26"><a href="#Routes_are_periodically_reset"><span class="tocnumber">5.1</span> <span class="toctext">Routes are periodically reset</span></a></li>
<li class="toclevel-2 tocsection-27"><a href="#Broken_DNS_resolution"><span class="tocnumber">5.2</span> <span class="toctext">Broken DNS resolution</span></a></li>
<li class="toclevel-2 tocsection-28"><a href="#Low_MTU"><span class="tocnumber">5.3</span> <span class="toctext">Low MTU</span></a></li>
<li class="toclevel-2 tocsection-29"><a href="#Key_is_not_the_correct_length_or_format"><span class="tocnumber">5.4</span> <span class="toctext">Key is not the correct length or format</span></a></li>
<li class="toclevel-2 tocsection-30"><a href="#Unable_to_establish_a_persistent_connection_behind_NAT_/_firewall"><span class="tocnumber">5.5</span> <span class="toctext">Unable to establish a persistent connection behind NAT / firewall</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-31">
<a href="#Known_issues"><span class="tocnumber">6</span> <span class="toctext">Known issues</span></a>
<ul>
<li class="toclevel-2 tocsection-32"><a href="#Loop_routing"><span class="tocnumber">6.1</span> <span class="toctext">Loop routing</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-33">
<a href="#Tips_and_tricks"><span class="tocnumber">7</span> <span class="toctext">Tips and tricks</span></a>
<ul>
<li class="toclevel-2 tocsection-34"><a href="#Vanity_keys"><span class="tocnumber">7.1</span> <span class="toctext">Vanity keys</span></a></li>
<li class="toclevel-2 tocsection-35"><a href="#Store_private_keys_in_encrypted_form"><span class="tocnumber">7.2</span> <span class="toctext">Store private keys in encrypted form</span></a></li>
<li class="toclevel-2 tocsection-36"><a href="#Endpoint_with_changing_IP"><span class="tocnumber">7.3</span> <span class="toctext">Endpoint with changing IP</span></a></li>
<li class="toclevel-2 tocsection-37"><a href="#Generate_QR_code"><span class="tocnumber">7.4</span> <span class="toctext">Generate QR code</span></a></li>
<li class="toclevel-2 tocsection-38"><a href="#Enable_debug_logs"><span class="tocnumber">7.5</span> <span class="toctext">Enable debug logs</span></a></li>
<li class="toclevel-2 tocsection-39"><a href="#Reload_peer_(server)_configuration"><span class="tocnumber">7.6</span> <span class="toctext">Reload peer (server) configuration</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-40"><a href="#See_also"><span class="tocnumber">8</span> <span class="toctext">See also</span></a></li>
</ul>
</div>

<h2><span class="mw-headline" id="Installation">Installation</span></h2>
<ol>
<li>
<a href="../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">Install</a> <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=wireguard-tools">wireguard-tools</a></span>.</li>
<li>For Linux kernels &lt; 5.6 additionally install the appropriate kernel module: (not needed when using the default <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux">linux</a></span> package)
<ul>
<li>
<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=wireguard-lts">wireguard-lts</a></span> for the LTS <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux-lts">linux-lts</a></span> kernel.</li>
<li>
<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=wireguard-dkms">wireguard-dkms</a></span> for the DKMS variant for other Linux &lt; 5.6 <a href="../en/Kernel.html" title="Kernel">kernels</a>.</li>
</ul>
</li>
</ol>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> <a href="#systemd-networkd">systemd-networkd</a> and <a href="#NetworkManager">NetworkManager</a> both have native support for setting up WireGuard interfaces, they only require the kernel module.</div>
<h3><span class="mw-headline" id="Graphical_clients">Graphical clients</span></h3>
<ul><li>
<b>TunSafe</b> — High performance and secure VPN client that uses the WireGuard protocol</li></ul>
<dl><dd>
<a rel="nofollow" class="external free" href="https://tunsafe.com/">https://tunsafe.com/</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/tunsafe/">tunsafe</a></span><sup><small>AUR</small></sup>, <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/tunsafe-git/">tunsafe-git</a></span><sup><small>AUR</small></sup>
</dd></dl>
<ul><li>
<b>Qomui</b> — OpenVPN Gui with advanced features and support for multiple providers</li></ul>
<dl><dd>
<a rel="nofollow" class="external free" href="https://github.com/corrad1nho/qomui">https://github.com/corrad1nho/qomui</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/qomui/">qomui</a></span><sup><small>AUR</small></sup>
</dd></dl>
<h2><span class="mw-headline" id="Usage">Usage</span></h2>
<p>The commands below demonstrate how to set up a basic tunnel between two or more peers with the following settings:
</p>
<table class="wikitable">
<tbody>
<tr>
<th rowspan="2">
</th>
<th colspan="3">External (public) addresses
</th>
<th colspan="2">Internal IP addresses
</th>
<th rowspan="2">Port
</th>
</tr>
<tr>
<th>Domain name
</th>
<th>IPv4 address
</th>
<th>IPv6 address
</th>
<th>IPv4 address
</th>
<th>IPv6 address
</th>
</tr>
<tr>
<th>Peer A
</th>
<td>
</td>
<td>198.51.100.101
</td>
<td>2001:db8:a85b:70a:ffd4:ec1b:4650:a001
</td>
<td>10.0.0.1/24
</td>
<td>fdc9:281f:04d7:9ee9::1/64
</td>
<td>UDP/51871
</td>
</tr>
<tr>
<th>Peer B
</th>
<td>peer-b.example
</td>
<td>203.0.113.102
</td>
<td>2001:db8:40f0:147a:80ad:3e88:f8e9:b002
</td>
<td>10.0.0.2/24
</td>
<td>fdc9:281f:04d7:9ee9::2/64
</td>
<td>UDP/51902
</td>
</tr>
<tr>
<th>Peer C
</th>
<td>
</td>
<td>
<i>dynamic</i>
</td>
<td>
<i>dynamic</i>
</td>
<td>10.0.0.3/24
</td>
<td>fdc9:281f:04d7:9ee9::3/64
</td>
<td>UDP/51993
</td>
</tr>
</tbody>
</table>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> The same UDP port can be used for all peers.</div>
<p>The external addresses should already exist. For example, if ICMP echo requests are not blocked, peer A should be able to <a href="../en/Network_configuration.html#Ping" class="mw-redirect" title="Ping">ping</a> peer B via its public IP address(es) and vice versa.
</p>
<p>The internal addresses will be new addresses, created either manually using the <span class="plainlinks archwiki-template-man" title="$ man 8 ip"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/ip.8">ip(8)</a></span> utility or by network management software, which will be used internally within the new WireGuard network. The following examples will use 10.0.0.0/24 and fdc9:281f:04d7:9ee9::/64 as the internal network. The <code>/24</code> and <code>/64</code> in the IP addresses is the <a href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing#CIDR_notation" class="extiw" title="wikipedia:Classless Inter-Domain Routing">CIDR</a>.
</p>
<h3><span class="mw-headline" id="Key_generation">Key generation</span></h3>
<p>Create a private and public key for each peer.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> Optionally consider a vanity keypair. See <a href="#Vanity_keys">#Vanity keys</a>.</div>
<p>To create a private key run:
</p>
<pre>$ (umask 0077; wg genkey &gt; peer_A.key)
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> It is recommended to only allow reading and writing access for the owner. The above alters the <a href="../en/Umask.html" title="Umask">umask</a> temporarily within a sub-shell to ensure that access (read/write permissions) is restricted to the owner.</div>
<p>To create a public key:
</p>
<pre>$ wg pubkey &lt; peer_A.key &gt; peer_A.pub
</pre>
<p>Alternatively, do this all at once:
</p>
<pre>$ wg genkey | tee peer_A.key | wg pubkey &gt; peer_A.pub
</pre>
<p>One can also generate a pre-shared key to add an additional layer of symmetric-key cryptography to be mixed into the already existing public-key cryptography, for post-quantum resistance. A pre-shared key should be generated for each peer pair and should not be reused. For example, three interconnected peers, A, B, and, C will need three separate pre-shared keys, one for each peer pair.
</p>
<p>Generate a pre-shared key for each peer pair using the following command:
</p>
<pre>$ wg genpsk &gt; peer_A-peer_B.psk
$ wg genpsk &gt; peer_A-peer_C.psk
$ wg genpsk &gt; peer_B-peer_C.psk
</pre>
<h3><span class="mw-headline" id="Manual_WireGuard_setup">Manual WireGuard setup</span></h3>
<h4><span class="mw-headline" id="Peer_setup">Peer setup</span></h4>
<p>Manual setup is accomplished by using <span class="plainlinks archwiki-template-man" title="$ man 8 ip"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/ip.8">ip(8)</a></span> and <span class="plainlinks archwiki-template-man" title="$ man 8 wg"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/wg.8">wg(8)</a></span>.
</p>
<p><b>Peer A setup:</b>
</p>
<p>In this example peer A will listen on UDP port 51871 and will accept connection from peer B and C.
</p>
<pre># ip link add dev wg0 type wireguard
# ip addr add 10.0.0.1/24 dev wg0
# ip addr add fdc9:281f:04d7:9ee9::1/64 dev wg0
# wg set wg0 listen-port 51871 private-key <i>/path/to/</i>peer_A.key
# wg set wg0 peer <i>PEER_B_PUBLIC_KEY</i> preshared-key <i>/path/to/</i>peer_A-peer_B.psk endpoint peer-b.example:51902 allowed-ips 10.0.0.2/32,fdc9:281f:04d7:9ee9::2/128
# wg set wg0 peer <i>PEER_C_PUBLIC_KEY</i> preshared-key <i>/path/to/</i>peer_A-peer_C.psk allowed-ips 10.0.0.3/32,fdc9:281f:04d7:9ee9::3/128
# ip link set wg0 up
</pre>
<p><code><i>PEER_X_PUBLIC_KEY</i></code> should have the same format as <code>EsnHH9m6RthHSs+sd9uM6eCHe/mMVFaRh93GYadDDnM=</code>.
</p>
<p>The keyword <code>allowed-ips</code> is a list of addresses that will get routed to the peer. Make sure to specify at least one address range that contains the WireGuard connection's internal IP address(es).
</p>
<p><b>Peer B setup:</b>
</p>
<pre># ip link add dev wg0 type wireguard
# ip addr add 10.0.0.2/24 dev wg0
# ip addr add fdc9:281f:04d7:9ee9::2/64 dev wg0
# wg set wg0 listen-port 51902 private-key <i>/path/to/</i>peer_B.key
# wg set wg0 peer <i>PEER_A_PUBLIC_KEY</i> preshared-key <i>/path/to/</i>peer_A-peer_B.psk endpoint 198.51.100.101:51871 allowed-ips 10.0.0.1/32,fdc9:281f:04d7:9ee9::1/128
# wg set wg0 peer <i>PEER_C_PUBLIC_KEY</i> preshared-key <i>/path/to/</i>peer_B-peer_C.psk allowed-ips 10.0.0.3/32,fdc9:281f:04d7:9ee9::3/128
# ip link set wg0 up
</pre>
<p><b>Peer C setup:</b>
</p>
<pre># ip link add dev wg0 type wireguard
# ip addr add 10.0.0.3/24 dev wg0
# ip addr add fdc9:281f:04d7:9ee9::3/64 dev wg0
# wg set wg0 listen-port 51993 private-key <i>/path/to/</i>peer_C.key
# wg set wg0 peer <i>PEER_A_PUBLIC_KEY</i> preshared-key <i>/path/to/</i>peer_A-peer_C.psk endpoint 198.51.100.101:51871 allowed-ips 10.0.0.1/32,fdc9:281f:04d7:9ee9::1/128
# wg set wg0 peer <i>PEER_B_PUBLIC_KEY</i> preshared-key <i>/path/to/</i>peer_B-peer_C.psk endpoint peer-b.example:51902 allowed-ips 10.0.0.2/32,fdc9:281f:04d7:9ee9::2/128
# ip link set wg0 up
</pre>
<h4><span class="mw-headline" id="Additional_routes">Additional routes</span></h4>
<p>To establish connections more complicated than point-to-point, additional setup is necessary.
</p>
<h5><span class="mw-headline" id="Point-to-site">Point-to-site</span></h5>
<p>To access the network of a peer, specify the network subnet(s) in <code>allowed-ips</code> in the configuration of the peers who should be able to connect to it. E.g. <code>allowed-ips 10.0.0.2/32,fdc9:281f:04d7:9ee9::2/128,<b>192.168.35.0/24,fd7b:d0bd:7a6e::/64</b></code>.
</p>
<p>Make sure to also set up the <a href="../en/Network_configuration.html#Routing_table" title="Network configuration">routing table</a> with <span class="plainlinks archwiki-template-man" title="$ man 8 ip-route"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/ip-route.8">ip-route(8)</a></span>. E.g.:
</p>
<pre># ip route add 192.168.35.0/24 dev wg0
# ip route add fd7b:d0bd:7a6e::/64 dev wg0
</pre>
<h5><span class="mw-headline" id="Site-to-point">Site-to-point</span></h5>
<div class="noprint archwiki-template-message">
<p><a href="../File:Tango-view-fullscreen.png" class="image"><img alt="Tango-view-fullscreen.png" src="../File:Tango-view-fullscreen.png" decoding="async" width="48" height="48"></a><b>This article or section needs expansion.</b><a href="../File:Tango-view-fullscreen.png" class="image"><img alt="Tango-view-fullscreen.png" src="../File:Tango-view-fullscreen.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>Reason:</b> Add <code>ip route</code> examples; add alternative using NAT; mention the situation when the <i>site</i>-peer is the network's gateway. (Discuss in <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php/Talk:WireGuard">Talk:WireGuard#</a>)</div>
</div>
<p>If the intent is to connect a device to a network with WireGuard peer(s), set up routes on each device so they know that the peer(s) are reachable via the device.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> Deploy routes network-wide by configuring them in the router.</div>
<p>Enable IP forwarding on the peer through which other devices on the network will connect to WireGuard peer(s):
</p>
<pre># sysctl -w net.ipv4.ip_forward=1
# sysctl -w net.ipv6.conf.all.forwarding=1
</pre>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> Enabling IP forwarding without a properly configured <a href="../en/Category:Firewalls.html" class="mw-redirect" title="Firewall">firewall</a> is a security risk.</div>
<p>See <a href="../en/Sysctl.html#Configuration" title="Sysctl">sysctl#Configuration</a> for instructions on how to set the <i>sysctl</i> parameters on boot.
</p>
<h5><span class="mw-headline" id="Site-to-site">Site-to-site</span></h5>
<p>For connect two (or more) networks, apply both <a href="#Point-to-site">#Point-to-site</a> and <a href="#Site-to-point">#Site-to-point</a> on all <i>sites</i>.
</p>
<h5><span class="mw-headline" id="Routing_all_traffic_over_WireGuard">Routing all traffic over WireGuard</span></h5>
<div class="noprint archwiki-template-message">
<p><a href="../File:Tango-view-fullscreen.png" class="image"><img alt="Tango-view-fullscreen.png" src="../File:Tango-view-fullscreen.png" decoding="async" width="48" height="48"></a><b>This article or section needs expansion.</b><a href="../File:Tango-view-fullscreen.png" class="image"><img alt="Tango-view-fullscreen.png" src="../File:Tango-view-fullscreen.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>Reason:</b> Add instructions on how to <i>route everything over VPN</i>.<a rel="nofollow" class="external autonumber" href="https://www.wireguard.com/netns/">[1]</a> (Discuss in <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php/Talk:WireGuard">Talk:WireGuard#</a>)</div>
</div>
<h4><span class="mw-headline" id="DNS">DNS</span></h4>
<p>To use a peer as a DNS server, add its WireGuard tunnel IP address(es) to <a href="../en/Domain_name_resolution.html" class="mw-redirect" title="/etc/resolv.conf">/etc/resolv.conf</a>. For example, to use peer B as the DNS server:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/resolv.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">nameserver fdc9:281f:04d7:9ee9::2
nameserver 10.0.0.2
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> If a peer will act as a DNS server, make sure to use its WireGuard tunnel address(es) as the DNS server address(es) instead of another of its addresses from allowed IPs. Otherwise DNS lookups may fail.</div>
<h3><span class="mw-headline" id="Basic_checkups">Basic checkups</span></h3>
<p>Invoking the <span class="plainlinks archwiki-template-man" title="$ man 8 wg"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/wg.8">wg(8)</a></span> command without parameters will give a quick overview of the current configuration.
</p>
<p>As an example, when peer A has been configured we are able to see its identity and its associated peers:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">[user@peer-a]# wg</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">interface: wg0
  public key: UguPyBThx/+xMXeTbRYkKlP0Wh/QZT3vTLPOVaaXTD8=
  private key: (hidden)
  listening port: 51871

peer: 9jalV3EEBnVXahro0pRMQ+cHlmjE33Slo9tddzCVtCw=
  endpoint: 203.0.113.102:51902
  allowed ips: 10.0.0.2/32, fdc9:281f:04d7:9ee9::2

peer: 2RzKFbGMx5g7fG0BrWCI7JIpGvcwGkqUaCoENYueJw4=
  endpoint: 192.0.2.103:51993
  allowed ips: 10.0.0.3/32, fdc9:281f:04d7:9ee9::3</pre>
<p>At this point one could reach the end of the tunnel. If the peers do not block ICMP echo requests, try <a href="../en/Network_configuration.html#Ping" class="mw-redirect" title="Ping">pinging</a> a peer to test the connection between them.
</p>
<p>Using ICMPv4:
</p>
<pre>[user@peer-a]$ ping 10.0.0.2
</pre>
<p>Using ICMPv6:
</p>
<pre>[user@peer-a]$ ping fdc9:281f:04d7:9ee9::2
</pre>
<p>After transferring some data between peers, the <code>wg</code> utility will show additional information:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">[root@peer-a]# wg</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">interface: wg0
  public key: UguPyBThx/+xMXeTbRYkKlP0Wh/QZT3vTLPOVaaXTD8=
  private key: (hidden)
  listening port: 51871

peer: 9jalV3EEBnVXahro0pRMQ+cHlmjE33Slo9tddzCVtCw=
  endpoint: 203.0.113.102:51902
  allowed ips: 10.0.0.2/32, fdc9:281f:04d7:9ee9::2
  latest handshake: 5 seconds ago
  transfer: 1.24 KiB received, 1.38 KiB sent

peer: 2RzKFbGMx5g7fG0BrWCI7JIpGvcwGkqUaCoENYueJw4=
  allowed ips: 10.0.0.3/32, fdc9:281f:04d7:9ee9::3</pre>
<h3><span class="mw-headline" id="Persistent_configuration">Persistent configuration</span></h3>
<p>Persistent configuration can be achieved using <code>wg-quick@.service</code>, which is shipped with <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=wireguard-tools">wireguard-tools</a></span>, or using a network manager. Network managers that support WireGuard are—<a href="../en/Systemd-networkd.html" title="Systemd-networkd">systemd-networkd</a>, <a href="../en/Netctl.html" title="Netctl">netctl</a><a rel="nofollow" class="external autonumber" href="https://git.archlinux.org/netctl.git/tree/docs/examples/wireguard">[2]</a>, <a href="../en/NetworkManager.html" title="NetworkManager">NetworkManager</a> and <a href="../en/ConnMan.html" title="ConnMan">ConnMan</a><a rel="nofollow" class="external autonumber" href="https://git.kernel.org/pub/scm/network/connman/connman.git/tree/doc/vpn-config-format.txt">[3]</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 
<ul>
<li>
<a href="../en/Netctl.html" title="Netctl">netctl</a> relies on <span class="plainlinks archwiki-template-man" title="$ man 8 wg"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/wg.8">wg(8)</a></span> from <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=wireguard-tools">wireguard-tools</a></span> and <code>/etc/wireguard/<i>interfacename</i>.conf</code> configuration files for establishing WireGuard connections.</li>
<li>
<a href="../en/ConnMan.html" title="ConnMan">ConnMan</a> has a very limited support for WireGuard. It can connect to only one peer.<a rel="nofollow" class="external autonumber" href="https://git.kernel.org/pub/scm/network/connman/connman.git/commit/?id=95b25140bec7c4d9b6ae4e479dc1b94b7d409b39">[4]</a>
</li>
</ul>
</div>
<h4><span class="mw-headline" id="wg-quick">wg-quick</span></h4>
<p><span class="plainlinks archwiki-template-man" title="$ man 8 wg-quick"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/wg-quick.8">wg-quick(8)</a></span> configures WireGuard tunnels using configuration files from <code>/etc/wireguard/<i>interfacename</i>.conf</code>.
</p>
<p>The current WireGuard configuration can be saved by utilizing the <span class="plainlinks archwiki-template-man" title="$ man 8 wg"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/wg.8">wg(8)</a></span> utility's <code>showconf</code> command. For example:
</p>
<pre># wg showconf wg0 &gt; /etc/wireguard/wg0.conf
</pre>
<p>To start a tunnel with a configuration file, use
</p>
<pre># wg-quick up <i>interfacename</i>
</pre>
<p>or use the systemd service—<code>wg-quick@<i>interfacename</i>.service</code>. To start the tunnel at boot, <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Enable">enable</a> the unit.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 
<ul>
<li>Users configuring the WireGuard interface using <i>wg-quick</i>, should make sure that no other <a href="../en/Network_configuration.html#Network_management" class="mw-redirect" title="Network management">network management</a> software tries to manage it. To use <a href="../en/NetworkManager.html" title="NetworkManager">NetworkManager</a> and to not configure WireGuard interfaces with it, see <a href="#Routes_are_periodically_reset">#Routes are periodically reset</a>.</li>
<li>
<i>wg-quick</i> adds additional configuration options to the configuration file format thus making it incompatible with <span class="plainlinks archwiki-template-man" title="$ man 8 wg"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/wg.8#CONFIGURATION_FILE_FORMAT">wg(8) § CONFIGURATION FILE FORMAT</a></span>. See the <span class="plainlinks archwiki-template-man" title="$ man 8 wg-quick"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/wg-quick.8#CONFIGURATION">wg-quick(8) § CONFIGURATION</a></span> man page for the configuration values in question. A <i>wg</i>-compatible configuration file can be produced by using <code>wg-quick strip</code>.</li>
<li>
<i>wg-quick</i> does not provide a way to instruct <a href="../en/Openresolv.html" class="mw-redirect" title="Resolvconf">resolvconf</a> to set the WireGuard interface as <i>private</i>. Even if there are search domains specified, all DNS queries from the system, not just those that match the search domains, will be sent to the DNS servers which are set in the WireGuard configuration.</li>
</ul>
</div>
<p><b>Peer A setup:</b>
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/wireguard/wg0.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Interface]
Address = 10.0.0.1/24, fdc9:281f:04d7:9ee9::1/64
ListenPort = 51871
PrivateKey = <i>PEER_A_PRIVATE_KEY</i>

[Peer]
PublicKey = <i>PEER_B_PUBLIC_KEY</i>
PresharedKey = <i>PEER_A-PEER_B-PRESHARED_KEY</i>
AllowedIPs = 10.0.0.2/32, fdc9:281f:04d7:9ee9::2/128
Endpoint = peer-b.example:51902

[Peer]
PublicKey = <i>PEER_C_PUBLIC_KEY</i>
PresharedKey = <i>PEER_A-PEER_C-PRESHARED_KEY</i>
AllowedIPs = 10.0.0.3/32, fdc9:281f:04d7:9ee9::3/128</pre>
<ul>
<li>To <i>route all traffic</i> through the tunnel to a specific peer, add the <a href="https://en.wikipedia.org/wiki/Default_route" class="extiw" title="wikipedia:Default route">default route</a> (<code>0.0.0.0/0</code> for IPv4 and <code>::/0</code> for IPv6) to <code>AllowedIPs</code>. E.g. <code>AllowedIPs = 0.0.0.0/0, ::/0</code>. wg-quick will automatically take care of setting up correct routing and fwmark<a rel="nofollow" class="external autonumber" href="https://www.wireguard.com/netns/#routing-all-your-traffic">[5]</a> so that networking still functions.</li>
<li>To use a peer as a DNS server, set <code>DNS = <i>wireguard_internal_ip_address_of_peer</i></code> in the <code>[Interface]</code> section. <a href="https://en.wikipedia.org/wiki/Search_domain" class="extiw" title="wikipedia:Search domain">Search domains</a> are also set with the <code>DNS =</code> option. Separate all values in the list with commas.</li>
</ul>
<p><b>Peer B setup:</b>
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/wireguard/wg0.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Interface]
Address = 10.0.0.2/24, fdc9:281f:04d7:9ee9::2/64
ListenPort = 51902
PrivateKey = <i>PEER_B_PRIVATE_KEY</i>

[Peer]
PublicKey = <i>PEER_A_PUBLIC_KEY</i>
PresharedKey = <i>PEER_A-PEER_B-PRESHARED_KEY</i>
AllowedIPs = 10.0.0.1/32, fdc9:281f:04d7:9ee9::1/128
Endpoint = 198.51.100.101:51871

[Peer]
PublicKey = <i>PEER_C_PUBLIC_KEY</i>
PresharedKey = <i>PEER_B-PEER_C-PRESHARED_KEY</i>
AllowedIPs = 10.0.0.3/32, fdc9:281f:04d7:9ee9::3/128</pre>
<p><b>Peer C setup:</b>
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/wireguard/wg0.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Interface]
Address = 10.0.0.3/24, fdc9:281f:04d7:9ee9::3/64
ListenPort = 51993
PrivateKey = <i>PEER_C_PRIVATE_KEY</i>

[Peer]
PublicKey = <i>PEER_A_PUBLIC_KEY</i>
PresharedKey = <i>PEER_A-PEER_C-PRESHARED_KEY</i>
AllowedIPs = 10.0.0.1/32, fdc9:281f:04d7:9ee9::1/128
Endpoint = 198.51.100.101:51871

[Peer]
PublicKey = <i>PEER_B_PUBLIC_KEY</i>
PresharedKey = <i>PEER_B-PEER_C-PRESHARED_KEY</i>
AllowedIPs = 10.0.0.2/32, fdc9:281f:04d7:9ee9::2/128
Endpoint = peer-b.example:51902</pre>
<h4><span class="mw-headline" id="systemd-networkd">systemd-networkd</span></h4>
<p><a href="../en/Systemd-networkd.html" title="Systemd-networkd">systemd-networkd</a> has native support for setting up WireGuard interfaces. An example is provided in the <span class="plainlinks archwiki-template-man" title="$ man 5 systemd.netdev"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd.netdev.5#EXAMPLES">systemd.netdev(5) § EXAMPLES</a></span> man page.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 
<ul>
<li>Routing all DNS over WireGuard (i.e. <code>Domains=~.</code>) will prevent the DNS resolution of endpoints.</li>
<li>systemd-networkd does not automatically create routes for subnets specified in AllowedIPs. See <a rel="nofollow" class="external text" href="https://github.com/systemd/systemd/issues/14176">systemd issue 14176</a>. This will not affect the connectivity between peers since they exist in the subnet that is specified with the <code>Address=</code> option in the <i>.network</i> file.</li>
</ul>
</div>
<p><b>Peer A setup:</b>
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/network/99-wg0.netdev</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[NetDev]
Name=wg0
Kind=wireguard
Description=WireGuard tunnel wg0

[WireGuard]
ListenPort=51871
PrivateKey=<i>PEER_A_PRIVATE_KEY</i>

[WireGuardPeer]
PublicKey=<i>PEER_B_PUBLIC_KEY</i>
PresharedKey=<i>PEER_A-PEER_B-PRESHARED_KEY</i>
AllowedIPs=10.0.0.2/32
AllowedIPs=fdc9:281f:04d7:9ee9::2/128
Endpoint=peer-b.example:51902

[WireGuardPeer]
PublicKey=<i>PEER_C_PUBLIC_KEY</i>
PresharedKey=<i>PEER_A-PEER_C-PRESHARED_KEY</i>
AllowedIPs=10.0.0.3/32
AllowedIPs=fdc9:281f:04d7:9ee9::3/128</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/network/99-wg0.network</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Match]
Name=wg0

[Network]
Address=10.0.0.1/24
Address=fdc9:281f:04d7:9ee9::1/64</pre>
<ul>
<li>To use a peer as a DNS server, specify its WireGuard tunnel's IP address(es) in the <i>.network</i> file using the <code>DNS=</code> option. For <a href="https://en.wikipedia.org/wiki/Search_domain" class="extiw" title="wikipedia:Search domain">search domains</a> use the <code>Domains=</code> option. See <span class="plainlinks archwiki-template-man" title="$ man 5 systemd.network"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd.network.5#%5BNETWORK%5D_SECTION_OPTIONS">systemd.network(5) § [NETWORK] SECTION OPTIONS</a></span> for details.</li>
<li>To use a peer as the <b>only</b> DNS server, then in the <i>.network</i> file's <code>[Network]</code> section set <code>DNSDefaultRoute=true</code> and add <code>~.</code> to <code>Domains=</code> option.</li>
<li>To route additional subnets add them as <code>[Route]</code> sections in the <i>.network</i> file. For example:</li>
</ul>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/network/99-wg0.network</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">...
[Route]
Destination=192.168.35.0/24
Scope=link

[Route]
Destination=fd7b:d0bd:7a6e::/64
Scope=link</pre>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> In order to prevent the leaking of private keys, it is recommended to set the permissions of the <i>.netdev</i> file:
<pre># chown root:systemd-network /etc/systemd/network/99-*.netdev
# chmod 0640 /etc/systemd/network/99-*.netdev
</pre>
</div>
<p><b>Peer B setup:</b>
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/network/99-wg0.netdev</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[NetDev]
Name=wg0
Kind=wireguard
Description=WireGuard tunnel wg0

[WireGuard]
ListenPort=51902
PrivateKey=<i>PEER_B_PRIVATE_KEY</i>

[WireGuardPeer]
PublicKey=<i>PEER_A_PUBLIC_KEY</i>
PresharedKey=<i>PEER_A-PEER_B-PRESHARED_KEY</i>
AllowedIPs=10.0.0.1/32
AllowedIPs=fdc9:281f:04d7:9ee9::1/128
Endpoint=198.51.100.101:51871

[WireGuardPeer]
PublicKey=<i>PEER_C_PUBLIC_KEY</i>
PresharedKey=<i>PEER_B-PEER_C-PRESHARED_KEY</i>
AllowedIPs=10.0.0.3/32
AllowedIPs=fdc9:281f:04d7:9ee9::3/128</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/network/99-wg0.network</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Match]
Name=wg0

[Network]
Address=10.0.0.2/24
Address=fdc9:281f:04d7:9ee9::2/64</pre>
<p><b>Peer C setup:</b>
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/network/99-wg0.netdev</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[NetDev]
Name=wg0
Kind=wireguard
Description=WireGuard tunnel wg0

[WireGuard]
ListenPort=51993
PrivateKey=<i>PEER_C_PRIVATE_KEY</i>

[WireGuardPeer]
PublicKey=<i>PEER_A_PUBLIC_KEY</i>
PresharedKey=<i>PEER_A-PEER_C-PRESHARED_KEY</i>
AllowedIPs=10.0.0.1/32
AllowedIPs=fdc9:281f:04d7:9ee9::1/128
Endpoint=198.51.100.101:51871

[WireGuardPeer]
PublicKey=<i>PEER_B_PUBLIC_KEY</i>
PresharedKey=<i>PEER_B-PEER_C-PRESHARED_KEY</i>
AllowedIPs=10.0.0.2/32
AllowedIPs=fdc9:281f:04d7:9ee9::2/128
Endpoint=peer-b.example:51902</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/network/99-wg0.network</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Match]
Name=wg0

[Network]
Address=10.0.0.3/24
Address=fdc9:281f:04d7:9ee9::3/64</pre>
<h4><span class="mw-headline" id="Netctl">Netctl</span></h4>
<p><a href="../en/Netctl.html" title="Netctl">Netctl</a> has native support for setting up WireGuard interfaces. At least Netctl version ≥ 1.23 is recommended as previous versions had various bugs around WireGuard implementation. A typical set of WireGuard netctl profile configuration files would look like this.
</p>
<p><b>Peer A setup:</b>
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/netctl/wg0</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">Description="WireGuard tunnel on peer A"
Interface=wg0
Connection=wireguard
WGConfigFile=/etc/wireguard/wg0.conf

IP=static
Address=('10.0.0.1/24')</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/wireguard/wg0.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Interface]
ListenPort = 51871
PrivateKey = <i>PEER_A_PRIVATE_KEY</i>

[Peer]
PublicKey = <i>PEER_B_PUBLIC_KEY</i>
AllowedIPs = 10.0.0.2/32
Endpoint = peer-b.example:51902

[Peer]
PublicKey = <i>PEER_C_PUBLIC_KEY</i>
AllowedIPs = 10.0.0.3/32</pre>
<p><b>Peer B setup:</b>
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/netctl/wg0</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">Description="WireGuard tunnel on peer B"
Interface=wg0
Connection=wireguard
WGConfigFile=/etc/wireguard/wg0.conf

IP=static
Address=('10.0.0.2/24')</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/wireguard/wg0.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Interface]
ListenPort = 51902
PrivateKey = <i>PEER_B_PRIVATE_KEY</i>

[Peer]
PublicKey = <i>PEER_A_PUBLIC_KEY</i>
AllowedIPs = 10.0.0.1/32
Endpoint = peer-a.example:51871

[Peer]
PublicKey = <i>PEER_C_PUBLIC_KEY</i>
AllowedIPs = 10.0.0.3/32</pre>
<p><b>Peer C setup:</b>
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/netctl/wg0</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">Description="WireGuard tunnel on peer C"
Interface=wg0
Connection=wireguard
WGConfigFile=/etc/wireguard/wg0.conf

IP=static
Address=('10.0.0.3/24')</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/wireguard/wg0.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Interface]
ListenPort = 51993
PrivateKey = <i>PEER_C_PRIVATE_KEY</i>

[Peer]
PublicKey = <i>PEER_A_PUBLIC_KEY</i>
AllowedIPs = 10.0.0.1/32
Endpoint = peer-a.example:51871

[Peer]
PublicKey = <i>PEER_B_PUBLIC_KEY</i>
AllowedIPs = 10.0.0.2/32
Endpoint = peer-b.example:51902</pre>
<p>Then start and/or enable wg0 interface on every participating peer as needed, ie.
</p>
<pre># netctl start wg0
</pre>
<p>To implement persistent site-to-peer, peer-to-site or site-to-site type of connection with WireGuard and Netctl, just add appropriate <code>Routes=</code> line into netctl profile config file and add this network to <code>AllowedIPs</code> in WireGuard profile, eg. <code>Routes=('192.168.10.0/24 dev wg0')</code> in the <code>/etc/netctl/wg0</code> and <code>AllowedIPs=10.0.0.1/32, 192.168.10.0/24</code> in <code>/etc/wireguard/wg0.conf</code> and then do not forget to enable <a href="../en/Internet_sharing.html#Enable_packet_forwarding" title="Internet sharing">IP forwarding</a>.
</p>
<h4><span class="mw-headline" id="NetworkManager">NetworkManager</span></h4>
<p><a href="../en/NetworkManager.html" title="NetworkManager">NetworkManager</a> has native support for setting up WireGuard interfaces. For all details about WireGuard usage in NetworkManager, read Thomas Haller's blog post—<a rel="nofollow" class="external text" href="https://blogs.gnome.org/thaller/2019/03/15/wireguard-in-networkmanager/">WireGuard in NetworkManager</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> NetworkManager can import a wg-quick configuration file. E.g.: <pre># nmcli connection import type wireguard file /etc/wireguard/wg0.conf</pre>
</div>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> nmcli can create a WireGuard connection profile, but it does not support configuring peers. See <a rel="nofollow" class="external text" href="https://gitlab.freedesktop.org/NetworkManager/NetworkManager/issues/358">NetworkManager issue 358</a>.</div>
<p>The following examples configure WireGuard via the keyfile format <i>.nmconnection</i> files. See <span class="plainlinks archwiki-template-man" title="$ man 5 nm-settings-keyfile"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/nm-settings-keyfile.5">nm-settings-keyfile(5)</a></span> and <span class="plainlinks archwiki-template-man" title="$ man 5 nm-settings"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/nm-settings.5">nm-settings(5)</a></span> for a explanation on the syntax and available options.
</p>
<p><b>Peer A setup:</b>
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/NetworkManager/system-connections/wg0.nmconnection</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[connection]
id=wg0
type=wireguard
interface-name=wg0

[wireguard]
listen-port=51871
private-key=<i>PEER_A_PRIVATE_KEY</i>
private-key-flags=0

[wireguard-peer.<i>PEER_B_PUBLIC_KEY</i>]
endpoint=peer-b.example:51902
preshared-key=<i>PEER_A-PEER_B-PRESHARED_KEY</i>
preshared-key-flags=0
allowed-ips=10.0.0.2/32;fdc9:281f:04d7:9ee9::2/128;

[wireguard-peer.<i>PEER_C_PUBLIC_KEY</i>]
preshared-key=<i>PEER_A-PEER_C-PRESHARED_KEY</i>
preshared-key-flags=0
allowed-ips=10.0.0.3/32;fdc9:281f:04d7:9ee9::3/128;

[ipv4]
address1=10.0.0.1/24
method=manual

[ipv6]
address1=fdc9:281f:04d7:9ee9::1/64
method=manual</pre>
<ul>
<li>To <i>route all traffic</i> through the tunnel to a specific peer, add the <a href="https://en.wikipedia.org/wiki/Default_route" class="extiw" title="wikipedia:Default route">default route</a> (<code>0.0.0.0/0</code> for IPv4 and <code>::/0</code> for IPv6) to <code>wireguard-peer.<i>PEER_X_PUBLIC_KEY</i>.allowed-ips</code>. E.g. <code>wireguard-peer.<i>PEER_B_PUBLIC_KEY</i>.allowed-ips=0.0.0.0/0;::/0;</code>. Special handling of the default route in WireGuard connections is supported since NetworkManager 1.20.0.</li>
<li>To use a peer as a DNS server, specify its WireGuard tunnel's IP address(es) with the <code>ipv4.dns</code> and <code>ipv6.dns</code> settings. <a href="https://en.wikipedia.org/wiki/Search_domain" class="extiw" title="wikipedia:Search domain">Search domains</a> can be specified with the <code>ipv4.dns-search=</code> and <code>ipv6.dns-search=</code> options. See <span class="plainlinks archwiki-template-man" title="$ man 5 nm-settings"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/nm-settings.5">nm-settings(5)</a></span> for more details. For example, using the keyfile format:</li>
</ul>
<pre>...
[ipv4]
...
dns=10.0.0.2;
dns-search=corp;
...
[ipv6]
...
dns=fdc9:281f:04d7:9ee9::2;
dns-search=corp;
...</pre>
<p>To use a peer as the <b>only</b> DNS server, set a negative DNS priority (e.g. <code>dns-priority=-1</code>) and add <code>~.</code> to the <code>dns-search=</code> settings.
</p>
<p><b>Peer B setup:</b>
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/NetworkManager/system-connections/wg0.nmconnection</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[connection]
id=wg0
type=wireguard
interface-name=wg0

[wireguard]
listen-port=51902
private-key=<i>PEER_B_PRIVATE_KEY</i>
private-key-flags=0

[wireguard-peer.<i>PEER_A_PUBLIC_KEY</i>]
endpoint=198.51.100.101:51871
preshared-key=<i>PEER_A-PEER_B-PRESHARED_KEY</i>
preshared-key-flags=0
allowed-ips=10.0.0.1/32;fdc9:281f:04d7:9ee9::1/128;

[wireguard-peer.<i>PEER_C_PUBLIC_KEY</i>]
preshared-key=<i>PEER_B-PEER_C-PRESHARED_KEY</i>
preshared-key-flags=0
allowed-ips=10.0.0.3/32;fdc9:281f:04d7:9ee9::3/128;

[ipv4]
address1=10.0.0.2/24
method=manual

[ipv6]
address1=fdc9:281f:04d7:9ee9::2/64
method=manual</pre>
<p><b>Peer C setup:</b>
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/NetworkManager/system-connections/wg0.nmconnection</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[connection]
id=wg0
type=wireguard
interface-name=wg0

[wireguard]
listen-port=51993
private-key=<i>PEER_C_PRIVATE_KEY</i>
private-key-flags=0

[wireguard-peer.<i>PEER_A_PUBLIC_KEY</i>]
endpoint=198.51.100.101:51871
preshared-key=<i>PEER_A-PEER_C-PRESHARED_KEY</i>
preshared-key-flags=0
allowed-ips=10.0.0.1/32;fdc9:281f:04d7:9ee9::1/128;

[wireguard-peer.<i>PEER_B_PUBLIC_KEY</i>]
endpoint=peer-b.example:51902
preshared-key=<i>PEER_B-PEER_C-PRESHARED_KEY</i>
preshared-key-flags=0
allowed-ips=10.0.0.2/32;fdc9:281f:04d7:9ee9::2/128;

[ipv4]
address1=10.0.0.3/24
method=manual

[ipv6]
address1=fdc9:281f:04d7:9ee9::3/64
method=manual</pre>
<h2><span class="mw-headline" id="Specific_use-case:_VPN_server">Specific use-case: VPN server</span></h2>
<div class="noprint archwiki-template-message">
<p><a href="../File:Merge-arrows-2.png" class="image"><img alt="Merge-arrows-2.png" src="../File:Merge-arrows-2.png" decoding="async" width="48" height="48"></a><b>This article or section is a candidate for merging with <a href="#Routing_all_traffic_over_WireGuard">#Routing all traffic over WireGuard</a>.</b><a href="../File:Merge-arrows-2.png" class="image"><img alt="Merge-arrows-2.png" src="../File:Merge-arrows-2.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>Notes:</b> Same use case. (Discuss in <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php/Talk:WireGuard">Talk:WireGuard#</a>)</div>
</div>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Usage of the terms "server" and "client" were purposefully chosen in this section specifically to help new users/existing OpenVPN users become familiar with the construction of WireGuard's configuration files.  WireGuard documentation simply refers to both of these concepts as "peers."</div>
<p>The purpose of this section is to setup a WireGuard "server" and generic "clients" to enable access to the server/network resources through an encrypted and secured tunnel like <a href="../en/OpenVPN.html" title="OpenVPN">OpenVPN</a> and others.  The "server" runs on Linux and the "clients" can run on any number of platforms (the WireGuard Project offers apps on both iOS and Android platforms in addition to Linux, Windows and MacOS).  See the official project <a rel="nofollow" class="external text" href="https://www.wireguard.com/install/">install link</a> for more.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> Instead of using <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=wireguard-tools">wireguard-tools</a></span> for server/client configuration, one may also use <a href="#systemd-networkd">systemd-networkd</a> native WireGuard support.</div>
<h3><span class="mw-headline" id="Server">Server</span></h3>
<div class="noprint archwiki-template-message">
<p><a href="../File:Merge-arrows-2.png" class="image"><img alt="Merge-arrows-2.png" src="../File:Merge-arrows-2.png" decoding="async" width="48" height="48"></a><b>This article or section is a candidate for merging with <a href="#Site-to-point">#Site-to-point</a>.</b><a href="../File:Merge-arrows-2.png" class="image"><img alt="Merge-arrows-2.png" src="../File:Merge-arrows-2.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>Notes:</b> Same use case. (Discuss in <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php/Talk:WireGuard">Talk:WireGuard#</a>)</div>
</div>
<p>On the peer that will act as the "server", first enable IPv4 forwarding using <a href="../en/Sysctl.html" title="Sysctl">sysctl</a>:
</p>
<pre># sysctl -w net.ipv4.ip_forward=1
</pre>
<p>To make the change permanent, add <code>net.ipv4.ip_forward = 1</code> to <code>/etc/sysctl.d/99-sysctl.conf</code>.
</p>
<p>A properly configured <a href="../en/Category:Firewalls.html" class="mw-redirect" title="Firewall">firewall</a> is <i>HIGHLY recommended</i> for any Internet-facing device.
</p>
<p>If the server has a public IP configured, be sure to:
</p>
<ul>
<li>Allow UDP traffic on the specified port(s) on which WireGuard will be running (for example allowing traffic on 51820/udp).</li>
<li>Setup the forwarding policy for the firewall if it is not included in the WireGuard config for the interface itself <code>/etc/wireguard/wg0.conf</code>. The example below should have the iptables rules and work as-is.</li>
</ul>
<p>If the server is behind NAT, be sure to forward the specified port(s) on which WireGuard will be running (for example, 51820/UDP) from the router to the WireGuard server.
</p>
<h3><span class="mw-headline" id="Key_generation_2">Key generation</span></h3>
<p>Generate key pairs for the server and for each client as explained in <a href="#Key_generation">#Key generation</a>.
</p>
<h3><span class="mw-headline" id="Server_config">Server config</span></h3>
<p>Create the "server" config file:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/wireguard/wg0.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Interface]
Address = 10.200.200.1/24
ListenPort = 51820
PrivateKey = <i>SERVER_PRIVATE_KEY</i>

# substitute <i>eth0</i> in the following lines to match the Internet-facing interface
# if the server is behind a router and receives traffic via NAT, these iptables rules are not needed
PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -D FORWARD -o %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE

[Peer]
# foo
PublicKey = <i>PEER_FOO_PUBLIC_KEY</i>
PresharedKey = <i>PRE-SHARED_KEY</i>
AllowedIPs = 10.200.200.2/32

[Peer]
# bar
PublicKey = <i>PEER_BAR_PUBLIC_KEY</i>
PresharedKey = <i>PRE-SHARED_KEY</i>
AllowedIPs = 10.200.200.3/32</pre>
<p>Additional peers ("clients") can be listed in the same format as needed. Each peer requires the <code>PublicKey</code> to be set. However, specifying <code>PresharedKey</code> is optional.
</p>
<p>Notice that the <code>Address</code> has a netmask of "/24" and the clients on <code>AllowedIPs</code> "/32". The clients only use their IP and the server only sends back their respective address.
</p>
<p>The interface can be managed manually using <span class="plainlinks archwiki-template-man" title="$ man 8 wg-quick"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/wg-quick.8">wg-quick(8)</a></span> or using a <a href="../en/Systemd.html" title="Systemd">systemd</a> service managed via <span class="plainlinks archwiki-template-man" title="$ man 1 systemctl"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemctl.1">systemctl(1)</a></span>.
</p>
<p>The interface may be brought up using <code>wg-quick up wg0</code> respectively by <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Start">starting</a> and potentially <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Enable">enabling</a> the interface via <code>wg-quick@<i>interface</i>.service</code>, e.g. <code>wg-quick@wg0.service</code>. To close the interface use <code>wg-quick down wg0</code> respectively <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Stop">stop</a> <code>wg-quick@<i>interface</i>.service</code>.
</p>
<h3><span class="mw-headline" id="Client_config">Client config</span></h3>
<p>Create the corresponding "client" config file(s):
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">foo.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Interface]
Address = 10.200.200.2/32
PrivateKey = <i>PEER_FOO_PRIVATE_KEY</i>
DNS = 10.200.200.1

[Peer]
PublicKey = <i>SERVER_PUBLICKEY</i>
PresharedKey = <i>PRE-SHARED_KEY</i>
Endpoint = my.ddns.example.com:51820
AllowedIPs = 0.0.0.0/0, ::/0</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">bar.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Interface]
Address = 10.200.200.3/32
PrivateKey = <i>PEER_BAR_PRIVATE_KEY</i>
DNS = 10.200.200.1

[Peer]
PublicKey = <i>SERVER_PUBLICKEY</i>
PresharedKey = <i>PRE-SHARED KEY</i>
Endpoint = my.ddns.example.com:51820
AllowedIPs = 0.0.0.0/0, ::/0</pre>
<p>Using the catch-all <code>AllowedIPs = 0.0.0.0/0, ::/0</code> will forward all IPv4 (<code>0.0.0.0/0</code>) and IPv6 (<code>::/0</code>) traffic over the VPN.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Users of <a href="../en/NetworkManager.html" title="NetworkManager">NetworkManager</a>, may need to <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Enable">enable</a> the <code>NetworkManager-wait-online.service</code> and users of <a href="../en/Systemd-networkd.html" title="Systemd-networkd">systemd-networkd</a> may need to <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Enable">enable</a> the <code>systemd-networkd-wait-online.service</code> to wait until devices are network ready before attempting wireguard connection.</div>
<h2><span class="mw-headline" id="Testing_the_tunnel">Testing the tunnel</span></h2>
<p>Once a tunnel has been established, one can use <a href="../en/Network_tools.html#Netcat" class="mw-redirect" title="Netcat">netcat</a> to send traffic through it to test out throughput, CPU usage, etc.
On one side of the tunnel, run <code>nc</code> in listen mode and on the other side, pipe some data from <code>/dev/zero</code> into <code>nc</code> in sending mode.
</p>
<p>In the example below, port 2222 is used for the traffic (be sure to allow traffic on port 2222 if using a firewall).
</p>
<p>On one side of the tunnel listen for traffic:
</p>
<pre>$ nc -vvlnp 2222
</pre>
<p>On the other side of the tunnel, send some traffic:
</p>
<pre>$ dd if=/dev/zero bs=1024K count=1024 | nc -v 10.0.0.203 2222
</pre>
<p>Status can be monitored using <code>wg</code> directly.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># wg</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">interface: wg0
  public key: UguPyBThx/+xMXeTbRYkKlP0Wh/QZT3vTLPOVaaXTD8=
  private key: (hidden)
  listening port: 51820

peer: 9jalV3EEBnVXahro0pRMQ+cHlmjE33Slo9tddzCVtCw=
  preshared key: (hidden)
  endpoint: 192.168.1.216:53207
  allowed ips: 10.0.0.0/0
  latest handshake: 1 minutes, 17 seconds ago
  transfer: 56.43 GiB received, 1.06 TiB sent</pre>
<h2><span class="mw-headline" id="Troubleshooting">Troubleshooting</span></h2>
<h3><span class="mw-headline" id="Routes_are_periodically_reset">Routes are periodically reset</span></h3>
<p>Users of <a href="../en/NetworkManager.html" title="NetworkManager">NetworkManager</a> should make sure that it <a href="../en/NetworkManager.html#Ignore_specific_devices" title="NetworkManager">is not managing</a> the WireGuard interface(s). For example, create the following configuration file:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/NetworkManager/conf.d/unmanaged.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[keyfile]
unmanaged-devices=interface-name:wg*</pre>
<h3><span class="mw-headline" id="Broken_DNS_resolution">Broken DNS resolution</span></h3>
<p>When tunneling all traffic through a WireGuard interface, the connection can become seemingly lost after a while or upon new connection. This could be caused by a <a href="../en/Network_configuration.html#Network_managers" class="mw-redirect" title="Network manager">network manager</a> or <a href="../en/Network_configuration.html#DHCP" class="mw-redirect" title="DHCP">DHCP</a> client overwriting <code>/etc/resolv.conf</code>.
</p>
<p>By default <i>wg-quick</i>  uses <i>resolvconf</i> to register new <a href="../en/Domain_name_resolution.html" class="mw-redirect" title="DNS">DNS</a> entries (from the <code>DNS</code> keyword in the configuration file). This will cause issues with <a href="../en/Network_configuration.html#Network_managers" class="mw-redirect" title="Network manager">network managers</a> and <a href="../en/Network_configuration.html#DHCP" class="mw-redirect" title="DHCP">DHCP</a> clients that do not use <i>resolvconf</i>, as they will overwrite <code>/etc/resolv.conf</code> thus removing the DNS servers added by wg-quick.
</p>
<p>The solution is to use networking software that supports <a href="../en/Openresolv.html" class="mw-redirect" title="Resolvconf">resolvconf</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Users of <a href="../en/Systemd-resolved.html" title="Systemd-resolved">systemd-resolved</a> should make sure that <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=systemd-resolvconf">systemd-resolvconf</a></span> is <a href="../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">installed</a>.</div>
<p>Users of <a href="../en/NetworkManager.html" title="NetworkManager">NetworkManager</a> should know that it does not use resolvconf by default.  It is recommended to use <a href="../en/Systemd-resolved.html" title="Systemd-resolved">systemd-resolved</a>.  If this is undesirable, <a href="../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">install</a> <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=openresolv">openresolv</a></span> and configure NetworkManager to use it: <a href="../en/NetworkManager.html#Use_openresolv" title="NetworkManager">NetworkManager#Use openresolv</a>.
</p>
<h3><span class="mw-headline" id="Low_MTU">Low MTU</span></h3>
<p>Due to too low MTU (lower than 1280), wg-quick may have failed to create the WireGuard interface. This can be solved by setting the MTU value in WireGuard configuration in Interface section on client.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/foo.config</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Interface]
Address = 10.200.200.2/24
MTU = 1500
PrivateKey = <i>PEER_FOO_PRIVATE_KEY</i>
DNS = 10.200.200.1</pre>
<h3><span class="mw-headline" id="Key_is_not_the_correct_length_or_format">Key is not the correct length or format</span></h3>
<p>To avoid the following error, put the key value in the configuration file and not the path to the key file.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># wg-quick up wg0</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[#] ip link add wg0 type wireguard
[#] wg setconf wg0 /dev/fd/63
Key is not the correct length or format: `<i>/path/example.key'</i>
Configuration parsing error
[#] ip link delete dev wg0
</pre>
<h3>
<span id="Unable_to_establish_a_persistent_connection_behind_NAT_.2F_firewall"></span><span class="mw-headline" id="Unable_to_establish_a_persistent_connection_behind_NAT_/_firewall">Unable to establish a persistent connection behind NAT / firewall</span>
</h3>
<p>By default WireGuard peers remain silent while they do not need to communicate, so peers located behind a NAT and/or <a href="../en/Category:Firewalls.html" class="mw-redirect" title="Firewall">firewall</a> may be unreachable from other peers until they reach out to other peers themselves (or the connection may time out). Adding <code>PersistentKeepalive = 25</code> to the <code>[Peer]</code> setting of a peer located behind a NAT and/or firewall can ensure that the connection remains open. 
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># Set the persistent-keepalive via command line (temporarily)</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[#] wg set wg0 peer $PUBKEY persistent-keepalive 25
</pre>
<h2><span class="mw-headline" id="Known_issues">Known issues</span></h2>
<h3><span class="mw-headline" id="Loop_routing">Loop routing</span></h3>
<p>Adding the endpoint IP to the allowed IPs list, the kernel will attempt to send handshakes to said device binding, rather than using the original route. This results in failed handshake attempts.
</p>
<p>As a workaround, the correct route to the endpoint needs to be manually added using
</p>
<pre>ip route add &lt;endpoint ip&gt; via &lt;gateway&gt; dev &lt;network interface&gt;
</pre>
<p>e.g. for peer B from above in a standard LAN setup:
</p>
<pre>ip route add 203.0.113.102 via 192.168.0.1 dev eth0
</pre>
<p>To make this route persistent the command can be added as <code>PostUp = ip route ...</code> to the <code>[Interface]</code> section of <code>wg0.conf</code>. However, on certain setups (e.g. using <code>wg-quick@.service</code> in combination with NetworkManager) this might fail on resume. Furthermore, this only works for a static network setup and fails if gateways or devices change (e.g. using ethernet or wifi on a laptop).
</p>
<p>Using NetworkManager, a more flexible solution is to start wireguard using an dispatcher script. As root, create
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/NetworkManager/dispatcher.d/50-wg0.sh</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">#!/bin/sh
case $2 in
  up)
    wg-quick up wg0
    ip route add &lt;endpoint ip&gt; via $IP4_GATEWAY dev $DEVICE_IP_IFACE
    ;;
  pre-down)
    wg-quick down wg0
    ;;
esac</pre>
<p>If not already running, start and enable <code>NetworkManager-dispatcher.service</code>.
Also, make sure that NetworkManager is not manging routes for <code>wg0</code> (<a href="#Routes_are_periodically_reset">see above</a>).
</p>
<h2><span class="mw-headline" id="Tips_and_tricks">Tips and tricks</span></h2>
<h3><span class="mw-headline" id="Vanity_keys">Vanity keys</span></h3>
<p>Currently, Wireguard does not support comments or attaching human-memorable names to keys.  This makes identifying the key's owner difficult particularly when multiple keys are in use.  One solution is to generate a public key that contains some familiar characters (perhaps the first few letters of the owner's name or of the hostname etc.), <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/wireguard-vanity-address/">wireguard-vanity-address</a></span><sup><small>AUR</small></sup> does this.
</p>
<h3><span class="mw-headline" id="Store_private_keys_in_encrypted_form">Store private keys in encrypted form</span></h3>
<p>It may be desirable to store private keys in encrypted form, such as through use of <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=pass">pass</a></span>. Just replace the PrivateKey line under [Interface] in the configuration file with:
</p>
<pre>PostUp = wg set %i private-key &lt;(su user -c "export PASSWORD_STORE_DIR=/path/to/your/store/; pass WireGuard/private-keys/%i")
</pre>
<p>where <i>user</i> is the Linux username of interest. See the <span class="plainlinks archwiki-template-man" title="$ man 8 wg-quick"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/wg-quick.8">wg-quick(8)</a></span> man page for more details.
</p>
<h3><span class="mw-headline" id="Endpoint_with_changing_IP">Endpoint with changing IP</span></h3>
<p>After resolving a server's domain, WireGuard <a rel="nofollow" class="external text" href="https://lists.zx2c4.com/pipermail/wireguard/2017-November/002028.html">will not check for changes in DNS again</a>.
</p>
<p>If the WireGuard server is frequently changing its IP-address due DHCP, Dyndns, IPv6, etc., any WireGuard client is going to lose its connection, until its endpoint is updated via something like <code>wg set "$INTERFACE" peer "$PUBLIC_KEY" endpoint "$ENDPOINT"</code>.
</p>
<p>Also be aware, if the endpoint is ever going to change its address (for example when moving to a new provider/datacenter), just updating DNS will not be enough, so periodically running reresolve-dns might make sense on any DNS-based setup.
</p>
<p>Luckily, <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=wireguard-tools">wireguard-tools</a></span> provides an example script <code>/usr/share/wireguard-tools/examples/reresolve-dns/reresolve-dns.sh</code>, that parses WG configuration files and automatically resets the endpoint address.
</p>
<p>One needs to run the <code>/usr/share/wireguard-tools/examples/reresolve-dns/reresolve-dns.sh /etc/wireguard/wg.conf</code> periodically to recover from an endpoint that has changed its IP.
</p>
<p>One way of doing so is by updating all WireGuard endpoints once every thirty seconds<a rel="nofollow" class="external autonumber" href="https://git.zx2c4.com/WireGuard/tree/contrib/examples/reresolve-dns/README">[6]</a> via a systemd timer:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/wireguard_reresolve-dns.timer</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=Periodically reresolve DNS of all WireGuard endpoints

[Timer]
OnCalendar=*:*:0/30

[Install]
WantedBy=timers.target</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/wireguard_reresolve-dns.service</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=Reresolve DNS of all WireGuard endpoints
Wants=network-online.target
After=network-online.target

[Service]
Type=oneshot
ExecStart=/bin/sh -c 'for i in /etc/wireguard/*.conf; do /usr/share/wireguard-tools/examples/reresolve-dns/reresolve-dns.sh "$i"; done'</pre>
<p>Afterwards <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Enable">enable</a> and <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Start">start</a> <code>wireguard_reresolve-dns.timer</code>
</p>
<h3><span class="mw-headline" id="Generate_QR_code">Generate QR code</span></h3>
<p>If the client is a mobile device such as a phone, <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=qrencode">qrencode</a></span> can be used to generate client's configuration QR code and display it in terminal:
</p>
<pre>$ qrencode -t ansiutf8 -r <i>client.conf</i>
</pre>
<h3><span class="mw-headline" id="Enable_debug_logs">Enable debug logs</span></h3>
<p>When using the Linux kernel module on a kernel that supports dynamic debugging, debugging information can be written into the kernel ring buffer (viewable with <a href="../en/Core_utilities.html#Essentials" class="mw-redirect" title="Dmesg">dmesg</a> and <a href="../en/Systemd/Journal.html" class="mw-redirect" title="Journalctl">journalctl</a>) by running:
</p>
<pre># modprobe wireguard 
# echo module wireguard +p &gt; /sys/kernel/debug/dynamic_debug/control
</pre>
<h3>
<span id="Reload_peer_.28server.29_configuration"></span><span class="mw-headline" id="Reload_peer_(server)_configuration">Reload peer (server) configuration</span>
</h3>
<p>In case the WireGuard peer (mostly server) adding or removing another peers from its configuration and wants to reload it without stopping any active sessions, one can execute the following command to do it:
</p>
<pre># wg syncconf ${WGNET} &lt;(wg-quick strip ${WGNET})
</pre>
<p>Where <code>$WGNET</code> is WireGuard interface name or configuration base name, for example <code>wg0</code> (for server) or <code>client</code> (without the .conf extension, for client).
</p>
<h2><span class="mw-headline" id="See_also">See also</span></h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/WireGuard" class="extiw" title="wikipedia:WireGuard">Wikipedia:WireGuard</a></li>
<li>
<a rel="nofollow" class="external text" href="https://www.wireguard.com/presentations/">Presentations by Jason Donenfeld</a>.</li>
<li><a rel="nofollow" class="external text" href="https://lists.zx2c4.com/mailman/listinfo/wireguard">Mailing list</a></li>
<li><a rel="nofollow" class="external text" href="https://docs.sweeting.me/s/wireguard">Unofficial WireGuard Documentation</a></li>
<li><a href="https://wiki.debian.org/Wireguard" class="extiw" title="debian:Wireguard">Debian:Wireguard</a></li>
</ul>
</div>
</div>
<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../en/Category:Virtual_Private_Network.html" title="Category:Virtual Private Network">Virtual Private Network</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden categories: <ul>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Expansion.html" title="Category:Pages or sections flagged with Template:Expansion">Pages or sections flagged with Template:Expansion</a></li>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Merge.html" title="Category:Pages or sections flagged with Template:Merge">Pages or sections flagged with Template:Merge</a></li>
</ul>
</div>
</div>
	</div>
</div>

<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
		<li>Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=WireGuard&amp;oldid=646140">https://wiki.archlinux.org/index.php?title=WireGuard&amp;oldid=646140</a>"</li>
		<li id="footer-info-lastmod"> This page was last edited on 21 December 2020, at 03:08.</li>
		<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="http://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
	<br>
</ul>
	<ul id="footer-places">
		<li id="footer-places-privacy"><a href="../en/ArchWiki:Privacy_policy.html" title="ArchWiki:Privacy policy">Privacy policy</a></li>
		<li id="footer-places-about"><a href="../en/ArchWiki:About.html" title="ArchWiki:About">About ArchWiki</a></li>
		<li id="footer-places-disclaimer"><a href="../en/ArchWiki:General_disclaimer.html" title="ArchWiki:General disclaimer">Disclaimers</a></li>
	</ul>
	<ul id="footer-icons" class="noprint">
		<li id="footer-copyrightico">
	</ul>
	<div style="clear: both;"></div>
</footer>



</body>
</html>
