<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>OpenSSH - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.35.0">
<meta name="robots" content="noindex,follow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="http://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-OpenSSH rootpage-OpenSSH skin-vector action-view skin-vector-legacy">
<div id="content" class="mw-body" role="main" style="margin: 0">
	<a id="top"></a>
	<div id="siteNotice" class="mw-body-content"></div>
	<div class="mw-indicators mw-body-content">
	</div>
	<h1 id="firstHeading" class="firstHeading" lang="en">OpenSSH</h1>
	<div id="bodyContent" class="mw-body-content">
		<div id="siteSub" class="noprint">From ArchWiki</div>
		<div id="contentSub"></div>
		<div id="contentSub2"></div>
		
		<div id="jump-to-nav"></div>
		<a class="mw-jump-link" href="#mw-head">Jump to navigation</a>
		<a class="mw-jump-link" href="#searchInput">Jump to search</a>
		<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr">
<div class="warningbox">The printable version is no longer supported and may have rendering errors. Please update your browser bookmarks and please use the default browser print function instead.</div>
<div class="mw-parser-output">
<div class="archwiki-template-meta-related-articles-start">
<p>Related articles</p>
<ul>
<li><a href="../en/SSH_keys.html" title="SSH keys">SSH keys</a></li>
<li><a href="../en/Pam_abl.html" title="Pam abl">Pam abl</a></li>
<li><a href="../en/Fail2ban.html" title="Fail2ban">fail2ban</a></li>
<li><a href="../en/Sshguard.html" title="Sshguard">sshguard</a></li>
<li><a href="../en/SSHFS.html" class="mw-redirect" title="Sshfs">Sshfs</a></li>
<li><a href="../en/Syslog-ng.html" title="Syslog-ng">Syslog-ng</a></li>
<li><a href="../en/SFTP_chroot.html" title="SFTP chroot">SFTP chroot</a></li>
<li><a href="../en/SCP_and_SFTP.html" title="SCP and SFTP">SCP and SFTP</a></li>
<li><a href="../en/VPN_over_SSH.html" title="VPN over SSH">VPN over SSH</a></li>
</ul>
</div>
<p><a href="https://en.wikipedia.org/wiki/OpenSSH" class="extiw" title="wikipedia:OpenSSH">OpenSSH</a> (OpenBSD Secure Shell) is a set of computer programs providing encrypted communication sessions over a computer network using the <a href="../en/Secure_Shell.html" title="Secure Shell">Secure Shell</a> (SSH) protocol. It was created as an open source alternative to the proprietary Secure Shell software suite offered by SSH Communications Security. OpenSSH is developed as part of the OpenBSD project, which is led by Theo de Raadt.
</p>
<p>OpenSSH is occasionally confused with the similarly-named OpenSSL; however, the projects have different purposes and are developed by different teams, the similar name is drawn only from similar goals.
</p>
<div id="toc" class="toc" role="navigation" aria-labelledby="mw-toc-heading">
<input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none"><div class="toctitle" lang="en" dir="ltr">
<h2 id="mw-toc-heading">Contents</h2>
<span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span>
</div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Installation"><span class="tocnumber">1</span> <span class="toctext">Installation</span></a></li>
<li class="toclevel-1 tocsection-2">
<a href="#Client_usage"><span class="tocnumber">2</span> <span class="toctext">Client usage</span></a>
<ul>
<li class="toclevel-2 tocsection-3"><a href="#Configuration"><span class="tocnumber">2.1</span> <span class="toctext">Configuration</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-4">
<a href="#Server_usage"><span class="tocnumber">3</span> <span class="toctext">Server usage</span></a>
<ul>
<li class="toclevel-2 tocsection-5"><a href="#Configuration_2"><span class="tocnumber">3.1</span> <span class="toctext">Configuration</span></a></li>
<li class="toclevel-2 tocsection-6"><a href="#Daemon_management"><span class="tocnumber">3.2</span> <span class="toctext">Daemon management</span></a></li>
<li class="toclevel-2 tocsection-7">
<a href="#Protection"><span class="tocnumber">3.3</span> <span class="toctext">Protection</span></a>
<ul>
<li class="toclevel-3 tocsection-8"><a href="#Force_public_key_authentication"><span class="tocnumber">3.3.1</span> <span class="toctext">Force public key authentication</span></a></li>
<li class="toclevel-3 tocsection-9">
<a href="#Two-factor_authentication_and_public_keys"><span class="tocnumber">3.3.2</span> <span class="toctext">Two-factor authentication and public keys</span></a>
<ul>
<li class="toclevel-4 tocsection-10"><a href="#Authentication_providers"><span class="tocnumber">3.3.2.1</span> <span class="toctext">Authentication providers</span></a></li>
<li class="toclevel-4 tocsection-11"><a href="#PAM_setup"><span class="tocnumber">3.3.2.2</span> <span class="toctext">PAM setup</span></a></li>
</ul>
</li>
<li class="toclevel-3 tocsection-12"><a href="#Protecting_against_brute_force_attacks"><span class="tocnumber">3.3.3</span> <span class="toctext">Protecting against brute force attacks</span></a></li>
<li class="toclevel-3 tocsection-13">
<a href="#Limit_root_login"><span class="tocnumber">3.3.4</span> <span class="toctext">Limit root login</span></a>
<ul>
<li class="toclevel-4 tocsection-14"><a href="#Deny"><span class="tocnumber">3.3.4.1</span> <span class="toctext">Deny</span></a></li>
<li class="toclevel-4 tocsection-15"><a href="#Restrict"><span class="tocnumber">3.3.4.2</span> <span class="toctext">Restrict</span></a></li>
</ul>
</li>
<li class="toclevel-3 tocsection-16"><a href="#Securing_the_authorized_keys_file"><span class="tocnumber">3.3.5</span> <span class="toctext">Securing the authorized_keys file</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-17">
<a href="#Tips_and_tricks"><span class="tocnumber">4</span> <span class="toctext">Tips and tricks</span></a>
<ul>
<li class="toclevel-2 tocsection-18">
<a href="#Encrypted_SOCKS_tunnel"><span class="tocnumber">4.1</span> <span class="toctext">Encrypted SOCKS tunnel</span></a>
<ul>
<li class="toclevel-3 tocsection-19"><a href="#Step_1:_start_the_connection"><span class="tocnumber">4.1.1</span> <span class="toctext">Step 1: start the connection</span></a></li>
<li class="toclevel-3 tocsection-20"><a href="#Step_2_(Variant_A):_configure_your_browser_(or_other_programs)"><span class="tocnumber">4.1.2</span> <span class="toctext">Step 2 (Variant A): configure your browser (or other programs)</span></a></li>
<li class="toclevel-3 tocsection-21"><a href="#Step_2_(Variant_B):_set_up_a_local_TUN_interface"><span class="tocnumber">4.1.3</span> <span class="toctext">Step 2 (Variant B): set up a local TUN interface</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-22">
<a href="#X11_forwarding"><span class="tocnumber">4.2</span> <span class="toctext">X11 forwarding</span></a>
<ul>
<li class="toclevel-3 tocsection-23">
<a href="#Setup"><span class="tocnumber">4.2.1</span> <span class="toctext">Setup</span></a>
<ul>
<li class="toclevel-4 tocsection-24"><a href="#Remote"><span class="tocnumber">4.2.1.1</span> <span class="toctext">Remote</span></a></li>
<li class="toclevel-4 tocsection-25"><a href="#Client"><span class="tocnumber">4.2.1.2</span> <span class="toctext">Client</span></a></li>
</ul>
</li>
<li class="toclevel-3 tocsection-26"><a href="#Usage"><span class="tocnumber">4.2.2</span> <span class="toctext">Usage</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-27"><a href="#Forwarding_other_ports"><span class="tocnumber">4.3</span> <span class="toctext">Forwarding other ports</span></a></li>
<li class="toclevel-2 tocsection-28"><a href="#Jump_hosts"><span class="tocnumber">4.4</span> <span class="toctext">Jump hosts</span></a></li>
<li class="toclevel-2 tocsection-29"><a href="#Reverse_SSH_through_a_relay"><span class="tocnumber">4.5</span> <span class="toctext">Reverse SSH through a relay</span></a></li>
<li class="toclevel-2 tocsection-30"><a href="#Multiplexing"><span class="tocnumber">4.6</span> <span class="toctext">Multiplexing</span></a></li>
<li class="toclevel-2 tocsection-31"><a href="#Speeding_up_SSH"><span class="tocnumber">4.7</span> <span class="toctext">Speeding up SSH</span></a></li>
<li class="toclevel-2 tocsection-32"><a href="#Mounting_a_remote_filesystem_with_SSHFS"><span class="tocnumber">4.8</span> <span class="toctext">Mounting a remote filesystem with SSHFS</span></a></li>
<li class="toclevel-2 tocsection-33"><a href="#Keep_alive"><span class="tocnumber">4.9</span> <span class="toctext">Keep alive</span></a></li>
<li class="toclevel-2 tocsection-34"><a href="#Automatically_restart_SSH_tunnels_with_systemd"><span class="tocnumber">4.10</span> <span class="toctext">Automatically restart SSH tunnels with systemd</span></a></li>
<li class="toclevel-2 tocsection-35">
<a href="#Autossh_-_automatically_restarts_SSH_sessions_and_tunnels"><span class="tocnumber">4.11</span> <span class="toctext">Autossh - automatically restarts SSH sessions and tunnels</span></a>
<ul>
<li class="toclevel-3 tocsection-36"><a href="#Run_autossh_automatically_at_boot_via_systemd"><span class="tocnumber">4.11.1</span> <span class="toctext">Run autossh automatically at boot via systemd</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-37"><a href="#Alternative_service_should_SSH_daemon_fail"><span class="tocnumber">4.12</span> <span class="toctext">Alternative service should SSH daemon fail</span></a></li>
<li class="toclevel-2 tocsection-38"><a href="#Terminal_background_color_based_on_host"><span class="tocnumber">4.13</span> <span class="toctext">Terminal background color based on host</span></a></li>
<li class="toclevel-2 tocsection-39"><a href="#Network_specific_configuration"><span class="tocnumber">4.14</span> <span class="toctext">Network specific configuration</span></a></li>
<li class="toclevel-2 tocsection-40"><a href="#Private_networks_hostkeys_verification"><span class="tocnumber">4.15</span> <span class="toctext">Private networks hostkeys verification</span></a></li>
<li class="toclevel-2 tocsection-41"><a href="#Run_command_at_login"><span class="tocnumber">4.16</span> <span class="toctext">Run command at login</span></a></li>
<li class="toclevel-2 tocsection-42"><a href="#Agent_forwarding"><span class="tocnumber">4.17</span> <span class="toctext">Agent forwarding</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-43">
<a href="#Troubleshooting"><span class="tocnumber">5</span> <span class="toctext">Troubleshooting</span></a>
<ul>
<li class="toclevel-2 tocsection-44"><a href="#Checklist"><span class="tocnumber">5.1</span> <span class="toctext">Checklist</span></a></li>
<li class="toclevel-2 tocsection-45">
<a href="#Connection_refused_or_timeout_problem"><span class="tocnumber">5.2</span> <span class="toctext">Connection refused or timeout problem</span></a>
<ul>
<li class="toclevel-3 tocsection-46"><a href="#Port_forwarding"><span class="tocnumber">5.2.1</span> <span class="toctext">Port forwarding</span></a></li>
<li class="toclevel-3 tocsection-47"><a href="#Is_SSH_running_and_listening?"><span class="tocnumber">5.2.2</span> <span class="toctext">Is SSH running and listening?</span></a></li>
<li class="toclevel-3 tocsection-48"><a href="#Are_there_firewall_rules_blocking_the_connection?"><span class="tocnumber">5.2.3</span> <span class="toctext">Are there firewall rules blocking the connection?</span></a></li>
<li class="toclevel-3 tocsection-49"><a href="#Is_the_traffic_even_getting_to_your_computer?"><span class="tocnumber">5.2.4</span> <span class="toctext">Is the traffic even getting to your computer?</span></a></li>
<li class="toclevel-3 tocsection-50">
<a href="#Your_ISP_or_a_third_party_blocking_default_port?"><span class="tocnumber">5.2.5</span> <span class="toctext">Your ISP or a third party blocking default port?</span></a>
<ul>
<li class="toclevel-4 tocsection-51"><a href="#Diagnosis"><span class="tocnumber">5.2.5.1</span> <span class="toctext">Diagnosis</span></a></li>
<li class="toclevel-4 tocsection-52"><a href="#Possible_solution"><span class="tocnumber">5.2.5.2</span> <span class="toctext">Possible solution</span></a></li>
</ul>
</li>
<li class="toclevel-3 tocsection-53"><a href="#Read_from_socket_failed:_connection_reset_by_peer"><span class="tocnumber">5.2.6</span> <span class="toctext">Read from socket failed: connection reset by peer</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-54"><a href="#%22%5Byour_shell%5D:_No_such_file_or_directory%22_/_ssh_exchange_identification_problem"><span class="tocnumber">5.3</span> <span class="toctext">"[your shell]: No such file or directory" / ssh_exchange_identification problem</span></a></li>
<li class="toclevel-2 tocsection-55">
<a href="#%22Terminal_unknown%22_or_%22Error_opening_terminal%22_error_message"><span class="tocnumber">5.4</span> <span class="toctext">"Terminal unknown" or  "Error opening terminal" error message</span></a>
<ul>
<li class="toclevel-3 tocsection-56"><a href="#TERM_hack"><span class="tocnumber">5.4.1</span> <span class="toctext">TERM hack</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-57"><a href="#Connection_closed_by_x.x.x.x_%5Bpreauth%5D"><span class="tocnumber">5.5</span> <span class="toctext">Connection closed by x.x.x.x [preauth]</span></a></li>
<li class="toclevel-2 tocsection-58"><a href="#id_dsa_refused_by_OpenSSH_7.0"><span class="tocnumber">5.6</span> <span class="toctext">id_dsa refused by OpenSSH 7.0</span></a></li>
<li class="toclevel-2 tocsection-59"><a href="#No_matching_key_exchange_method_found_by_OpenSSH_7.0"><span class="tocnumber">5.7</span> <span class="toctext">No matching key exchange method found by OpenSSH 7.0</span></a></li>
<li class="toclevel-2 tocsection-60"><a href="#tmux/screen_session_killed_when_disconnecting_from_SSH"><span class="tocnumber">5.8</span> <span class="toctext">tmux/screen session killed when disconnecting from SSH</span></a></li>
<li class="toclevel-2 tocsection-61"><a href="#SSH_session_stops_responding"><span class="tocnumber">5.9</span> <span class="toctext">SSH session stops responding</span></a></li>
<li class="toclevel-2 tocsection-62"><a href="#Broken_pipe"><span class="tocnumber">5.10</span> <span class="toctext">Broken pipe</span></a></li>
<li class="toclevel-2 tocsection-63"><a href="#Slow_daemon_startup_after_reboot"><span class="tocnumber">5.11</span> <span class="toctext">Slow daemon startup after reboot</span></a></li>
<li class="toclevel-2 tocsection-64"><a href="#Terminate_unresponsive_SSH_connection"><span class="tocnumber">5.12</span> <span class="toctext">Terminate unresponsive SSH connection</span></a></li>
<li class="toclevel-2 tocsection-65"><a href="#WARNING:_REMOTE_HOST_IDENTIFICATION_HAS_CHANGED!"><span class="tocnumber">5.13</span> <span class="toctext">WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-66"><a href="#See_also"><span class="tocnumber">6</span> <span class="toctext">See also</span></a></li>
</ul>
</div>

<h2><span class="mw-headline" id="Installation">Installation</span></h2>
<p><a href="../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">Install</a> the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=openssh">openssh</a></span> package.
</p>
<h2><span class="mw-headline" id="Client_usage">Client usage</span></h2>
<p>To connect to a server, run:
</p>
<pre>$ ssh -p <i>port</i> <i>user</i>@<i>server-address</i>
</pre>
<p>If the server only allows public-key authentication, follow <a href="../en/SSH_keys.html" title="SSH keys">SSH keys</a>.
</p>
<h3><span class="mw-headline" id="Configuration">Configuration</span></h3>
<p>The client can be configured to store common options and hosts. All options can be declared globally or restricted to specific hosts. For example:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">~/.ssh/config</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;"># global options
User <i>user</i>

# host-specific options
Host <i>myserver</i>
    Hostname <i>server-address</i>
    Port     <i>port</i>
</pre>
<p>With such a configuration, the following commands are equivalent
</p>
<pre>$ ssh -p <i>port</i> <i>user</i>@<i>server-address</i>
$ ssh <i>myserver</i>
</pre>
<p>See <span class="plainlinks archwiki-template-man" title="$ man 5 ssh_config"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/ssh_config.5">ssh_config(5)</a></span> for more information.
</p>
<p>Some options do not have command line switch equivalents, but you can specify config options on the command line with <code>-o</code>. For example <code>-oKexAlgorithms=+diffie-hellman-group1-sha1</code>.
</p>
<h2><span class="mw-headline" id="Server_usage">Server usage</span></h2>
<p><code>sshd</code> is the OpenSSH server daemon, configured with <code>/etc/ssh/sshd_config</code> and managed by <code>sshd.service</code>. Whenever changing the configuration, use <code>sshd</code> in test mode before restarting the service to ensure it will be able to start cleanly. Valid configurations produce no output.
</p>
<pre># sshd -t
</pre>
<h3><span class="mw-headline" id="Configuration_2">Configuration</span></h3>
<p>To allow access only for some users add this line:
</p>
<pre>AllowUsers    <i>user1 user2</i>
</pre>
<p>To allow access only for some groups:
</p>
<pre>AllowGroups   <i>group1 group2</i>
</pre>
<p>To add a nice welcome message (e.g. from the <code>/etc/issue</code> file), configure the <code>Banner</code> option:
</p>
<pre>Banner /etc/issue
</pre>
<p>Public and private host keys are automatically generated in <code>/etc/ssh</code> by the <i>sshdgenkeys</i> <a href="#Daemon_management">service</a> and regenerated if missing even if <code>HostKeyAlgorithms</code> option in <code>sshd_config</code> allows only some. Four key pairs are provided based on the algorithms <a href="../en/SSH_keys.html#Choosing_the_authentication_key_type" title="SSH keys">dsa, rsa, ecdsa and ed25519</a>. To have sshd use a particular key, specify the following option:
</p>
<pre>HostKey /etc/ssh/ssh_host_rsa_key
</pre>
<p>If the server is to be exposed to the WAN, it is recommended to change the default port from 22 to a random higher one like this:
</p>
<pre>Port 39901
</pre>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> 
<ul>
<li>To help select an alternative port that is not already assigned to a common service, review the <a href="https://en.wikipedia.org/wiki/List_of_TCP_and_UDP_port_numbers" class="extiw" title="wikipedia:List of TCP and UDP port numbers">list of TCP and UDP port numbers</a>. You can also find port information locally in <code>/etc/services</code>. A port change from default port 22 will reduce the number of log entries caused by automated authentication attempts but will not eliminate them. See <a href="../en/Port_knocking.html" title="Port knocking">Port knocking</a> for related information.</li>
<li>It is recommended to disable password logins entirely. This will greatly increase security, see <a href="#Force_public_key_authentication">#Force public key authentication</a> for more information. See <a href="#Protection">#Protection</a> for more recommend security methods.</li>
<li>OpenSSH can listen to multiple ports simply by having multiple <code>Port <i>port_number</i></code> lines in the config file.</li>
<li>New (or missing) host key pairs can be generated by removing the pair(s) that you want to replace from <code>/etc/ssh</code> and running <code>ssh-keygen -A</code> as root.</li>
</ul>
</div>
<h3><span class="mw-headline" id="Daemon_management">Daemon management</span></h3>
<p><a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Start/enable">Start/enable</a> <code>sshd.service</code>. It will keep the SSH daemon permanently active and fork for each incoming connection.<a rel="nofollow" class="external autonumber" href="https://github.com/archlinux/svntogit-packages/blob/packages/openssh/trunk/sshd.service">[1]</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=openssh">openssh</a></span> 8.0p1-3 removed <code>sshd.socket</code> that used systemd's socket activation due to it being susceptible to denial of service. See <a rel="nofollow" class="external text" href="https://bugs.archlinux.org/task/62248">FS#62248</a> for details. If <code>sshd.socket</code> is enabled when updating to <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=openssh">openssh</a></span> 8.0p1-3, the <code>sshd.socket</code> and <code>sshd@.service</code> units will be copied to <code>/etc/systemd/system/</code> and <a href="../en/Systemd.html#Replacement_unit_files" title="Systemd">reenabled</a>. This is only done to not break existing setups, users are still advised to migrate to <code>sshd.service</code>.</div>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> If you continue using <code>sshd.socket</code>, be aware of its issues:
<ul>
<li>
<code>sshd.socket</code> unit may fail (e.g. due to out-of-memory situation) and <code>Restart=always</code> cannot be specified on socket units. See <a rel="nofollow" class="external text" href="https://github.com/systemd/systemd/issues/11553">systemd issue  11553</a>.</li>
<li>Using socket activation can result in denial of service, as too many connections can cause refusal to further activate the service. See <a rel="nofollow" class="external text" href="https://bugs.archlinux.org/task/62248">FS#62248</a>.</li>
</ul>
</div>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Using <code>sshd.socket</code> negates the <code>ListenAddress</code> setting, so it will allow connections over any address. To achieve the effect of setting <code>ListenAddress</code>, you must specify the port <i>and</i> IP for <code>ListenStream</code> (e.g. <code>ListenStream=192.168.1.100:22</code>) by <a href="../en/Systemd.html#Editing_provided_units" class="mw-redirect" title="Edit">editing</a> <code>sshd.socket</code>. You must also add <code>FreeBind=true</code> under <code>[Socket]</code> or else setting the IP address will have the same drawback as setting <code>ListenAddress</code>: the socket will fail to start if the network is not up in time.</div>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> When using socket activation a transient instance of <code>sshd@.service</code> will be started for each connection (with different instance names). Therefore, neither <code>sshd.socket</code> nor the daemon's regular <code>sshd.service</code> allow to monitor connection attempts in the log. The logs of socket-activated instances of SSH can be seen with <code>journalctl -u "sshd@*"</code> or with <code>journalctl /usr/bin/sshd</code>.</div>
<h3><span class="mw-headline" id="Protection">Protection</span></h3>
<p>Allowing remote log-on through SSH is good for administrative purposes, but can pose a threat to your server's security. Often the target of brute force attacks, SSH access needs to be limited properly to prevent third parties gaining access to your server.
</p>
<p>Several other good guides and tools are available on the topic, for example:
</p>
<ul>
<li><a href="https://wiki.mozilla.org/Security/Guidelines/OpenSSH" class="extiw" title="mozillawiki:Security/Guidelines/OpenSSH">Article by Mozilla Infosec Team</a></li>
<li><a rel="nofollow" class="external text" href="https://github.com/mozilla/ssh_scan">Mozilla ssh_scan</a></li>
<li><a rel="nofollow" class="external text" href="https://stribika.github.io/2015/01/04/secure-secure-shell.html">Secure sshd</a></li>
</ul>
<h4><span class="mw-headline" id="Force_public_key_authentication">Force public key authentication</span></h4>
<p>If a client cannot authenticate through a public key, by default the SSH server falls back to password authentication, thus allowing a malicious user to attempt to gain access by <a href="#Protecting_against_brute_force_attacks">brute-forcing</a> the password. One of the most effective ways to protect against this attack is to disable password logins entirely, and force the use of <a href="../en/SSH_keys.html" title="SSH keys">SSH keys</a>. This can be accomplished by disabling the following options in the daemon configuration file:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/ssh/sshd_config</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">PasswordAuthentication no</pre>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> Before adding this to your configuration, make sure that all accounts which require SSH access have public-key authentication set up in the corresponding <code>authorized_keys</code> files. See <a href="../en/SSH_keys.html#Copying_the_public_key_to_the_remote_server" title="SSH keys">SSH keys#Copying the public key to the remote server</a> for more information.</div>
<h4><span class="mw-headline" id="Two-factor_authentication_and_public_keys">Two-factor authentication and public keys</span></h4>
<p>SSH can be set up to require multiple ways of authentication, you can tell which authentication methods are required using the <code>AuthenticationMethods</code> option. This enables you to use public keys as well as a two-factor authorization.
</p>
<h5><span class="mw-headline" id="Authentication_providers">Authentication providers</span></h5>
<p>See <a href="../en/Google_Authenticator.html" title="Google Authenticator">Google Authenticator</a> to set up Google Authenticator.
</p>
<p>For <a rel="nofollow" class="external text" href="https://duo.com/">Duo</a>, <a href="../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">install</a> <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/duo_unix/">duo_unix</a></span><sup><small>AUR</small></sup> which will supply the <code>pam_duo.so</code> module. Read the <a rel="nofollow" class="external text" href="https://duo.com/docs/duounix">Duo Unix documentation</a> for instructions on how to setup the necessary Duo credentials (Integration Key, Secret Key, API Hostname).
</p>
<h5><span class="mw-headline" id="PAM_setup">PAM setup</span></h5>
<p>To use <a href="../en/PAM.html" title="PAM">PAM</a> with OpenSSH, edit the following files:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/ssh/sshd_config</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">ChallengeResponseAuthentication yes
AuthenticationMethods publickey keyboard-interactive:pam
</pre>
<p>Then you can log in with either a publickey <b>or</b> the user authentication as required by your PAM setup.
</p>
<p>If, on the other hand, you want to authenticate the user on both a publickey <b>and</b> the user authentication as required by your PAM setup, use a comma instead of a space to separate the AuthenticationMethods:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/ssh/sshd_config</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">ChallengeResponseAuthentication yes
AuthenticationMethods publickey<b>,</b>keyboard-interactive:pam
</pre>
<p>With required pubkey <b>and</b> pam authentication you may wish to disable the password requirement:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/pam.d/sshd</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">auth      required  pam_securetty.so     #disable remote root
#Require google authenticator
auth      required  pam_google_authenticator.so
#But not password
#auth      include   system-remote-login
account   include   system-remote-login
password  include   system-remote-login
session   include   system-remote-login
</pre>
<h4><span class="mw-headline" id="Protecting_against_brute_force_attacks">Protecting against brute force attacks</span></h4>
<p>Brute forcing is a simple concept: one continuously tries to log in to a webpage or server log-in prompt like SSH with a high number of random username and password combinations.
</p>
<p>See <a href="../en/Uncomplicated_Firewall.html#Rate_limiting_with_ufw" class="mw-redirect" title="Ufw">ufw#Rate limiting with ufw</a> or <a href="../en/Simple_stateful_firewall.html#Bruteforce_attacks" title="Simple stateful firewall">Simple stateful firewall#Bruteforce attacks</a> for <a href="../en/Iptables.html" title="Iptables">iptables</a>.
</p>
<p>Alternatively, you can protect yourself from brute force attacks by using an automated script that blocks anybody trying to brute force their way in, for example <a href="../en/Fail2ban.html" title="Fail2ban">fail2ban</a> or <a href="../en/Sshguard.html" title="Sshguard">sshguard</a>.
</p>
<ul>
<li>Only allow incoming SSH connections from trusted locations</li>
<li>Use <a href="../en/Fail2ban.html" title="Fail2ban">fail2ban</a> or <a href="../en/Sshguard.html" title="Sshguard">sshguard</a> to automatically block IP addresses that fail password authentication too many times.</li>
<li>Use <a rel="nofollow" class="external text" href="https://github.com/jtniehof/pam_shield">pam_shield</a> to block IP addresses that perform too many login attempts within a certain period of time. In contrast to <a href="../en/Fail2ban.html" title="Fail2ban">fail2ban</a> or <a href="../en/Sshguard.html" title="Sshguard">sshguard</a>, this program does not take login success or failure into account.</li>
</ul>
<h4><span class="mw-headline" id="Limit_root_login">Limit root login</span></h4>
<div class="noprint archwiki-template-message">
<p><a href="../File:Tango-view-refresh-red.png" class="image"><img alt="Tango-view-refresh-red.png" src="../File:Tango-view-refresh-red.png" decoding="async" width="48" height="48"></a><b>This article or section is out of date.</b><a href="../File:Tango-view-refresh-red.png" class="image"><img alt="Tango-view-refresh-red.png" src="../File:Tango-view-refresh-red.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>Reason:</b> Root login has been disabled by default upstream in the current version.  Unclear to me what parts of this section and subsections are redundant. (Discuss in <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php/Talk:OpenSSH">Talk:OpenSSH#</a>)</div>
</div>
<p>It is generally considered bad practice to allow the root user to log in without restraint over SSH. There are two methods by which SSH root access can be restricted for increased security.
</p>
<h5><span class="mw-headline" id="Deny">Deny</span></h5>
<p>Sudo selectively provides root rights for actions requiring these without requiring authenticating against the root account. This allows locking the root account against access via SSH and potentially functions as a security measure against brute force attacks, since now an attacker must guess the account name in addition to the password.
</p>
<p>SSH can be configured to deny remote logins with the root user by editing the "Authentication" section in the daemon configuration file. Simply set <code>PermitRootLogin</code> to <code>no</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/ssh/sshd_config</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">PermitRootLogin no</pre>
<p>Next, <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Restart">restart</a> the SSH daemon.
</p>
<p>You will now be unable to log in through SSH under root, but will still be able to log in with your normal user and use <a href="../en/Su.html" title="Su">su</a> or <a href="../en/Sudo.html" title="Sudo">sudo</a> to do system administration.
</p>
<h5><span class="mw-headline" id="Restrict">Restrict</span></h5>
<p>Some automated tasks such as remote, full-system backup require full root access. To allow these in a secure way, instead of disabling root login via SSH, it is possible to only allow root logins for selected commands. This can be achieved by editing <code>~root/.ssh/authorized_keys</code>, by prefixing the desired key, e.g. as follows:
</p>
<pre>command="/usr/lib/rsync/rrsync -ro /" ssh-rsa â€¦
</pre>
<p>This will allow any login with this specific key only to execute the command specified between the quotes.
</p>
<p>The increased attack surface created by exposing the root user name at login can be compensated by adding the following to <code>sshd_config</code>:
</p>
<pre>PermitRootLogin forced-commands-only
</pre>
<p>This setting will not only restrict the commands which root may execute via SSH, but it will also disable the use of passwords, forcing use of public key authentication for the root account.
</p>
<p>A slightly less restrictive alternative will allow any command for root, but makes brute force attacks infeasible by enforcing public key authentication. For this option, set:
</p>
<pre>PermitRootLogin prohibit-password
</pre>
<h4><span class="mw-headline" id="Securing_the_authorized_keys_file">Securing the authorized_keys file</span></h4>
<div class="noprint archwiki-template-message">
<p><a href="../File:Tango-inaccurate.png" class="image"><img alt="Tango-inaccurate.png" src="../File:Tango-inaccurate.png" decoding="async" width="48" height="48"></a><b>The factual accuracy of this article or section is disputed.</b><a href="../File:Tango-inaccurate.png" class="image"><img alt="Tango-inaccurate.png" src="../File:Tango-inaccurate.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>Reason:</b> The immutable bit can be simply removed, so it does not "secure" anything". (Discuss in <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php/Talk:OpenSSH">Talk:OpenSSH#</a>)</div>
</div>
<p>For additional protection, you can prevent users from adding new public keys and connecting from them.
</p>
<p>In the server, make the <code>authorized_keys</code> file read-only for the user and deny all other permissions:
</p>
<pre>$ chmod 400 ~/.ssh/authorized_keys
</pre>
<p>To keep the user from simply changing the permissions back, <a href="../en/File_permissions_and_attributes.html#chattr_and_lsattr" title="File permissions and attributes">set the immutable bit</a> on the <code>authorized_keys</code> file. After that the user could rename the <code>~/.ssh</code> directory to something else and create a new <code>~/.ssh</code> directory and <code>authorized_keys</code> file. To prevent this, set the immutable bit on the <code>~/.ssh</code> directory too.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> If you find yourself needing to add a new key, you will first have to remove the immutable bit from <code>authorized_keys</code> and make it writable. Follow the steps above to secure it again.</div>
<h2><span class="mw-headline" id="Tips_and_tricks">Tips and tricks</span></h2>
<h3><span class="mw-headline" id="Encrypted_SOCKS_tunnel">Encrypted SOCKS tunnel</span></h3>
<p>This is highly useful for laptop users connected to various unsafe wireless connections. The only thing you need is an SSH server running at a somewhat secure location, like your home or at work. It might be useful to use a dynamic DNS service like <a rel="nofollow" class="external text" href="https://dyn.com/dns/">DynDNS</a> so you do not have to remember your IP-address.
</p>
<h4><span class="mw-headline" id="Step_1:_start_the_connection">Step 1: start the connection</span></h4>
<p>You only have to execute this single command to start the connection:
</p>
<pre>$ ssh -TND 4711 <i>user</i>@<i>host</i>
</pre>
<p>where <code><i>user</i></code> is your username at the SSH server running at the <code><i>host</i></code>. It will ask for your password, and then you are connected. The <code>N</code> flag disables the interactive prompt, and the <code>D</code> flag specifies the local port on which to listen on (you can choose any port number if you want).  The <code>T</code> flag disables pseudo-tty allocation.
</p>
<p>It is nice to add the verbose (<code>-v</code>) flag, because then you can verify that it is actually connected from that output.
</p>
<h4>
<span id="Step_2_.28Variant_A.29:_configure_your_browser_.28or_other_programs.29"></span><span class="mw-headline" id="Step_2_(Variant_A):_configure_your_browser_(or_other_programs)">Step 2 (Variant A): configure your browser (or other programs)</span>
</h4>
<p>The above step is useful only in combination with a web browser or another program that uses this newly created SOCKS tunnel. Since SSH currently supports both SOCKS v4 and SOCKS v5, you can use either of them.
</p>
<ul><li>For Firefox: At <i>Preferences &gt; General</i> navigates to the bottom of the page and click <i>Settings...</i>, which is to the right of the Network Settings title. Next, within the new semi window, check the <i>Manual proxy configuration</i> option and enter <code>localhost</code> in the <i>SOCKS host</i> text field, and the port number in the <i>Port</i> text field (<code>4711</code> in the example above) next to it.</li></ul>
<dl>
<dd>Firefox does not automatically make DNS requests through the socks tunnel. This potential privacy concern can be mitigated by scrolling further down, checking in the <i>Proxy DNS when using SOCKS v5</i>. Obviously, this will only work if you chooses SOCKS v5 rather then v4.</dd>
<dd>Restart Firefox to activate these settings.</dd>
</dl>
<ul><li>For Chromium: You can set the SOCKS settings as environment variables or as command line options. I recommend to add one of the following functions to your <code>.bashrc</code>:</li></ul>
<pre>function secure_chromium {
    port=4711
    export SOCKS_SERVER=localhost:$port
    export SOCKS_VERSION=5
    chromium &amp;
    exit
}
</pre>
<p>OR
</p>
<pre>function secure_chromium {
    port=4711
    chromium --proxy-server="socks://localhost:$port" &amp;
    exit
}
</pre>
<p>Now open a terminal and just do:
</p>
<pre>$ secure_chromium
</pre>
<p>Enjoy your secure tunnel!
</p>
<h4>
<span id="Step_2_.28Variant_B.29:_set_up_a_local_TUN_interface"></span><span class="mw-headline" id="Step_2_(Variant_B):_set_up_a_local_TUN_interface">Step 2 (Variant B): set up a local TUN interface</span>
</h4>
<p>This variant is slightly more involved upfront but results in you not having to manually configure every single application one by one to use the SOCKS proxy. It involves setting up a local TUN interface and routing traffic through it.
</p>
<p>See <a href="../en/VPN_over_SSH.html#Set_up_badvpn_and_tunnel_interface" title="VPN over SSH">VPN over SSH#Set up badvpn and tunnel interface</a>.
</p>
<h3><span class="mw-headline" id="X11_forwarding">X11 forwarding</span></h3>
<p>X11 forwarding is a mechanism that allows graphical interfaces of X11 programs running on a remote system to be displayed on a local client machine. For X11 forwarding the remote host does not need to have a full X11 system installed, however it needs at least to have <i>xauth</i> installed. <i>xauth</i> is a utility that maintains <code>Xauthority</code> configurations used by server and client for authentication of X11 session (<a rel="nofollow" class="external text" href="http://xmodulo.com/2012/11/how-to-enable-x11-forwarding-using-ssh.html">source</a>).
</p>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> X11 forwarding has important security implications which should be at least acknowledged by reading relevant sections of <span class="plainlinks archwiki-template-man" title="$ man 1 ssh"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/ssh.1">ssh(1)</a></span>, <span class="plainlinks archwiki-template-man" title="$ man 5 sshd_config"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/sshd_config.5">sshd_config(5)</a></span>, and <span class="plainlinks archwiki-template-man" title="$ man 5 ssh_config"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/ssh_config.5">ssh_config(5)</a></span> manual pages. See also <a rel="nofollow" class="external text" href="https://security.stackexchange.com/questions/14815/security-concerns-with-x11-forwarding">this StackExchange question.</a>
</div>
<h4><span class="mw-headline" id="Setup">Setup</span></h4>
<h5><span class="mw-headline" id="Remote">Remote</span></h5>
<ul>
<li>
<a href="../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">install</a> the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=xorg-xauth">xorg-xauth</a></span> and <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=xorg-xhost">xorg-xhost</a></span> packages</li>
<li>in <code>/etc/ssh/ssh<b>d</b>_config</code>:
<ul>
<li>set <code>X11Forwarding</code> to <i>yes</i>
</li>
<li>verify that <code>AllowTcpForwarding</code> and <code>X11UseLocalhost</code> options are set to <i>yes</i>, and that <code>X11DisplayOffset</code> is set to <i>10</i> (those are the default values if nothing has been changed, see <span class="plainlinks archwiki-template-man" title="$ man 5 sshd_config"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/sshd_config.5">sshd_config(5)</a></span>)</li>
</ul>
</li>
<li>then <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Restart">restart</a> the <a href="#Daemon_management"><i>sshd</i> daemon</a>.</li>
</ul>
<h5><span class="mw-headline" id="Client">Client</span></h5>
<ul>
<li>
<a href="../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">install</a> the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=xorg-xauth">xorg-xauth</a></span> package</li>
<li>enable the <code>ForwardX11</code> option by either specifying the <code>-X</code> switch on the command line for opportunistic connections, or by setting <code>ForwardX11</code> to <i>yes</i> in the <a href="#Configuration">client's configuration</a>.</li>
</ul>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> You can enable the <code>ForwardX11Trusted</code> option (<code>-Y</code> switch on the command line) if GUI is drawing badly or you receive errors; this will prevent X11 forwardings from being subjected to the <a rel="nofollow" class="external text" href="http://www.x.org/wiki/Development/Documentation/Security/">X11 SECURITY extension</a> controls. Be sure you have read <a href="#X11_forwarding">the warning</a> at the beginning of this section if you do so.</div>
<h4><span class="mw-headline" id="Usage">Usage</span></h4>
<div class="noprint archwiki-template-message">
<p><a href="../File:Tango-inaccurate.png" class="image"><img alt="Tango-inaccurate.png" src="../File:Tango-inaccurate.png" decoding="async" width="48" height="48"></a><b>The factual accuracy of this article or section is disputed.</b><a href="../File:Tango-inaccurate.png" class="image"><img alt="Tango-inaccurate.png" src="../File:Tango-inaccurate.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>Reason:</b> <code>xhost</code> is <a rel="nofollow" class="external text" href="https://unix.stackexchange.com/questions/12755/how-to-forward-x-over-ssh-from-ubuntu-machine#comment17148_12772">generally not needed</a> (Discuss in <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php/Talk:OpenSSH#X11_forwarding">Talk:OpenSSH#X11 forwarding</a>)</div>
</div>
<p>Log on to the remote machine normally, specifying the <code>-X</code> switch if <i>ForwardX11</i> was not enabled in the client's configuration file:
</p>
<pre>$ ssh -X <i>user@host</i>
</pre>
<p>If you receive errors trying to run graphical applications, try <i>ForwardX11Trusted</i> instead:
</p>
<pre>$ ssh -Y <i>user@host</i>
</pre>
<p>You can now start any X program on the remote server, the output will be forwarded to your local session:
</p>
<pre>$ xclock
</pre>
<p>If you get "Cannot open display" errors try the following command as the non root user:
</p>
<pre>$ xhost +
</pre>
<p>The above command will allow anybody to forward X11 applications. To restrict forwarding to a particular host type:
</p>
<pre>$ xhost +hostname
</pre>
<p>where hostname is the name of the particular host you want to forward to. See <span class="plainlinks archwiki-template-man" title="$ man 1 xhost"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/xhost.1">xhost(1)</a></span> for more details.
</p>
<p>Be careful with some applications as they check for a running instance on the local machine. <a href="../en/Firefox.html" title="Firefox">Firefox</a> is an example: either close the running Firefox instance or use the following start parameter to start a remote instance on the local machine:
</p>
<pre>$ firefox --no-remote
</pre>
<p>If you get "X11 forwarding request failed on channel 0" when you connect (and the server <code>/var/log/errors.log</code> shows "Failed to allocate internet-domain X11 display socket"), make sure package <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=xorg-xauth">xorg-xauth</a></span> is installed. If its installation is not working, try to either:
</p>
<ul>
<li>enable the <code>AddressFamily any</code> option in <code>ssh<b>d</b>_config</code> on the <i>server</i>, or</li>
<li>set the <code>AddressFamily</code> option in <code>ssh<b>d</b>_config</code> on the <i>server</i> to inet.</li>
</ul>
<p>Setting it to inet may fix problems with Ubuntu clients on IPv4.
</p>
<p>For running X applications as other user on the SSH server you need to <code>xauth add</code> the authentication line taken from <code>xauth list</code> of the SSH logged in user.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> <a rel="nofollow" class="external text" href="https://unix.stackexchange.com/a/12772">Here</a> are <a rel="nofollow" class="external text" href="https://unix.stackexchange.com/a/46748">some</a> useful <a rel="nofollow" class="external text" href="https://superuser.com/a/805060">links</a> for troubleshooting <code>X11 Forwarding</code> issues.</div>
<h3><span class="mw-headline" id="Forwarding_other_ports">Forwarding other ports</span></h3>
<p>In addition to SSH's built-in support for X11, it can also be used to securely tunnel any TCP connection, by use of local forwarding or remote forwarding.
</p>
<p>Local forwarding opens a port on the local machine, connections to which will be forwarded to the remote host and from there on to a given destination. Very often, the forwarding destination will be the same as the remote host, thus providing a secure shell and, e.g. a secure <a href="../en/List_of_applications/Internet.html#Remote_desktop" class="mw-redirect" title="VNC">VNC</a> connection, to the same machine. Local forwarding is accomplished by means of the <code>-L</code> switch and it is accompanying forwarding specification in the form of <code>&lt;tunnel port&gt;:&lt;destination address&gt;:&lt;destination port&gt;</code>.
</p>
<p>Thus:
</p>
<pre>$ ssh -L 1000:mail.google.com:25 192.168.0.100
</pre>
<p>will use SSH to login to and open a shell on <code>192.168.0.100</code>, and will also create a tunnel from the local machine's TCP port 1000 to mail.google.com on port 25. Once established, connections to <code>localhost:1000</code> will connect to the Gmail SMTP port. To Google, it will appear that any such connection (though not necessarily the data conveyed over the connection) originated from <code>192.168.0.100</code>, and such data will be secure between the local machine and 192.168.0.100, but not between <code>192.168.0.100</code> and Google, unless other measures are taken.
</p>
<p>Similarly:
</p>
<pre>$ ssh -L 2000:192.168.0.100:6001 192.168.0.100
</pre>
<p>will allow connections to <code>localhost:2000</code> which will be transparently sent to the remote host on port 6001. The preceding example is useful for VNC connections using the vncserver utility--part of the <a href="../en/TigerVNC.html" class="mw-redirect" title="Tightvnc">tightvnc</a> package--which, though very useful, is explicit about its lack of security.
</p>
<p>Remote forwarding allows the remote host to connect to an arbitrary host via the SSH tunnel and the local machine, providing a functional reversal of local forwarding, and is useful for situations where, e.g., the remote host has limited connectivity due to firewalling. It is enabled with the <code>-R</code> switch and a forwarding specification in the form of <code>&lt;tunnel port&gt;:&lt;destination address&gt;:&lt;destination port&gt;</code>.
</p>
<p>Thus:
</p>
<pre>$ ssh -R 3000:irc.freenode.net:6667 192.168.0.200
</pre>
<p>will bring up a shell on <code>192.168.0.200</code>, and connections from <code>192.168.0.200</code> to itself on port 3000 (the remote host's <code>localhost:3000</code>) will be sent over the tunnel to the local machine and then on to irc.freenode.net on port 6667, thus, in this example, allowing the use of IRC programs on the remote host to be used, even if port 6667 would normally be blocked to it.
</p>
<p>Both local and remote forwarding can be used to provide a secure "gateway", allowing other computers to take advantage of an SSH tunnel, without actually running SSH or the SSH daemon by providing a bind-address for the start of the tunnel as part of the forwarding specification, e.g. <code>&lt;tunnel address&gt;:&lt;tunnel port&gt;:&lt;destination address&gt;:&lt;destination port&gt;</code>. The <code>&lt;tunnel address&gt;</code> can be any address on the machine at the start of the tunnel. The address <code>localhost</code> allows connections via the <code>localhost</code> or loopback interface, and an empty address or <code>*</code> allow connections via any interface. By default, forwarding is limited to connections from the machine at the "beginning" of the tunnel, i.e. the <code>&lt;tunnel address&gt;</code> is set to <code>localhost</code>. Local forwarding requires no additional configuration, however remote forwarding is limited by the remote server's SSH daemon configuration. See the <code>GatewayPorts</code> option in <span class="plainlinks archwiki-template-man" title="$ man 5 sshd_config"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/sshd_config.5">sshd_config(5)</a></span> and <code>-L address</code> option in <span class="plainlinks archwiki-template-man" title="$ man 1 ssh"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/ssh.1">ssh(1)</a></span> for more information about remote forwarding and local forwarding, respectively.
</p>
<h3><span class="mw-headline" id="Jump_hosts">Jump hosts</span></h3>
<p>In certain scenarios, there might not be a direct connection to your target SSH daemon, and the use of a jump server (or bastion server) is required. Thus, we attempt to connect together two or more SSH tunnels, and assuming your local keys are authorized against each server in the chain. This is possible using SSH agent forwarding (<code>-A</code>) and pseudo-terminal allocation (<code>-t</code>) which forwards your local key with the following syntax:
</p>
<pre>$ ssh -A -t -l user1 bastion1 \
  ssh -A -t -l user2 intermediate2 \
  ssh -A -t -l user3 target
</pre>
<p>An easier way to do this is using the <code>-J</code> flag:
</p>
<pre>$ ssh -J user1@bastion1,user2@intermediate2 user3@target
</pre>
<p>Multiple hosts in the <code>-J</code> directive can be separted with a comma, they will be connected to in the order listed. The <code>user...@</code> part is not required, but can be used. The host specifications for <code>-J</code> use the ssh configuration file, so specific per-host options can be set there, if needed.
</p>
<p>An equivalent of the <code>-J</code> flag in the configuration file is the <code>ProxyJump</code> option, see <span class="plainlinks archwiki-template-man" title="$ man 5 ssh_config"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/ssh_config.5">ssh_config(5)</a></span> for details.
</p>
<h3><span class="mw-headline" id="Reverse_SSH_through_a_relay">Reverse SSH through a relay</span></h3>
<div class="noprint archwiki-template-message">
<p><a href="../File:Tango-edit-clear.png" class="image"><img alt="Tango-edit-clear.png" src="../File:Tango-edit-clear.png" decoding="async" width="48" height="48"></a><b>This article or section needs language, wiki syntax or style improvements. See <a href="../en/Help:Style.html" title="Help:Style">Help:Style</a> for reference.</b><a href="../File:Tango-edit-clear.png" class="image"><img alt="Tango-edit-clear.png" src="../File:Tango-edit-clear.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>Reason:</b> The idea of SSH tunneling is classic, so some references for detailed explanation would be nice. E.g. <a rel="nofollow" class="external autonumber" href="https://unix.stackexchange.com/questions/46235/how-does-reverse-ssh-tunneling-work/118650#118650">[2]</a> which includes other scenarios. (Discuss in <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php/Talk:OpenSSH">Talk:OpenSSH#</a>)</div>
</div>
<p>The idea is that client connects to the server via another relay, while the server is connected to the same relay using a reverse SSH tunnel. This is for example useful when the server is behind a NAT and relay is a publicly accessible SSH server used as a proxy to which the user has access. So the prerequisite is that client's keys are authorized against both the relay and the server and server's need to be authorized against the relay as well for the reverse SSH connection.
</p>
<p>The following configuration example assumes that user1 is the user account used on client, user2 on relay and user3 on server. First the server needs to establish the reverse tunnel with:
</p>
<pre>ssh -R 2222:localhost:22 -N user2@relay
</pre>
<p>Which can also be automated with a startup script, systemd service or <a href="#Autossh_-_automatically_restarts_SSH_sessions_and_tunnels">autossh</a>.
</p>
<div class="noprint archwiki-template-message">
<p><a href="../File:Tango-view-fullscreen.png" class="image"><img alt="Tango-view-fullscreen.png" src="../File:Tango-view-fullscreen.png" decoding="async" width="48" height="48"></a><b>This article or section needs expansion.</b><a href="../File:Tango-view-fullscreen.png" class="image"><img alt="Tango-view-fullscreen.png" src="../File:Tango-view-fullscreen.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>Reason:</b> Explain why <code>ssh user3@relay -p 2222</code> is not sufficient. (Discuss in <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php/Talk:OpenSSH">Talk:OpenSSH#</a>)</div>
</div>
<p>At the client side the connection is established with:
</p>
<pre>ssh -t user2@relay ssh user3@localhost -p 2222
</pre>
<p>The remote command to establish the connection to reverse tunnel can also be defined in relay's <code>~/.ssh/authorized_keys</code> by including the <code>command</code> field as follows:
</p>
<pre>command="ssh user3@localhost -p 2222" ssh-rsa KEY2 user1@client
</pre>
<p>In this case the connection is established with:
</p>
<pre>ssh user2@relay
</pre>
<p>Note that SCP's autocomplete function in client's terminal is not working and even the SCP transfers themselves are not working under some configurations.
</p>
<h3><span class="mw-headline" id="Multiplexing">Multiplexing</span></h3>
<p>The SSH daemon usually listens on port 22. However, it is common practice for many public internet hotspots to block all traffic that is not on the regular HTTP/S ports (80 and 443, respectively), thus effectively blocking SSH connections. The immediate solution for this is to have <code>sshd</code> listen additionally on one of the whitelisted ports:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/ssh/sshd_config</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">Port 22
Port 443
</pre>
<p>However, it is likely that port 443 is already in use by a web server serving HTTPS content, in which case it is possible to use a multiplexer, such as <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=sslh">sslh</a></span>, which listens on the multiplexed port and can intelligently forward packets to many services.
</p>
<h3><span class="mw-headline" id="Speeding_up_SSH">Speeding up SSH</span></h3>
<p>There are several <a href="#Configuration">client configuration</a> options which can speed up connections either globally or for specific hosts. See <span class="plainlinks archwiki-template-man" title="$ man 5 ssh_config"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/ssh_config.5">ssh_config(5)</a></span> for full descriptions of these options.
</p>
<ul><li>
<i>Use a faster cipher</i>: on modern CPUs with AESNI instructions, <code>aes128-gcm@openssh.com</code> and <code>aes256-gcm@openssh.com</code> should offer significantly better performance over openssh's default preferred cipher, usually <code>chacha20-poly1305@openssh.com</code>. Cipher can be selected <code>-c</code> flag. For a permanent effect, put <code>Ciphers</code> option in your ~/.ssh/config with ciphers in new preferred order, e.g.:
<dl><dd><pre>Ciphers aes128-gcm@openssh.com,aes256-gcm@openssh.com,chacha20-poly1305@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr</pre></dd></dl>
</li></ul>
<ul><li>
<i>Enable or disable compression</i>: compression can increase speed on slow connections, it is enabled with the <code>Compression yes</code> option or the <code>-C</code> flag. However the compression algorithm used is the relatively slow <span class="plainlinks archwiki-template-man" title="$ man 1 gzip"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/gzip.1">gzip(1)</a></span> which becomes the bottleneck on fast networks. In order to speed up the connection one should use the <code>Compression no</code> option on local or fast networks.</li></ul>
<ul><li>
<i>Connection sharing</i>: you can make all sessions to the same host share a single connection using these options:
<dl><dd><pre>ControlMaster auto
ControlPersist yes
ControlPath ~/.ssh/sockets/socket-%r@%h:%p
</pre></dd></dl>
</li></ul>
<dl><dd>where <code>~/.ssh/sockets</code> can be any directory not writable by other users.</dd></dl>
<ul><li>
<code>ControlPersist</code> specifies how long the master should wait in the background for new clients after the initial client connection has been closed. Possible values are either:
<ul>
<li>
<code>no</code> to close the connection immediately after the last client disconnects,</li>
<li>a time in seconds,</li>
<li>
<code>yes</code> to wait forever, the connection will never be closed automatically.</li>
</ul>
</li></ul>
<ul><li>Login time can be shortened by bypassing IPv6 lookup using the <code>AddressFamily inet</code> option or <code>-4</code> flag.</li></ul>
<ul><li>Last, if you intend to use SSH for SFTP or SCP, <a rel="nofollow" class="external text" href="https://www.psc.edu/index.php/hpn-ssh">High Performance SSH/SCP</a> can significantly increase throughput by dynamically raising the SSH buffer sizes. Install the package <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/openssh-hpn-git/">openssh-hpn-git</a></span><sup><small>AUR</small></sup> to use a patched version of OpenSSH with this enhancement.</li></ul>
<h3><span class="mw-headline" id="Mounting_a_remote_filesystem_with_SSHFS">Mounting a remote filesystem with SSHFS</span></h3>
<p>Please refer to the <a href="../en/SSHFS.html" title="SSHFS">SSHFS</a> article to mount a SSH-accessible remote system to a local folder, so you will be able to do any operation on the mounted files with any tool (copy, rename, edit with vim, etc.). <i>sshfs</i> is generally preferred over <i>shfs</i>, the latter has not been updated since 2004.
</p>
<h3><span class="mw-headline" id="Keep_alive">Keep alive</span></h3>
<p>By default, the SSH session automatically logs out if it has been idle for a certain time. To keep the session up, the client can send a keep-alive signal to the server if no data has been received for some time, or symmetrically the server can send messages at regular intervals if it has not heard from the client.
</p>
<ul>
<li>On the <b>server</b> side, <code>ClientAliveInterval</code> sets the timeout in seconds after which if no data has been received from the client, <i>sshd</i> will send a request for response. The default is 0, no message is sent. For example to request a response every 60 seconds from the client, set the <code>ClientAliveInterval 60</code> option in your <a href="#Configuration_2">server configuration</a>. See also the <code>ClientAliveCountMax</code> and <code>TCPKeepAlive</code> options.</li>
<li>On the <b>client</b> side, <code>ServerAliveInterval</code> controls the interval between the requests for response sent from the client to the server. For example to request a response every 120 seconds from the server, add the <code>ServerAliveInterval 120</code> option to your <a href="#Configuration">client configuration</a>. See also the <code>ServerAliveCountMax</code> and <code>TCPKeepAlive</code> options.</li>
</ul>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong>  To ensure a session is kept alive, only one of either the client or the server needs to send keep alive requests. If ones control both the servers and the clients, a reasonable choice is to only configure the clients that require a persistent session with a positive <code>ServerAliveInterval</code> and leave other clients and servers in their default configuration.</div>
<h3><span class="mw-headline" id="Automatically_restart_SSH_tunnels_with_systemd">Automatically restart SSH tunnels with systemd</span></h3>
<p><a href="../en/Systemd.html" title="Systemd">systemd</a> can automatically start SSH connections on boot/login <i>and</i> restart them when they fail. This makes it a useful tool for maintaining SSH tunnels.
</p>
<p>The following service can start an SSH tunnel on login using the connection settings in your <a href="#Configuration">ssh configuration</a>. If the connection closes for any reason, it waits 10 seconds before restarting it:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">~/.config/systemd/user/tunnel.service</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=SSH tunnel to myserver

[Service]
Type=simple
Restart=always
RestartSec=10
ExecStart=/usr/bin/ssh -F %h/.ssh/config -N myserver
</pre>
<p>Then <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Enable">enable</a> and <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Start">start</a> the <a href="../en/Systemd/User.html" title="Systemd/User">Systemd/User</a> service. See <a href="#Keep_alive">#Keep alive</a> for how to prevent the tunnel from timing out. If you wish to start the tunnel on boot, you might want to <a href="../en/Systemd.html#Writing_unit_files" title="Systemd">rewrite the unit</a> as a system service.
</p>
<h3><span class="mw-headline" id="Autossh_-_automatically_restarts_SSH_sessions_and_tunnels">Autossh - automatically restarts SSH sessions and tunnels</span></h3>
<p>When a session or tunnel cannot be kept alive, for example due to bad network conditions causing client disconnections, you can use <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=autossh">autossh</a></span> to automatically restart them.
</p>
<p>Usage examples:
</p>
<pre>$ autossh -M 0 -o "ServerAliveInterval 45" -o "ServerAliveCountMax 2" username@example.com
</pre>
<p>Combined with <a href="../en/SSHFS.html" title="SSHFS">SSHFS</a>:
</p>
<pre>$ sshfs -o reconnect,compression=yes,transform_symlinks,ServerAliveInterval=45,ServerAliveCountMax=2,ssh_command='autossh -M 0' username@example.com: /mnt/example 
</pre>
<p>Connecting through a SOCKS-proxy set by <a href="../en/Proxy_server.html" class="mw-redirect" title="Proxy settings">Proxy settings</a>:
</p>
<pre>$ autossh -M 0 -o "ServerAliveInterval 45" -o "ServerAliveCountMax 2" -NCD 8080 username@example.com 
</pre>
<p>With the <code>-f</code> option autossh can be made to run as a background process. Running it this way however means the passphrase cannot be entered interactively.
</p>
<p>The session will end once you type <code>exit</code> in the session, or the autossh process receives a SIGTERM, SIGINT of SIGKILL signal.
</p>
<h4><span class="mw-headline" id="Run_autossh_automatically_at_boot_via_systemd">Run autossh automatically at boot via systemd</span></h4>
<p>If you want to automatically start autossh, you can create a systemd unit file:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/autossh.service</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=AutoSSH service for port 2222
After=network.target

[Service]
Environment="AUTOSSH_GATETIME=0"
ExecStart=/usr/bin/autossh -M 0 -NL 2222:localhost:2222 -o TCPKeepAlive=yes foo@bar.com

[Install]
WantedBy=multi-user.target</pre>
<p>Here <code>AUTOSSH_GATETIME=0</code> is an environment variable specifying how long ssh must be up before autossh considers it a successful connection, setting it to 0 autossh also ignores the first run failure of ssh. This may be useful when running autossh at boot. Other environment variables are available at <span class="plainlinks archwiki-template-man" title="$ man 1 autossh"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/autossh.1">autossh(1)</a></span>. Of course, you can make this unit more complex if necessary (see the systemd documentation for details), and obviously you can use your own options for autossh, but note that the <code>-f</code> implying <code>AUTOSSH_GATETIME=0</code> does not work with systemd. 
</p>
<p>Remember to <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Start">start</a> and/or <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Enable">enable</a> the service afterwards.
</p>
<p>You may also need to disable ControlMaster e.g.
</p>
<pre>ExecStart=/usr/bin/autossh -M 0 -o ControlMaster=no -NL 2222:localhost:2222 -o TCPKeepAlive=yes foo@bar.com
</pre>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> It is also easy to maintain several autossh processes, to keep several tunnels alive. Just create multiple service files with different names.</div>
<h3><span class="mw-headline" id="Alternative_service_should_SSH_daemon_fail">Alternative service should SSH daemon fail</span></h3>
<p>For remote or headless servers which rely exclusively on SSH, a failure to start the SSH daemon (e.g., after a system upgrade) may prevent administration access. <a href="../en/Systemd.html" title="Systemd">systemd</a> offers a simple solution via <code>OnFailure</code> option.
</p>
<p>Let us suppose the server runs <code>sshd</code> and <a href="../en/Telnet.html" title="Telnet">telnet</a> is the fail-safe alternative of choice. Create a file as follows. Do <b>not</b> <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Enable">enable</a> telnet.socket!
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/sshd.service.d/override.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
OnFailure=telnet.socket</pre>
<p>That's it. Telnet is not available when <code>sshd</code> is running. Should <code>sshd</code> fail to start, a telnet session can be opened for recovery.
</p>
<h3><span class="mw-headline" id="Terminal_background_color_based_on_host">Terminal background color based on host</span></h3>
<p>To better distinguish when you are on different hosts, you can set a <a rel="nofollow" class="external text" href="https://bryangilbert.com/post/etc/term/dynamic-ssh-terminal-background-colors/">different background color based on the kind of host</a>.
</p>
<p>This solution works, but is not universal (ZSH only).
</p>
<h3><span class="mw-headline" id="Network_specific_configuration">Network specific configuration</span></h3>
<p>You can use host configuration specific to the network you are connected to using a <code>Match exec</code>.
</p>
<p>For example, when using nmcli, and the connection is configured (manually or through DHCP) to use a search-domain:
</p>
<pre>Match exec "nmcli | grep domains: | grep example.com"
  CanonicalDomains example.com
  # Should you use a different username on this network
  #User username
  # Use a different known_hosts file (for private network or synchronisation)
  #UserKnownHostsFile &lt;network&gt;_known_hosts</pre>
<h3><span class="mw-headline" id="Private_networks_hostkeys_verification">Private networks hostkeys verification</span></h3>
<p>Because different servers on different networks are likely to share a common private IP address, you might want to handle them differently.
</p>
<div class="noprint archwiki-template-message">
<p><a href="../File:Tango-inaccurate.png" class="image"><img alt="Tango-inaccurate.png" src="../File:Tango-inaccurate.png" decoding="async" width="48" height="48"></a><b>The factual accuracy of this article or section is disputed.</b><a href="../File:Tango-inaccurate.png" class="image"><img alt="Tango-inaccurate.png" src="../File:Tango-inaccurate.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>Reason:</b> The best solution would not need a warning to use something else in practice. (Discuss in <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php/Talk:OpenSSH">Talk:OpenSSH#</a>)</div>
</div>
<p>The best solution is to use the <a href="#Network_specific_configuration">#Network specific configuration</a> to use a different <code>UserKnownHostsFile</code> depending on the network you are on. The second solution, best used as default when you are working on new/prototype networks, would be to simply ignore hostkeys for private networks:
</p>
<pre>Host 10.* 192.168.*.* 172.31.* 172.30.* 172.2?.* 172.1?.*
    # Disable HostKey verification
    # Trust HostKey automatically
    StrictHostKeyChecking no
    # Do not save the HostKey
    UserKnownHostsFile=/dev/null
    # Do not display: "Warning: Permanently Added ..."
    LogLevel Error</pre>
<div class="noprint archwiki-template-message">
<p><a href="../File:Tango-inaccurate.png" class="image"><img alt="Tango-inaccurate.png" src="../File:Tango-inaccurate.png" decoding="async" width="48" height="48"></a><b>The factual accuracy of this article or section is disputed.</b><a href="../File:Tango-inaccurate.png" class="image"><img alt="Tango-inaccurate.png" src="../File:Tango-inaccurate.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>Reason:</b> The <code>known_hosts</code> file records an IP address even when you use hostname to access the server. (Discuss in <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php/Talk:OpenSSH">Talk:OpenSSH#</a>)</div>
</div>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> In a production environment, make sure to either use the hostname to access the host and/or to use network specific known_hosts files.</div>
<h3><span class="mw-headline" id="Run_command_at_login">Run command at login</span></h3>
<p>If you are using an interactive session, there are multiple ways to execute a command on login:
</p>
<ul>
<li>use the <code>authorized_keys</code> file on the remote host (see <code>AUTHORIZED_KEYS FILE FORMAT</code> in <span class="plainlinks archwiki-template-man" title="$ man 8 sshd"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/sshd.8">sshd(8)</a></span>)</li>
<li>use <code>~/.ssh/rc</code> on the remote host if the server has enabled the <code>PermitUserRC</code> option</li>
<li>use your shell config file on the remote host, e.g. <code>.bashrc</code>
</li>
</ul>
<h3><span class="mw-headline" id="Agent_forwarding">Agent forwarding</span></h3>
<p>SSH agent forwarding allows you to use your local keys when connected to a server. It is recommended to only enable agent forwarding for selected hosts.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">~/.ssh/config</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">Host <i>myserver.com</i>
    ForwardAgent yes
</pre>
<p>Next, configure an <a href="../en/SSH_keys.html#SSH_agents" class="mw-redirect" title="SSH agent">SSH agent</a> and add your local key with <i>ssh-add</i>.
</p>
<p>If you now connect to a remote server you will be able to connect to other services using your local keys.
</p>
<h2><span class="mw-headline" id="Troubleshooting">Troubleshooting</span></h2>
<h3><span class="mw-headline" id="Checklist">Checklist</span></h3>
<p>Check these simple issues before you look any further.
</p>
<ol>
<li>The config directory <code>~/.ssh</code>, its contents should be accessible only by the user (check this on both the client and the server), and the user's home folder should only be writable by the user: <pre>$ chmod go-w ~
$ chmod 700 ~/.ssh
$ chmod 600 ~/.ssh/*
$ chown -R $USER ~/.ssh
</pre>
</li>
<li>Check that the client's public key (e.g. <code>id_rsa.pub</code>) is in <code>~/.ssh/authorized_keys</code> on the server.</li>
<li>Check that you did not limit SSH access with <code>AllowUsers</code> or <code>AllowGroups</code> in the <a href="#Configuration_2">server config</a>.</li>
<li>Check if the user has set a password. Sometimes new users who have not yet logged in to the server do not have a password.</li>
<li>
<a href="../en/Help:Reading.html#Append,_add,_create,_edit" class="mw-redirect" title="Append">Append</a> <code>LogLevel DEBUG</code> to <code>/etc/ssh/sshd_config</code>.</li>
<li>Use <code>journalctl -xe</code> for possible (error) messages.</li>
<li>
<a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Restart">Restart</a> <code>sshd</code> and logout/login on both client and server.</li>
</ol>
<h3><span class="mw-headline" id="Connection_refused_or_timeout_problem">Connection refused or timeout problem</span></h3>
<h4><span class="mw-headline" id="Port_forwarding">Port forwarding</span></h4>
<p>If you are behind a NAT mode/router (which is likely unless you are on a VPS or publicly addressed host), make sure that your router is forwarding incoming ssh connections to your machine. Find the server's internal IP address with <code>$ ip addr</code> and set up your router to forward TCP on your SSH port to that IP. <a rel="nofollow" class="external text" href="http://portforward.com">portforward.com</a> can help with that.
</p>
<h4>
<span id="Is_SSH_running_and_listening.3F"></span><span class="mw-headline" id="Is_SSH_running_and_listening?">Is SSH running and listening?</span>
</h4>
<p>The <a href="../en/Network_configuration.html#Investigate_sockets" class="mw-redirect" title="Ss">ss</a> utility shows all the processes listening to a TCP port with the following command line:
</p>
<pre>$ ss --tcp --listening
</pre>
<p>If the above command do not show the system is listening to the port <code>ssh</code>, then SSH is not running: check the <a href="../en/Systemd/Journal.html" class="mw-redirect" title="Journal">journal</a> for errors etc.
</p>
<h4>
<span id="Are_there_firewall_rules_blocking_the_connection.3F"></span><span class="mw-headline" id="Are_there_firewall_rules_blocking_the_connection?">Are there firewall rules blocking the connection?</span>
</h4>
<p><a href="../en/Iptables.html" title="Iptables">Iptables</a> may be blocking connections on port <code>22</code>. Check this with:
</p>
<pre># iptables -nvL</pre>
<p>and look for rules that might be dropping packets on the <code>INPUT</code> chain. Then, if necessary, unblock the port with a command like: 
</p>
<pre># iptables -I INPUT 1 -p tcp --dport 22 -j ACCEPT
</pre>
<p>For more help configuring firewalls, see <a href="../en/Category:Firewalls.html" class="mw-redirect" title="Firewalls">firewalls</a>.
</p>
<h4>
<span id="Is_the_traffic_even_getting_to_your_computer.3F"></span><span class="mw-headline" id="Is_the_traffic_even_getting_to_your_computer?">Is the traffic even getting to your computer?</span>
</h4>
<p>Start a traffic dump on the computer you are having problems with:
</p>
<pre># tcpdump -lnn -i any port ssh and tcp-syn
</pre>
<p>This should show some basic information, then wait for any matching traffic to happen before displaying it. Try your connection now. If you do not see any output when you attempt to connect, then something outside of your computer is blocking the traffic (e. g., hardware firewall, NAT router etc.).
</p>
<h4>
<span id="Your_ISP_or_a_third_party_blocking_default_port.3F"></span><span class="mw-headline" id="Your_ISP_or_a_third_party_blocking_default_port?">Your ISP or a third party blocking default port?</span>
</h4>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Try this step if you <b>know</b> you are not running any firewalls and you know you have configured the router for DMZ or have forwarded the port to your computer and it still does not work. Here you will find diagnostic steps and a possible solution.</div>
<p>In some cases, your ISP might block the default port (SSH port 22) so whatever you try (opening ports, hardening the stack, defending against flood attacks, et al) ends up useless. To confirm this, create a server on all interfaces (0.0.0.0) and connect remotely. 
</p>
<p>If you get an error message comparable to this:
</p>
<pre>ssh: connect to host www.inet.hr port 22: Connection refused
</pre>
<p>That means the port is <b>not</b> being blocked by the ISP, but the server does not run SSH on that port (See <a href="https://en.wikipedia.org/wiki/Security_through_obscurity" class="extiw" title="wikipedia:Security through obscurity">security through obscurity</a>).
</p>
<p>However, if you get an error message comparable to this:
</p>
<pre>ssh: connect to host 111.222.333.444 port 22: Operation timed out 
</pre>
<p>That means that something is rejecting your TCP traffic on port 22. Basically that port is stealth, either by your firewall or 3rd party intervention (like an ISP blocking and/or rejecting incoming traffic on port 22). If you know you are not running any firewall on your computer, and you know that Gremlins are not growing in your routers and switches, then your ISP is blocking the traffic.
</p>
<p>To double check, you can run Wireshark on your server and listen to traffic on port 22. Since Wireshark is a Layer 2 Packet Sniffing utility, and TCP/UDP are Layer 3 and above (see <a href="https://en.wikipedia.org/wiki/Internet_protocol_suite" class="extiw" title="wikipedia:Internet protocol suite">IP Network stack</a>), if you do not receive anything while connecting remotely, a third party is most likely to be blocking the traffic on that port to your server.
</p>
<h5><span class="mw-headline" id="Diagnosis">Diagnosis</span></h5>
<p><a href="../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">Install</a> either <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=tcpdump">tcpdump</a></span> or Wireshark with the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=wireshark-cli">wireshark-cli</a></span> package.
</p>
<p>For tcpdump:
</p>
<pre># tcpdump -ni <i>interface</i> "port 22"
</pre>
<p>For Wireshark:
</p>
<pre>$ tshark -f "tcp port 22" -i <i>interface</i>
</pre>
<p>where <code><i>interface</i></code> is the network interface for a WAN connection (see <code>ip a</code> to check). If you are not receiving any packets while trying to connect remotely, you can be very sure that your ISP is blocking the incoming traffic on port 22.
</p>
<h5><span class="mw-headline" id="Possible_solution">Possible solution</span></h5>
<p>The solution is just to use some other port that the ISP is not blocking. Open the <code>/etc/ssh/sshd_config</code> and configure the file to use different ports. For example, add:
</p>
<pre>Port 22
Port 1234
</pre>
<p>Also make sure that other "Port" configuration lines in the file are commented out. Just commenting "Port 22" and putting "Port 1234" will not solve the issue because then sshd will only listen on port 1234. Use both lines to run the SSH server on both ports. 
</p>
<p><a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Restart">Restart</a> the server <code>sshd.service</code> and you are almost done. You still have to configure your client(s) to use the other port instead of the default port. There are numerous solutions to that problem, but let us cover two of them here.
</p>
<h4><span class="mw-headline" id="Read_from_socket_failed:_connection_reset_by_peer">Read from socket failed: connection reset by peer</span></h4>
<p>Recent versions of openssh sometimes fail with the above error message when connecting to older ssh servers. This can be worked around by setting various <a href="#Configuration">client options</a> for that host. See <span class="plainlinks archwiki-template-man" title="$ man 5 ssh_config"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/ssh_config.5">ssh_config(5)</a></span> for more information about the following options.
</p>
<p>The problem could be the <code>ecdsa-sha2-nistp*-cert-v01@openssh</code> elliptical host key algorithms. These can be disabled by setting <code>HostKeyAlgorithms</code> to a list excluding those algorithms.
</p>
<p>If that does not work, it could be that the list of ciphers is too long. Set the <code>Ciphers</code> option to a shorter list (fewer than 80 characters should be enough). Similarly, you can also try shortening the list of <code>MACs</code>.
</p>
<p>See also the <a rel="nofollow" class="external text" href="http://www.gossamer-threads.com/lists/openssh/dev/51339">discussion</a> on the openssh bug forum.
</p>
<h3>
<span id=".22.5Byour_shell.5D:_No_such_file_or_directory.22_.2F_ssh_exchange_identification_problem"></span><span class="mw-headline" id='"[your_shell]:_No_such_file_or_directory"_/_ssh_exchange_identification_problem'>"[your shell]: No such file or directory" / ssh_exchange_identification problem</span>
</h3>
<p>One possible cause for this is the need of certain SSH clients to find an absolute path (one returned by <code>whereis -b [your shell]</code>, for instance) in <code>$SHELL</code>, even if the shell's binary is located in one of the <code>$PATH</code> entries.
</p>
<h3>
<span id=".22Terminal_unknown.22_or_.22Error_opening_terminal.22_error_message"></span><span class="mw-headline" id='"Terminal_unknown"_or_"Error_opening_terminal"_error_message'>"Terminal unknown" or  "Error opening terminal" error message</span>
</h3>
<p>If you receive the above errors upon logging in, this means the server does not recognize your terminal. Ncurses applications like nano may fail with the message "Error opening terminal".
</p>
<p>The correct solution is to install the client terminal's terminfo file on the server. This tells console programs on the server how to correctly interact with your terminal. You can get info about current terminfo using <code>$ infocmp</code> and then find out <a href="../en/Pacman.html#Querying_package_databases" title="Pacman">which package owns it</a>.
</p>
<p>If you cannot <a href="../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">install</a> it normally, you can copy your terminfo to your home directory on the server:
</p>
<pre>$ ssh myserver mkdir -p  ~/.terminfo/${TERM:0:1}
$ scp /usr/share/terminfo/${TERM:0:1}/$TERM myserver:~/.terminfo/${TERM:0:1}/
</pre>
<p>After logging in and out from the server the problem should be fixed.
</p>
<h4><span class="mw-headline" id="TERM_hack">TERM hack</span></h4>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> This should only be used as a last resort.</div>
<p>Alternatively, you can simply set <code>TERM=xterm</code> in your environment on the server (e.g. in <code>.bash_profile</code>). This will silence the error and allow ncurses applications to run again, but you may experience strange behavior and graphical glitches unless your terminal's control sequences exactly match xterm's.
</p>
<h3>
<span id="Connection_closed_by_x.x.x.x_.5Bpreauth.5D"></span><span class="mw-headline" id="Connection_closed_by_x.x.x.x_[preauth]">Connection closed by x.x.x.x [preauth]</span>
</h3>
<p>If you are seeing this error in your sshd logs, make sure you have set a valid HostKey
</p>
<pre>HostKey /etc/ssh/ssh_host_rsa_key
</pre>
<h3><span class="mw-headline" id="id_dsa_refused_by_OpenSSH_7.0">id_dsa refused by OpenSSH 7.0</span></h3>
<p>OpenSSH 7.0 deprecated DSA public keys for security reasons. If you absolutely must enable them, set the <a href="#Configuration">config</a> option <code>PubkeyAcceptedKeyTypes +ssh-dss</code> (<a rel="nofollow" class="external free" href="http://www.openssh.com/legacy.html">http://www.openssh.com/legacy.html</a> does not mention this).
</p>
<h3><span class="mw-headline" id="No_matching_key_exchange_method_found_by_OpenSSH_7.0">No matching key exchange method found by OpenSSH 7.0</span></h3>
<p>OpenSSH 7.0 deprecated the diffie-hellman-group1-sha1 key algorithm because it is weak and within theoretical range of the so-called Logjam attack (see <a rel="nofollow" class="external free" href="http://www.openssh.com/legacy.html">http://www.openssh.com/legacy.html</a>). If the key algorithm is needed for a particular host, ssh will produce an error message like this:
</p>
<pre>Unable to negotiate with 127.0.0.1: no matching key exchange method found.
Their offer: diffie-hellman-group1-sha1
</pre>
<p>The best resolution for these failures is to upgrade/configure the server to not use deprecated algorithms. If that is not possible, you can force the client to reenable the algorithm with the <a href="#Configuration">client option</a> <code>KexAlgorithms +diffie-hellman-group1-sha1</code>.
</p>
<h3>
<span id="tmux.2Fscreen_session_killed_when_disconnecting_from_SSH"></span><span class="mw-headline" id="tmux/screen_session_killed_when_disconnecting_from_SSH">tmux/screen session killed when disconnecting from SSH</span>
</h3>
<p>If your processes get killed at the end of the session, it is possible that you are using socket activation and it gets killed by <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=systemd">systemd</a></span> when it notices that the SSH session process exited. In that case there are two solutions. One is to avoid using socket activation by using <code>ssh.service</code> instead of <code>ssh.socket</code>. The other is to set <code>KillMode=process</code> in the Service section of <code>ssh@.service</code>.
</p>
<p>The <code>KillMode=process</code> setting may also be useful with the classic <code>ssh.service</code>, as it avoids killing the SSH session process or the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=screen">screen</a></span> or <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=tmux">tmux</a></span> processes when the server gets stopped or restarted.
</p>
<h3><span class="mw-headline" id="SSH_session_stops_responding">SSH session stops responding</span></h3>
<p>SSH responds to <a href="https://en.wikipedia.org/wiki/Software_flow_control" class="extiw" title="wikipedia:Software flow control">flow control commands</a> <code>XON</code> and <code>XOFF</code>. It will freeze/hang/stop responding when you hit <code>Ctrl+s</code>. Use <code>Ctrl+q</code> to resume your session.
</p>
<h3><span class="mw-headline" id="Broken_pipe">Broken pipe</span></h3>
<p>If you attempt to create a connection which results in a <code>Broken pipe</code> response for <code>packet_write_wait</code>, you should reattempt the connection in debug mode and see if the output ends in error:
</p>
<pre>debug3: send packet: type 1
packet_write_wait: Connection to A.B.C.D port 22: Broken pipe</pre>
<p>The <code>send packet</code> line above indicates that the reply packet was never received. So, it follows that this is a <i>QoS</i> issue. To decrease the likely-hood of a packet being dropped, set <code>IPQoS</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/ssh/ssh_config</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">Host *
    IPQoS reliability</pre>
<p>The <code>reliability</code> (<code>0x04</code>) type-of-service should resolve the issue, as well as <code>0x00</code> and <code>throughput</code> (<code>0x08</code>).
</p>
<h3><span class="mw-headline" id="Slow_daemon_startup_after_reboot">Slow daemon startup after reboot</span></h3>
<p>If you are experiencing excessively long daemon startup times after reboots (e.g. several minutes before the daemon starts accepting connections), especially on headless or virtualized servers, it may be due to a lack of entropy.<a rel="nofollow" class="external autonumber" href="https://bbs.archlinux.org/viewtopic.php?id=241954">[3]</a> This can be remedied by installing either <a href="../en/Rng-tools.html" title="Rng-tools">Rng-tools</a> or <a href="../en/Haveged.html" title="Haveged">Haveged</a>, as appropriate for your system. However, take note of the associated security implications discussed in each package's respective wiki page.
</p>
<h3><span class="mw-headline" id="Terminate_unresponsive_SSH_connection">Terminate unresponsive SSH connection</span></h3>
<p>If a client session is no longer responding and cannot be terminated by instructing the running program (e.g. <a href="../en/Command-line_shell.html" class="mw-redirect" title="Shell">shell</a>), you can still terminate the session by pressing <code>Enter</code>, <code>~</code> and <code>.</code> one after another in that order.
</p>
<p>The <code>~</code> is a pseudo-terminal escape character (see <span class="plainlinks archwiki-template-man" title="$ man 1 ssh"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/ssh.1#ESCAPE_CHARACTERS">ssh(1) Â§â€¯ESCAPE CHARACTERS</a></span>), which can be added multiple times depending on the client session to terminate. For example, if you connected from A to B and then from B to C and the session from B to C freezes, you can terminate it by pressing <code>Enter</code> and typing <code>~~.</code>, which will leave you in a working session on B.
</p>
<h3>
<span id="WARNING:_REMOTE_HOST_IDENTIFICATION_HAS_CHANGED.21"></span><span class="mw-headline" id="WARNING:_REMOTE_HOST_IDENTIFICATION_HAS_CHANGED!">WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!</span>
</h3>
<p>If the client warns that the key of an ssh server has changed, you should verify that the newly offered key really belongs to the server operator. Then remove the old key from the <code>known_hosts</code> file with <code>ssh-keygen -R $SSH_HOST</code> and accept the new key as if it was a new server.
</p>
<h2><span class="mw-headline" id="See_also">See also</span></h2>
<ul>
<li><a rel="nofollow" class="external text" href="http://www.la-samhna.de/library/brutessh.html">Defending against brute force ssh attacks</a></li>
<li>OpenSSH key management: <a rel="nofollow" class="external text" href="http://www.ibm.com/developerworks/library/l-keyc/index.html">Part 1</a> on IBM developerWorks, <a rel="nofollow" class="external text" href="https://www.funtoo.org/OpenSSH_Key_Management,_Part_2">Part 2</a>, <a rel="nofollow" class="external text" href="https://www.funtoo.org/OpenSSH_Key_Management,_Part_3">Part 3</a> on funtoo.org</li>
<li><a rel="nofollow" class="external text" href="https://stribika.github.io/2015/01/04/secure-secure-shell.html">Secure Secure Shell</a></li>
</ul>
</div>
</div>
<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Categories</a>: <ul>
<li><a href="../en/Category:Secure_Shell.html" title="Category:Secure Shell">Secure Shell</a></li>
<li><a href="../en/Category:Servers.html" title="Category:Servers">Servers</a></li>
<li><a href="../en/Category:OpenBSD.html" title="Category:OpenBSD">OpenBSD</a></li>
</ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden categories: <ul>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Out_of_date.html" title="Category:Pages or sections flagged with Template:Out of date">Pages or sections flagged with Template:Out of date</a></li>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Accuracy.html" title="Category:Pages or sections flagged with Template:Accuracy">Pages or sections flagged with Template:Accuracy</a></li>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Style.html" title="Category:Pages or sections flagged with Template:Style">Pages or sections flagged with Template:Style</a></li>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Expansion.html" title="Category:Pages or sections flagged with Template:Expansion">Pages or sections flagged with Template:Expansion</a></li>
</ul>
</div>
</div>
	</div>
</div>

<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
		<li>Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=OpenSSH&amp;oldid=646974">https://wiki.archlinux.org/index.php?title=OpenSSH&amp;oldid=646974</a>"</li>
		<li id="footer-info-lastmod"> This page was last edited on 26 December 2020, at 12:20.</li>
		<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="http://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
	<br>
</ul>
	<ul id="footer-places">
		<li id="footer-places-privacy"><a href="../en/ArchWiki:Privacy_policy.html" title="ArchWiki:Privacy policy">Privacy policy</a></li>
		<li id="footer-places-about"><a href="../en/ArchWiki:About.html" title="ArchWiki:About">About ArchWiki</a></li>
		<li id="footer-places-disclaimer"><a href="../en/ArchWiki:General_disclaimer.html" title="ArchWiki:General disclaimer">Disclaimers</a></li>
	</ul>
	<ul id="footer-icons" class="noprint">
		<li id="footer-copyrightico">
	</ul>
	<div style="clear: both;"></div>
</footer>



</body>
</html>
