<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>PostgreSQL (简体中文) - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.35.0">
<meta name="robots" content="noindex,follow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="http://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-PostgreSQL_简体中文 rootpage-PostgreSQL_简体中文 skin-vector action-view skin-vector-legacy">
<div id="content" class="mw-body" role="main" style="margin: 0">
	<a id="top"></a>
	<div id="siteNotice" class="mw-body-content"></div>
	<div class="mw-indicators mw-body-content">
	</div>
	<h1 id="firstHeading" class="firstHeading" lang="en">PostgreSQL (简体中文)</h1>
	<div id="bodyContent" class="mw-body-content">
		<div id="siteSub" class="noprint">From ArchWiki</div>
		<div id="contentSub"></div>
		<div id="contentSub2"></div>
		
		<div id="jump-to-nav"></div>
		<a class="mw-jump-link" href="#mw-head">Jump to navigation</a>
		<a class="mw-jump-link" href="#searchInput">Jump to search</a>
		<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr">
<div class="warningbox">The printable version is no longer supported and may have rendering errors. Please update your browser bookmarks and please use the default browser print function instead.</div>
<div class="mw-parser-output">
<div class="noprint archwiki-template-message">
<p><a href="../File:Tango-preferences-desktop-locale.png" class="image"><img alt="Tango-preferences-desktop-locale.png" src="../File:Tango-preferences-desktop-locale.png" decoding="async" width="48" height="48"></a><b>本文或本节需要<a href="../zh-CN/ArchWiki:Contributing.html#%E7%BF%BB%E8%AF%91" title="ArchWiki:Contributing (简体中文)">翻译</a>。要贡献翻译，请访问<a href="../zh-CN/ArchWiki:Translation_Team.html" class="mw-redirect" title="ArchWiki Translation Team (简体中文)">简体中文翻译团队</a>。</b><a href="../File:Tango-preferences-desktop-locale.png" class="image"><img alt="Tango-preferences-desktop-locale.png" src="../File:Tango-preferences-desktop-locale.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>附注：</b> <span style="color:red;">请使用模板的第一个参数进行更详细的指示。</span>（在 <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php/Talk:PostgreSQL_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">Talk:PostgreSQL (简体中文)#</a> 中讨论）</div>
</div>
<p>PostgreSQL是一个开源的，社区驱动的，符合标准的 对象-关系型 数据库系统。
</p>
<p>本文档介绍如何安装PostgreSql。同时，也介绍了如何配置PostgreSql，使远程客户端能够操作之。在某些应用中，PostgreSQL可以代替MySQL作为LAMP网络栈的一部分。  
</p>
<p><br>
</p>
<div id="toc" class="toc" role="navigation" aria-labelledby="mw-toc-heading">
<input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none"><div class="toctitle" lang="en" dir="ltr">
<h2 id="mw-toc-heading">Contents</h2>
<span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span>
</div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#%E5%AE%89%E8%A3%85PostgreSQL"><span class="tocnumber">1</span> <span class="toctext">安装PostgreSQL</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#%E5%88%9B%E5%BB%BA%E7%AC%AC%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93/%E7%94%A8%E6%88%B7"><span class="tocnumber">2</span> <span class="toctext">创建第一个数据库/用户</span></a></li>
<li class="toclevel-1 tocsection-3">
<a href="#%E7%86%9F%E6%82%89PostgreSQL"><span class="tocnumber">3</span> <span class="toctext">熟悉PostgreSQL</span></a>
<ul>
<li class="toclevel-2 tocsection-4"><a href="#%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93shell"><span class="tocnumber">3.1</span> <span class="toctext">连接数据库shell</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-5">
<a href="#%E9%80%89%E6%8B%A9%E9%85%8D%E7%BD%AE"><span class="tocnumber">4</span> <span class="toctext">选择配置</span></a>
<ul>
<li class="toclevel-2 tocsection-6"><a href="#%E9%85%8D%E7%BD%AE_PostgreSQL_%E8%A2%AB%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AE"><span class="tocnumber">4.1</span> <span class="toctext">配置 PostgreSQL 被远程访问</span></a></li>
<li class="toclevel-2 tocsection-7"><a href="#Configure_PostgreSQL_to_work_with_PHP"><span class="tocnumber">4.2</span> <span class="toctext">Configure PostgreSQL to work with PHP</span></a></li>
<li class="toclevel-2 tocsection-8"><a href="#Change_default_data_dir_(optional)"><span class="tocnumber">4.3</span> <span class="toctext">Change default data dir (optional)</span></a></li>
<li class="toclevel-2 tocsection-9"><a href="#Change_default_encoding_of_new_databases_to_UTF-8"><span class="tocnumber">4.4</span> <span class="toctext">Change default encoding of new databases to UTF-8</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-10"><a href="#%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7"><span class="tocnumber">5</span> <span class="toctext">管理工具</span></a></li>
<li class="toclevel-1 tocsection-11">
<a href="#Postgresql%E5%8D%87%E7%BA%A7%E9%85%8D%E7%BD%AE"><span class="tocnumber">6</span> <span class="toctext">Postgresql升级配置</span></a>
<ul>
<li class="toclevel-2 tocsection-12"><a href="#%E5%BF%AB%E9%80%9F%E6%8C%87%E5%8D%97"><span class="tocnumber">6.1</span> <span class="toctext">快速指南</span></a></li>
<li class="toclevel-2 tocsection-13"><a href="#%E8%AF%A6%E7%BB%86%E8%AF%B4%E6%98%8E"><span class="tocnumber">6.2</span> <span class="toctext">详细说明</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-14">
<a href="#Troubleshooting"><span class="tocnumber">7</span> <span class="toctext">Troubleshooting</span></a>
<ul>
<li class="toclevel-2 tocsection-15"><a href="#Improve_performance_of_small_transactions"><span class="tocnumber">7.1</span> <span class="toctext">Improve performance of small transactions</span></a></li>
<li class="toclevel-2 tocsection-16"><a href="#%E7%A9%BA%E9%97%B2%E6%97%B6%E9%98%B2%E6%AD%A2%E7%A3%81%E7%9B%98%E5%86%99%E5%85%A5"><span class="tocnumber">7.2</span> <span class="toctext">空闲时防止磁盘写入</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-17"><a href="#See_also"><span class="tocnumber">8</span> <span class="toctext">See also</span></a></li>
</ul>
</div>

<h2>
<span id=".E5.AE.89.E8.A3.85PostgreSQL"></span><span class="mw-headline" id="安装PostgreSQL">安装PostgreSQL</span>
</h2>
<p><a href="../en/Pacman.html" title="Pacman">安装</a> <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=postgresql">postgresql</a></span>，并为新用户<i>postgres</i><a href="../zh-CN/Users_and_groups.html#%E5%85%B6%E4%BB%96%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E7%A4%BA%E4%BE%8B" title="Users and groups (简体中文)">设置一个密码 </a>。
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>注意：</strong> 在本篇文章中需要以postgres用户运行的命令以<code>[postgres]$</code>作为前置符号。你可以以root用户执行<code>su - postgres</code>登陆postgres用户。如果你使用<a href="../en/Sudo.html" title="Sudo">sudo</a>，可以以普通用户执行<code>sudo -i -u postgres</code>。</div>
<p>在PostgreSQL可以正确使用之前，数据库集群必须被初始化:
</p>
<pre># sudo su - postgres -c "initdb --locale en_US.UTF-8 -E UTF8 -D '/var/lib/postgres/data'"
</pre>
<p>启动PostgreSQL，(可选)，添加 PostgreSQL 到daemons列表里作为守护进程同时启动：
</p>
<pre># systemctl enable postgresql.service
# systemctl start postgresql.service
</pre>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>警告：</strong> 如果数据库位于<a href="../en/Btrfs.html" title="Btrfs">Btrfs</a>文件系统上，你应该在创建数据库前禁用数据库目录的<a href="../zh-CN/Btrfs.html#%E5%86%99%E6%97%B6%E5%A4%8D%E5%88%B6_(CoW)" title="Btrfs (简体中文)">Copy-on-Write</a>
</div>
<h2>
<span id=".E5.88.9B.E5.BB.BA.E7.AC.AC.E4.B8.80.E4.B8.AA.E6.95.B0.E6.8D.AE.E5.BA.93.2F.E7.94.A8.E6.88.B7"></span><span class="mw-headline" id="创建第一个数据库/用户">创建第一个数据库/用户</span>
</h2>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>提示：</strong> 如果创建一个与你的 Arch 用户 ($USER) 同名的数据库用户，并允许其访问 PostgreSQL 数据库的 shell，那么在使用PostgreSQL 数据库 shell 的时候无需指定用户登录（这样做会比较方便）。</div>
<p>以 postgres 用户身份, 添加一个新的数据库用户使用 <a rel="nofollow" class="external text" href="http://www.postgresql.org/docs/9.0/static/app-createuser.html">createuser</a> 命令
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">[postgres]$ createuser --interactive</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">输入要增加的角色名称: 我登录 Arch 的用户名</pre>
<p>以具备读写权限的用户身份，创建一个新的数据库,使用<a rel="nofollow" class="external text" href="http://www.postgresql.org/docs/9.0/static/app-createdb.html">createdb</a> 命令。
</p>
<p>从你的 shell (<b>不是</b> 以 postrgres 用户的身份)
</p>
<pre>$ createdb myDatabaseName
</pre>
<h2>
<span id=".E7.86.9F.E6.82.89PostgreSQL"></span><span class="mw-headline" id="熟悉PostgreSQL">熟悉PostgreSQL</span>
</h2>
<h3>
<span id=".E8.BF.9E.E6.8E.A5.E6.95.B0.E6.8D.AE.E5.BA.93shell"></span><span class="mw-headline" id="连接数据库shell">连接数据库shell</span>
</h3>
<p>登陆为postgres用户，启动主要数据库shell <a rel="nofollow" class="external text" href="http://www.postgresql.org/docs/current/static/app-psql.html">psql</a>，你可以创建数据库或表、设计权限和运行原始的SQL命令。使用<code>-d</code>选项连接你创建的数据库（如果没有指定数据库，<code>psql</code>会尝试连接与你用户名同名的数据库）。
</p>
<pre>[postgres]$ psql -d myDatabaseName
</pre>
<p>一些有用的命令：
</p>
<ul><li>帮助</li></ul>
<pre>=&gt; \help
</pre>
<ul><li>连接到数据库&lt;database&gt;</li></ul>
<pre>=&gt; \c &lt;database&gt;
</pre>
<ul><li>列出所有用户以及他们的权限</li></ul>
<pre>=&gt; \du
</pre>
<ul><li>展示当前数据库中所有的表相关的汇总信息</li></ul>
<pre>=&gt; \dt
</pre>
<ul><li>退出psql</li></ul>
<pre>=&gt; \q or CTRL+d
</pre>
<p>当然也有更多元命令，但这些应该能够帮助您开始。
</p>
<h2>
<span id=".E9.80.89.E6.8B.A9.E9.85.8D.E7.BD.AE"></span><span class="mw-headline" id="选择配置">选择配置</span>
</h2>
<h4>
<span id=".E9.85.8D.E7.BD.AE_PostgreSQL_.E8.A2.AB.E8.BF.9C.E7.A8.8B.E8.AE.BF.E9.97.AE"></span><span class="mw-headline" id="配置_PostgreSQL_被远程访问">配置 PostgreSQL 被远程访问</span>
</h4>
<p>PostgreSQL Server 的配置文件是 <code>postgresql.conf</code>。此文件在数据库数据目录中，通常在 <code>/var/lib/postgres/data</code>。这个目录也包含其他主要的配置文件，包括 <code>pg_hba.conf</code>。
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>注意：</strong> 默认情况下这个目录不能被普通用户访问，这就是 <code>find</code> 或 <code>locate</code> 没有找到这些配置文件的原因。</div>
<p>编辑文件<code>/var/lib/postgres/data/postgresql.conf</code>。在<i>connections and authentications</i>选项中，按照你的需要添加<code>listen_addresses</code>行:
</p>
<pre>listen_addresses = 'localhost,my_remote_server_ip_address'
</pre>
<p>仔细检查其他行。
</p>
<p><code>/var/lib/postgres/data/pg_hba.conf</code>配置基于主机的认证。这个文件控制哪些主机允许连接。要注意默认情况下<b>允许所有本地用户连接任何数据库用户</b>，包括数据库的超级用户。根据下面的描述添加一行:
</p>
<pre># IPv4 local connections:
host   all   all   <i>my_remote_client_ip_address</i>/32   md5
</pre>
<p><code>my_remote_client_ip_address</code>是客户端的IP地址。
</p>
<p>如需更多帮助请查看<a rel="nofollow" class="external text" href="http://www.postgresql.org/docs/current/static/auth-pg-hba-conf.html">pg_hba.conf</a>的文档。
</p>
<p>在完成编辑后你需要<a href="../zh-CN/Systemd.html#%E4%BD%BF%E7%94%A8%E5%8D%95%E5%85%83" title="Systemd (简体中文)">重启</a> <code>postgresql.service</code>服务使你的配置生效。
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>注意：</strong> PostgreSQL默认使用<code>5432</code>端口作为远程连接。确保打开这个端口并可以接受入口连接</div>
<p>如果遇到麻烦，使用下面的命令查看服务器日志:
</p>
<pre>$ journalctl -u postgresql
</pre>
<h4><span class="mw-headline" id="Configure_PostgreSQL_to_work_with_PHP">Configure PostgreSQL to work with PHP</span></h4>
<p>Install the PHP-PostgreSQL modules <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=php-pgsql">php-pgsql</a></span>.
Edit the file <code>/etc/php/php.ini</code>. Find the line that starts with:
</p>
<pre>;extension=pgsql.so
</pre>
<p>Change it to:
</p>
<pre>extension=pgsql.so
</pre>
<p>If you need PDO, do the same thing with <code>;extension=pdo.so</code> and <code>;extension=pdo_pgsql.so</code>. If these lines are not present, add them. These lines may be in the "Dynamic Extensions" section of the file, or toward the very end of the file.
Restart the Apache web server:
</p>
<ol><li>systemctl restart httpd</li></ol>
<h4>
<span id="Change_default_data_dir_.28optional.29"></span><span class="mw-headline" id="Change_default_data_dir_(optional)">Change default data dir (optional)</span>
</h4>
<p>The default directory where all your newly created databases will be stored is <code>/var/lib/postgres/data</code>. To change this, follow these steps:
</p>
<p>Create the new directory and assign it to user <code>postgres</code> (you eventually have to become root):
</p>
<pre>mkdir -p /pathto/pgroot/data
chown -R postgres:postgres /pathto/pgroot
</pre>
<p>Become the postgres user(change to root, then postgres user), and initialize the new cluster:
</p>
<pre>initdb -D /pathto/pgroot/data
</pre>
<p>If not using systemd, edit <code>/etc/conf.d/postgresql</code> and change the PGROOT variable(optionally PGLOG) to point to your new pgroot directory:
</p>
<pre>#PGROOT="/var/lib/postgres/"
PGROOT="<i>/pathto/pgroot/</i>"
</pre>
<p>If using systemd, edit <code>/etc/systemd/system/multi-user.target.wants/postgresql.service</code>, which links to <code>/usr/lib/systemd/system/postgresql.service</code>, and change the default PGROOT path.
</p>
<pre>#Environment=PGROOT=/var/lib/postgres/
Environment=PGROOT=<i>/pathto/pgroot/</i>
</pre>
<p>You will also need to change the default PIDFile path.
</p>
<pre>PIDFile=/pathto/pgroot/data/postmaster.pid
</pre>
<h4><span class="mw-headline" id="Change_default_encoding_of_new_databases_to_UTF-8">Change default encoding of new databases to UTF-8</span></h4>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> If you ran initdb with -E UTF8 these steps are not required</div>
<p>When creating a new database (e.g. with <code>createdb blog</code>) PostgreSQL actually copies a template database. There are two predefined templates: template0 is vanilla, while template1 is meant as an on-site template changeable by the administrator and is used by default. In order to change the encoding of new database, one of the options is to change on-site template1. To do this, log into PostgresSQL shell (psql) and execute the following:
</p>
<p>First, we need to drop template1. Templates cannot be dropped, so we first modify it so it is an ordinary database:
</p>
<pre>UPDATE pg_database SET datistemplate = FALSE WHERE datname = 'template1';
</pre>
<p>Now we can drop it:
</p>
<pre>DROP DATABASE template1;
</pre>
<p>The next step is to create a new database from template0, with a new default encoding:
</p>
<pre>CREATE DATABASE template1 WITH TEMPLATE = template0 ENCODING = 'UNICODE';
</pre>
<p>Now modify template1 so it is actually a template:
</p>
<pre>UPDATE pg_database SET datistemplate = TRUE WHERE datname = 'template1';
</pre>
<p>(OPTIONAL) If you do not want anyone connecting to this template, set datallowconn to FALSE:
</p>
<pre>UPDATE pg_database SET datallowconn = FALSE WHERE datname = 'template1';
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> this last step can create problems when upgrading via <code>pg_upgrade</code>.</div>
<p>Now you can create a new database by running from regular shell:
</p>
<pre>su -
su - postgres
createdb blog;
</pre>
<p>If you log in back to psql and check the databases, you should see the proper encoding of your new database:
</p>
<pre>\l
</pre>
<p>returns
</p>
<pre>                              List of databases
  Name    |  Owner   | Encoding  | Collation | Ctype |   Access privileges
-----------+----------+-----------+-----------+-------+----------------------
blog      | postgres | UTF8      | C         | C     |
postgres  | postgres | SQL_ASCII | C         | C     |
template0 | postgres | SQL_ASCII | C         | C     | =c/postgres
                                                     : postgres=CTc/postgres
template1 | postgres | UTF8      | C         | C     |
</pre>
<h2>
<span id=".E7.AE.A1.E7.90.86.E5.B7.A5.E5.85.B7"></span><span class="mw-headline" id="管理工具">管理工具</span>
</h2>
<ul><li>
<b><a href="../en/PhpPgAdmin.html" title="PhpPgAdmin">phpPgAdmin</a></b> — Web-based administration tool for PostgreSQL.</li></ul>
<dl><dd>
<a rel="nofollow" class="external free" href="http://phppgadmin.sourceforge.net">http://phppgadmin.sourceforge.net</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=phppgadmin">phppgadmin</a></span>
</dd></dl>
<ul><li>
<b>pgAdmin</b> — GUI-based administration tool for PostgreSQL.</li></ul>
<dl><dd>
<a rel="nofollow" class="external free" href="http://www.pgadmin.org/">http://www.pgadmin.org/</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/pgadmin3/">pgadmin3</a></span><sup><small>AUR</small></sup>
</dd></dl>
<p><br>
</p>
<h2>
<span id="Postgresql.E5.8D.87.E7.BA.A7.E9.85.8D.E7.BD.AE"></span><span class="mw-headline" id="Postgresql升级配置">Postgresql升级配置</span>
</h2>
<h3>
<span id=".E5.BF.AB.E9.80.9F.E6.8C.87.E5.8D.97"></span><span class="mw-headline" id="快速指南">快速指南</span>
</h3>
<p>This is for upgrading from 9.2 to 9.3.
</p>
<pre> pacman -S --needed postgresql-old-upgrade
 su -
 su - postgres -c 'mv /var/lib/postgres/data /var/lib/postgres/data-9.2'
 su - postgres -c 'mkdir /var/lib/postgres/data'
 su - postgres -c 'initdb --locale en_US.UTF-8 -E UTF8 -D /var/lib/postgres/data'
</pre>
<p>If you had custom settings in configuration files like pg_hba.conf and postgresql.conf, merge them into the new ones. Then:
</p>
<pre> su - postgres -c 'pg_upgrade -b /opt/pgsql-9.2/bin/ -B /usr/bin/ -d /var/lib/postgres/data-9.2 -D /var/lib/postgres/data'
</pre>
<p>If the "pg_upgrade" step fails with:
</p>
<ul>
<li>
<i>cannot write to log file pg_upgrade_internal.log<br> Failure, exiting</i> <br>Make sure you're in a directory that the "postgres" user has enough rights to write the log file to (<code>/tmp</code> for example). Or use "su - postgres" instead of "sudo -u postgres".</li>
<li>
<i>LC_COLLATE error that says that old and new values are different</i><br>Figure out what the old locale was, C or en_US.UTF-8 for example, and force it when calling initdb.</li>
</ul>
<pre> sudo -u postgres LC_ALL=C initdb -D /var/lib/postgres/data
</pre>
<ul><li>
<i>There seems to be a postmaster servicing the old cluster.<br>Please shutdown that postmaster and try again.</i><br>Make sure postgres isn't running. If you still get the error then chances are these an old PID file you need to clear out.</li></ul>
<pre> &gt; sudo -u postgres ls -l /var/lib/postgres/data-9.2
   total 88
   -rw------- 1 postgres postgres     4 Mar 25  2012 PG_VERSION
   drwx------ 8 postgres postgres  4096 Jul 17 00:36 base
   drwx------ 2 postgres postgres  4096 Jul 17 00:38 global
   drwx------ 2 postgres postgres  4096 Mar 25  2012 pg_clog
   -rw------- 1 postgres postgres  4476 Mar 25  2012 pg_hba.conf
   -rw------- 1 postgres postgres  1636 Mar 25  2012 pg_ident.conf
   drwx------ 4 postgres postgres  4096 Mar 25  2012 pg_multixact
   drwx------ 2 postgres postgres  4096 Jul 17 00:05 pg_notify
   drwx------ 2 postgres postgres  4096 Mar 25  2012 pg_serial
   drwx------ 2 postgres postgres  4096 Jul 17 00:53 pg_stat_tmp
   drwx------ 2 postgres postgres  4096 Mar 25  2012 pg_subtrans
   drwx------ 2 postgres postgres  4096 Mar 25  2012 pg_tblspc
   drwx------ 2 postgres postgres  4096 Mar 25  2012 pg_twophase
   drwx------ 3 postgres postgres  4096 Mar 25  2012 pg_xlog
   -rw------- 1 postgres postgres 19169 Mar 25  2012 postgresql.conf
   -rw------- 1 postgres postgres    48 Jul 17 00:05 postmaster.opts
   -rw------- 1 postgres postgres    80 Jul 17 00:05 postmaster.pid   # &lt;-- This is the problem
 
 &gt; sudo -u postgres mv /var/lib/postgres/data-9.2/postmaster.pid /tmp
</pre>
<ul><li>
<i>ERROR: could not access file "$libdir/postgis-2.0": No such file or directory</i> <br> Retrieve postgis-2.0.so from postgis package for version postgresql 9.2 () and copy it to /opt/pgsql-9.2/lib (make sure the privileges are right)</li></ul>
<p><br>
</p>
<h3>
<span id=".E8.AF.A6.E7.BB.86.E8.AF.B4.E6.98.8E"></span><span class="mw-headline" id="详细说明">详细说明</span>
</h3>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Official PostgreSQL <a rel="nofollow" class="external text" href="http://www.postgresql.org/docs/current/static/upgrading.html">upgrade documentation</a> should be followed.</div>
<p>需要注意的是，这些指令可能会导致数据丢失。 <b>后果自负</b>.
</p>
<p>推荐把下面的加入你的 <code>/etc/pacman.conf</code> 文件中:
</p>
<pre>IgnorePkg = postgresql postgresql-libs
</pre>
<p>这将确保你不会不小心将数据库升级到不兼容的版本中。当一个升级可用时，pacman将通知你，因为在pacman.conf中的设置，它跳过了升级。小版本升级 (e.g., 9.0.3 to 9.0.4) 可以被安全地执行。不过，当如果你突然做一个不同的主版本升级时，(e.g., 9.0.X to 9.1.X), 您可能无法访问你的任何数据。请务必检查PostgreSQL的主页 (<a rel="nofollow" class="external free" href="http://www.postgresql.org/">http://www.postgresql.org/</a>) ，以确认每次升级所需要的步骤。对于为什么是这种情况见 <a rel="nofollow" class="external text" href="http://www.postgresql.org/support/versioning">versioning policy</a>。
</p>
<p>主要有两种方式来升级您的PostgreSQL数据库。阅读官方文档细节。
</p>
<p>For those wishing to use <code>pg_upgrade</code>, a <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=postgresql-old-upgrade">postgresql-old-upgrade</a></span> package is available in the repositories that will always run one major version behind the real PostgreSQL package. This can be installed side by side with the new version of PostgreSQL. When you are ready to perform the upgrade, you can do
</p>
<pre>pacman -Syu postgresql postgresql-libs postgresql-old-upgrade
</pre>
<p>Note also that the data directory does not change from version to version, so before running pg_upgrade it is necessary to rename your existing data directory and migrate into a new directory. The new database must be initialized by starting the server, as described near the top of this page.  The server then needs to be stopped before running pg_upgrade.
</p>
<pre># systemctl stop postgresql
# su - postgres -c 'mv /var/lib/postgres/data /var/lib/postgres/olddata'
# systemctl start postgresql
# systemctl stop postgresql
</pre>
<p>Reference the <a rel="nofollow" class="external text" href="http://www.postgresql.org/docs/current/static/pgupgrade.html">upstream pg_upgrade documentation</a> for details.
</p>
<p>The upgrade invocation will likely look something like the following (run as the postgres user). <b>Do not run this command blindly without understanding what it does!</b>
</p>
<pre># su - postgres -c 'pg_upgrade -d /var/lib/postgres/olddata/ -D /var/lib/postgres/data/ -b /opt/pgsql-8.4/bin/ -B /usr/bin/'
</pre>
<p>You could also do something like this (after the upgrade and install of postgresql-old-upgrade) (NB: these instructions DON'T seem to work for 9.2 -&gt; 9.3 upgrades)
</p>
<pre># systemctl stop postgresql
# /opt/pgsql-8.4/bin/pg_ctl -D /var/lib/postgres/olddata/ start
# pg_dumpall &gt;&gt; old_backup.sql
# /opt/pgsql-8.4/bin/pg_ctl -D /var/lib/postgres/olddata/ stop
# systemctl start postgresql
# psql -f old_backup.sql postgres
</pre>
<h2><span class="mw-headline" id="Troubleshooting">Troubleshooting</span></h2>
<h3><span class="mw-headline" id="Improve_performance_of_small_transactions">Improve performance of small transactions</span></h3>
<p>If you are using PostgresSQL on a local machine for development and it seems slow, you could try turning <a rel="nofollow" class="external text" href="http://www.postgresql.org/docs/current/static/runtime-config-wal.html#GUC-SYNCHRONOUS-COMMIT">synchronous_commit off</a> in the configuration (<code>/var/lib/postgres/data/postgresql.conf</code>). Beware of the <a rel="nofollow" class="external text" href="http://www.postgresql.org/docs/current/static/runtime-config-wal.html#GUC-SYNCHRONOUS-COMMIT">caveats</a>, however.
</p>
<pre>synchronous_commit = off
</pre>
<h3>
<span id=".E7.A9.BA.E9.97.B2.E6.97.B6.E9.98.B2.E6.AD.A2.E7.A3.81.E7.9B.98.E5.86.99.E5.85.A5"></span><span class="mw-headline" id="空闲时防止磁盘写入">空闲时防止磁盘写入</span>
</h3>
<p>PostgreSQL periodically updates its internal "statistics" file. By default, this file is stored on disk, which prevents disks spinning down on laptops and causes hard drive seek noise. It's simple and safe to relocate this file to a memory-only file system with the following configuration option:
</p>
<pre>stats_temp_directory = '/run/postgresql'
</pre>
<h2><span class="mw-headline" id="See_also">See also</span></h2>
<ul><li><a rel="nofollow" class="external text" href="http://www.postgresql.org/">Official PostgreSQL Homepage</a></li></ul>
</div>
</div>
<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../zh-CN/Category:Relational_DBMSs.html" title="Category:Relational DBMSs (简体中文)">Relational DBMSs (简体中文)</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden category: <ul><li><a href="../zh-CN/Category:Pages_or_sections_flagged_with_Template:Translateme.html" title="Category:Pages or sections flagged with Template:Translateme (简体中文)">Pages or sections flagged with Template:Translateme (简体中文)</a></li></ul>
</div>
</div>
	</div>
</div>

<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
		<li>Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=PostgreSQL_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)&amp;oldid=627532">https://wiki.archlinux.org/index.php?title=PostgreSQL_(简体中文)&amp;oldid=627532</a>"</li>
		<li id="footer-info-lastmod"> This page was last edited on 31 July 2020, at 19:33.</li>
		<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="http://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
	<br>
</ul>
	<ul id="footer-places">
		<li id="footer-places-privacy"><a href="../en/ArchWiki:Privacy_policy.html" title="ArchWiki:Privacy policy">Privacy policy</a></li>
		<li id="footer-places-about"><a href="../en/ArchWiki:About.html" title="ArchWiki:About">About ArchWiki</a></li>
		<li id="footer-places-disclaimer"><a href="../en/ArchWiki:General_disclaimer.html" title="ArchWiki:General disclaimer">Disclaimers</a></li>
	</ul>
	<ul id="footer-icons" class="noprint">
		<li id="footer-copyrightico">
	</ul>
	<div style="clear: both;"></div>
</footer>



</body>
</html>
