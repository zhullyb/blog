<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>Samba (简体中文) - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.35.0">
<meta name="robots" content="noindex,follow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="http://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Samba_简体中文 rootpage-Samba_简体中文 skin-vector action-view skin-vector-legacy">
<div id="content" class="mw-body" role="main" style="margin: 0">
	<a id="top"></a>
	<div id="siteNotice" class="mw-body-content"></div>
	<div class="mw-indicators mw-body-content">
	</div>
	<h1 id="firstHeading" class="firstHeading" lang="en">Samba (简体中文)</h1>
	<div id="bodyContent" class="mw-body-content">
		<div id="siteSub" class="noprint">From ArchWiki</div>
		<div id="contentSub"></div>
		<div id="contentSub2"></div>
		
		<div id="jump-to-nav"></div>
		<a class="mw-jump-link" href="#mw-head">Jump to navigation</a>
		<a class="mw-jump-link" href="#searchInput">Jump to search</a>
		<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr">
<div class="warningbox">The printable version is no longer supported and may have rendering errors. Please update your browser bookmarks and please use the default browser print function instead.</div>
<div class="mw-parser-output">
<div class="archwiki-template-meta-related-articles-start">
<p>相关文章</p>
<ul>
<li><a href="../en/NFS.html" title="NFS">NFS</a></li>
<li><a href="../en/Samba/Active_Directory_domain_controller.html" title="Samba/Active Directory domain controller">Samba/Active Directory domain controller</a></li>
<li><a href="../en/Active_Directory_integration.html" class="mw-redirect" title="Active Directory Integration">Active Directory Integration</a></li>
</ul>
</div>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>翻译状态：</strong>本文是 <a href="../en/Samba.html" title="Samba">Samba</a> 的<a href="../zh-CN/ArchWiki:Translation_Team.html" title="ArchWiki:Translation Team (简体中文)">翻译</a>。上次翻译日期：2020-05-06。如果英文版本有所<a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php?title=Samba&amp;diff=0&amp;oldid=606810">更改</a>，则您可以帮助同步翻译。</div>
<p><b>Samba</b> 是 <a href="https://en.wikipedia.org/wiki/Server_Message_Block" class="extiw" title="wikipedia:Server Message Block">SMB/CIFS</a> 网络协议的重新实现, 可以在 Linux 和 Windows 系统间进行文件、打印机共享，和 <a href="../zh-CN/NFS.html" title="NFS (简体中文)">NFS</a> 的功能类似。本文介绍如何配置和使用 Samba.
</p>
<div id="toc" class="toc" role="navigation" aria-labelledby="mw-toc-heading">
<input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none"><div class="toctitle" lang="en" dir="ltr">
<h2 id="mw-toc-heading">Contents</h2>
<span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span>
</div>
<ul>
<li class="toclevel-1 tocsection-1">
<a href="#%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="tocnumber">1</span> <span class="toctext">服务器</span></a>
<ul>
<li class="toclevel-2 tocsection-2">
<a href="#%E5%AE%89%E8%A3%85"><span class="tocnumber">1.1</span> <span class="toctext">安装</span></a>
<ul>
<li class="toclevel-3 tocsection-3"><a href="#%E9%85%8D%E7%BD%AE%E9%98%B2%E7%81%AB%E5%A2%99"><span class="tocnumber">1.1.1</span> <span class="toctext">配置防火墙</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-4">
<a href="#%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86"><span class="tocnumber">1.2</span> <span class="toctext">用户管理</span></a>
<ul>
<li class="toclevel-3 tocsection-5"><a href="#%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7"><span class="tocnumber">1.2.1</span> <span class="toctext">添加用户</span></a></li>
<li class="toclevel-3 tocsection-6"><a href="#%E6%9F%A5%E8%AF%A2%E7%94%A8%E6%88%B7"><span class="tocnumber">1.2.2</span> <span class="toctext">查询用户</span></a></li>
<li class="toclevel-3 tocsection-7"><a href="#%E6%9B%B4%E6%94%B9_samba_%E7%94%A8%E6%88%B7%E7%9A%84%E5%AF%86%E7%A0%81"><span class="tocnumber">1.2.3</span> <span class="toctext">更改 samba 用户的密码</span></a></li>
<li class="toclevel-3 tocsection-8"><a href="#%E5%88%9B%E5%BB%BA%E5%85%B1%E4%BA%AB"><span class="tocnumber">1.2.4</span> <span class="toctext">创建共享</span></a></li>
<li class="toclevel-3 tocsection-9"><a href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="tocnumber">1.2.5</span> <span class="toctext">启动服务</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-10">
<a href="#%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE"><span class="tocnumber">1.3</span> <span class="toctext">高级配置</span></a>
<ul>
<li class="toclevel-3 tocsection-11"><a href="#%E5%BB%BA%E7%AB%8B_Usershare_%E8%B7%AF%E5%BE%84"><span class="tocnumber">1.3.1</span> <span class="toctext">建立 Usershare 路径</span></a></li>
<li class="toclevel-3 tocsection-12"><a href="#Set_and_forcing_permissions"><span class="tocnumber">1.3.2</span> <span class="toctext">Set and forcing permissions</span></a></li>
<li class="toclevel-3 tocsection-13"><a href="#Restrict_protocols_for_better_security"><span class="tocnumber">1.3.3</span> <span class="toctext">Restrict protocols for better security</span></a></li>
<li class="toclevel-3 tocsection-14"><a href="#Restrict_protocols_for_better_security_2"><span class="tocnumber">1.3.4</span> <span class="toctext">Restrict protocols for better security</span></a></li>
<li class="toclevel-3 tocsection-15"><a href="#Use_native_SMB_transport_encryption"><span class="tocnumber">1.3.5</span> <span class="toctext">Use native SMB transport encryption</span></a></li>
<li class="toclevel-3 tocsection-16"><a href="#Disable_printer_sharing"><span class="tocnumber">1.3.6</span> <span class="toctext">Disable printer sharing</span></a></li>
<li class="toclevel-3 tocsection-17"><a href="#Block_certain_file_extensions_on_Samba_share"><span class="tocnumber">1.3.7</span> <span class="toctext">Block certain file extensions on Samba share</span></a></li>
<li class="toclevel-3 tocsection-18"><a href="#Improve_throughput"><span class="tocnumber">1.3.8</span> <span class="toctext">Improve throughput</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-19">
<a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%85%8D%E7%BD%AE"><span class="tocnumber">2</span> <span class="toctext">客户端配置</span></a>
<ul>
<li class="toclevel-2 tocsection-20"><a href="#%E6%98%BE%E7%A4%BA%E5%8F%AF%E7%94%A8%E5%85%B1%E4%BA%AB"><span class="tocnumber">2.1</span> <span class="toctext">显示可用共享</span></a></li>
<li class="toclevel-2 tocsection-21"><a href="#WINS_%E4%B8%BB%E6%9C%BA%E5%90%8D"><span class="tocnumber">2.2</span> <span class="toctext">WINS 主机名</span></a></li>
<li class="toclevel-2 tocsection-22">
<a href="#%E6%89%8B%E5%8A%A8%E6%8C%82%E8%BD%BD"><span class="tocnumber">2.3</span> <span class="toctext">手动挂载</span></a>
<ul>
<li class="toclevel-3 tocsection-23"><a href="#%E4%BF%9D%E5%AD%98%E5%85%B1%E4%BA%AB%E5%AF%86%E7%A0%81"><span class="tocnumber">2.3.1</span> <span class="toctext">保存共享密码</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-24">
<a href="#Automatic_mounting"><span class="tocnumber">2.4</span> <span class="toctext">Automatic mounting</span></a>
<ul>
<li class="toclevel-3 tocsection-25"><a href="#As_mount_entry"><span class="tocnumber">2.4.1</span> <span class="toctext">As mount entry</span></a></li>
<li class="toclevel-3 tocsection-26">
<a href="#As_systemd_unit"><span class="tocnumber">2.4.2</span> <span class="toctext">As systemd unit</span></a>
<ul>
<li class="toclevel-4 tocsection-27"><a href="#automount"><span class="tocnumber">2.4.2.1</span> <span class="toctext">automount</span></a></li>
</ul>
</li>
<li class="toclevel-3 tocsection-28">
<a href="#smbnetfs"><span class="tocnumber">2.4.3</span> <span class="toctext">smbnetfs</span></a>
<ul>
<li class="toclevel-4 tocsection-29"><a href="#Daemon"><span class="tocnumber">2.4.3.1</span> <span class="toctext">Daemon</span></a></li>
</ul>
</li>
<li class="toclevel-3 tocsection-30"><a href="#autofs"><span class="tocnumber">2.4.4</span> <span class="toctext">autofs</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-31">
<a href="#File_manager_configuration"><span class="tocnumber">2.5</span> <span class="toctext">File manager configuration</span></a>
<ul>
<li class="toclevel-3 tocsection-32"><a href="#GNOME_Files,_Nemo,_Caja,_Thunar_and_PCManFM"><span class="tocnumber">2.5.1</span> <span class="toctext">GNOME Files, Nemo, Caja, Thunar and PCManFM</span></a></li>
<li class="toclevel-3 tocsection-33"><a href="#KDE"><span class="tocnumber">2.5.2</span> <span class="toctext">KDE</span></a></li>
<li class="toclevel-3 tocsection-34"><a href="#Other_graphical_environments"><span class="tocnumber">2.5.3</span> <span class="toctext">Other graphical environments</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-35">
<a href="#Tips_and_tricks"><span class="tocnumber">3</span> <span class="toctext">Tips and tricks</span></a>
<ul>
<li class="toclevel-2 tocsection-36"><a href="#Discovering_network_shares"><span class="tocnumber">3.1</span> <span class="toctext">Discovering network shares</span></a></li>
<li class="toclevel-2 tocsection-37"><a href="#Remote_control_of_Windows_computer"><span class="tocnumber">3.2</span> <span class="toctext">Remote control of Windows computer</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-38">
<a href="#Troubleshooting"><span class="tocnumber">4</span> <span class="toctext">Troubleshooting</span></a>
<ul>
<li class="toclevel-2 tocsection-39"><a href="#Failed_to_start_Samba_SMB/CIFS_server"><span class="tocnumber">4.1</span> <span class="toctext">Failed to start Samba SMB/CIFS server</span></a></li>
<li class="toclevel-2 tocsection-40"><a href="#Permission_issues_on_AppArmor"><span class="tocnumber">4.2</span> <span class="toctext">Permission issues on AppArmor</span></a></li>
<li class="toclevel-2 tocsection-41"><a href="#No_dialect_specified_on_mount"><span class="tocnumber">4.3</span> <span class="toctext">No dialect specified on mount</span></a></li>
<li class="toclevel-2 tocsection-42"><a href="#Unable_to_overwrite_files,_permissions_errors"><span class="tocnumber">4.4</span> <span class="toctext">Unable to overwrite files, permissions errors</span></a></li>
<li class="toclevel-2 tocsection-43"><a href="#Windows_clients_keep_asking_for_password_even_if_Samba_shares_are_created_with_guest_permissions"><span class="tocnumber">4.5</span> <span class="toctext">Windows clients keep asking for password even if Samba shares are created with guest permissions</span></a></li>
<li class="toclevel-2 tocsection-44"><a href="#Windows_7_connectivity_problems_-_mount_error(12):_cannot_allocate_memory"><span class="tocnumber">4.6</span> <span class="toctext">Windows 7 connectivity problems - mount error(12): cannot allocate memory</span></a></li>
<li class="toclevel-2 tocsection-45"><a href="#Windows_10_1709_and_up_connectivity_problems_-_%22Windows_cannot_access%22_0x80004005"><span class="tocnumber">4.7</span> <span class="toctext">Windows 10 1709 and up connectivity problems - "Windows cannot access" 0x80004005</span></a></li>
<li class="toclevel-2 tocsection-46"><a href="#Error:_Failed_to_retrieve_printer_list:_NT_STATUS_UNSUCCESSFUL"><span class="tocnumber">4.8</span> <span class="toctext">Error: Failed to retrieve printer list: NT_STATUS_UNSUCCESSFUL</span></a></li>
<li class="toclevel-2 tocsection-47"><a href="#Sharing_a_folder_fails"><span class="tocnumber">4.9</span> <span class="toctext">Sharing a folder fails</span></a></li>
<li class="toclevel-2 tocsection-48"><a href="#%22Browsing%22_network_fails_with_%22Failed_to_retrieve_share_list_from_server%22"><span class="tocnumber">4.10</span> <span class="toctext">"Browsing" network fails with "Failed to retrieve share list from server"</span></a></li>
<li class="toclevel-2 tocsection-49"><a href="#Protocol_negotiation_failed:_NT_STATUS_INVALID_NETWORK_RESPONSE"><span class="tocnumber">4.11</span> <span class="toctext">Protocol negotiation failed: NT_STATUS_INVALID_NETWORK_RESPONSE</span></a></li>
<li class="toclevel-2 tocsection-50"><a href="#Connection_to_SERVER_failed:_(Error_NT_STATUS_UNSUCCESSFUL)"><span class="tocnumber">4.12</span> <span class="toctext">Connection to SERVER failed: (Error NT_STATUS_UNSUCCESSFUL)</span></a></li>
<li class="toclevel-2 tocsection-51"><a href="#Connection_to_SERVER_failed:_(Error_NT_STATUS_CONNECTION_REFUSED)"><span class="tocnumber">4.13</span> <span class="toctext">Connection to SERVER failed: (Error NT_STATUS_CONNECTION_REFUSED)</span></a></li>
<li class="toclevel-2 tocsection-52"><a href="#Protocol_negotiation_failed:_NT_STATUS_CONNECTION_RESET"><span class="tocnumber">4.14</span> <span class="toctext">Protocol negotiation failed: NT_STATUS_CONNECTION_RESET</span></a></li>
<li class="toclevel-2 tocsection-53"><a href="#Password_Error_when_correct_credentials_are_given_(error_1326)"><span class="tocnumber">4.15</span> <span class="toctext">Password Error when correct credentials are given (error 1326)</span></a></li>
<li class="toclevel-2 tocsection-54"><a href="#Mapping_reserved_Windows_characters"><span class="tocnumber">4.16</span> <span class="toctext">Mapping reserved Windows characters</span></a></li>
<li class="toclevel-2 tocsection-55">
<a href="#Folder_shared_inside_graphical_environment_is_not_available_to_guests"><span class="tocnumber">4.17</span> <span class="toctext">Folder shared inside graphical environment is not available to guests</span></a>
<ul>
<li class="toclevel-3 tocsection-56"><a href="#Verify_correct_samba_configuration"><span class="tocnumber">4.17.1</span> <span class="toctext">Verify correct samba configuration</span></a></li>
<li class="toclevel-3 tocsection-57"><a href="#Verify_correct_shared_folder_creation"><span class="tocnumber">4.17.2</span> <span class="toctext">Verify correct shared folder creation</span></a></li>
<li class="toclevel-3 tocsection-58"><a href="#Verify_folder_access_by_guest"><span class="tocnumber">4.17.3</span> <span class="toctext">Verify folder access by guest</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-59"><a href="#Mount_error:_Host_is_down"><span class="tocnumber">4.18</span> <span class="toctext">Mount error: Host is down</span></a></li>
<li class="toclevel-2 tocsection-60"><a href="#Software_caused_connection_abort"><span class="tocnumber">4.19</span> <span class="toctext">Software caused connection abort</span></a></li>
<li class="toclevel-2 tocsection-61"><a href="#Connection_problem_(due_to_authentification_error)"><span class="tocnumber">4.20</span> <span class="toctext">Connection problem (due to authentification error)</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-62"><a href="#See_also"><span class="tocnumber">5</span> <span class="toctext">See also</span></a></li>
</ul>
</div>

<h2>
<span id=".E6.9C.8D.E5.8A.A1.E5.99.A8"></span><span class="mw-headline" id="服务器">服务器</span>
</h2>
<h3>
<span id=".E5.AE.89.E8.A3.85"></span><span class="mw-headline" id="安装">安装</span>
</h3>
<p><a href="../en/Pacman.html" title="Pacman">安装</a> 软件包 <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=samba">samba</a></span>。
</p>
<p>Samba 服务的配置文件是 <code>/etc/samba/smb.conf</code>，<span class="plainlinks archwiki-template-man" title="$ man 5 smb.conf"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/smb.conf.5">smb.conf(5)</a></span>提供了详细的文档。
</p>
<p><span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=samba">samba</a></span> 软件包没有提供此文件，启动 <i>smb</i>.service 前需要先创建这个文件。从 <a rel="nofollow" class="external text" href="https://git.samba.org/samba.git/?p=samba.git;a=blob_plain;f=examples/smb.conf.default;hb=HEAD">这里</a> 可以获取到示例文件。
</p>
<p>从上面获取的默认配置文件里把日志<code>log file</code>设置到一个不能写的地方, 这会引起错误。下面的办法可以解决这个问题:
</p>
<ul><li>把日志文件放到可写的路径: <code>log file = /var/log/samba/%m.log</code>
<ul><li>把日志存到非文件后端的解决方案里: <code>logging = syslog</code> 配合 <code>syslog only = yes</code>, 或者使用 <code>logging = systemd</code>
</li></ul>
</li></ul>
<p>如果需要的话; 在<code>[global]</code>部份中指定的 <code>workgroup</code> 需要对应windows工作组的名称 (默认是 <code>WORKGROUP</code>).
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> 修改 <code>smb.conf</code> 文件后，运行 <span class="plainlinks archwiki-template-man" title="$ man 1 testparm"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/testparm.1">testparm(1)</a></span> 命令看看有没有语法错误。</div>
<h4>
<span id=".E9.85.8D.E7.BD.AE.E9.98.B2.E7.81.AB.E5.A2.99"></span><span class="mw-headline" id="配置防火墙">配置防火墙</span>
</h4>
<p>如果使用了 <a href="../en/Category:Firewalls.html" class="mw-redirect" title="Firewall">防火墙</a>，请记得打开需要的端口(通常是 137-139 + 445). 完整列表请查看 <a rel="nofollow" class="external text" href="https://www.samba.org/~tpot/articles/firewall.html">Samba 端口使用</a>。
</p>
<h3>
<span id=".E7.94.A8.E6.88.B7.E7.AE.A1.E7.90.86"></span><span class="mw-headline" id="用户管理">用户管理</span>
</h3>
<h4>
<span id=".E6.B7.BB.E5.8A.A0.E7.94.A8.E6.88.B7"></span><span class="mw-headline" id="添加用户">添加用户</span>
</h4>
<p>Samba 需要 Linux 账户才能使用 - 可以使用已有账户或 <a href="../en/Users_and_groups.html#User_management" title="Users and groups">创建新用户</a>.
</p>
<p>虽然用户名可以和 Linux 系统共享，Samba 使用单独的密码管理，将下面的 <code>samba_user</code> 替换为选择的 Samba 用户:
</p>
<pre># smbpasswd -a <i>samba_user</i>
</pre>
<p>根据 <a rel="nofollow" class="external text" href="https://www.samba.org/samba/docs/man/manpages-3/smb.conf.5.html#SERVERROLE">服务器角色</a> 的差异，可能需要修改已有的 <a href="../en/File_permissions_and_attributes.html" title="File permissions and attributes">文件权限和属性</a>。
</p>
<p>要让新创建的用户仅能访问 Samba 远程文件服务器，可以禁用其它登录选项
</p>
<ul>
<li>禁用 shell - <code>usermod --shell /usr/bin/nologin --lock samba_user</code>
</li>
<li>禁用 SSH logons  - /etc/ssh/sshd_conf, option <code>AllowUsers</code>
</li>
</ul>
<p>参阅<a href="../en/Security.html" title="Security">Security</a>。
</p>
<h4>
<span id=".E6.9F.A5.E8.AF.A2.E7.94.A8.E6.88.B7"></span><span class="mw-headline" id="查询用户">查询用户</span>
</h4>
<p>用 <span class="plainlinks archwiki-template-man" title="$ man 8 pdbedit"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/pdbedit.8">pdbedit(8)</a></span> 命令查询现有用户:
</p>
<pre># pdbedit -L -v
</pre>
<h4>
<span id=".E6.9B.B4.E6.94.B9_samba_.E7.94.A8.E6.88.B7.E7.9A.84.E5.AF.86.E7.A0.81"></span><span class="mw-headline" id="更改_samba_用户的密码">更改 samba 用户的密码</span>
</h4>
<p>用 <code>smbpasswd</code> 修改 samba 用户的密码:
</p>
<pre># smbpasswd <i>samba_user</i>
</pre>
<h4>
<span id=".E5.88.9B.E5.BB.BA.E5.85.B1.E4.BA.AB"></span><span class="mw-headline" id="创建共享">创建共享</span>
</h4>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> To allow the usage of <i>guests</i> on public shares, one may need to <a href="../en/Help:Reading.html#Append,_add,_create,_edit" class="mw-redirect" title="Append">append</a> <code>map to guest = Bad User</code> in the <code>[global]</code> section of <code>/etc/samba/smb.conf</code>. A different <code>guest account</code> may be used instead of the default provided <code>nobody</code>.</div>
<p>请确保 <a rel="nofollow" class="external text" href="https://git.samba.org/samba.git/?p=samba.git;a=blob_plain;f=examples/smb.conf.default;hb=HEAD">smb.conf.default</a> 的 <i>Share Definitions</i> 部分正确设置了共享。
</p>
<h4>
<span id=".E5.90.AF.E5.8A.A8.E6.9C.8D.E5.8A.A1"></span><span class="mw-headline" id="启动服务">启动服务</span>
</h4>
<p>为了能够使用 SMB 进行基本的文件共享，<a href="../en/Systemd.html#Using_units" title="Systemd">start/enable</a> <code>smb.service</code> 和 <code>nmb.service</code> 服务。更多信息参阅 <a rel="nofollow" class="external text" href="http://www.samba.org/samba/docs/man/manpages-3/smbd.8.html">smbd</a> 和 <a rel="nofollow" class="external text" href="http://www.samba.org/samba/docs/man/manpages-3/nmbd.8.html">nmbd</a> 的 man 手册。
<code>nmbd.service</code> 并不总是需要启用。
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>提示：</strong> 除了在启动时启动服务，可以选择启用 <code>smbd.socket</code>，禁用 <code>smbd.service</code>。这样的话会在第一次收到连接请求是启动后台进程。</div>
<h3>
<span id=".E9.AB.98.E7.BA.A7.E9.85.8D.E7.BD.AE"></span><span class="mw-headline" id="高级配置">高级配置</span>
</h3>
<h4>
<span id=".E5.BB.BA.E7.AB.8B_Usershare_.E8.B7.AF.E5.BE.84"></span><span class="mw-headline" id="建立_Usershare_路径">建立 Usershare 路径</span>
</h4>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 此为可选功能，如无需要可以跳过。</div>
<p><a rel="nofollow" class="external text" href="https://www.samba.org/samba/docs/current/man-html/smb.conf.5.html">Usershares</a> 让不具有 root 权限的用户可以进行添加、修改和删除自己的文件夹的操作。
</p>
<p>以下操作将会在 <code>/var/lib/samba</code> 添加 usershares 目录：
</p>
<pre>#mkdir /var/lib/samba/usershare
</pre>
<p>以下操作将会建立 sambashare 用户组：
</p>
<pre>#groupadd sambashare
</pre>
<p>以下操作将会将刚刚建立的文件夹的权限：拥有者更改为 root，群组更改为 sambashare：
</p>
<pre># chown root:sambashare /var/lib/samba/usershare
</pre>
<p>以下的操作将会让 sambashare 群组中的用户拥有读取，写入和执行此文件夹中内容的权限：
</p>
<pre># chmod 1770 /var/lib/samba/usershare
</pre>
<p>修改 <code>smb.conf</code> 配置文件中的以下变量：
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/samba/smb.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">...
[global]
  usershare path = /var/lib/samba/usershare
  usershare max shares = 100
  usershare allow guests = yes
  usershare owner only = yes
  ...</pre>
<p>将用户添加到群组 <i>sambashare</i> 中。其中，替换 <code><i>your_username</i></code> 为实际的用户名：
</p>
<pre># usermod -a -G sambashare <i>your_username</i>
</pre>
<p>重启 <code>smbd.service</code> 和 <code>nmbd.service</code> 服务。
</p>
<p>注销后重新登陆，此时您应该就可以使用 GUI 程序配置您的 samba 共享服务了。例如，在 <a href="../en/Thunar.html" title="Thunar">Thunar</a> 中您可以右键点击任何一个文件夹将它在局域网中共享。如果你想共享自己主目录内的路径，需要主目录的内容让其它用户可以列出。
</p>
<p>在命令行中，请使用下面命令, 替换掉 <i>sharename</i>, <i>user</i>, ... :
</p>
<pre># net usershare add <i>sharename</i> <i>abspath</i> [<i>comment</i>] [<i>user</i>:{R|D|F}] [guest_ok={y|n}]
# net usershare delete <i>sharename</i>
# net usershare list <i>wildcard-sharename</i>
# net usershare info <i>wildcard-sharename</i>
</pre>
<h4><span class="mw-headline" id="Set_and_forcing_permissions">Set and forcing permissions</span></h4>
<p>Permissions may be applied to both the server and shares:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/samba/smb.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[global]
  ;inherit owner = unix only ; Inherit ownership of the parent directory for new files and directories
  ;inherit permissions = yes ; Inherit permissions of the parent directory for new files and directories
  create mask = 0664
  directory mask = 2755
  force create mode = 0644
  force directory mode = 2755
  ...

[media]
  comment = Media share accessible by <i>greg</i> and <i>pcusers</i>
  path = <i>/path/to/media</i>
  valid users = <i>greg @pcusers</i>
  force group = <i>+pcusers</i>
  public = no
  writable = yes
  create mask = 0664
  directory mask = 2775
  force create mode = 0664
  force directory mode = 2775

[public]
  comment = Public share where <i>archie</i> has write access
  path = <i>/path/to/public</i>
  public = yes
  read only = yes
  write list = <i>archie</i>
  printable = no

[guests]
  comment = Allow all users to read/write
  path = <i>/path/to/guests</i>
  public = yes
  only guest = yes
  writable = yes
  printable = no</pre>
<p>See <span class="plainlinks archwiki-template-man" title="$ man 5 smb.conf"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/smb.conf.5">smb.conf(5)</a></span> for a full overview of possible permission flags and settings.
</p>
<h4><span class="mw-headline" id="Restrict_protocols_for_better_security">Restrict protocols for better security</span></h4>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> By default, Samba versions prior to 4.11 allow connections using the outdated and insecure SMB1 protocol. When using one these Samba versions, it is highly recommended to set <code>server min protocol = SMB2_02</code> to protect yourself from ransomware attacks. In Samba 4.11 and newer, SMB2 is the default min protocol, so no changes are required there.</div>
<p><a href="../en/Help:Reading.html#Append,_add,_create,_edit" class="mw-redirect" title="Append">Append</a> <code>server min protocol</code> and <code>server max protocol</code> in <code>/etc/samba/smb.conf</code> to force usage of a minimum and maximum protocol:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/samba/smb.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[global]
  server min protocol = SMB2_02
  ; server max protocol = SMB3</pre>
<p>See <code>server max protocol</code> in <span class="plainlinks archwiki-template-man" title="$ man 5 smb.conf"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/smb.conf.5">smb.conf(5)</a></span> for an overview of supported protocols.
</p>
<p>For compatibility with older clients and/or servers, you might need to set <code>client min protocol = CORE</code> or <code>server min protocol = CORE</code>, but please note that this makes you vulnerable to exploits in SMB1 including ransomware attacks.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> Use <code>server min protocol = SMB3_00</code> when clients should only connect using the latest SMB3 protocol, e.g. on clients running Windows 8 and later.</div>
<p><a href="#Manual_mounting">Clients</a><sup>[<a href="../en/ArchWiki:Requests.html#Broken_section_links" class="mw-redirect" title="ArchWiki:Requests">断开的链接</a>：无效的部分]</sup> using <code>mount.cifs</code> may need to specify the correct <code>vers=*</code>, e.g.:
</p>
<pre># mount -t cifs //<i>SERVER</i>/<i>sharename</i> /mnt/<i>mountpoint</i> -o username=<i>username</i>,password=<i>password</i>,iocharset=<i>utf8</i>,vers=<i>3.1.1</i>
</pre>
<p>See <span class="plainlinks archwiki-template-man" title="$ man 8 mount.cifs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/mount.cifs.8">mount.cifs(8)</a></span> for more information.
</p>
<h4><span class="mw-headline" id="Restrict_protocols_for_better_security_2">Restrict protocols for better security</span></h4>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> By default, Samba versions prior to 4.11 allow connections using the outdated and insecure SMB1 protocol. When using one these Samba versions, it is highly recommended to set <code>server min protocol = SMB2_02</code> to protect yourself from ransomware attacks. In Samba 4.11 and newer, SMB2 is the default min protocol, so no changes are required there.</div>
<p><a href="../en/Help:Reading.html#Append,_add,_create,_edit" class="mw-redirect" title="Append">Append</a> <code>server min protocol</code> and <code>server max protocol</code> in <code>/etc/samba/smb.conf</code> to force usage of a minimum and maximum protocol:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/samba/smb.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[global]
  server min protocol = SMB2_02
  ; server max protocol = SMB3</pre>
<p>See <code>server max protocol</code> in <span class="plainlinks archwiki-template-man" title="$ man 5 smb.conf"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/smb.conf.5">smb.conf(5)</a></span> for an overview of supported protocols.
</p>
<p>For compatibility with older clients and/or servers, you might need to set <code>client min protocol = CORE</code> or <code>server min protocol = CORE</code>, but please note that this makes you vulnerable to exploits in SMB1 including ransomware attacks.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> Use <code>server min protocol = SMB3_00</code> when clients should only connect using the latest SMB3 protocol, e.g. on clients running Windows 8 and later.</div>
<p><a href="#Manual_mounting">Clients</a><sup>[<a href="../en/ArchWiki:Requests.html#Broken_section_links" class="mw-redirect" title="ArchWiki:Requests">断开的链接</a>：无效的部分]</sup> using <code>mount.cifs</code> may need to specify the correct <code>vers=*</code>, e.g.:
</p>
<pre># mount -t cifs //<i>SERVER</i>/<i>sharename</i> /mnt/<i>mountpoint</i> -o username=<i>username</i>,password=<i>password</i>,iocharset=<i>utf8</i>,vers=<i>3.1.1</i>
</pre>
<p>See <span class="plainlinks archwiki-template-man" title="$ man 8 mount.cifs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/mount.cifs.8">mount.cifs(8)</a></span> for more information.
</p>
<h4><span class="mw-headline" id="Use_native_SMB_transport_encryption">Use native SMB transport encryption</span></h4>
<p>Native SMB transport encryption is available in SMB version 3.0 or newer. Clients supporting this type of encryption include Windows 8 and newer, Windows server 2012 and newer, and smbclient of Samba 4.1 and newer.
</p>
<p>To use native SMB transport encryption by default, set the <code>smb encrypt</code> parameter globally and/or by share. Possible values are <code>off</code>, <code>enabled</code> (default value), <code>desired</code>, or <code>required</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/samba/smb.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[global]
  smb encrypt = desired</pre>
<p>See <span class="plainlinks archwiki-template-man" title="$ man 5 smb.conf"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/smb.conf.5">smb.conf(5)</a></span> for more information, especially the paragraphs <i>Effects for SMB1</i> and <i>Effects for SMB2</i>.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> When <a href="#Manual_mounting">mounting</a><sup>[<a href="../en/ArchWiki:Requests.html#Broken_section_links" class="mw-redirect" title="ArchWiki:Requests">断开的链接</a>：无效的部分]</sup> a share, specify the <code>seal</code> mount option to force usage of encryption.</div>
<h4><span class="mw-headline" id="Disable_printer_sharing">Disable printer sharing</span></h4>
<p>By default Samba shares printers configured using <a href="../en/CUPS.html" title="CUPS">CUPS</a>.
</p>
<p>If you do not want printers to be shared, use the following settings:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/samba/smb.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[global]
  load printers = no
  printing = bsd
  printcap name = /dev/null
  disable spoolss = yes
  show add printer wizard = no</pre>
<h4><span class="mw-headline" id="Block_certain_file_extensions_on_Samba_share">Block certain file extensions on Samba share</span></h4>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Setting this parameter will affect the performance of Samba, as it will be forced to check all files and directories for a match as they are scanned.</div>
<p>Samba offers an option to block files with certain patterns, like file extensions. This option can be used to prevent dissemination of viruses or to dissuade users from wasting space with certain files. More information about this option can be found in <span class="plainlinks archwiki-template-man" title="$ man 5 smb.conf"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/smb.conf.5">smb.conf(5)</a></span>.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/samba/smb.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">...
[myshare]
  comment = Private
  path = /mnt/data
  read only = no
  veto files = /*.exe/*.com/*.dll/*.bat/*.vbs/*.tmp/*.mp3/*.avi/*.mp4/*.wmv/*.wma/</pre>
<h4><span class="mw-headline" id="Improve_throughput">Improve throughput</span></h4>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> Beware this may lead to corruption/connection issues and potentially cripple your TCP/IP stack.</div>
<p>The default settings should be sufficient for most users. However setting the 'socket options' correct can improve performance, but getting them wrong can degrade it by just as much. Test the effect before making any large changes.
</p>
<p>Read the <span class="plainlinks archwiki-template-man" title="$ man 5 smb.conf"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/smb.conf.5">smb.conf(5)</a></span> man page before applying any of the options listed below.
</p>
<p>The following settings should be <a href="../en/Help:Reading.html#Append,_add,_create,_edit" class="mw-redirect" title="Append">append</a> to the <code>[global]</code> section of <code>/etc/samba/smb.conf</code>.
</p>
<p>SMB3 multi-channel may improve performance, however it may result in data corruption under some race conditions. Future releases may improve this situation:
</p>
<pre>server multi channel support = yes
</pre>
<p>Setting a deadtime is useful to stop a server's resources being exhausted by a large number of inactive connections:
</p>
<pre>deadtime = 30
</pre>
<p>The usage of sendfile may make more efficient use of the system CPU's and cause Samba to be faster:
</p>
<pre>use sendfile = yes
</pre>
<p>The write cache allows Samba to batch client writes into a more efficient write size for <a href="../en/RAID.html" title="RAID">RAID</a> disks (i.e. writes may be tuned to be the RAID stripe size) and can improve performance on systems where the disk subsystem is a bottleneck but there is free memory for userspace programs:
</p>
<pre>write cache size = 262144
</pre>
<p>Setting min receivefile size allows zero-copy writes directly from network socket buffers into the filesystem buffer cache (if available). It may improve performance but user testing is recommended:
</p>
<pre>min receivefile size = 16384
</pre>
<p>Reading/writing files asynchronously may improve performance instead of using synchronously writes:
</p>
<pre>aio read size = 1
aio write size = 1
</pre>
<p>Increasing the receive/send buffers size and socket optimize flags might be useful to improve throughput. It is recommended to test each flag separately as it may cause issues on some networks:
</p>
<pre>socket options = IPTOS_LOWDELAY TCP_NODELAY IPTOS_THROUGHPUT SO_RCVBUF=131072 SO_SNDBUF=131072
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Network-interface adjustments may be needed for some options to work, see <a href="../en/Sysctl.html#Networking" title="Sysctl">Sysctl#Networking</a>.</div>
<h2>
<span id=".E5.AE.A2.E6.88.B7.E7.AB.AF.E9.85.8D.E7.BD.AE"></span><span class="mw-headline" id="客户端配置">客户端配置</span>
</h2>
<p>如果不需要查询公开的共享，可以安装轻量级的 <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=cifs-utils">cifs-utils</a></span> 软件包，使用 <code>/usr/bin/mount.cifs</code> 命令挂载共享.
</p>
<p>要使用类似 ftp 的命令行界面，请安装软件包 <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=smbclient">smbclient</a></span>。常用命令请参考 <span class="plainlinks archwiki-template-man" title="$ man 1 smbclient"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/smbclient.1">smbclient(1)</a></span>。
</p>
<p><a href="../en/Desktop_environment.html" title="Desktop environment">桌面环境</a> 可能提供了图形界面，参考<a href="#%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E5%99%A8%E9%85%8D%E7%BD%AE">#文件管理器配置</a><sup>[<a href="../en/ArchWiki:Requests.html#Broken_section_links" class="mw-redirect" title="ArchWiki:Requests">断开的链接</a>：无效的部分]</sup>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 安装 <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=cifs-utils">cifs-utils</a></span> 或 <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=smbclient">smbclient</a></span> 后，请加载 <code>cifs</code> <a href="../en/Kernel_module.html" title="Kernel module">内核模块</a> 或重启以避免挂载失败。</div>
<h4>
<span id=".E6.98.BE.E7.A4.BA.E5.8F.AF.E7.94.A8.E5.85.B1.E4.BA.AB"></span><span class="mw-headline" id="显示可用共享">显示可用共享</span>
</h4>
<p>下面命令会显示服务器上的可用共享:
</p>
<pre>$ smbclient -L <i>hostname</i> -U%
</pre>
<p><i>smbtree</i> 可用显示共享目录树，不建议再有大量计算机的网络上使用此功能。可用它检查共享名是否可用。
</p>
<pre>$ smbtree -b -N
</pre>
<p><code>-b</code> (<code>--broadcast</code>) 使用广播模式，<code>-N</code> (<code>-no-pass</code>) 不询问密码.
</p>
<h4>
<span id="WINS_.E4.B8.BB.E6.9C.BA.E5.90.8D"></span><span class="mw-headline" id="WINS_主机名">WINS 主机名</span>
</h4>
<p><span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=smbclient">smbclient</a></span> 提供了一个用 WINS 解析主机名的驱动，要启用它，将 “wins” 添加到  /etc/nsswitch.conf 的 “hosts” 行。
</p>
<h4>
<span id=".E6.89.8B.E5.8A.A8.E6.8C.82.E8.BD.BD"></span><span class="mw-headline" id="手动挂载">手动挂载</span>
</h4>
<p>创建共享挂载点：
</p>
<pre># mkdir /mnt/<i>mountpoint</i>
</pre>
<p>使用 <code>mount.cifs</code> 作为挂载类型 <code>type</code>，下面列出的选项并不是全部都需要：
</p>
<pre># mount -t cifs //<i>SERVER</i>/<i>sharename</i> /mnt/<i>mountpoint</i> -o user=<i>username</i>,password=<i>password</i>,uid=<i>username</i>,gid=<i>group</i>,workgroup=<i>workgroup</i>,ip=<i>serverip</i>,iocharset=<i>utf8</i></pre>
<p>要允许用户挂载到自己可以访问的目录，请使用 <code>users</code> 挂载选项。
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 请注意这里有 <b>s</b>,其它文件系统一般用的是 <i>user</i>。</div>
<p>使用 <code>uid</code> 和 <code>gid</code> 挂载选项时，请注意 <a href="../en/File_permissions_and_attributes.html" title="File permissions and attributes">文件权限</a>，否则会出现 I/O 错误。}}
</p>
<p><i>SERVER</i>
</p>
<dl><dd>服务器名.</dd></dl>
<p><i>sharename</i>
</p>
<dl><dd>共享目录.</dd></dl>
<p><i>mountpoint</i>
</p>
<dl><dd>本地的挂载点.</dd></dl>
<p><code>-o [options]</code>
</p>
<dl><dd>详情请参考 <span class="plainlinks archwiki-template-man" title="$ man 8 mount.cifs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/mount.cifs.8">mount.cifs(8)</a></span>.</dd></dl>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 
<ul>
<li>结尾不要加 <code>/</code>. <code>//<i>SERVER</i>/<i>sharename</i><b>/</b></code> 无法工作.</li>
<li>如果挂载工作不稳定，出现死机和掉线问题，请尝试用 <code>vers=</code> 设置不同的 SMB 协议版本。例如， 挂载 Vista 用 <code>vers=2.0</code>.</li>
<li>如果挂载了 cifs 机器上出现关机超时，请参考 <a href="../en/Wpa_supplicant.html#Problem_with_mounted_network_shares_(cifs)_and_shutdown" title="Wpa supplicant">wpa_supplicant#Problem with mounted network shares (cifs) and shutdown</a>.</li>
</ul>
</div>
<h5>
<span id=".E4.BF.9D.E5.AD.98.E5.85.B1.E4.BA.AB.E5.AF.86.E7.A0.81"></span><span class="mw-headline" id="保存共享密码">保存共享密码</span>
</h5>
<p>不建议将密码保存在所有人都可读的文件中，一个更安全的方式是创建密码文件：
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/path/to/credentials/share</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">username=<i>myuser</i>
password=<i>mypass</i></pre>
<p>将 <code>username=myuser,password=mypass</code> 替换为 <code>credentials=/path/to/credentials/share</code>.
</p>
<p>修改密码文件的权限：
</p>
<pre># chmod 600 /path/to/credentials/share
</pre>
<h3><span class="mw-headline" id="Automatic_mounting">Automatic mounting</span></h3>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> You may need to <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Enable">enable</a> <code>systemd-networkd-wait-online.service</code> or <code> NetworkManager-wait-online.service</code> (depending on your setup) to proper enable booting on start-up.</div>
<h4><span class="mw-headline" id="As_mount_entry">As mount entry</span></h4>
<p>This is a simple example of a <code>cifs</code> <a href="../en/Fstab.html" title="Fstab">mount entry</a> that requires authentication:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/fstab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">//<i>SERVER</i>/<i>sharename</i> /mnt/<i>mountpoint</i> cifs _netdev,username=<i>myuser</i>,password=<i>mypass</i> 0 0</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Spaces in sharename should be replaced by <code>\040</code> (ASCII code for space in octal). For example, <code>//<i>SERVER</i>/share name</code> on the command line should be <code>//<i>SERVER</i>/share\040name</code> in <code>/etc/fstab</code>.</div>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> Use <code>x-systemd.automount</code> if you want them to be mounted only upon access. See <a href="../en/Fstab.html#Remote_filesystem" title="Fstab">Fstab#Remote filesystem</a> for details.</div>
<h4><span class="mw-headline" id="As_systemd_unit">As systemd unit</span></h4>
<p>Create a new <code>.mount</code> file inside <code>/etc/systemd/system</code>, e.g. <code>mnt-myshare.mount</code>. See <span class="plainlinks archwiki-template-man" title="$ man 5 systemd.mount"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd.mount.5">systemd.mount(5)</a></span> for details.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Make sure the filename corresponds to the mountpoint you want to use.
E.g. the unit name <code>mnt-myshare.mount</code> can only be used if are going to mount the share under <code>/mnt/myshare</code>. Otherwise the following error might occur: <code>systemd[1]: mnt-myshare.mount: Where= setting does not match unit name. Refusing.</code>.</div>
<p><code>What=</code> path to share
</p>
<p><code>Where=</code> path to mount the share
</p>
<p><code>Options=</code> share mounting options
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 
<ul>
<li>Network mount units automatically acquire <code>After</code> dependencies on <i>remote-fs-pre.target</i>, <i>network.target</i> and <i>network-online.target</i>, and gain a <code>Before</code> dependency on <i>remote-fs.target</i> unless <code>nofail</code> mount option is set. Towards the latter a <code>Wants</code> unit is added as well.</li>
<li>
<a href="../en/Help:Reading.html#Append,_add,_create,_edit" class="mw-redirect" title="Append">Append</a> <code>noauto</code> to <code>Options</code> preventing automatically mount during boot (unless it is pulled in by some other unit).</li>
<li>If you want to use a hostname for the server you want to share (instead of an IP address), add <code>nss-lookup.target</code> to <code>After</code> and <code>Wants</code>. This might avoid mount errors at boot time that do not arise when testing the unit.</li>
</ul>
</div>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/mnt-myshare.mount</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=Mount Share at boot

[Mount]
What=//server/share
Where=/mnt/myshare
Options=_netdev,credentials=/etc/samba/credentials/myshare,iocharset=utf8,rw
Type=cifs
TimeoutSec=30

[Install]
WantedBy=multi-user.target</pre>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> In case of an unreachable system, <a href="../en/Help:Reading.html#Append,_add,_create,_edit" class="mw-redirect" title="Append">append</a> <code>ForceUnmount=true</code> to <code>[Mount]</code>, allowing the share to be (force-)unmounted.</div>
<p>To use <code>mnt-myshare.mount</code>, <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Start">start</a> the unit and <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Enable">enable</a> it to run on system boot.
</p>
<h5><span class="mw-headline" id="automount">automount</span></h5>
<p>To automatically mount a share, one may use the following automount unit:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/mnt-myshare.automount</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=Automount myshare

[Automount]
Where=/mnt/myshare

[Install]
WantedBy=multi-user.target</pre>
<p><a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Disable">Disable</a>/<a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Stop">stop</a> the <code>mnt-myshare.mount</code> unit, and <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Enable">enable</a>/<a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Start">start</a> <code>mnt-myshare.automount</code> to automount the share when the mount path is being accessed.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> <a href="../en/Help:Reading.html#Append,_add,_create,_edit" class="mw-redirect" title="Append">Append</a> <code>TimeoutIdleSec</code> to enable auto unmount. See <span class="plainlinks archwiki-template-man" title="$ man 5 systemd.automount"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/systemd.automount.5">systemd.automount(5)</a></span> for details.</div>
<h4><span class="mw-headline" id="smbnetfs">smbnetfs</span></h4>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> smbnetfs needs an intact Samba server setup.
See above on how to do that.</div>
<p>First, check if you can see all the shares you are interested in mounting:
</p>
<pre>$ smbtree -U <i>remote_user</i>
</pre>
<p>If that does not work, find and modify the following line
in <code>/etc/samba/smb.conf</code> accordingly:
</p>
<pre>domain master = auto
</pre>
<p>Now <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Restart">restart</a> <code>smb.service</code> and <code>nmb.service</code>.
</p>
<p>If everything works as expected, <a href="../en/Pacman.html#Installing_specific_packages" title="Pacman">install</a> <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=smbnetfs">smbnetfs</a></span> from the official repositories.
</p>
<p>Then, add the following line to <code>/etc/fuse.conf</code>:
</p>
<pre>user_allow_other
</pre>
<p>Now copy the directory <code>/etc/smbnetfs/.smb</code> to your home directory:
</p>
<pre>$ cp -a /etc/smbnetfs/.smb ~
</pre>
<p>Then create a link to <code>smb.conf</code>:
</p>
<pre>$ ln -sf /etc/samba/smb.conf ~/.smb/smb.conf
</pre>
<p>If a username and a password are required to access some of the shared folders, edit <code>~/.smb/smbnetfs.auth</code>
to include one or more entries like this:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">~/.smb/smbnetfs.auth</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">auth			"hostname" "username" "password"
</pre>
<p>It is also possible to add entries for specific hosts to be mounted by smbnetfs, if necessary.
More details can be found in <code>~/.smb/smbnetfs.conf</code>.
</p>
<p>If you are using the <a href="../en/Dolphin.html" title="Dolphin">Dolphin</a> or <a href="../en/GNOME/Files.html" class="mw-redirect" title="GNOME Files">GNOME Files</a>, you may want to add the following to <code>~/.smb/smbnetfs.conf</code> to avoid "Disk full" errors as smbnetfs by default will report 0 bytes of free space:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">~/.smb/smbnetfs.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">free_space_size 1073741824
</pre>
<p>When you are done with the configuration, you need to run
</p>
<pre>$ chmod 600 ~/.smb/smbnetfs.*
</pre>
<p>Otherwise, smbnetfs complains about 'insecure config file permissions'.
</p>
<p>Finally, to mount your Samba network neighbourhood to a directory of your choice, call
</p>
<pre>$ smbnetfs <i>mount_point</i>
</pre>
<h5><span class="mw-headline" id="Daemon">Daemon</span></h5>
<p>The Arch Linux package also maintains an additional system-wide operation mode for smbnetfs. To enable it, you need to make the
said modifications in the directory <code>/etc/smbnetfs/.smb</code>.
</p>
<p>Then, you can start and/or enable the <code>smbnetfs</code> <a href="../en/Daemons.html" class="mw-redirect" title="Daemon">daemon</a> as usual. The system-wide mount point is at <code>/mnt/smbnet/</code>.
</p>
<h4><span class="mw-headline" id="autofs">autofs</span></h4>
<p>See <a href="../en/Autofs.html" title="Autofs">Autofs</a> for information on the kernel-based automounter for Linux.
</p>
<h3><span class="mw-headline" id="File_manager_configuration">File manager configuration</span></h3>
<h4>
<span id="GNOME_Files.2C_Nemo.2C_Caja.2C_Thunar_and_PCManFM"></span><span class="mw-headline" id="GNOME_Files,_Nemo,_Caja,_Thunar_and_PCManFM">GNOME Files, Nemo, Caja, Thunar and PCManFM</span>
</h4>
<p>In order to access samba shares through GNOME Files, Nemo, Caja, Thunar or PCManFM, install the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=gvfs-smb">gvfs-smb</a></span> package, available in the <a href="../en/Official_repositories.html" title="Official repositories">official repositories</a>.
</p>
<p>Press <code>Ctrl+l</code> and enter <code>smb://<i>servername</i>/<i>share</i></code> in the location bar to access your share.
</p>
<p>The mounted share is likely to be present at <code>/run/user/<i>your_UID</i>/gvfs</code> or <code>~/.gvfs</code> in the filesystem.
</p>
<h4><span class="mw-headline" id="KDE">KDE</span></h4>
<p>KDE has the ability to browse Samba shares built in. To use a GUI in the KDE System Settings, you will need to install the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=kdenetwork-filesharing">kdenetwork-filesharing</a></span> package.
</p>
<p>
If you get a "Time Out" Error when navigating with Dolphin, you should uncomment and edit the following line in smb.conf:</p>
<pre>name resolve order = lmhosts bcast host wins</pre>
<p>as shown in this <a rel="nofollow" class="external text" href="http://ubuntuforums.org/showthread.php?t=1605499">page</a>.
</p>
<h4><span class="mw-headline" id="Other_graphical_environments">Other graphical environments</span></h4>
<p>There are a number of useful programs, but they may need to have packages created for them. This can be done with the Arch package build system. The good thing about these others is that they do not require a particular environment to be installed to support them, and so they bring along less baggage.
</p>
<ul>
<li>
<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/pyneighborhood/">pyneighborhood</a></span><sup><small>AUR</small></sup> is available in the official repositories.</li>
<li>LinNeighborhood, RUmba, xffm-samba plugin for Xffm are not available in the official repositories or the AUR. As they are not officially (or even unofficially supported), they may be obsolete and may not work at all.</li>
</ul>
<h2><span class="mw-headline" id="Tips_and_tricks">Tips and tricks</span></h2>
<h3><span class="mw-headline" id="Discovering_network_shares">Discovering network shares</span></h3>
<p>If nothing is known about other systems on the local network, and automated tools such as <a href="#smbnetfs">smbnetfs</a> are not available, the following methods allow one to manually probe for Samba shares.
</p>
<p>1. First, <a href="../en/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">install</a> the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=nmap">nmap</a></span> and <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=smbclient">smbclient</a></span> packages.
</p>
<p>2. <code>nmap</code> checks which ports are open:
</p>
<pre># nmap -p 139 -sT "192.168.1.*"
</pre>
<p>In this case, a scan on the 192.168.1.* IP address range and port 139 has been performed, resulting in:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$ nmap -sT "192.168.1.*"</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">Starting nmap 3.78 ( <a rel="nofollow" class="external free" href="http://www.insecure.org/nmap/">http://www.insecure.org/nmap/</a> ) at 2005-02-15 11:45 PHT
Interesting ports on 192.168.1.1:
(The 1661 ports scanned but not shown below are in state: closed)
PORT     STATE SERVICE
<b>139/tcp  open  netbios-ssn</b>
5000/tcp open  UPnP

Interesting ports on 192.168.1.5:
(The 1662 ports scanned but not shown below are in state: closed)
PORT     STATE SERVICE
6000/tcp open  X11

Nmap run completed -- 256 IP addresses (2 hosts up) scanned in 7.255 seconds
</pre>
<p>The first result is another system; the second happens to be the client from where this scan was performed.
</p>
<p>3. Now that systems with port 139 open are revealed, use <span class="plainlinks archwiki-template-man" title="$ man 1 nmblookup"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/nmblookup.1">nmblookup(1)</a></span> to check for NetBIOS names: 
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$ nmblookup -A 192.168.1.1</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">Looking up status of 192.168.1.1
        PUTER           &lt;00&gt; -         B &lt;ACTIVE&gt;
        HOMENET         &lt;00&gt; - &lt;GROUP&gt; B &lt;ACTIVE&gt;
        PUTER           &lt;03&gt; -         B &lt;ACTIVE&gt;
        <b>PUTER           &lt;20&gt; -         B &lt;ACTIVE&gt;</b>
        HOMENET         &lt;1e&gt; - &lt;GROUP&gt; B &lt;ACTIVE&gt;
        USERNAME        &lt;03&gt; -         B &lt;ACTIVE&gt;
        HOMENET         &lt;1d&gt; -         B &lt;ACTIVE&gt;
        MSBROWSE        &lt;01&gt; - &lt;GROUP&gt; B &lt;ACTIVE&gt;
</pre>
<p>Regardless of the output, look for <b>&lt;20&gt;</b>, which shows the host with open services.
</p>
<p>4. Use <code>smbclient</code> to list which services are shared on <i>PUTER</i>. If prompted for a password, pressing enter should still display the list:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$ smbclient -L \\PUTER</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">Sharename       Type      Comment
<hr>       ----      -------
MY_MUSIC        Disk
SHAREDDOCS      Disk
PRINTER$        Disk
PRINTER         Printer
IPC$            IPC       Remote Inter Process Communication

Server               Comment
<hr>            -------
PUTER

Workgroup            Master
<hr>            -------
HOMENET               PUTER</pre>
<h3><span class="mw-headline" id="Remote_control_of_Windows_computer">Remote control of Windows computer</span></h3>
<p>Samba offers a set of tools for communication with Windows. These can be handy if access to a Windows computer through remote desktop is not an option, as shown by some examples.
</p>
<p>Send shutdown command with a comment:
</p>
<pre>$ net rpc shutdown -C "comment" -I IPADDRESS -U USERNAME%PASSWORD
</pre>
<p>A forced shutdown instead can be invoked by changing -C with comment to a single -f. For a restart, only add -r, followed by a -C or -f.
</p>
<p>Stop and start services:
</p>
<pre>$ net rpc service stop SERVICENAME -I IPADDRESS -U USERNAME%PASSWORD
</pre>
<p>To see all possible net rpc command:
</p>
<pre>$ net rpc
</pre>
<h2><span class="mw-headline" id="Troubleshooting">Troubleshooting</span></h2>
<h3>
<span id="Failed_to_start_Samba_SMB.2FCIFS_server"></span><span class="mw-headline" id="Failed_to_start_Samba_SMB/CIFS_server">Failed to start Samba SMB/CIFS server</span>
</h3>
<p>Possible solutions:
</p>
<ul>
<li>Check <code>smb.conf</code> on syntactic errors with <span class="plainlinks archwiki-template-man" title="$ man 1 testparm"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/testparm.1">testparm(1)</a></span>.</li>
<li>Set correct permissions for <code>/var/cache/samba/</code> and <a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Restart">restart</a> <code>smb.service</code>:</li>
</ul>
<pre># chmod 0755 /var/cache/samba/msg
</pre>
<h3><span class="mw-headline" id="Permission_issues_on_AppArmor">Permission issues on AppArmor</span></h3>
<p>If using a <a href="#Creating_a_share">share path</a><sup>[<a href="../en/ArchWiki:Requests.html#Broken_section_links" class="mw-redirect" title="ArchWiki:Requests">断开的链接</a>：无效的部分]</sup> located outside of a home-directory, whitelist it in <code>/etc/apparmor.d/local/usr.sbin.smbd</code>. E.g.:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/apparmor.d/local/usr.sbin.smbd</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">"/data/" rk,
"/data/**" lrwk,
</pre>
<h3><span class="mw-headline" id="No_dialect_specified_on_mount">No dialect specified on mount</span></h3>
<p>The client is using an unsupported SMB/CIFS version that is required by the server.
</p>
<p>See <a href="#Restrict_protocols_for_better_security">#Restrict protocols for better security</a> for more information.
</p>
<h3>
<span id="Unable_to_overwrite_files.2C_permissions_errors"></span><span class="mw-headline" id="Unable_to_overwrite_files,_permissions_errors">Unable to overwrite files, permissions errors</span>
</h3>
<div class="noprint archwiki-template-message">
<p><a href="../File:Tango-inaccurate.png" class="image"><img alt="Tango-inaccurate.png" src="../File:Tango-inaccurate.png" decoding="async" width="48" height="48"></a><b>The factual accuracy of this article or section is disputed.</b><a href="../File:Tango-inaccurate.png" class="image"><img alt="Tango-inaccurate.png" src="../File:Tango-inaccurate.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>Reason:</b> An user should set/check for server/client permissions, instead of using incorrect/possible insecure flags. (Discuss in <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php/Talk:Samba_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">Talk:Samba (简体中文)#</a>)</div>
</div>
<p>Possible solutions:
</p>
<ul>
<li>Append the mount option <code>nodfs</code> to the <code>/etc/fstab</code> <a href="#As_mount_entry">entry</a>.</li>
<li>Add <code>msdfs root = no</code> to the <code>[global]</code> section of the server's <code>/etc/samba/smb.conf</code>.</li>
</ul>
<h3><span class="mw-headline" id="Windows_clients_keep_asking_for_password_even_if_Samba_shares_are_created_with_guest_permissions">Windows clients keep asking for password even if Samba shares are created with guest permissions</span></h3>
<p>Set <code>map to guest</code> inside the <code>global</code> section of <code>/etc/samba/smb.conf</code>:
</p>
<pre>map to guest = Bad User
</pre>
<p>From Samba 4.10.10 you should use <code>Bad Password</code> instead <code>Bad User</code>.
</p>
<h3>
<span id="Windows_7_connectivity_problems_-_mount_error.2812.29:_cannot_allocate_memory"></span><span class="mw-headline" id="Windows_7_connectivity_problems_-_mount_error(12):_cannot_allocate_memory">Windows 7 connectivity problems - mount error(12): cannot allocate memory</span>
</h3>
<p>A known Windows 7 bug that causes "mount error(12): cannot allocate memory" on an otherwise perfect cifs share on the Linux end can be fixed by setting a few registry keys on the Windows box as follows:
</p>
<ul>
<li>
<code>HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management\LargeSystemCache</code> (set to <code>1</code>)</li>
<li>
<code>HKLM\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters\Size</code> (set to <code>3</code>)</li>
</ul>
<p>Alternatively, start Command Prompt in Admin Mode and execute the following:
</p>
<pre>reg add "HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" /v "LargeSystemCache" /t REG_DWORD /d 1 /f
reg add "HKLM\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters" /v "Size" /t REG_DWORD /d 3 /f
</pre>
<p>Do one of the following for the settings to take effect:
</p>
<ul>
<li>Restart Windows</li>
<li>Restart the Server service via services.msc</li>
<li>From the Command Prompt run: 'net stop lanmanserver' and 'net start lanmanserver' - The server may automatically restart after stopping it.</li>
</ul>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Googling will reveal another tweak recommending users to add a key modifying the "IRPStackSize" size.  This is incorrect for fixing this issue under Windows 7.  Do not attempt it.</div>
<p><a rel="nofollow" class="external text" href="http://alan.lamielle.net/2009/09/03/windows-7-nonpaged-pool-srv-error-2017">Original article</a><sup title="最后检查状态：domain name not resolved">[<a href="https://en.wikipedia.org/wiki/Wikipedia:Link_rot" class="extiw" title="wikipedia:Wikipedia:Link rot">失效链接</a> 2020-04-03 ⓘ]</sup>.
</p>
<h3>
<span id="Windows_10_1709_and_up_connectivity_problems_-_.22Windows_cannot_access.22_0x80004005"></span><span class="mw-headline" id='Windows_10_1709_and_up_connectivity_problems_-_"Windows_cannot_access"_0x80004005'>Windows 10 1709 and up connectivity problems - "Windows cannot access" 0x80004005</span>
</h3>
<p>This error affects some machines running Windows 10 version 1709 and later. It is not related to SMB1 being disabled in this version but to the fact that Microsoft disabled insecure logons for guests on this version for some, but not others.
</p>
<p>To fix, open Group Policy Editor (<code>gpedit.msc</code>). Navigate to <i>Computer configuration\administrative templates\network\Lanman Workstation &gt; Enable insecure guest logons</i> and enable it.
Alternatively,change the following value in the registry:
</p>
<pre>[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters]
"AllowInsecureGuestAuth"=dword:1
</pre>
<h3><span class="mw-headline" id="Error:_Failed_to_retrieve_printer_list:_NT_STATUS_UNSUCCESSFUL">Error: Failed to retrieve printer list: NT_STATUS_UNSUCCESSFUL</span></h3>
<p>If you are a home user and using samba purely for file sharing from a server or NAS, you are probably not interested in sharing printers through it. If so, you can prevent this error from occurring by adding the following lines to your <code>/etc/samba/smb.conf</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/samba/smb.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[global]
  load printers = No
  printing = bsd
  printcap name = /dev/null
  disable spoolss = Yes</pre>
<p><a href="../en/Systemd.html#Using_units" class="mw-redirect" title="Restart">Restart</a> the samba service, <code>smb.service</code>, and then check your logs:
</p>
<pre># cat /var/log/samba/smbd.log
</pre>
<p>and the error should now no longer be appearing.
</p>
<h3><span class="mw-headline" id="Sharing_a_folder_fails">Sharing a folder fails</span></h3>
<p>It means that while you are sharing a folder from <i>Dolphin</i> (file manager) and everything seems ok at first, after restarting <i>Dolphin</i> the share icon is gone from the shared folder, and also some output like this in terminal (<i>Konsole</i>) output:
</p>
<pre>‘net usershare’ returned error 255: net usershare: usershares are currently disabled
</pre>
<p>To fix it, enable usershare as described in <a href="#Enable_Usershares">#Enable Usershares</a><sup>[<a href="../en/ArchWiki:Requests.html#Broken_section_links" class="mw-redirect" title="ArchWiki:Requests">断开的链接</a>：无效的部分]</sup>.
</p>
<h3>
<span id=".22Browsing.22_network_fails_with_.22Failed_to_retrieve_share_list_from_server.22"></span><span class="mw-headline" id='"Browsing"_network_fails_with_"Failed_to_retrieve_share_list_from_server"'>"Browsing" network fails with "Failed to retrieve share list from server"</span>
</h3>
<p>And you are using a firewall (iptables) because you do not trust your local (school, university, hotel) network.  This may be due to the following: When the smbclient is browsing the local network it sends out a broadcast request on udp port 137.  The servers on the network then reply to your client but as the source address of this reply is different from the destination address iptables saw when sending the request for the listing out, iptables will not recognize the reply as being "ESTABLISHED" or "RELATED", and hence the packet is dropped.  A possible solution is to add:
</p>
<pre>iptables -t raw -A OUTPUT -p udp -m udp --dport 137 -j CT --helper netbios-ns
</pre>
<p>to your iptables setup.
</p>
<h3><span class="mw-headline" id="Protocol_negotiation_failed:_NT_STATUS_INVALID_NETWORK_RESPONSE">Protocol negotiation failed: NT_STATUS_INVALID_NETWORK_RESPONSE</span></h3>
<p>The client probably does not have access to shares.  Make sure clients' IP address is in <code>hosts allow =</code> line in <code>/etc/samba/smb.conf</code>.
</p>
<p>Another problem could be, that the client uses an invalid protocol version. To check this try to connect with the <code>smbclient</code> where you specify the maximum protocol version manually:
</p>
<pre>$ smbclient -U &lt;user name&gt; -L //&lt;server name&gt; -m &lt;protocol version: e. g. SMB2&gt; -W &lt;domain name&gt;
</pre>
<p>If the command was successful then create a configuration file:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">~/.smb/smb.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[global]
  workgroup = &lt;domain name&gt;
  client max protocol = SMB2</pre>
<h3>
<span id="Connection_to_SERVER_failed:_.28Error_NT_STATUS_UNSUCCESSFUL.29"></span><span class="mw-headline" id="Connection_to_SERVER_failed:_(Error_NT_STATUS_UNSUCCESSFUL)">Connection to SERVER failed: (Error NT_STATUS_UNSUCCESSFUL)</span>
</h3>
<p>You are probably passing a wrong server name to <code>smbclient</code>.  To find out the server name, run <code>hostnamectl</code> on the server and look at "Transient hostname" line
</p>
<h3>
<span id="Connection_to_SERVER_failed:_.28Error_NT_STATUS_CONNECTION_REFUSED.29"></span><span class="mw-headline" id="Connection_to_SERVER_failed:_(Error_NT_STATUS_CONNECTION_REFUSED)">Connection to SERVER failed: (Error NT_STATUS_CONNECTION_REFUSED)</span>
</h3>
<p>Make sure that the server has started. The shared directories should exist and be accessible.
</p>
<h3><span class="mw-headline" id="Protocol_negotiation_failed:_NT_STATUS_CONNECTION_RESET">Protocol negotiation failed: NT_STATUS_CONNECTION_RESET</span></h3>
<p>Probably the server is configured not to accept protocol SMB1. Add option <code>client max protocol = SMB2</code> in <code>/etc/samba/smb.conf</code>.
Or just pass argument <code>-m SMB2</code> to <code>smbclient</code>.
</p>
<h3>
<span id="Password_Error_when_correct_credentials_are_given_.28error_1326.29"></span><span class="mw-headline" id="Password_Error_when_correct_credentials_are_given_(error_1326)">Password Error when correct credentials are given (error 1326)</span>
</h3>
<p><a rel="nofollow" class="external text" href="https://www.samba.org/samba/history/samba-4.5.0.html">Samba 4.5</a> has NTLMv1 authentication disabled by default. It is recommend to install the latest available upgrades on clients and deny access for unsupported clients.
</p>
<p>If you still need support for very old clients without NTLMv2 support (e.g. Windows XP), it is possible force enable NTLMv1, although this is <b>not recommend</b> for security reasons:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/samba/smb.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[global]
  lanman auth = yes
  ntlm auth = yes</pre>
<p>If NTLMv2 clients are unable to authenticate when NTLMv1 has been enabled, create the following file on the client:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/home/user/.smb/smb.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[global]
  sec = ntlmv2
  client ntlmv2 auth = yes</pre>
<p>This change also affects samba shares mounted with <b>mount.cifs</b>. If after upgrade to Samba 4.5 your mount fails, add the <b>sec=ntlmssp</b> option to your mount command, e.g.
</p>
<pre>mount.cifs //server/share /mnt/point -o sec=ntlmssp,...
</pre>
<p>See the <span class="plainlinks archwiki-template-man" title="$ man 8 mount.cifs"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/mount.cifs.8">mount.cifs(8)</a></span> man page: <b>ntlmssp</b> - Use NTLMv2 password hashing encapsulated in Raw NTLMSSP message. The default in mainline kernel versions prior to v3.8 was <b>sec=ntlm</b>. In v3.8, the default was changed to <b>sec=ntlmssp</b>.
</p>
<h3><span class="mw-headline" id="Mapping_reserved_Windows_characters">Mapping reserved Windows characters</span></h3>
<p>Starting with kernel 3.18, the cifs module uses the <a rel="nofollow" class="external text" href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=2baa2682531ff02928e2d3904800696d9e7193db">"mapposix" option by default</a>.
When mounting a share using unix extensions and a default Samba configuration, files and directories containing one of the seven reserved Windows characters <code>: \ * &lt; &gt; ? </code> are listed but cannot be accessed.
</p>
<p>Possible solutions are:
</p>
<ul><li>Use the undocumented <code>nomapposix</code> mount option for cifs</li></ul>
<pre> # mount.cifs //server/share /mnt/point -o nomapposix
</pre>
<ul><li>Configure Samba to remap <code>mapposix</code> ("SFM", Services for Mac) style characters to the correct native ones using <a rel="nofollow" class="external text" href="https://www.mankier.com/8/vfs_fruit">fruit</a>
</li></ul>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/samba/smb.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[global]
  vfs objects = catia fruit
  fruit:encoding = native</pre>
<ul><li>Manually remap forbidden characters using <a rel="nofollow" class="external text" href="https://www.mankier.com/8/vfs_catia">catia</a>
</li></ul>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/samba/smb.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[global]
  vfs objects = catia
  catia:mappings = 0x22:0xf022, 0x2a:0xf02a, 0x2f:0xf02f, 0x3a:0xf03a, 0x3c:0xf03c, 0x3e:0xf03e, 0x3f:0xf03f, 0x5c:0xf05c, 0x7c:0xf07c, 0x20:0xf020</pre>
<p>The latter approach (using catia or fruit) has the drawback of filtering files with unprintable characters.
</p>
<h3><span class="mw-headline" id="Folder_shared_inside_graphical_environment_is_not_available_to_guests">Folder shared inside graphical environment is not available to guests</span></h3>
<p>This section presupposes:
</p>
<ol>
<li>Usershares are configured following <a href="#Enable_Usershares">previous section</a><sup>[<a href="../en/ArchWiki:Requests.html#Broken_section_links" class="mw-redirect" title="ArchWiki:Requests">断开的链接</a>：无效的部分]</sup>
</li>
<li>A shared folder has been created as a non-root user from GUI</li>
<li>Guests access has been set to shared folder during creation</li>
<li>Samba service has been restarted at least once since last <code>/etc/samba/smb.conf</code> file modification</li>
</ol>
<p>For clarification purpose only, in the following sub-sections is assumed:
</p>
<ul>
<li>Shared folder is located inside user home directory path (<code>/home/yourUser/Shared</code>)</li>
<li>Shared folder name is <i>MySharedFiles</i>
</li>
<li>Guest access is read-only.</li>
<li>Windows users will access shared folder content without login prompt</li>
</ul>
<h4><span class="mw-headline" id="Verify_correct_samba_configuration">Verify correct samba configuration</span></h4>
<p>Run the following command from a terminal to test configuration file correctness:
</p>
<pre>$ testparm
</pre>
<h4><span class="mw-headline" id="Verify_correct_shared_folder_creation">Verify correct shared folder creation</span></h4>
<p>Run the following commands from a terminal:
</p>
<pre>$ cd /var/lib/samba/usershare
$ ls
</pre>
<p>If everything is fine, you will notice a file named <code>mysharedfiles</code>
</p>
<p>Read the file contents using the following command:
</p>
<pre>$ cat mysharedfiles
</pre>
<p>The terminal output should display something like this:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/var/lib/samba/usershare/mysharedfiles</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">path=/home/yourUser/Shared
comment=
usershare_acl=S-1-1-0:r
guest_ok=y
sharename=MySharedFiles</pre>
<h4><span class="mw-headline" id="Verify_folder_access_by_guest">Verify folder access by guest</span></h4>
<p>Run the following command from a terminal. If prompted for a password, just press Enter:
</p>
<pre>$ smbclient -L localhost
</pre>
<p>If everything is fine, MySharedFiles should be displayed under <code>Sharename</code> column
</p>
<p>Run the following command in order to access the shared folder as guest (anonymous login)
</p>
<pre>$ smbclient -N //localhost/MySharedFiles
</pre>
<p>If everything is fine samba client prompt will be displayed:
</p>
<pre>smb: \&gt;
</pre>
<p>From samba prompt verify guest can list directory contents:
</p>
<pre>smb: \&gt; ls
</pre>
<p>If <code>NTFS_STATUS_ACCESS_DENIED</code> error displayed, probably there is something to be solved at directory permission level.
</p>
<p>Run the following commands as root to set correct permissions for folders:
</p>
<pre># cd /home
# chmod -R 755 /home/yourUser/Shared
</pre>
<p>Access shared folder again as guest to be sure guest read access error has been solved.
</p>
<h3><span class="mw-headline" id="Mount_error:_Host_is_down">Mount error: Host is down</span></h3>
<p>This error might be seen when mounting shares of Synology NAS servers. Use the mount option <code>vers=1.0</code> to solve it.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> SMB version 1 is known to have security vulnerabilities and was used in successful ransomware attacks.</div>
<h3><span class="mw-headline" id="Software_caused_connection_abort">Software caused connection abort</span></h3>
<p>File managers that utilizes <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=gvfs-smb">gvfs-smb</a></span> can show the error <code>Software caused connection abort</code> when writing a file to a share/server. This may be due to the server running SMB/CIFS version 1, which many routers use for USB drive sharing (e.g. Belkin routers). To write to these shares specify the CIFS version with the option <code>vers=1.0</code>. E.g.:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/fstab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">//SERVER/sharename /mnt/mountpoint cifs _netdev,guest,file_mode=0777,dir_mode=0777,vers=1.0 0 0</pre>
<p>This can also happen after updating Samba to version 4.11, which deactivates SMB1 as default, and accessing any Samba share. You can reenable it by adding
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/samba/smb.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[global]
client min protocol = CORE</pre>
<h3>
<span id="Connection_problem_.28due_to_authentification_error.29"></span><span class="mw-headline" id="Connection_problem_(due_to_authentification_error)">Connection problem (due to authentification error)</span>
</h3>
<p>Be sure that you do not leave any space characters before your username in Samba client configuration file as follows:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">~/.samba</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">username= user
password=pass</pre>
<p>The correct format is:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">~/.samba</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">username=user
password=pass</pre>
<h2><span class="mw-headline" id="See_also">See also</span></h2>
<ul>
<li><a rel="nofollow" class="external text" href="https://www.samba.org/">Official website</a></li>
<li><a rel="nofollow" class="external text" href="https://www.samba.org/samba/docs/SambaIntro.html">Samba: An Introduction</a></li>
<li>
<a rel="nofollow" class="external text" href="https://www.samba.org/samba/docs/Samba-HOWTO-Collection.pdf">Samba 3.2.x HOWTO and Reference Guide</a> (outdated but still most extensive documentation)</li>
<li><a href="https://en.wikipedia.org/wiki/Samba_(software)" class="extiw" title="wikipedia:Samba (software)">Wikipedia</a></li>
<li><a href="https://wiki.gentoo.org/wiki/Samba/Guide" class="extiw" title="gentoo:Samba/Guide">Gentoo:Samba/Guide</a></li>
<li><a href="https://wiki.debian.org/SambaServerSimple" class="extiw" title="debian:SambaServerSimple">Debian:SambaServerSimple</a></li>
</ul>
</div>
</div>
<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../zh-CN/Category:Networking.html" title="Category:Networking (简体中文)">Networking (简体中文)</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden categories: <ul>
<li><a href="../en/Category:Pages_with_broken_section_links.html" title="Category:Pages with broken section links">Pages with broken section links</a></li>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Accuracy.html" title="Category:Pages or sections flagged with Template:Accuracy">Pages or sections flagged with Template:Accuracy</a></li>
<li><a href="../en/Category:Pages_with_dead_links.html" title="Category:Pages with dead links">Pages with dead links</a></li>
</ul>
</div>
</div>
	</div>
</div>

<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
		<li>Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Samba_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)&amp;oldid=647913">https://wiki.archlinux.org/index.php?title=Samba_(简体中文)&amp;oldid=647913</a>"</li>
		<li id="footer-info-lastmod"> This page was last edited on 1 January 2021, at 22:56.</li>
		<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="http://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
	<br>
</ul>
	<ul id="footer-places">
		<li id="footer-places-privacy"><a href="../en/ArchWiki:Privacy_policy.html" title="ArchWiki:Privacy policy">Privacy policy</a></li>
		<li id="footer-places-about"><a href="../en/ArchWiki:About.html" title="ArchWiki:About">About ArchWiki</a></li>
		<li id="footer-places-disclaimer"><a href="../en/ArchWiki:General_disclaimer.html" title="ArchWiki:General disclaimer">Disclaimers</a></li>
	</ul>
	<ul id="footer-icons" class="noprint">
		<li id="footer-copyrightico">
	</ul>
	<div style="clear: both;"></div>
</footer>



</body>
</html>
