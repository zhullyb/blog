<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>Unified Extensible Firmware Interface (简体中文) - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.35.0">
<meta name="robots" content="noindex,follow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="license" href="http://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Unified_Extensible_Firmware_Interface_简体中文 rootpage-Unified_Extensible_Firmware_Interface_简体中文 skin-vector action-view skin-vector-legacy">
<div id="content" class="mw-body" role="main" style="margin: 0">
	<a id="top"></a>
	<div id="siteNotice" class="mw-body-content"></div>
	<div class="mw-indicators mw-body-content">
	</div>
	<h1 id="firstHeading" class="firstHeading" lang="en">Unified Extensible Firmware Interface (简体中文)</h1>
	<div id="bodyContent" class="mw-body-content">
		<div id="siteSub" class="noprint">From ArchWiki</div>
		<div id="contentSub"></div>
		<div id="contentSub2"></div>
		
		<div id="jump-to-nav"></div>
		<a class="mw-jump-link" href="#mw-head">Jump to navigation</a>
		<a class="mw-jump-link" href="#searchInput">Jump to search</a>
		<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr">
<div class="warningbox">The printable version is no longer supported and may have rendering errors. Please update your browser bookmarks and please use the default browser print function instead.</div>
<div class="mw-parser-output">
<div class="archwiki-template-meta-related-articles-start">
<p>相关文章</p>
<ul>
<li><a href="../en/EFI_system_partition.html" class="mw-redirect" title="EFI System Partition">EFI System Partition</a></li>
<li><a href="../en/Partitioning.html#GUID_Partition_Table" class="mw-redirect" title="GUID Partition Table">GUID Partition Table</a></li>
<li><a href="../en/Partitioning.html#Master_Boot_Record" class="mw-redirect" title="Master Boot Record">Master Boot Record</a></li>
<li><a href="../en/Arch_boot_process.html" title="Arch boot process">Arch boot process</a></li>
<li><a href="../en/Unified_Extensible_Firmware_Interface/Secure_Boot.html" class="mw-redirect" title="Secure Boot">Secure Boot</a></li>
</ul>
</div>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>翻译状态：</strong>本文是 <a href="../en/Unified_Extensible_Firmware_Interface.html" title="Unified Extensible Firmware Interface">Unified_Extensible_Firmware_Interface</a> 的<a href="../zh-CN/ArchWiki:Translation_Team.html" title="ArchWiki:Translation Team (简体中文)">翻译</a>。上次翻译日期：2017-08-04。如果英文版本有所<a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php?title=Unified_Extensible_Firmware_Interface&amp;diff=0&amp;oldid=481694">更改</a>，则您可以帮助同步翻译。</div>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> 虽然选择UEFI模式安装系统是一个与时俱进的做法，但早期主板制造商实现的UEFI模式“可能”相比BIOS模式有着更多的bug。建议在安装系统前仔细搜寻自己主板的相应信息。</div>
<p><a rel="nofollow" class="external text" href="http://www.uefi.org/">统一可扩展固件界面</a>(Unified Extensible Firmware Interface)，简称 UEFI, 是操作系统与固件交互的新模式，提供了启动操作系统或程序的标准环境。该方式有别于传统<a href="https://en.wikipedia.org/wiki/BIOS" class="extiw" title="wikipedia:BIOS">BIOS</a>系统所使用的“<a href="../en/Partitioning.html#Master_Boot_Record" class="mw-redirect" title="MBR">MBR</a>”，二者启动的区别见 <a href="../en/Arch_boot_process.html#Firmware_types" title="Arch boot process">Arch boot process#Firmware types</a>。若要配置 UEFI 引导器，详见 <a href="../zh-CN/Arch_boot_process.html#%E5%90%AF%E5%8A%A8%E5%8A%A0%E8%BD%BD%E5%99%A8" class="mw-redirect" title="Boot loaders (简体中文)">Boot loaders (简体中文)</a>.
</p>
<div id="toc" class="toc" role="navigation" aria-labelledby="mw-toc-heading">
<input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none"><div class="toctitle" lang="en" dir="ltr">
<h2 id="mw-toc-heading">Contents</h2>
<span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span>
</div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#UEFI_%E5%8F%91%E5%B1%95%E5%8E%86%E5%8F%B2"><span class="tocnumber">1</span> <span class="toctext">UEFI 发展历史</span></a></li>
<li class="toclevel-1 tocsection-2">
<a href="#UEFI_%E5%9B%BA%E4%BB%B6%E6%9E%B6%E6%9E%84"><span class="tocnumber">2</span> <span class="toctext">UEFI 固件架构</span></a>
<ul>
<li class="toclevel-2 tocsection-3">
<a href="#%E6%A3%80%E6%9F%A5%E7%B3%BB%E7%BB%9F%E4%BD%8D%E6%95%B0"><span class="tocnumber">2.1</span> <span class="toctext">检查系统位数</span></a>
<ul>
<li class="toclevel-3 tocsection-4"><a href="#Linux_%E7%B3%BB%E7%BB%9F"><span class="tocnumber">2.1.1</span> <span class="toctext">Linux 系统</span></a></li>
<li class="toclevel-3 tocsection-5"><a href="#macOS_%E7%B3%BB%E7%BB%9F"><span class="tocnumber">2.1.2</span> <span class="toctext">macOS 系统</span></a></li>
<li class="toclevel-3 tocsection-6"><a href="#Windows_%E7%B3%BB%E7%BB%9F"><span class="tocnumber">2.1.3</span> <span class="toctext">Windows 系统</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-7"><a href="#Linux_%E5%86%85%E6%A0%B8%E4%B8%AD%E6%9C%89%E5%85%B3_UEFI_%E7%9A%84%E9%85%8D%E7%BD%AE%E9%80%89%E9%A1%B9"><span class="tocnumber">3</span> <span class="toctext">Linux 内核中有关 UEFI 的配置选项</span></a></li>
<li class="toclevel-1 tocsection-8">
<a href="#UEFI_%E5%8F%98%E9%87%8F"><span class="tocnumber">4</span> <span class="toctext">UEFI 变量</span></a>
<ul>
<li class="toclevel-2 tocsection-9">
<a href="#Linux_%E5%86%85%E6%A0%B8%E4%B8%AD%E7%9A%84_UEFI_%E5%8F%98%E9%87%8F%E6%94%AF%E6%8C%81"><span class="tocnumber">4.1</span> <span class="toctext">Linux 内核中的 UEFI 变量支持</span></a>
<ul>
<li class="toclevel-3 tocsection-10"><a href="#efivarfs_%E5%92%8C_sysfs-efivars_%E7%9A%84%E4%B8%8D%E4%B8%80%E8%87%B4"><span class="tocnumber">4.1.1</span> <span class="toctext">efivarfs 和 sysfs-efivars 的不一致</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-11">
<a href="#UEFI_%E5%8F%98%E9%87%8F%E6%AD%A3%E5%B8%B8%E5%B7%A5%E4%BD%9C%E7%9A%84%E9%9C%80%E6%B1%82"><span class="tocnumber">4.2</span> <span class="toctext">UEFI 变量正常工作的需求</span></a>
<ul>
<li class="toclevel-3 tocsection-12"><a href="#%E6%8C%82%E8%BD%BD_efivarfs"><span class="tocnumber">4.2.1</span> <span class="toctext">挂载 efivarfs</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-13">
<a href="#%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4%E5%B7%A5%E5%85%B7"><span class="tocnumber">4.3</span> <span class="toctext">用户空间工具</span></a>
<ul>
<li class="toclevel-3 tocsection-14"><a href="#efibootmgr"><span class="tocnumber">4.3.1</span> <span class="toctext">efibootmgr</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-15">
<a href="#UEFI_Shell"><span class="tocnumber">5</span> <span class="toctext">UEFI Shell</span></a>
<ul>
<li class="toclevel-2 tocsection-16"><a href="#%E8%8E%B7%E5%8F%96_UEFI_Shell"><span class="tocnumber">5.1</span> <span class="toctext">获取 UEFI Shell</span></a></li>
<li class="toclevel-2 tocsection-17"><a href="#%E5%90%AF%E5%8A%A8_UEFI_Shell"><span class="tocnumber">5.2</span> <span class="toctext">启动 UEFI Shell</span></a></li>
<li class="toclevel-2 tocsection-18">
<a href="#%E9%87%8D%E8%A6%81_UEFI_Shell_%E5%91%BD%E4%BB%A4"><span class="tocnumber">5.3</span> <span class="toctext">重要 UEFI Shell 命令</span></a>
<ul>
<li class="toclevel-3 tocsection-19"><a href="#bcfg"><span class="tocnumber">5.3.1</span> <span class="toctext">bcfg</span></a></li>
<li class="toclevel-3 tocsection-20"><a href="#map"><span class="tocnumber">5.3.2</span> <span class="toctext">map</span></a></li>
<li class="toclevel-3 tocsection-21"><a href="#edit"><span class="tocnumber">5.3.3</span> <span class="toctext">edit</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-22">
<a href="#UEFI_%E5%8F%AF%E5%90%AF%E5%8A%A8%E4%BB%8B%E8%B4%A8"><span class="tocnumber">6</span> <span class="toctext">UEFI 可启动介质</span></a>
<ul>
<li class="toclevel-2 tocsection-23"><a href="#%E4%BB%8E_ISO_%E5%88%9B%E5%BB%BA_UEFI_%E5%8F%AF%E5%90%AF%E5%8A%A8_USB"><span class="tocnumber">6.1</span> <span class="toctext">从 ISO 创建 UEFI 可启动 USB</span></a></li>
<li class="toclevel-2 tocsection-24"><a href="#%E4%BB%8E%E5%85%89%E5%AD%A6%E4%BB%8B%E8%B4%A8%E9%87%8C%E7%A7%BB%E9%99%A4_UEFI_%E5%90%AF%E5%8A%A8%E6%94%AF%E6%8C%81"><span class="tocnumber">6.2</span> <span class="toctext">从光学介质里移除 UEFI 启动支持</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-25">
<a href="#%E5%8E%9F%E7%94%9F%E6%97%A0%E6%94%AF%E6%8C%81%E6%83%85%E5%86%B5%E4%B8%8B%E6%B5%8B%E8%AF%95_UEFI"><span class="tocnumber">7</span> <span class="toctext">原生无支持情况下测试 UEFI</span></a>
<ul>
<li class="toclevel-2 tocsection-26"><a href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%BD%BF%E7%94%A8_OVMF"><span class="tocnumber">7.1</span> <span class="toctext">虚拟机使用 OVMF</span></a></li>
<li class="toclevel-2 tocsection-27"><a href="#%E4%BD%BF%E7%94%A8%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="tocnumber">7.2</span> <span class="toctext">使用虚拟机</span></a></li>
<li class="toclevel-2 tocsection-28"><a href="#%E4%BB%85_BIOS_%E7%9A%84%E7%B3%BB%E7%BB%9F%E4%BD%BF%E7%94%A8_DUET"><span class="tocnumber">7.3</span> <span class="toctext">仅 BIOS 的系统使用 DUET</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-29">
<a href="#%E7%96%91%E9%9A%BE%E9%97%AE%E9%A2%98"><span class="tocnumber">8</span> <span class="toctext">疑难问题</span></a>
<ul>
<li class="toclevel-2 tocsection-30"><a href="#Windows_7_%E6%97%A0%E6%B3%95%E4%BB%A5_UEFI_%E6%A8%A1%E5%BC%8F%E5%90%AF%E5%8A%A8"><span class="tocnumber">8.1</span> <span class="toctext">Windows 7 无法以 UEFI 模式启动</span></a></li>
<li class="toclevel-2 tocsection-31"><a href="#Windows_%E6%94%B9%E5%8F%98%E4%BA%86%E5%90%AF%E5%8A%A8%E6%AC%A1%E5%BA%8F"><span class="tocnumber">8.2</span> <span class="toctext">Windows 改变了启动次序</span></a></li>
<li class="toclevel-2 tocsection-32"><a href="#USB_%E4%BB%8B%E8%B4%A8%E5%8D%A1%E5%9C%A8%E9%BB%91%E5%B1%8F%E7%95%8C%E9%9D%A2"><span class="tocnumber">8.3</span> <span class="toctext">USB 介质卡在黑屏界面</span></a></li>
<li class="toclevel-2 tocsection-33">
<a href="#%E5%9C%A8_32_%E4%BD%8D_UEFI_%E4%B8%8A%E5%90%AF%E5%8A%A8_64_%E4%BD%8D%E5%86%85%E6%A0%B8"><span class="tocnumber">8.4</span> <span class="toctext">在 32 位 UEFI 上启动 64 位内核</span></a>
<ul>
<li class="toclevel-3 tocsection-34"><a href="#%E4%BD%BF%E7%94%A8_GRUB"><span class="tocnumber">8.4.1</span> <span class="toctext">使用 GRUB</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-35"><a href="#%E5%8F%82%E9%98%85"><span class="tocnumber">9</span> <span class="toctext">参阅</span></a></li>
</ul>
</div>

<h2>
<span id="UEFI_.E5.8F.91.E5.B1.95.E5.8E.86.E5.8F.B2"></span><span class="mw-headline" id="UEFI_发展历史">UEFI 发展历史</span>
</h2>
<ul>
<li>UEFI起始于Intel的EFI 1.x版。</li>
<li>从2.0版本起，一个名为UEFI论坛的公司组织接管了其开发工作，并更名为Unified EFI(统一EFI).</li>
<li>除非特别指明是EFI 1.x, EFI和UEFI均指代UEFI 2.x固件。</li>
<li>苹果公司的EFI实现不是EFI 1.x也不是UEFI 2.x而是这两者的混合体。这类固件不被归入到任何(U)EFI规格中，因而并没有一个标准的UEFI固件。除非特别指明，以下说明可通用但部分可能会在<a href="../en/Mac.html" class="mw-redirect" title="MacBook">Apple Macs</a>上有所不同或是会不起效。</li>
<li>此标准的最新版本位于 <a rel="nofollow" class="external free" href="http://uefi.org/specifications">http://uefi.org/specifications</a>.</li>
</ul>
<h2>
<span id="UEFI_.E5.9B.BA.E4.BB.B6.E6.9E.B6.E6.9E.84"></span><span class="mw-headline" id="UEFI_固件架构">UEFI 固件架构</span>
</h2>
<p>UEFI 下每一个程序，无论它是某个 OS 引导器还是某个内存测试或数据恢复的工具，都要兼容于 EFI 固件位数或体系结构。
</p>
<p>目前主流的 UEFI 固件，包括近期的 Apple Macs，都采用了 x86_64 EFI 固件。目前还在用 IA32 即 32 位的 EFI 的已知设备只有于 2008 年前生产的 Apple Macs，一些 Intel Cloverfield 超级本和采用 EFI 1.10 固件的 Intel 服务器主板。
</p>
<p>x86_64 EFI 不能兼容 32 位 EFI 程序。所以 UEFI 应用程序必须依固件处理器位数／体系结构编译而成。
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 官方的安装镜像不支持32位的UEFI系统，请查阅<a href="#%E5%9C%A8_32_%E4%BD%8D_UEFI_%E4%B8%8A%E5%90%AF%E5%8A%A8_64_%E4%BD%8D%E5%86%85%E6%A0%B8">#在 32 位 UEFI 上启动 64 位内核</a>章节了解解决方法。这种平台需要一个支持 IA32 UEFI的启动加载器，比如带有<code>i386-efi</code>模块的<a href="../en/GRUB.html" title="GRUB">GRUB</a>。</div>
<h3>
<span id=".E6.A3.80.E6.9F.A5.E7.B3.BB.E7.BB.9F.E4.BD.8D.E6.95.B0"></span><span class="mw-headline" id="检查系统位数">检查系统位数</span>
</h3>
<h4>
<span id="Linux_.E7.B3.BB.E7.BB.9F"></span><span class="mw-headline" id="Linux_系统">Linux 系统</span>
</h4>
<p>在运行Linux 4.0及以上内核的发行版中，可以通过 sysfs 接口查看 UEFI 系统位数。试着运行：
</p>
<pre>$ cat /sys/firmware/efi/fw_platform_size
</pre>
<p>如果返回 <code>64</code> 则代表 64 位（x86_64） UEFI 系统，如果返回 <code>32</code> 则代表 32 位（IA32） UEFI 系统。如果文件不存在，那么代表并没有进入 UEFI 模式。
</p>
<h4>
<span id="macOS_.E7.B3.BB.E7.BB.9F"></span><span class="mw-headline" id="macOS_系统">macOS 系统</span>
</h4>
<p>2008年以前的 Mac 大都使用 i386-efi 固件， 2008年以后大都使用 x86_64-efi 。有能力运行 Mac OS X Snow Leopard 64位内核的 Mac 都是 x86_64 EFI 1.x 版的固件。
在 Mac OS 下输入以下命令可以找出该 Mac 的 efi 固件：
</p>
<pre>$ ioreg -l -p IODeviceTree | grep firmware-abi
</pre>
<p>如果命令返回 EFI32 则对应的是 i386 EFI 1.x 版本的固件，返回 EFI64 对应的则是 x86_64 EFI 1.x 版的固件. Mac 没有 UEFI 2.x 固件，Apple的 EFI 实现也不完全跟 UEFI 标准兼容。
</p>
<h4>
<span id="Windows_.E7.B3.BB.E7.BB.9F"></span><span class="mw-headline" id="Windows_系统">Windows 系统</span>
</h4>
<p>64 位的 Windows 系统不支持在 32 位 UEFI 上启动。所以如果你在 UEFI 模式下启动了 32 位 Windows，那么你使用的是 32 位 UEFI。
</p>
<p>可以通过运行 <code>msinfo32.exe</code>来查看系统位数。请看 <i>系统摘要</i> 条目下“系统类型”和“BIOS模式”对应的值。
</p>
<p>如果是 64 位 UEFI 上的 64 位 Windows，则会有 <code>系统类型：基于x64的电脑</code> 和 <code>BIOS 模式：UEFI</code> ;如果是 32 位 UEFI 上的 32 位 Windows，则会有 <code>系统类型：基于x86的电脑</code> 和 <code>BIOS 模式：UEFI</code>.如果“BIOS”模式不是 <code>UEFI</code> ,那么 Windows 并没有用 UEFI 模式启动.
</p>
<h2>
<span id="Linux_.E5.86.85.E6.A0.B8.E4.B8.AD.E6.9C.89.E5.85.B3_UEFI_.E7.9A.84.E9.85.8D.E7.BD.AE.E9.80.89.E9.A1.B9"></span><span class="mw-headline" id="Linux_内核中有关_UEFI_的配置选项">Linux 内核中有关 UEFI 的配置选项</span>
</h2>
<p>UEFI 系统所要求的 Linux 内核配置选项设置如下:
</p>
<pre>CONFIG_RELOCATABLE=y
CONFIG_EFI=y
CONFIG_EFI_STUB=y
CONFIG_FB_EFI=y
CONFIG_FRAMEBUFFER_CONSOLE=y
</pre>
<p>UEFI运行时变量支持 (<b>efivarfs</b> 文件系统 - <code>/sys/firmware/efi/efivars</code>). 该选项十分重要，因为它是使用如 <code>/usr/bin/efibootmgr</code> 的工具来操作UEFI运行时变量所必须的。下面的选项已添加进了版本3.10及以上的内核中。
</p>
<pre>CONFIG_EFIVAR_FS=y
</pre>
<p>UEFI运行时变量支持 (老式 <b>efivars sysfs</b> 接口 - <code>/sys/firmware/efi/vars</code>). 应当禁用该选项来防止同时启用 efivarfs 和 sysfs-efivars 所导致的潜在问题。
</p>
<pre>CONFIG_EFI_VARS=n
</pre>
<p>GUID 分区表 <a href="../en/Partitioning.html#GUID_Partition_Table" class="mw-redirect" title="GPT">GPT</a> 配置选项 - UEFI 支持的强制需求
</p>
<pre>CONFIG_EFI_PARTITION=y
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>注意：</strong> 以上所有选项是通过 UEFI 启动 Linux 所必须的，并已在官方源的 Archlinux 内核中启用。</div>
<p>来自于 <a rel="nofollow" class="external free" href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/plain/Documentation/x86/x86_64/uefi.txt">https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/plain/Documentation/x86/x86_64/uefi.txt</a><sup title="最后检查状态：404">[<a href="https://en.wikipedia.org/wiki/Wikipedia:Link_rot" class="extiw" title="wikipedia:Wikipedia:Link rot">失效链接</a> 2020-08-06 ⓘ]</sup> .
</p>
<h2>
<span id="UEFI_.E5.8F.98.E9.87.8F"></span><span class="mw-headline" id="UEFI_变量">UEFI 变量</span>
</h2>
<p>UEFI 定义了变量，通过它们操作系统可以与固件进行交互。 UEFI 引导变量只在早期系统启动时由引导加载程序和操作系统使用。UEFI运行时变量允许操作系统来管理固件的某些设置(如UEFI引导管理器)或 UEFI Secure Boot 协议的密钥。你可通过下面的命令来获得变量列表: 
</p>
<pre>$ efivar -l
</pre>
<h3>
<span id="Linux_.E5.86.85.E6.A0.B8.E4.B8.AD.E7.9A.84_UEFI_.E5.8F.98.E9.87.8F.E6.94.AF.E6.8C.81"></span><span class="mw-headline" id="Linux_内核中的_UEFI_变量支持">Linux 内核中的 UEFI 变量支持</span>
</h3>
<p>Linux 内核通过两个接口来把 EFI 变量数据传递给用户空间:
</p>
<ul><li>
<b>老式 sysfs-efivars</b> 接口 (CONFIG_EFI_VARS) - 由位于 <code>/sys/firmware/efi/vars</code> 的内核模块 <code>efivars</code> 生成  - 每个变量数据最大大小为1024B, 不支持 UEFI Secure Boot 变量(由于大小限制)，并再也不被上游推荐使用。现仍被上游支持但<b>在 Arch 官方内核中已完全禁用</b>。</li></ul>
<ul><li>
<b>新式 efivarfs</b> (<b>EFI</b> <b>VAR</b>iable <b>F</b>ile<b>S</b>ystem) 接口 (CONFIG_EFIVAR_FS) - 由位于 <code>/sys/firmware/efi/efivars</code> 的 <code>efivarfs</code> 内核模块挂载使用 - 老式 sysfs-efivars 接口的替代品，不限制变量数据大小，支持 UEFI Secure Boot 变量并被上游推荐使用。在3.8版的内核中引入，新的 <code>efivarfs</code> 模块在3.10版内核中从旧的 <code>efivars</code> 内核模块中分离。</li></ul>
<h4>
<span id="efivarfs_.E5.92.8C_sysfs-efivars_.E7.9A.84.E4.B8.8D.E4.B8.80.E8.87.B4"></span><span class="mw-headline" id="efivarfs_和_sysfs-efivars_的不一致">efivarfs 和 sysfs-efivars 的不一致</span>
</h4>
<p>同时启用老式的 sysfs-efivars 和新式的 efivarfs 会导致数据不一致的问题(更多信息见 <a rel="nofollow" class="external free" href="https://lkml.org/lkml/2013/4/16/473">https://lkml.org/lkml/2013/4/16/473</a> )。由于(自从 <b>core/<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux">linux</a></span>-3.11</b> 和 <b>core/<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=linux-lts">linux-lts</a></span>-3.10</b>)老式的 sysfs-efivars 在 Arch 官方内核中已完全禁用，新式的 efivarfs 将会被继续地启用/支持下去。自2013年10月1日起，在<a href="../zh-CN/Official_repositories.html" class="mw-redirect" title="官方源">官方源</a>中所有与 UEFI 变量相关的工具都支持 efivarfs.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>注意：</strong> 作为禁用老式 sysfs-efivars 的副作用，<code>efi_pstore</code> 在 Arch 官方内核中也被禁用，因为 EFI pstore 功能依赖老式 sysfs-efivars 支持。</div>
<p>如果在使用任何用户空间工具访问 EFI VAR 数据前你同时开启了这两者，请禁用其中之一并重新开启另一个接口 (为了刷新数据和防止不一致) :
</p>
<p>禁用 sysfs-efivars 并刷新 efivarfs:
</p>
<pre># modprobe -r efivars

# umount /sys/firmware/efi/efivars
# modprobe -r efivarfs

# modprobe efivarfs
# mount -t efivarfs efivarfs /sys/firmware/efi/efivars
</pre>
<p>禁用 efivarfs 并刷新 sysfs-efivars:
</p>
<pre># umount /sys/firmware/efi/efivars
# modprobe -r efivarfs

# modprobe -r efivars
# modprobe efivars
</pre>
<h3>
<span id="UEFI_.E5.8F.98.E9.87.8F.E6.AD.A3.E5.B8.B8.E5.B7.A5.E4.BD.9C.E7.9A.84.E9.9C.80.E6.B1.82"></span><span class="mw-headline" id="UEFI_变量正常工作的需求">UEFI 变量正常工作的需求</span>
</h3>
<ol>
<li>内核处理器的位数应该与 EFI 处理器的位数相符。</li>
<li>内核应以 EFI 模式(通过 <a href="../en/EFISTUB.html" title="EFISTUB">EFISTUB</a> 或 <a href="../en/Arch_boot_process.html#Boot_loader" class="mw-redirect" title="Boot loader">EFI 引导器</a>，而不是 BIOS/CSM 或者同为 BIOS/CSM 的"bootcamp")启动。</li>
<li>EFI 运行时服务支持应出现在内核中 (<code>CONFIG_EFI=y</code>, 运行 <code>zgrep CONFIG_EFI /proc/config.gz</code> 来核对是否共存 ).</li>
<li>EFI 运行时服务在内核命令行中<b>不应被禁用</b>，即<b>不应使用</b>内核参数 <code>noefi</code>.</li>
<li>
<code>efivarfs</code> 文件系统应被挂载在 <code>/sys/firmware/efi/efivars</code>, 否则参考下文 <a href="#%E6%8C%82%E8%BD%BD_efivarfs">#挂载 efivarfs</a> 部分。</li>
<li>
<code>efivar</code> 应无错列出 (选项 <code>-l</code>) EFI 变量。参见输出内容 <a href="#Sample_List_of_UEFI_Variables">#Sample_List_of_UEFI_Variables</a><sup>[<a href="../en/ArchWiki:Requests.html#Broken_section_links" class="mw-redirect" title="ArchWiki:Requests">断开的链接</a>：无效的部分]</sup>.</li>
</ol>
<p>如果 EFI 变量支持在满足以上条件后仍有问题，尝试以下解决方案:
</p>
<ol>
<li>如果所有的用户空间工具都不能修改 EFI 变量数据，检查 <code>/sys/firmware/efi/efivars/dump-*</code> 文件是否存在。如果是，删掉，重启，再试一次。</li>
<li>如果上面的步骤没有解决问题，尝试以内核参数 <code>efi_no_storage_paranoia</code> 启动以禁用内核 EFI 变量存储空间来防止对 EFI 变量的写入/修改。</li>
</ol>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>注意：</strong> <code>efi_no_storage_paranoia</code> 仅当需要时使用且不应留下作为正常启动参数。该内核参数的效果是关闭正在实施的安全保护，来避免 NVRAM 过满时机器故障。</div>
<h4>
<span id=".E6.8C.82.E8.BD.BD_efivarfs"></span><span class="mw-headline" id="挂载_efivarfs">挂载 efivarfs</span>
</h4>
<p>如果 <code>efivarfs</code> 启动时并没有被 <a href="../en/Systemd.html" title="Systemd">systemd</a> 自动挂载在 <code>/sys/firmware/efi/efivars</code>, 你需要手动挂载来把 EFI 变量支持传递给像 <code>efibootmgr</code> 等的用户空间工具:
</p>
<pre># mount -t efivarfs efivarfs /sys/firmware/efi/efivars
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>注意：</strong> 这个命令即使要运行的话也要在 <b>chroot</b> 之外(之前)和之内都运行一次。</div>
<p>如下通过 <code>/etc/fstab</code> 来自动挂载 <code>efivarfs</code> 也是极好的:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/fstab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">efivarfs    /sys/firmware/efi/efivars    efivarfs    defaults    0    0
</pre>
<h3>
<span id=".E7.94.A8.E6.88.B7.E7.A9.BA.E9.97.B4.E5.B7.A5.E5.85.B7"></span><span class="mw-headline" id="用户空间工具">用户空间工具</span>
</h3>
<p>只有少量工具能够访问/修改 UEFI 变量，即
</p>
<ul><li>
<b>efivar</b> — 操作 UEFI 变量的库和工具 (被 efibootmgr 用到)</li></ul>
<dl><dd>
<a rel="nofollow" class="external free" href="https://github.com/vathpela/efivar">https://github.com/vathpela/efivar</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=efivar">efivar</a></span>,<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/efivar-git/">efivar-git</a></span><sup><small>AUR</small></sup>
</dd></dl>
<ul><li>
<b>efibootmgr</b> — 操作 UEFI 固件启动管理器设置的工具</li></ul>
<dl><dd>
<a rel="nofollow" class="external free" href="https://github.com/vathpela/efibootmgr">https://github.com/vathpela/efibootmgr</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=efibootmgr">efibootmgr</a></span>
</dd></dl>
<ol><li>
<b>uefivars</b> — 转储 UEFI 变量和 PCI 相关信息 (内部使用 efibootmgr 源码)</li></ol>
<dl><dd>
<a rel="nofollow" class="external free" href="https://github.com/fpmurphy/Various/tree/master/uefivars-2.0">https://github.com/fpmurphy/Various/tree/master/uefivars-2.0</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/uefivars-git/">uefivars-git</a></span><sup><small>AUR</small></sup>
</dd></dl>
<ol><li>
<b>efitools</b> — 创建与设置自己的 UEFI Secure Boot 证书，密钥和签名过的程序的工具 (需要 efivarfs)</li></ol>
<dl><dd>
<a rel="nofollow" class="external free" href="https://git.kernel.org/cgit/linux/kernel/git/jejb/efitools.git">https://git.kernel.org/cgit/linux/kernel/git/jejb/efitools.git</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/efitools-git/">efitools-git</a></span><sup><small>AUR</small></sup>
</dd></dl>
<ol><li>
<b>Ubuntu的固件测试套件</b> — 固件检查工具</li></ol>
<dl><dd>
<a rel="nofollow" class="external free" href="https://wiki.ubuntu.com/FirmwareTestSuite/">https://wiki.ubuntu.com/FirmwareTestSuite/</a> || <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/fwts-git/">fwts-git</a></span><sup><small>AUR</small></sup>
</dd></dl>
<h4><span class="mw-headline" id="efibootmgr">efibootmgr</span></h4>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>注意：</strong> 
<ul>
<li>如果 <code>efibootmgr</code> 完全无效，你可以重启进入 UEFI Shell 使用 <code>bcfg</code> 命令来给引导器创建一个启动条目。</li>
<li>如果你不能使用 <code>efibootmgr</code>, 某些 UEFI 固件允许用户用内建的启动时界面管理启动条目。例如，某些华硕机有 "Add New Boot Option" 选项，能让你选择本地 EFI 系统分区并手动进入 EFI 存根位置 (例如 <code>\EFI\refind\refind_x64.efi</code>).</li>
<li>下面的命令用 <a href="../en/REFInd.html" title="REFInd">rEFInd</a> 引导器作为例子。</li>
</ul>
</div>
<p>要通过 <i>efibootmgr</i> 添加新的启动参数，需要确认：
</p>
<ol>
<li>包含 ESP 的磁盘编号: <code>/dev/sd<i>X</i></code>
</li>
<li>ESP 在第几个分区 <code>/dev/sdX<i>Y</i></code> 中的 <code><i>Y</i></code>
</li>
<li>UEFI 程序相对 ESP 根目录的路径</li>
</ol>
<p>假设要启动的引导器文件是 <code>/boot/efi/EFI/refind/refind_x64.efi</code>,<code>/boot/efi</code> 是 ESP 的挂载目录
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$ findmnt /boot/efi</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">TARGET SOURCE  FSTYPE OPTIONS
/boot/efi /dev/sda1  vfat   rw,flush,tz=UTC</pre>
<p>上面结果说明 ESP 位于 <code>/dev/sda</code>，分区编号是 1. UEFI 程序相对于 ESP 根的路径是<code>/EFI/refind/refind_x64.efi</code>. 应该用下面 efibootmgr 语句创建:
</p>
<pre># efibootmgr --create --disk /dev/sda --part 1 --loader /EFI/refind/refind_x64.efi --label "rEFInd Boot Manager"
</pre>
<p>参考<span class="plainlinks archwiki-template-man" title="$ man 8 efibootmgr"><a rel="nofollow" class="external text" href="https://man.archlinux.org/man/efibootmgr.8">efibootmgr(8)</a></span> 或 <a rel="nofollow" class="external text" href="https://raw.githubusercontent.com/rhinstaller/efibootmgr/master/README">efibootmgr README</a>。
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>注意：</strong> UEFI 使用反斜杠 <code>\</code> 作为路径分隔符 (类似于 Windows 路径)，Efibootmgr 解析路径之前内部会把 <code>/</code> 转换为 <code>\</code>.</div>
<h2><span class="mw-headline" id="UEFI_Shell">UEFI Shell</span></h2>
<p>UEFI Shell 是固件的终端，可用于启动包括引导器的 UEFI 程序。除此之外， Shell也可用于采集固件和系统的各种信息，例如内存映射 (memmap), 修改启动管理器变量 (bcfg), 运行分区程序 (diskpart), 加载 UEFI 驱动，编辑文本文件 (edit), 十六进制编辑等等。 
</p>
<h3>
<span id=".E8.8E.B7.E5.8F.96_UEFI_Shell"></span><span class="mw-headline" id="获取_UEFI_Shell">获取 UEFI Shell</span>
</h3>
<p>你可从 Intel 的 Tianocore UDK/EDK2 Sourceforge.net 工程下载以 BSD 许可证发布的 UEFI Shell.
</p>
<ul>
<li>
<span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/uefi-shell-git/">uefi-shell-git</a></span><sup><small>AUR</small></sup> 包 (推荐) - 为 x86_64 系统提供 x86_64 Shell 以及为 i686 系统提供 IA32 Shell - 直接从 Tianocore EDK2 最新的源码编译</li>
<li>
<a rel="nofollow" class="external text" href="https://github.com/tianocore/edk2/tree/master/ShellBinPkg">Precompiled UEFI Shell v2 binaries</a><sup title="最后检查状态：404">[<a href="https://en.wikipedia.org/wiki/Wikipedia:Link_rot" class="extiw" title="wikipedia:Wikipedia:Link rot">失效链接</a> 2020-08-06 ⓘ]</sup> (may not be up-to-date)</li>
<li>
<a rel="nofollow" class="external text" href="https://github.com/tianocore/edk2/tree/master/EdkShellBinPkg">Precompiled UEFI Shell v1 binaries</a><sup title="最后检查状态：404">[<a href="https://en.wikipedia.org/wiki/Wikipedia:Link_rot" class="extiw" title="wikipedia:Wikipedia:Link rot">失效链接</a> 2020-08-06 ⓘ]</sup> (not updated anymore upstream)</li>
<li>
<a rel="nofollow" class="external text" href="http://dl.dropbox.com/u/17629062/Shell2.zip">UEFI Shell v2 binary with bcfg modified to work with UEFI pre-2.3 firmware</a><sup title="最后检查状态：404">[<a href="https://en.wikipedia.org/wiki/Wikipedia:Link_rot" class="extiw" title="wikipedia:Wikipedia:Link rot">失效链接</a> 2020-08-06 ⓘ]</sup> - from Clover EFI bootloader</li>
</ul>
<p>Shell v2 在 UEFI 2.3+ 系统上表现最好，并比 Shell v1 优先推荐。Shell v1 应该在所有 UEFI 系统上有效并且与它们遵循的 UEFI 标准版本无关。更多信息见 <a rel="nofollow" class="external text" href="https://sourceforge.net/apps/mediawiki/tianocore/index.php?title=ShellPkg">ShellPkg</a>。
</p>
<h3>
<span id=".E5.90.AF.E5.8A.A8_UEFI_Shell"></span><span class="mw-headline" id="启动_UEFI_Shell">启动 UEFI Shell</span>
</h3>
<p>部分基于 AMI Aptio x86_64 UEFI 固件的主板 (从 Sandy Bridge 起，尤其是华硕) 提供了一个叫做 <code>"Launch EFI Shell from filesystem device"</code> 的选项。对于这些主板，下载 x86_64 UEFI Shell ，复制进 EFI 系统分区，命名为 <code>&lt;EFI_SYSTEM_PARTITION&gt;/shellx64.efi</code> (大部分是 <code>/boot/efi/shellx64.efi</code>) .
</p>
<p>Phoenix SecureCore Tiano UEFI 固件已内嵌 UEFI Shell, 可按 <code>F6</code>, <code>F11</code> 或 <code>F12</code> 键来启动。
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>注意：</strong> 如果你用以上方法不能启动 UEFI Shell, 创建一个 FAT32 格式的 USB 并把 <code>Shell.efi</code> 复制到 <code>(USB)/efi/boot/bootx64.efi</code>. 这个 USB 会出现在固件的启动菜单里。启动它就会启动到 UEFI Shell.</div>
<h3>
<span id=".E9.87.8D.E8.A6.81_UEFI_Shell_.E5.91.BD.E4.BB.A4"></span><span class="mw-headline" id="重要_UEFI_Shell_命令">重要 UEFI Shell 命令</span>
</h3>
<p>UEFI Shell 命令通常支持 <code>-b</code> 选项，它在输出的每页末尾暂停. 运行 <code>help -b</code> 来列出所有可用命令。
</p>
<p>更多信息见 <a rel="nofollow" class="external free" href="http://software.intel.com/en-us/articles/efi-shells-and-scripting/">http://software.intel.com/en-us/articles/efi-shells-and-scripting/</a>
</p>
<h4><span class="mw-headline" id="bcfg">bcfg</span></h4>
<p><code>bcfg</code> 命令用于修改 UEFI NVRAM 条目，它能让用户改变启动条目或驱动器选项。在[<a rel="nofollow" class="external free" href="http://www.uefi.org/sites/default/files/resources/UEFI_Shell_Spec_2_0.pdf">http://www.uefi.org/sites/default/files/resources/UEFI_Shell_Spec_2_0.pdf</a> 
</p>
<pre>UEFI Shell Specification 2.0] PDF 文档的 83 页(Section 5.3) 有详细说明。
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>注意：</strong> 
<ul>
<li>仅当 <code>efibootmgr</code> 无法创建启动条目时才推荐尝试 <code>bcfg</code>.</li>
<li>UEFI Shell v1 官方二进制文件不支持 <code>bcfg</code> 命令。你可以下载一个 <a rel="nofollow" class="external text" href="http://dl.dropbox.com/u/17629062/Shell2.zip">modified UEFI Shell v2 二进制文件</a><sup title="最后检查状态：404">[<a href="https://en.wikipedia.org/wiki/Wikipedia:Link_rot" class="extiw" title="wikipedia:Wikipedia:Link rot">失效链接</a> 2020-08-06 ⓘ]</sup>，它在 UEFI 2.3前的固件有效。</li>
</ul>
</div>
<p>转储当前启动条目:
</p>
<pre>Shell&gt; bcfg boot dump -v
</pre>
<p>为 rEFInd (作为例子) 添加一个启动菜单条目，在启动菜单里是第4个 (从0开始计数) 选项:
</p>
<pre>Shell&gt; bcfg boot add 3 fs0:\EFI\refind\refind_x64.efi "rEFInd"
</pre>
<p><code>fs0:</code> 映射到 EFI 系统分区，<code>fs0:\EFI\refind\refind_x64.efi</code> i是要启动的文件。
</p>
<p>To add an entry to boot directly into your system without a bootloader, configure a boot option using your kernel as an <a href="../en/EFISTUB.html#UEFI_Shell" title="EFISTUB">EFISTUB</a><sup>[<a href="../en/ArchWiki:Requests.html#Broken_section_links" class="mw-redirect" title="ArchWiki:Requests">断开的链接</a>：无效的部分]</sup>:
</p>
<pre>Shell&gt; bcfg boot add <b>N</b> fs<b>V</b>:\vmlinuz-linux "Arch Linux"	
Shell&gt; bcfg boot -opt <b>N</b> "root=<b>/dev/sdX#</b> initrd=\initramfs-linux.img"
</pre>
<p>where <code>N</code> is the priority, <code>V</code> is the volume number of your EFI partition, and <code>/dev/sdX#</code> is your root partition.
</p>
<p>删除第4个启动选项:
</p>
<pre>Shell&gt; bcfg boot rm 3
</pre>
<p>把第3个启动选项移动到第0 (也就是说第1个是 UEFI 启动菜单的默认启动选项):
</p>
<pre>Shell&gt; bcfg boot mv 3 0
</pre>
<p>bcfg 帮助文档:
</p>
<pre>Shell&gt; help bcfg -v -b
</pre>
<p>或:
</p>
<pre>Shell&gt; bcfg -? -v -b
</pre>
<h4><span class="mw-headline" id="map">map</span></h4>
<p><code>map</code> displays a list of device mappings i.e. the names of available file systems (<code>fs0</code>) and storage devices (<code>blk0</code>).
</p>
<p>Before running file system commands such as <code>cd</code> or <code>ls</code>, you need to change the shell to the appropriate file system by typing its name:
</p>
<pre> Shell&gt; fs0:
 fs0:\&gt; cd EFI/
</pre>
<h4><span class="mw-headline" id="edit">edit</span></h4>
<p>EDIT 命令提供了类似于 nano 界面的基本编辑器，但是功能略少一点。它以 UTF-8 编码并且行尾结束符兼容 LF 和 CRLF.
</p>
<p>本例中，编辑在固件 EFI 系统分区 (<code>fs0:</code> 中 rEFInd 的 <code>refind.conf</code> 
</p>
<pre> Shell&gt; edit FS0:\EFI\refind\refind.conf
</pre>
<p>输入 <code>Ctrl-E</code> 以获得帮助。
</p>
<h2>
<span id="UEFI_.E5.8F.AF.E5.90.AF.E5.8A.A8.E4.BB.8B.E8.B4.A8"></span><span class="mw-headline" id="UEFI_可启动介质">UEFI 可启动介质</span>
</h2>
<h3>
<span id=".E4.BB.8E_ISO_.E5.88.9B.E5.BB.BA_UEFI_.E5.8F.AF.E5.90.AF.E5.8A.A8_USB"></span><span class="mw-headline" id="从_ISO_创建_UEFI_可启动_USB">从 ISO 创建 UEFI 可启动 USB</span>
</h3>
<p>教程见 <a href="../en/USB_flash_installation_medium.html#BIOS_and_UEFI_bootable_USB" class="mw-redirect" title="USB flash installation media">USB flash installation media#BIOS and UEFI bootable USB</a>.
</p>
<h3>
<span id=".E4.BB.8E.E5.85.89.E5.AD.A6.E4.BB.8B.E8.B4.A8.E9.87.8C.E7.A7.BB.E9.99.A4_UEFI_.E5.90.AF.E5.8A.A8.E6.94.AF.E6.8C.81"></span><span class="mw-headline" id="从光学介质里移除_UEFI_启动支持">从光学介质里移除 UEFI 启动支持</span>
</h3>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>注意：</strong> 本部分提及的是给 <b>CD/DVD only</b> (光学介质)而不是 USB 闪存移除 UEFI 启动支持。</div>
<p>大部分32位 EFI Mac 机和部分64位 EFI Mac 机无法从 UEFI(X64)+BIOS 可启动 CD/DVD 启动。如果希望使用光学介质完成安装，可能首先需要移除 UEFI 启动支持。
</p>
<ul><li>挂载官方安装介质并如前所述获取 <code>archisolabel</code> .</li></ul>
<pre># mount -o loop <i>input.iso</i> /mnt/iso
</pre>
<ul><li>然后重建 ISO,  使用 <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=libisoburn">libisoburn</a></span> 的 <code>xorriso</code> 移除 UEFI 光学介质启动支持。确认已设置正确的 archisolabel, 例如 "ARCH_201411"或类似的:</li></ul>
<pre>$ xorriso -as mkisofs -iso-level 3 \
    -full-iso9660-filenames\
    -volid "<i>archisolabel</i>" \
    -appid "Arch Linux CD" \
    -publisher "Arch Linux &lt;<a rel="nofollow" class="external free" href="https://archlinux.org">https://archlinux.org</a>&gt;" \
    -preparer "prepared by $USER" \
    -eltorito-boot isolinux/isolinux.bin \
    -eltorito-catalog isolinux/boot.cat \
    -no-emul-boot -boot-load-size 4 -boot-info-table \
    -isohybrid-mbr "/mnt/iso/isolinux/isohdpfx.bin" \
    -output <i>output.iso</i> /mnt/iso/</pre>
<ul><li>把 <code><i>output.iso</i></code> 烧制进光学介质并照常完成安装。</li></ul>
<h2>
<span id=".E5.8E.9F.E7.94.9F.E6.97.A0.E6.94.AF.E6.8C.81.E6.83.85.E5.86.B5.E4.B8.8B.E6.B5.8B.E8.AF.95_UEFI"></span><span class="mw-headline" id="原生无支持情况下测试_UEFI">原生无支持情况下测试 UEFI</span>
</h2>
<h3>
<span id=".E8.99.9A.E6.8B.9F.E6.9C.BA.E4.BD.BF.E7.94.A8_OVMF"></span><span class="mw-headline" id="虚拟机使用_OVMF">虚拟机使用 OVMF</span>
</h3>
<p><a rel="nofollow" class="external text" href="https://tianocore.github.io/ovmf/">OVMF</a> 是一个将 UEFI 添加到虚拟机的 tianocore 项目。OVMF 包含了一个 QEMU 使用的示例 UEFI 固件。
</p>
<p>安装 <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=ovmf">ovmf</a></span><sup>[<a href="../en/Help:Procedures.html#Fix_broken_package_links" title="Help:Procedures">断开的链接</a>：replaced by <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://archlinux.org/packages/?name=edk2-ovmf">edk2-ovmf</a></span>]</sup>. 
</p>
<p><a rel="nofollow" class="external text" href="http://www.linux-kvm.org/downloads/lersek/ovmf-whitepaper-c770f8c.txt">建议</a>先将虚拟机的非易逝变量本地保存一份。
</p>
<pre>$ cp /usr/share/ovmf/ovmf_vars_x64.bin my_uefi_vars.bin
</pre>
<p>然后在 QEME 命令中加入: 
</p>
<pre>-drive if=pflash,format=raw,readonly,file=/usr/share/ovmf/ovmf_code_x64.bin \
-drive if=pflash,format=raw,file=my_uefi_vars.bin
</pre>
<p>示例:
</p>
<pre> $ qemu-system-x86_64 -enable-kvm -m 1G -drive if=pflash,format=raw,readonly,file=/usr/share/ovmf/ovmf_code_x64.bin -drive if=pflash,format=raw,file=efi_vars.bin …
</pre>
<h3>
<span id=".E4.BD.BF.E7.94.A8.E8.99.9A.E6.8B.9F.E6.9C.BA"></span><span class="mw-headline" id="使用虚拟机">使用虚拟机</span>
</h3>
<p><a href="../en/VirtualBox.html" title="VirtualBox">VirtualBox</a>、<a href="../en/VMware.html" title="VMware">VMware</a>虚拟机支持UEFI固件。
</p>
<h3>
<span id=".E4.BB.85_BIOS_.E7.9A.84.E7.B3.BB.E7.BB.9F.E4.BD.BF.E7.94.A8_DUET"></span><span class="mw-headline" id="仅_BIOS_的系统使用_DUET">仅 BIOS 的系统使用 DUET</span>
</h3>
<p>DUET 是一个 tianocore 工程用以从 BIOS 启动到完整 UEFI 环境，这与 BIOS 启动操作系统相似。在 <a rel="nofollow" class="external free" href="http://www.insanelymac.com/forum/topic/186440-linux-and-windows-uefi-boot-using-tianocore-duet-firmware/">http://www.insanelymac.com/forum/topic/186440-linux-and-windows-uefi-boot-using-tianocore-duet-firmware/</a> 里有广泛讨论。预建立的 DUET 镜像可从其中一个源 <a rel="nofollow" class="external free" href="https://gitorious.org/tianocore_uefi_duet_builds">https://gitorious.org/tianocore_uefi_duet_builds</a><sup title="最后检查状态：SSL error">[<a href="https://en.wikipedia.org/wiki/Wikipedia:Link_rot" class="extiw" title="wikipedia:Wikipedia:Link rot">失效链接</a> 2020-08-06 ⓘ]</sup> 下载。教程见 <a rel="nofollow" class="external free" href="https://gitorious.org/tianocore_uefi_duet_builds/tianocore_uefi_duet_installer/blobs/raw/master/Migle_BootDuet_INSTALL.txt">https://gitorious.org/tianocore_uefi_duet_builds/tianocore_uefi_duet_installer/blobs/raw/master/Migle_BootDuet_INSTALL.txt</a><sup title="最后检查状态：SSL error">[<a href="https://en.wikipedia.org/wiki/Wikipedia:Link_rot" class="extiw" title="wikipedia:Wikipedia:Link rot">失效链接</a> 2020-08-06 ⓘ]</sup>. 
</p>
<p>也可考虑 <a rel="nofollow" class="external free" href="https://sourceforge.net/projects/cloverefiboot/">https://sourceforge.net/projects/cloverefiboot/</a> , 它提供的 DUET 镜像可能包含了一些系统的专用补丁，并且比 gitorious 源更新得更频繁。
</p>
<h2>
<span id=".E7.96.91.E9.9A.BE.E9.97.AE.E9.A2.98"></span><span class="mw-headline" id="疑难问题">疑难问题</span>
</h2>
<h3>
<span id="Windows_7_.E6.97.A0.E6.B3.95.E4.BB.A5_UEFI_.E6.A8.A1.E5.BC.8F.E5.90.AF.E5.8A.A8"></span><span class="mw-headline" id="Windows_7_无法以_UEFI_模式启动">Windows 7 无法以 UEFI 模式启动</span>
</h3>
<p>如果你把 Windows 安装进了另一个 GPT 格式的硬盘并且你电脑里还有一个 MBR 格式的硬盘，那么可能 UEFI 固件启动了 CSM 支持(为从 MBR 分区启动的支持) 因而 Windows 无法启动。为解决问题，把 MBR 硬盘的内容合并到 GPT 硬盘中并禁用 MBR 硬盘使用的 SATA 接口或者直接把硬盘拔下来。
</p>
<p>有此类问题的主板:
</p>
<p>Gigabyte Z77X-UD3H rev. 1.1 (UEFI 版本 F19e)
</p>
<p>- 固件启动选项 "UEFI Only" 并不妨碍以 CSM 启动。
</p>
<h3>
<span id="Windows_.E6.94.B9.E5.8F.98.E4.BA.86.E5.90.AF.E5.8A.A8.E6.AC.A1.E5.BA.8F"></span><span class="mw-headline" id="Windows_改变了启动次序">Windows 改变了启动次序</span>
</h3>
<p>例如你升级 Windows 后直接启动了Windows而不是选择启动菜单:
</p>
<ul>
<li>确定UEFI固件设置中的"安全启动"(Secure Boot) 和 <a href="../en/Dual_boot_with_Windows.html#Fast_Start-Up" title="Dual boot with Windows">Windows 中的"快速启动"</a><sup>[<a href="../en/ArchWiki:Requests.html#Broken_section_links" class="mw-redirect" title="ArchWiki:Requests">断开的链接</a>：无效的部分]</sup> 选项没有启用.</li>
<li>确定UEFI固件设置的启动顺序中Linux Boot Manager 先于 Windows Boot Manager.</li>
</ul>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Windows 8.x+,和 Windows 10,可能会覆盖你在UEFI固件设置中设置的启动顺序并把自己设置成第一启动选项. 所以你应该知道如何修改"一次性启动选项".</div>
<p>你可以通过组策略和一个批处理文件(".bat")来阻止Windows更改启动设置,在Windows上这样做:
</p>
<ol>
<li>以管理员身份打开命令提示符,运行 <code>bcdedit /enum firmware</code>
</li>
<li>寻找描述中带有"linux"的启动选项,例如 "Linux Boot Manager"</li>
<li>复制带大括号的描述符, 例如 <code>{31d0d5f4-22ad-11e5-b30b-806e6f6e6963}</code>
</li>
<li>创建一个批处理文件 (例如 <code>bootorder.bat</code>) ,包含下列的内容: <code>bcdedit /set {fwbootmgr} DEFAULT {<i>这里是你在第三步中获得的描述符</i>}</code> (例如 <code>bcdedit /set {fwbootmgr} DEFAULT {31d0d5f4-22ad-11e5-b30b-806e6f6e6963}</code>).</li>
<li>运行 <i>gpedit (组策略对象编辑器)</i> 在 <i>本地计算机策略 &gt; 计算机设置 &gt; Windows 设置 &gt; 脚本(启动/关机)</i>中,选择"启动,会打开一个名为"启动选项:的对话框.</li>
<li>添加第四步中创建的批处理文件到"脚本"列表中.</li>
</ol>
<p>或者让Windows 启动管理器加载systemd-boot的EFI应用程序,要这样做的话在Windows上以管理员身份运行:
</p>
<pre>bcdedit /set {bootmgr} path \EFI\systemd\systemd-bootx64.efi
</pre>
<h3>
<span id="USB_.E4.BB.8B.E8.B4.A8.E5.8D.A1.E5.9C.A8.E9.BB.91.E5.B1.8F.E7.95.8C.E9.9D.A2"></span><span class="mw-headline" id="USB_介质卡在黑屏界面">USB 介质卡在黑屏界面</span>
</h3>
<p>可能是 <a href="../en/Kernel_mode_setting.html" class="mw-redirect" title="KMS">KMS</a> 的问题。从 USB 启动时尝试 <a href="../en/Kernel_mode_setting.html#Disabling_modesetting" title="Kernel mode setting">Disabling KMS</a>.
</p>
<h3>
<span id=".E5.9C.A8_32_.E4.BD.8D_UEFI_.E4.B8.8A.E5.90.AF.E5.8A.A8_64_.E4.BD.8D.E5.86.85.E6.A0.B8"></span><span class="mw-headline" id="在_32_位_UEFI_上启动_64_位内核">在 32 位 UEFI 上启动 64 位内核</span>
</h3>
<p>官方 ISO (<a href="../en/Archiso.html" title="Archiso">Archiso</a>) 和 都用 EFISTUB (通过 <a href="../en/Systemd-boot.html" title="Systemd-boot">systemd-boot</a> 启动管理器) 来让内核以 UEFI 模式启动。这种情况下参考下文来使用 <a href="../en/GRUB.html" title="GRUB">GRUB</a> 作为 USB 的引导器。
</p>
<h4>
<span id=".E4.BD.BF.E7.94.A8_GRUB"></span><span class="mw-headline" id="使用_GRUB">使用 GRUB</span>
</h4>
<ul><li>如 <a href="../en/USB_flash_installation_medium.html#BIOS_and_UEFI_bootable_USB" class="mw-redirect" title="USB flash installation media">link</a> 所述创建 USB 闪存安装介质。之后按照以下步骤来使用 GRUB 替代 Gummiboot.</li></ul>
<ul><li>把 <code>&lt;USB&gt;/EFI/boot/loader.efi</code> 备份为 <code>&lt;USB&gt;/EFI/boot/gummiboot.efi</code>
</li></ul>
<ul><li>
<a href="../en/GRUB/Tips_and_tricks.html#GRUB_standalone" title="GRUB/Tips and tricks">创建一个独立的 GRUB 镜像</a>并把它复制为 <code>&lt;USB&gt;/EFI/boot/loader.efi</code> 或 <code>EFI/boot/bootia32.efi</code>
</li></ul>
<ul><li>按如下内容创建 <code>&lt;USB&gt;/EFI/boot/grub.cfg</code> (替换 <code>ARCH_YYYYMM</code> 为 USB 盘，例如 <code>ARCH_201404</code>):</li></ul>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">grub.cfg for Official ISO</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">insmod part_gpt
insmod part_msdos
insmod fat

insmod efi_gop
insmod efi_uga
insmod video_bochs
insmod video_cirrus

insmod font

if loadfont "${prefix}/fonts/unicode.pf2" ; then
    insmod gfxterm
    set gfxmode="1024x768x32;auto"
    terminal_input console
    terminal_output gfxterm
fi

menuentry "Arch Linux archiso x86_64" {
    set gfxpayload=keep
    search --no-floppy --set=root --label ARCH_YYYYMM
    linux /arch/boot/x86_64/vmlinuz archisobasedir=arch archisolabel=ARCH_YYYYMM add_efi_memmap
    initrd /arch/boot/x86_64/archiso.img
}

menuentry "UEFI Shell x86_64 v2" {
    search --no-floppy --set=root --label ARCH_YYYYMM
    chainloader /EFI/shellx64_v2.efi
}
    
menuentry "UEFI Shell x86_64 v1" {
    search --no-floppy --set=root --label ARCH_YYYYMM
    chainloader /EFI/shellx64_v1.efi
}
</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">grub.cfg for Archboot ISO</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">insmod part_gpt
insmod part_msdos
insmod fat

insmod efi_gop
insmod efi_uga
insmod video_bochs
insmod video_cirrus

insmod font

if loadfont "${prefix}/fonts/unicode.pf2" ; then
    insmod gfxterm
    set gfxmode="1024x768x32;auto"
    terminal_input console
    terminal_output gfxterm
fi

menuentry "Arch Linux x86_64 Archboot" {
    set gfxpayload=keep
    search --no-floppy --set=root --file /boot/vmlinuz_x86_64
    linux /boot/vmlinuz_x86_64 cgroup_disable=memory loglevel=7 add_efi_memmap
    initrd /boot/initramfs_x86_64.img
}

menuentry "UEFI Shell x86_64 v2" {
    search --no-floppy --set=root --file /boot/vmlinuz_x86_64
    chainloader /EFI/tools/shellx64_v2.efi
}
    
menuentry "UEFI Shell x86_64 v1" {
    search --no-floppy --set=root --file /boot/vmlinuz_x86_64
    chainloader /EFI/tools/shellx64_v1.efi
}
</pre>
<h2>
<span id=".E5.8F.82.E9.98.85"></span><span class="mw-headline" id="参阅">参阅</span>
</h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/UEFI" class="extiw" title="wikipedia:UEFI">Wikipedia:UEFI</a></li>
<li>
<a rel="nofollow" class="external text" href="http://www.uefi.org/home/">UEFI Forum</a> - contains the official <a rel="nofollow" class="external text" href="http://www.uefi.org/specs/">UEFI Specifications</a> - GUID Partition Table is part of UEFI Specification</li>
<li><a rel="nofollow" class="external text" href="https://www.happyassassin.net/2014/01/25/uefi-boot-how-does-that-actually-work-then/">UEFI boot: how does that actually work, then? - A blog post by AdamW</a></li>
<li>
<a rel="nofollow" class="external text" href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/plain/Documentation/x86/x86_64/uefi.txt">Linux Kernel x86_64 UEFI Documentation</a><sup title="最后检查状态：404">[<a href="https://en.wikipedia.org/wiki/Wikipedia:Link_rot" class="extiw" title="wikipedia:Wikipedia:Link rot">失效链接</a> 2020-08-06 ⓘ]</sup>
</li>
<li><a rel="nofollow" class="external text" href="http://www.intel.com/technology/efi/">Intel's page on EFI</a></li>
<li><a rel="nofollow" class="external text" href="http://firmware.intel.com/">Intel Architecture Firmware Resource Center</a></li>
<li><a rel="nofollow" class="external text" href="http://firmware.intel.com/blog/linux-efi-boot-stub">Matt Fleming - The Linux EFI Boot Stub</a></li>
<li><a rel="nofollow" class="external text" href="http://firmware.intel.com/blog/accessing-uefi-variables-linux">Matt Fleming - Accessing UEFI Variables from Linux</a></li>
<li><a rel="nofollow" class="external text" href="http://www.rodsbooks.com/linux-uefi/">Rod Smith - Linux on UEFI: A Quick Installation Guide</a></li>
<li><a rel="nofollow" class="external text" href="https://lkml.org/lkml/2011/6/8/322">UEFI Boot problems on some newer machines (LKML)</a></li>
<li>
<a rel="nofollow" class="external text" href="http://linuxplumbers.ubicast.tv/videos/plumbing-uefi-into-linux/">LPC 2012 Plumbing UEFI into Linux</a><sup title="最后检查状态：domain name not resolved">[<a href="https://en.wikipedia.org/wiki/Wikipedia:Link_rot" class="extiw" title="wikipedia:Wikipedia:Link rot">失效链接</a> 2020-08-06 ⓘ]</sup>
</li>
<li>
<a rel="nofollow" class="external text" href="http://linuxplumbers.ubicast.tv/videos/uefi-tutorial-part-1/">LPC 2012 UEFI Tutorial : part 1</a><sup title="最后检查状态：domain name not resolved">[<a href="https://en.wikipedia.org/wiki/Wikipedia:Link_rot" class="extiw" title="wikipedia:Wikipedia:Link rot">失效链接</a> 2020-08-06 ⓘ]</sup>
</li>
<li>
<a rel="nofollow" class="external text" href="http://linuxplumbers.ubicast.tv/videos/uefi-tutorial-part-2/">LPC 2012 UEFI Tutorial : part 2</a><sup title="最后检查状态：domain name not resolved">[<a href="https://en.wikipedia.org/wiki/Wikipedia:Link_rot" class="extiw" title="wikipedia:Wikipedia:Link rot">失效链接</a> 2020-08-06 ⓘ]</sup>
</li>
<li>
<a rel="nofollow" class="external text" href="https://sourceforge.net/apps/mediawiki/tianocore/index.php?title=Welcome_to_TianoCore">Intel's Tianocore Project</a> for Open-Source UEFI firmware which includes DuetPkg for direct BIOS based booting and OvmfPkg used in QEMU and Oracle VirtualBox</li>
<li><a rel="nofollow" class="external text" href="https://jdebp.eu/FGA/efi-boot-process.html">FGA: The EFI boot process</a></li>
<li>
<a rel="nofollow" class="external text" href="http://www.microsoft.com/whdc/device/storage/GPT_FAQ.mspx">Microsoft's Windows and GPT FAQ</a><sup title="最后检查状态：403">[<a href="https://en.wikipedia.org/wiki/Wikipedia:Link_rot" class="extiw" title="wikipedia:Wikipedia:Link rot">失效链接</a> 2020-08-06 ⓘ]</sup>
</li>
<li>
<a rel="nofollow" class="external text" href="https://gitorious.org/tianocore_uefi_duet_builds/pages/Windows_x64_BIOS_to_UEFI">Convert Windows x64 from BIOS-MBR mode to UEFI-GPT mode without Reinstall</a><sup title="最后检查状态：SSL error">[<a href="https://en.wikipedia.org/wiki/Wikipedia:Link_rot" class="extiw" title="wikipedia:Wikipedia:Link rot">失效链接</a> 2020-08-06 ⓘ]</sup>
</li>
<li>
<a rel="nofollow" class="external text" href="https://gitorious.org/tianocore_uefi_duet_builds/pages/Linux_Windows_BIOS_UEFI_boot_USB">Create a Linux BIOS+UEFI and Windows x64 BIOS+UEFI bootable USB drive</a><sup title="最后检查状态：SSL error">[<a href="https://en.wikipedia.org/wiki/Wikipedia:Link_rot" class="extiw" title="wikipedia:Wikipedia:Link rot">失效链接</a> 2020-08-06 ⓘ]</sup>
</li>
<li><a rel="nofollow" class="external text" href="http://rodsbooks.com/bios2uefi/">Rod Smith - A BIOS to UEFI Transformation</a></li>
<li><a rel="nofollow" class="external text" href="http://software.intel.com/en-us/articles/efi-shells-and-scripting/">EFI Shells and Scripting - Intel Documentation</a></li>
<li><a rel="nofollow" class="external text" href="http://software.intel.com/en-us/articles/uefi-shell/">UEFI Shell  - Intel Documentation</a></li>
<li>
<a rel="nofollow" class="external text" href="http://www.hpuxtips.es/?q=node/293">UEFI Shell - bcfg command info</a><sup title="最后检查状态：domain name not resolved">[<a href="https://en.wikipedia.org/wiki/Wikipedia:Link_rot" class="extiw" title="wikipedia:Wikipedia:Link rot">失效链接</a> 2020-08-06 ⓘ]</sup>
</li>
</ul>
</div>
</div>
<div id="catlinks" class="catlinks" data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../zh-CN/Category:Boot_process.html" title="Category:Boot process (简体中文)">Boot process (简体中文)</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden categories: <ul>
<li><a href="../en/Category:Pages_with_dead_links.html" title="Category:Pages with dead links">Pages with dead links</a></li>
<li><a href="../en/Category:Pages_with_broken_section_links.html" title="Category:Pages with broken section links">Pages with broken section links</a></li>
<li><a href="../en/Category:Pages_with_broken_package_links.html" title="Category:Pages with broken package links">Pages with broken package links</a></li>
</ul>
</div>
</div>
	</div>
</div>

<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
		<li>Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Unified_Extensible_Firmware_Interface_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)&amp;oldid=647077">https://wiki.archlinux.org/index.php?title=Unified_Extensible_Firmware_Interface_(简体中文)&amp;oldid=647077</a>"</li>
		<li id="footer-info-lastmod"> This page was last edited on 26 December 2020, at 12:28.</li>
		<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="http://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
	<br>
</ul>
	<ul id="footer-places">
		<li id="footer-places-privacy"><a href="../en/ArchWiki:Privacy_policy.html" title="ArchWiki:Privacy policy">Privacy policy</a></li>
		<li id="footer-places-about"><a href="../en/ArchWiki:About.html" title="ArchWiki:About">About ArchWiki</a></li>
		<li id="footer-places-disclaimer"><a href="../en/ArchWiki:General_disclaimer.html" title="ArchWiki:General disclaimer">Disclaimers</a></li>
	</ul>
	<ul id="footer-icons" class="noprint">
		<li id="footer-copyrightico">
	</ul>
	<div style="clear: both;"></div>
</footer>



</body>
</html>
